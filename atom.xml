<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é±¼ä¸å‰ç«¯ğŸŸ</title>
  
  <subtitle>æ‘¸é±¼å’Œå·¥ä½œä¸å¯å¾—å…¼~</subtitle>
  <link href="https://zlinni.github.io/atom.xml" rel="self"/>
  
  <link href="https://zlinni.github.io/"/>
  <updated>2022-06-13T13:49:32.368Z</updated>
  <id>https://zlinni.github.io/</id>
  
  <author>
    <name>Zlinni</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘¦--Schedulerç¯‡</title>
    <link href="https://zlinni.github.io/posts/3541433463/"/>
    <id>https://zlinni.github.io/posts/3541433463/</id>
    <published>2022-06-13T00:44:49.000Z</published>
    <updated>2022-06-13T13:49:32.368Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯ scheduler ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­è°ƒåº¦æœºåˆ¶çš„æ·±å…¥è®¨è®ºã€‚</p></div><h1 id="ä¸ºä»€ä¹ˆéœ€è¦-scheduler"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-scheduler" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ scheduler"></a>ä¸ºä»€ä¹ˆéœ€è¦ scheduler</h1><p>åœ¨æˆ‘ä»¬ä¸ŠèŠ‚ç»„ä»¶çš„å®è·µä¸­ï¼Œæˆ‘ä»¬è·‘äº†ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, h &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;./reactiveDemo/ref&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> Comp = &#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = ref(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      count.value++;</span><br><span class="line">      <span class="built_in">console</span>.log(count.value);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count,</span><br><span class="line">      add,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count),</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">&quot;button&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;add&quot;</span></span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = h(Comp);</span><br><span class="line">render(vnode, <span class="built_in">document</span>.body);</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å°†ä¾‹å­ä¸­çš„ add å‡½æ•°ä¿®æ”¹æˆå¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  count.value++;</span><br><span class="line">  count.value++;</span><br><span class="line">  count.value++;</span><br><span class="line">  <span class="built_in">console</span>.log(count.value);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">&#x27;render&#x27;</span>);</span><br><span class="line">   <span class="keyword">return</span> [</span><br><span class="line">     h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count),</span><br><span class="line">     h(</span><br><span class="line">       <span class="string">&quot;button&quot;</span>,</span><br><span class="line">       &#123;</span><br><span class="line">         <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="string">&quot;add&quot;</span></span><br><span class="line">     ),</span><br><span class="line">   ];</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°å®ƒæ˜¯å¯ä»¥è¿è¡Œï¼Œä¸€æ¬¡åŠ  3ï¼Œä½†æ˜¯å³ä¾§æ§åˆ¶å°ä¸­ä¼šå‘ç°è¿™æ ·çš„æƒ…å†µ</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220613085131.png" alt=""></p><p>è¯´æ˜äº†æˆ‘ä»¬æ¯æ‰§è¡Œä¸€æ¬¡ add æ“ä½œï¼Œæ¸²æŸ“å‡½æ•°å°±æ‰§è¡Œäº†ä¸‰æ¬¡ã€‚å¾ˆæ˜æ˜¾è¿™æ ·æ˜¯ä¸å¯¹çš„ï¼Œæˆ‘ä»¬æœŸæœ›å®ƒæ¯æ¬¡æ‰§è¡Œ add å°±åªæ‰§è¡Œä¸€æ¬¡ï¼Œå›æƒ³ä¸€ä¸‹ä¹‹å‰ reactive ç¯‡ä¸­çš„ effect å’Œ computedï¼Œæˆ‘ä»¬ç”¨åˆ°äº† scheduler æœºåˆ¶å»å¸®åŠ©æˆ‘ä»¬åœ¨ trigger ä¸­ä¼˜å…ˆæ‰§è¡Œ schedulerï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åŒæ ·çš„æœºåˆ¶ï¼Œä¼˜å…ˆæ‰§è¡Œå®Œ add æ“ä½œå†æ‰§è¡Œ render</p><h1 id="ä½¿ç”¨è°ƒåº¦æœºåˆ¶"><a href="#ä½¿ç”¨è°ƒåº¦æœºåˆ¶" class="headerlink" title="ä½¿ç”¨è°ƒåº¦æœºåˆ¶"></a>ä½¿ç”¨è°ƒåº¦æœºåˆ¶</h1><p>åªéœ€è¦åœ¨ update é‡Œé¢åŠ ä¸€ä¸ª scheduler çš„é…ç½®é¡¹å³å¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">instance.update = effect(</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">scheduler</span>: queueJob,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h1 id="queueJob"><a href="#queueJob" class="headerlink" title="queueJob"></a>queueJob</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª queueJob å‡½æ•°ï¼Œå®ƒæ¥æ”¶ job ä½œä¸ºå‚æ•°ï¼Œå…¶å®è¿™ä¸ª job å°±æ˜¯æˆ‘ä»¬çš„ effectFnï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä»»åŠ¡æ ˆç”¨äºæ”¾ jobï¼Œå¹¶ä¸”è¿˜è¦å¯¹ job è¿›è¡Œå»é‡(ï¼Ÿ)ä¹‹åæ”¾å…¥é˜Ÿåˆ—è¿›è¡Œä»»åŠ¡çš„æ‰§è¡Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queue = [];</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueJob</span>(<span class="params">job</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!queue.length || !queue.includes(job)) &#123;</span><br><span class="line">    queue.push(job);</span><br><span class="line">    <span class="comment">// æ¸…ç©ºé˜Ÿåˆ—çš„æ“ä½œ</span></span><br><span class="line">    queueFlush();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="queueFlush"><a href="#queueFlush" class="headerlink" title="queueFlush"></a>queueFlush</h1><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯çœ‹ä»»åŠ¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œå¦‚æœæœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å°±ç­‰å¾…ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ job</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueFlush</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä»»åŠ¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œ ä¸åœ¨çš„è¯æ‰èƒ½è¿›å…¥promise ä¸”è¦ç­‰æ¯æ¬¡promiseæ‰§è¡Œå®Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> (!isFlushing) &#123;</span><br><span class="line">    isFlushing = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">Promise</span>.resolve().then(flushJobs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="flushJobs"><a href="#flushJobs" class="headerlink" title="flushJobs"></a>flushJobs</h1><p>æˆ‘ä»¬çš„ä»»åŠ¡æ‰§è¡Œå®Œæ‰æ¸…ç©ºé˜Ÿåˆ—è¿›è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡,ä¸”ç”±äº job æ˜¯ç”¨æˆ·ä»£ç å¯èƒ½ä¼šå‡ºé”™ï¼Œæ‰€ä»¥è¦ç”¨ try åŒ…è£¹èµ·æ¥ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushJobs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å› ä¸ºæ˜¯ç”¨æˆ·ä»£ç å¯èƒ½ä¼šå‡ºé”™</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ä¸èƒ½ç”¨len = queue.length å› ä¸ºå®ƒå¯èƒ½åœ¨æ‰§è¡Œçš„æ—¶å€™ç»§ç»­æ·»åŠ </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; queue.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> job = queue[i];</span><br><span class="line">      job();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isFlushing = <span class="literal">false</span>;</span><br><span class="line">    queue.length = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå®è·µä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œè¦ç›´æ¥è·å– dom çš„æ•°æ®è¿˜æ˜¯ä¸è¡Œæˆ–è€…è·å–ï¼Œè¿™é‡Œå°±éœ€è¦ settimeout æˆ–è€… vue çš„ nextTick</p><p>æ‰€ä»¥æˆ‘ä»¬è¦å®ç°ä¸€ä¸ª nextTick</p><h1 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a>nextTick</h1><p>å¯¹äº nextTick æœ‰ä¸¤ç§æƒ…å†µï¼Œ1 æ˜¯ä½¿ç”¨çš„æ—¶å€™è¿˜å­˜åœ¨æ­£åœ¨æ‰§è¡Œçš„ promiseï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰æ­£åœ¨æ‰§è¡Œçš„ promise æˆåŠŸçš„å›è°ƒï¼Œ2 æ˜¯å½“å‰çš„ä»»åŠ¡éƒ½å·²ç»æ‰§è¡Œå®Œäº†ï¼Œé‚£ä¹ˆå°±è¿”å›ä¸€ä¸ªæ–°çš„ promise æˆåŠŸæ‰§è¡Œçš„å›è°ƒã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»£è¡¨æ­£åœ¨æ‰§è¡Œçš„promise</span></span><br><span class="line"><span class="keyword">let</span> currentFlushPromise = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// å°è£…ä¸€ä¸‹Promise.resolve()</span></span><br><span class="line"><span class="keyword">const</span> resolvedPromise = <span class="built_in">Promise</span>.resolve();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">fn</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰åœ¨æ‰§è¡Œçš„promiseåˆ™è¿”å›å½“å‰åœ¨æ‰§è¡Œçš„promiseæˆåŠŸå›è°ƒçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªæ–°çš„promiseçš„æˆåŠŸå›è°ƒç»“æœ</span></span><br><span class="line">    <span class="keyword">const</span> p = currentFlushPromise || resolvedPromise;</span><br><span class="line">    <span class="keyword">return</span> p.then(fn);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueFlush</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œ ä¸åœ¨çš„è¯æ‰èƒ½è¿›å…¥promise ä¸”è¦ç­‰æ¯æ¬¡promiseæ‰§è¡Œå®Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (!isFlushing) &#123;</span><br><span class="line">        isFlushing = <span class="literal">true</span>;</span><br><span class="line">        currentFlushPromise = resolvedPromise.then(flushJobs)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¸…ç©ºé˜Ÿåˆ—äº†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushJobs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯ç”¨æˆ·ä»£ç å¯èƒ½ä¼šå‡ºé”™</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        isFlushing = <span class="literal">false</span>;</span><br><span class="line">        queue.length = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// æ³¨æ„æ¸…ç©ºcurrentFlushPromise</span></span><br><span class="line">        currentFlushPromise = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬è¿˜ä¼šç”¨åˆ° es6 çš„ await è¯­æ³•ï¼Œæ¯”å¦‚<code>await nextTick()</code>è¿™ä¸ªæ—¶å€™æ˜¯ä¸ä¼ å‚çš„ï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ç§å†™æ³•æˆ‘ä»¬ä¹Ÿè¦æ³¨æ„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = currentFlushPromise || resolvedPromise;</span><br><span class="line">  <span class="comment">// å¦‚æœfnå­˜åœ¨å°±p.thenå¦åˆ™å°±æŠŠpä¼ å›å»</span></span><br><span class="line">  <span class="keyword">return</span> fn ? p.then(fn) : p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬å·²ç»å†™å¥½äº†å®Œæ•´çš„ scheduler</p><h1 id="scheduler-å®Œæ•´ä»£ç "><a href="#scheduler-å®Œæ•´ä»£ç " class="headerlink" title="scheduler å®Œæ•´ä»£ç "></a>scheduler å®Œæ•´ä»£ç </h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queue = [];</span><br><span class="line"><span class="keyword">let</span> isFlushing = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> currentFlushPromise = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> resolvedPromise = <span class="built_in">Promise</span>.resolve();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰åœ¨æ‰§è¡Œçš„promiseåˆ™è¿”å›å½“å‰åœ¨æ‰§è¡Œçš„promiseæˆåŠŸå›è°ƒçš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªæ–°çš„promiseçš„æˆåŠŸå›è°ƒç»“æœ</span></span><br><span class="line">  <span class="keyword">const</span> p = currentFlushPromise || resolvedPromise;</span><br><span class="line">  <span class="keyword">return</span> fn ? p.then(fn) : p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;effectFn&#125;</span> <span class="variable">job</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;*&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueJob</span>(<span class="params">job</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!queue.length || !queue.includes(job)) &#123;</span><br><span class="line">    queue.push(job);</span><br><span class="line">    <span class="comment">// æ¸…ç©ºé˜Ÿåˆ—çš„æ“ä½œ</span></span><br><span class="line">    queueFlush();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueFlush</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ä»»åŠ¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œ ä¸åœ¨çš„è¯æ‰èƒ½è¿›å…¥promise ä¸”è¦ç­‰æ¯æ¬¡promiseæ‰§è¡Œå®Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> (!isFlushing) &#123;</span><br><span class="line">    isFlushing = <span class="literal">true</span>;</span><br><span class="line">    currentFlushPromise = resolvedPromise.then(flushJobs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¸…ç©ºé˜Ÿåˆ—äº†</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushJobs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å› ä¸ºæ˜¯ç”¨æˆ·ä»£ç å¯èƒ½ä¼šå‡ºé”™</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ä¸èƒ½ç”¨len = queue.length å› ä¸ºå®ƒå¯èƒ½åœ¨æ‰§è¡Œçš„æ—¶å€™ç»§ç»­æ·»åŠ </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; queue.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> job = queue[i];</span><br><span class="line">      job();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isFlushing = <span class="literal">false</span>;</span><br><span class="line">    queue.length = <span class="number">0</span>;</span><br><span class="line">    currentFlushPromise = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="createApp"><a href="#createApp" class="headerlink" title="createApp"></a>createApp</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†™ minivue çš„ createAppï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ createApp åŒ…è£¹ä½ä¸€ä¸ªç»„ä»¶ï¼Œç„¶å<code>.mount(document.body)</code>è¿™æ ·å†™ï¼Œä¸éœ€è¦ render å’Œ h å‡½æ•°ç”Ÿæˆ vnode</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Author: Zlinni 984328216@qq.com</span></span><br><span class="line"><span class="comment"> * @Date: 2022-05-22 19:49:21</span></span><br><span class="line"><span class="comment"> * @LastEditors: Zlinni 984328216@qq.com</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2022-06-13 19:24:24</span></span><br><span class="line"><span class="comment"> * @FilePath: \mini-vue\zMini-vue\src\index.js</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2022 by Zlinni 984328216@qq.com, All Rights Reserved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123; render, h, createApp &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive/ref&quot;</span>;</span><br><span class="line">createApp(&#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = ref(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      count.value++;</span><br><span class="line">      count.value++;</span><br><span class="line">      count.value++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count,</span><br><span class="line">      add,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;render&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count.value),</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">&quot;button&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;add&quot;</span></span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).mount(<span class="built_in">document</span>.body);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>createApp.js</code>ï¼Œè¿™ä¸ª createApp æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯ç»„ä»¶ï¼Œè¿”å›ä¸€ä¸ªç»„ä»¶å®ä¾‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†ä»–ç”¨ mount æŒ‚è½½èµ·æ¥ï¼Œå…¶ä¸­å¯¹äº mount æ¥è¯´ï¼Œå¯ä»¥æ¥å—ä¸€ä¸ª dom ä¹Ÿå¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨åˆ›å»º vue å®ä¾‹çš„æ—¶å€™ç»å¸¸ä¼šå†™çš„<code>mount(#app)</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isString &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">&quot;./render&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;ç»„ä»¶&#125;</span> <span class="variable">rootComponent</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;ç»„ä»¶çš„å®ä¾‹&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = &#123;</span><br><span class="line">    <span class="function"><span class="title">mount</span>(<span class="params">rootContainer</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœå®ƒæ˜¯å­—ç¬¦ä¸²å°±æŠŠä»–è½¬æ¢æˆDOMå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">if</span> (isString(rootContainer)) &#123;</span><br><span class="line">        rootContainer = <span class="built_in">document</span>.querySelector(rootContainer);</span><br><span class="line">      &#125;</span><br><span class="line">      render(h(rootComponent), rootContainer);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®ç°äº†è¿™ä¸ª createAppï¼Œä½†æ˜¯ vue ä¸ºä»€ä¹ˆè¦å•ç‹¬å†™ä¸€ä¸ª createApp å‘¢ã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸ºäº†åé¢æ›´å¥½çš„æ‹“å±• Vue ä¸‹é¢çš„å…¶ä»–æ–¹æ³•ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”¨è¿‡çš„ <code>use()</code>,<code>mixin()</code>ç­‰æ–¹æ³•</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬èŠ‚ä¸­æˆ‘ä»¬å­¦ä¹ äº† vue çš„ scheduler è°ƒåº¦æœºåˆ¶ï¼Œä»ä¹‹å‰ effect å’Œ computed çš„æ¡ˆä¾‹å¼€å§‹è¯´èµ·ï¼Œæ²¿ç”¨ scheduler çš„ä¼˜å…ˆæ‰§è¡Œæœºåˆ¶(å¼‚æ­¥ä»»åŠ¡)æ¥å¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–ç»„ä»¶çš„æ›´æ–°è¿‡ç¨‹ï¼Œå…¶ä¸­å¯¹äºä»»åŠ¡é˜Ÿåˆ—(queueJob)ï¼Œæˆ‘ä»¬åªåœ¨é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…ä¸å­˜åœ¨ç›¸åŒçš„ä»»åŠ¡çš„æ—¶å€™æ‰å°†ä»»åŠ¡æ”¾è¿›ä»»åŠ¡æ ˆï¼Œç„¶åå»æ‰§è¡Œä»»åŠ¡(queueFlush),è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬è¦æŠŠå½“å‰æ‰§è¡Œçš„ä»»åŠ¡ä¿å­˜èµ·æ¥ï¼Œåˆ°çœŸæ­£æ‰§è¡Œç¯èŠ‚(flushJobs)çš„æ—¶å€™ï¼Œå› ä¸ºè¿™äº›ä»»åŠ¡æ˜¯ç”¨æˆ·ä»£ç éœ€è¦åŒ…è£¹èµ·æ¥ï¼Œç„¶åå°†å®ƒä»¬é€ä¸ªä»ä»»åŠ¡æ ˆä¸­å–å‡ºæ¥æ‰§è¡Œã€‚æ‰§è¡Œç»“æŸä¹‹åæ”¹å˜æ ‡å¿—ä½å¹¶æ¸…ç©ºå½“å‰æ‰§è¡Œä»»åŠ¡çš„æ ‡å¿—ã€‚</p><p>æˆ‘ä»¬è¿˜å­¦åˆ°äº†nextTickï¼Œå…¶å®nextTickå°±å’Œæˆ‘ä»¬çš„è°ƒåº¦æœºåˆ¶æ¯æ¯ç›¸å…³ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†schedulerä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå°±å°†nextTickçš„äº‹ä»¶æ”¾åˆ°å®ƒçš„æˆåŠŸå›è°ƒåï¼Œå½“ç„¶è¿˜è¦è€ƒè™‘ä¸€ç§æƒ…å†µå¦‚æœä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œå°±å°†äº‹ä»¶æ”¾åœ¨æ–°çš„promiseçš„æˆåŠŸå›è°ƒä¸­ã€‚ä¸è¿‡æœ€åæˆ‘ä»¬è¿˜è€ƒè™‘åˆ°äº†es6çš„awaitä½¿ç”¨nextTickçš„æƒ…å†µï¼Œæˆ‘ä»¬å°±æŠŠnextTickçš„è¿”å›å€¼ç¨ä½œä¿®æ”¹ï¼Œå½“æœ‰fnä¼ è¿›æ¥å°±è¿”å›ä»»åŠ¡çš„æˆåŠŸå›è°ƒï¼Œå¦åˆ™å°±è¿”å›æ•´ä¸ªä»»åŠ¡promiseã€‚</p><p>ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ vueçš„æ¨¡æ¿ç¼–è¯‘ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘¥--Componentç¯‡</title>
    <link href="https://zlinni.github.io/posts/1033180007/"/>
    <id>https://zlinni.github.io/posts/1033180007/</id>
    <published>2022-06-12T02:21:17.000Z</published>
    <updated>2022-06-13T13:48:55.261Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯ Component ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­ç»„ä»¶çš„æ·±å…¥è®¨è®ºã€‚</p></div><h1 id="ç»„ä»¶æ˜¯ä»€ä¹ˆ"><a href="#ç»„ä»¶æ˜¯ä»€ä¹ˆ" class="headerlink" title="ç»„ä»¶æ˜¯ä»€ä¹ˆ"></a>ç»„ä»¶æ˜¯ä»€ä¹ˆ</h1><div class="note primary flat"><p>ä»å¼€å‘è€…çš„è§†è§’æ¥çœ‹ï¼Œç»„ä»¶åˆ†ä¸ºçŠ¶æ€ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ï¼Œvue å…¶å®ä¹Ÿæœ‰å‡½æ•°å¼ç»„ä»¶ï¼Œä½†å®ƒå’ŒçŠ¶æ€ç»„ä»¶ï¼Œä»å®ç°ä¸Šæ¥è®²å‡ ä¹æ²¡æœ‰å¤šå¤§åŒºåˆ«ï¼Œå› æ­¤æˆ‘ä»¬åªè€ƒè™‘çŠ¶æ€ç»„ä»¶ï¼Œä»¥ä¸‹æ‰€è®²çš„ç»„ä»¶éƒ½æ˜¯çŠ¶æ€ç»„ä»¶</p></div><p>React çš„ç»„ä»¶ç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="built_in">this</span>.state.count + <span class="number">1</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; count &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.add&#125;</span>&gt;</span>add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Vue3 çš„ç»„ä»¶ç¤ºä¾‹ï¼ˆoptionalï¼‰ï¼ˆæ¸²æŸ“å‡½æ•°ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">createApp(&#123;</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">add</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.count++;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count),</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">&quot;button&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;add&quot;</span></span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).mount(<span class="string">&quot;#app&quot;</span>);</span><br></pre></td></tr></table></figure><p>Vue3 çš„ç»„ä»¶ç¤ºä¾‹ï¼ˆcompositionï¼‰ï¼ˆæ¸²æŸ“å‡½æ•°ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">createApp(&#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = ref(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> add = <span class="function">() =&gt;</span> count.value++;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count,</span><br><span class="line">      add,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count),</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">&quot;button&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;add&quot;</span></span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).mount(<span class="string">&quot;#app&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä»å®ç°æ¥çœ‹éƒ½æœ‰å…±åŒç‚¹ï¼š</p><ol><li>éƒ½æœ‰ instance å®ä¾‹ï¼Œä»¥æ‰¿è½½å†…éƒ¨çš„çŠ¶æ€ï¼Œæ–¹æ³•ç­‰</li><li>éƒ½æœ‰ä¸€ä¸ª render å‡½æ•°</li><li>éƒ½é€šè¿‡ render äº§å‡º vnode</li><li>éƒ½æœ‰ä¸€å¥—æ›´æ–°ç­–ç•¥ï¼Œä»¥é‡æ–°æ‰§è¡Œ render å‡½æ•°</li><li>åœ¨æ­¤åŸºç¡€ä¸Šé™„åŠ å„ç§èƒ½åŠ›ï¼Œå¦‚ç”Ÿå‘½å‘¨æœŸï¼Œé€šä¿¡æœºåˆ¶ï¼Œslotï¼Œprovideï¼Œinject ç­‰ç­‰</li></ol><p>ä¸è¿‡æˆ‘ä»¬ä¸æ‰“ç®—å®ç° optional API çš„å†™æ³•ï¼Œåªå®ç° composition APIã€‚ä¹Ÿä¸æ‰“ç®—å®ç° slotï¼Œprovideï¼Œinject ç­‰ç­‰</p><p>æ‰€ä»¥æ ¹æ®æ­¤åŸºç¡€æˆ‘ä»¬å…ˆæ¥æ”¹é€ ä¸€å¼€å§‹æ²¡ç”¨åšå®Œçš„ processComponent</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processComponent</span>(<span class="params">prevVNode, vnode, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// TODO processComponent</span></span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    <span class="comment">// TODO updateComponent</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountComponent(vnode, container, anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°† mountComponent æ”¾åœ¨<code>component.js</code>ä¸­å¹¶å¼•å…¥ã€‚</p><p>ä¸è¿‡åœ¨ç¼–å†™ mountComponent ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><h1 id="prop-å’Œ-attr"><a href="#prop-å’Œ-attr" class="headerlink" title="prop å’Œ attr"></a>prop å’Œ attr</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Comp = &#123;</span><br><span class="line">  <span class="attr">props</span>: [<span class="string">&quot;foo&quot;</span>],</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;a&quot;</span>, <span class="attr">id</span>: ctx.bar &#125;, ctx.foo);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnodeProps = &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = h(Comp, vnodeProps);</span><br><span class="line">render(vnode, root); <span class="comment">// æ¸²æŸ“ä¸º&lt;div class=&quot;a&quot; bar=&quot;bar&quot;&gt;foo&lt;/div&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­åª prop äº†ä¸€ä¸ª fooï¼Œæ²¡æœ‰æ¥æ”¶ barã€‚æ‰€ä»¥å¯¹åº”ä¹Ÿæ¸²æŸ“äº† foo å‡ºæ¥ï¼Œæ²¡æœ‰æ¸²æŸ“ id ä¸º barã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆåˆæœ‰ä¸€ä¸ª <code>bar=&quot;bar&quot;</code>å±æ€§å‘¢ï¼Ÿè¿™ä¸ªæ˜¯å› ä¸º vue3 ä¼šé»˜è®¤çš„å°†æ²¡æœ‰ prop è¿›æ¥çš„å‚æ•°è‡ªåŠ¨ä½œä¸º attribute æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸Šã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„å®ä¾‹è¦æœ‰ props å’Œ attrs ä¸¤ä¸ªå‚æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params">vnode, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">type</span>: Component &#125; = vnode;</span><br><span class="line">  <span class="comment">// ä¸€ä¸ªç»„ä»¶å¿…ç„¶æœ‰ä¸€ä¸ªå®ä¾‹</span></span><br><span class="line">  <span class="keyword">const</span> instance = &#123;</span><br><span class="line">    <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–props</span></span><br><span class="line">  initProps(instance, vnode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="initProps"><a href="#initProps" class="headerlink" title="initProps"></a>initProps</h2><p>è¿™ä¸€æ­¥æ“ä½œä¸»è¦æ˜¯ä¸ºäº†åˆ†ç¦» props å’Œ attrsï¼Œsetup çš„ props ä¸­å­˜åœ¨çš„å°±åˆ†é…ç»™ propsï¼Œä¸å­˜åœ¨çš„å°±åˆ†é…ç»™ attrsã€‚ç„¶åå†æŠŠ props å˜æˆå“åº”å¼æ”¾å‡ºå»ä½¿ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initProps</span>(<span class="params">instance, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æˆ‘ä»¬çŸ¥é“typeåœ¨vnodeé‡Œé¢</span></span><br><span class="line">  <span class="comment">// èµ·åˆ«åå…å¾—å‘½åå†²çª æ­¤æ—¶è¿™ä¸¤ä¸ªå°±å¯¹åº”äº†ä¾‹å­ä¸­çš„Compå’ŒvnodeProps</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">type</span>: Component, <span class="attr">props</span>: vnodeProps &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> props = (instance.props = &#123;&#125;);</span><br><span class="line">  <span class="keyword">const</span> attrs = (instance.attrs = &#123;&#125;);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> vnodeProps) &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºpropæœ‰å¾ˆå¤šç§ç±»å‹ï¼Œæˆ‘ä»¬æŠŠå®ƒå½“ä½œåªèƒ½æ¥æ”¶æ•°ç»„ç±»å‹æ¥ç®€å•å¤„ç†</span></span><br><span class="line">    <span class="comment">// åˆå› ä¸ºè¿™ä¸ªpropsä¸ä¸€å®šå£°æ˜ï¼Œæ‰€ä»¥ç”¨å¯é€‰é“¾</span></span><br><span class="line">    <span class="keyword">if</span> (Component.props?.includes(key)) &#123;</span><br><span class="line">      props[key] = vnodeProps[key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      attrs[key] = vnodeProps[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å› ä¸ºpropsçš„æ•°æ®ä¹Ÿæ˜¯å“åº”å¼çš„ï¼Œä½†æ˜¯å®ƒä¸èƒ½è¢«ä¿®æ”¹ï¼Œè¿™é‡Œå°±å…ˆç”¨reactiveæ¥ç®€å•æ›¿ä»£</span></span><br><span class="line">  instance.props = reactive(instance.props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><p>å†æ¬¡å›åˆ° mountComponent,æˆ‘ä»¬æ¥ä¸‹æ¥è¦å»å‡ºå‘ setup å°†æˆ‘ä»¬çš„ props å’Œ attrs ä¼ è¿›å»ã€‚æ ¹æ® vue3 å®˜ç½‘æˆ‘ä»¬çŸ¥é“ setup æ¥æ”¶ä¸¤ä¸ªå‚æ•°<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612151936.png" alt=""></p><p>å…¶ä¸­ props æˆ‘ä»¬å·²ç»å†™äº†ï¼Œcontext æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ç€ attrsï¼Œslotï¼Œemitï¼Œæˆ‘ä»¬åªç®€å•å®ç° attrsï¼Œæ‰€ä»¥ä¹Ÿå°±å°† attrs ä¼ è¿›å»å³å¯ã€‚å¦å¤–ç”±äº setup æœ€ç»ˆä¼šæŠŠå“åº”å¼æ•°æ® return å‡ºå»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¿å­˜ä¸‹è¿™ä¸ªç»“æœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">type</span>: Component &#125; = vnode;</span><br><span class="line"><span class="comment">// ä¸€ä¸ªç»„ä»¶å¿…ç„¶æœ‰ä¸€ä¸ªå®ä¾‹</span></span><br><span class="line"><span class="keyword">const</span> instance = &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†ç»“æœä¿å­˜èµ·æ¥</span></span><br><span class="line">  <span class="attr">setupState</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–props</span></span><br><span class="line">initProps(instance, vnode);</span><br><span class="line"><span class="comment">// å› ä¸ºsetupä¹Ÿå¯èƒ½ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å¯é€‰é“¾</span></span><br><span class="line">instance.setupState = Component.setup?.(instance.props, &#123;</span><br><span class="line">  <span class="attr">attrs</span>: instance.attrs,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­æ‰§è¡Œ mountComponent å‡½æ•°</p><h2 id="ctx"><a href="#ctx" class="headerlink" title="ctx"></a>ctx</h2><p>render æ¥æ”¶ä¸€ä¸ª ctxï¼Œé€šè¿‡è§‚å¯Ÿå‘ç° ctx åŒ…å«äº† props æˆ–è€… setupState</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†ç»“æœä¿å­˜èµ·æ¥</span></span><br><span class="line">  <span class="attr">setupState</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// è§‚æµ‹å®ä¾‹å‘ç°ctxå¯ä»¥å–åˆ°setupStateå’Œprops</span></span><br><span class="line">  <span class="attr">ctx</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æ³¨æ„vueæºç é‡Œé¢æ˜¯é‡‡ç”¨ä»£ç†ä»propsé‡Œé¢æ‰¾ï¼Œæ‰¾ä¸åˆ°å†æ‰¾setupStateï¼Œè¿™é‡Œå·æ‡’ç›´æ¥åˆå¹¶</span></span><br><span class="line">instance.ctx = &#123;</span><br><span class="line">  ...instance.props,</span><br><span class="line">  ...instance.setupState,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å°è£…-mount"><a href="#å°è£…-mount" class="headerlink" title="å°è£… mount"></a>å°è£… mount</h2><p>ç„¶åæˆ‘ä»¬å°†æ‰§è¡Œ render å‡½æ•°çš„æ“ä½œå°è£…æˆä¸€ä¸ªæ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å°†æ‰§è¡Œrenderçš„æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">  <span class="attr">mount</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è¿™é‡Œå°±ä¸ç”¨å¯é€‰é“¾äº†,å› ä¸ºrenderå¯¹äºç»„ä»¶æ¥è¯´å¿…é¡»å­˜åœ¨çš„</span></span><br><span class="line">instance.mount = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">  Component.render(instance.ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="normalizeVNode"><a href="#normalizeVNode" class="headerlink" title="normalizeVNode"></a>normalizeVNode</h3><p>ä¸è¿‡æˆ‘ä»¬è¿˜è¦å¯¹ mount è¿”å›çš„ç»“æœè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†</p><p>å¦‚æœå®ƒåªæ˜¯ä¸€ä¸ª h å‡½æ•°å¥½è¯´,ä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„çš„æƒ…å†µ,å°±ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ vnode,è€Œä¸”æˆ‘ä»¬å¦‚æœæƒ³å¯¹åªè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç­‰æ“ä½œåšå¤„ç†,é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªè¾…åŠ©å‡½æ•° normalizeVNode,æˆ‘ä»¬å°†ä»–æ”¾åˆ°<code>vnode.js</code>é‡Œé¢åšå¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">normalizeVNode</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ä¸ªæ•°ç»„æˆ‘ä»¬å°±ç”¨FragmentæŠŠä»–åŒ…è£…ä¸€ä¸‹</span></span><br><span class="line">  <span class="keyword">if</span> (isArray(result)) &#123;</span><br><span class="line">    <span class="keyword">return</span> h(Fragment, <span class="literal">null</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isObject(result)) &#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// string||number</span></span><br><span class="line">  <span class="keyword">return</span> h(Text, <span class="literal">null</span>, result.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡å›åˆ° mountComponent</p><p>æˆ‘ä»¬å°†ç»„ä»¶äº§ç‰©çš„ vnode å‘½åä¸º subTree</p><h3 id="subTree"><a href="#subTree" class="headerlink" title="subTree"></a>subTree</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">instance.mount = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> subTree = normalizeVNode(Component.render(instance.ctx));</span><br><span class="line">  <span class="comment">// ç›´æ¥patch ä½†æ˜¯æ³¨æ„è¿™é‡Œçš„å¼•å…¥æ–¹å¼,å¯ä»¥ç›´æ¥ä¼ å…¥ä¹Ÿå¯ä»¥å¯¼å‡ºç„¶åä½¿ç”¨</span></span><br><span class="line">  patch(<span class="literal">null</span>, subTree, container, anchor);</span><br><span class="line">&#125;;</span><br><span class="line">instance.mount();</span><br></pre></td></tr></table></figure><h1 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹ 1"></a>æ¡ˆä¾‹ 1</h1><p>ä¹‹åæˆ‘ä»¬è·‘ä¸€ä¸‹è¿™æ®µä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, h &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> Comp = &#123;</span><br><span class="line">  <span class="attr">props</span>: [<span class="string">&quot;foo&quot;</span>],</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;a&quot;</span>, <span class="attr">id</span>: ctx.bar &#125;, ctx.foo);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnodeProps = &#123;</span><br><span class="line">  <span class="attr">foo</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">  <span class="attr">bar</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = h(Comp, vnodeProps);</span><br><span class="line">render(vnode, <span class="built_in">document</span>.body); <span class="comment">// æ¸²æŸ“ä¸º&lt;div class=&quot;a&quot; bar=&quot;bar&quot;&gt;foo&lt;/div&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡è·‘çš„æ—¶å€™ä¼šå‘ç°å®ƒå°‘äº†ä¸€ä¸ª bar å±æ€§ï¼Œå‰é¢ä¹Ÿæåˆ°äº† vue3 ä¼šé»˜è®¤çš„å°†æ²¡æœ‰ prop è¿›æ¥çš„å‚æ•°è‡ªåŠ¨ä½œä¸º attribute æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ä¸Šã€‚æ‰€ä»¥è¿™ä¸ª bar æ˜¯ä¸€å®šå­˜åœ¨çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆè·‘äº†è¿™æ®µä»£ç ä»–æ²¡å‡ºç°ï¼ŒåŸå› æ˜¯æˆ‘ä»¬æ²¡æœ‰å¤„ç† attr çš„ç»§æ‰¿</p><h2 id="fallThrough"><a href="#fallThrough" class="headerlink" title="fallThrough"></a>fallThrough</h2><p>è¿™ä¸ªæ–¹æ³•ç”¨äºå¤„ç† attr çš„ç»§æ‰¿ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¿™ä¸ª props æœ€åæ˜¯ä¼šåœ¨ patchDomProp ä¸­è¿›è¡Œå¤„ç†çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦æŠŠ bar ä¼ è¿‡å»çš„æ–¹æ³•å°±æ˜¯å°†ä»–å’Œæˆ‘ä»¬ç°åœ¨çš„ props åˆå¹¶(è™½ç„¶ vue3 ä¸æ˜¯è¿™æ ·åšçš„ï¼Œä»ç®€å§)</p><p>å…·ä½“åšæ³•æ˜¯å¦‚æœå­˜åœ¨ attr å±æ€§ï¼Œå°±å°†ç»„ä»¶çš„èŠ‚ç‚¹æ‰€åœ¨çš„ props å’Œ instance çš„ attrs åˆå¹¶.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fallThrough</span>(<span class="params">instance, subTree</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.keys(instance.attrs).length) &#123;</span><br><span class="line">    subTree.props = &#123;</span><br><span class="line">      ...subTree.props,</span><br><span class="line">      ...instance.attrs,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612163006.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°æœ€åç»“æœå’Œæˆ‘ä»¬é¢„æƒ³çš„ä¸€è‡´</p><h1 id="æ¡ˆä¾‹-2"><a href="#æ¡ˆä¾‹-2" class="headerlink" title="æ¡ˆä¾‹ 2"></a>æ¡ˆä¾‹ 2</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, h &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;./reactiveDemo/ref&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> Comp = &#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> count = ref(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      count.value++;</span><br><span class="line">      <span class="built_in">console</span>.log(count.value);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count,</span><br><span class="line">      add,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      h(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, ctx.count),</span><br><span class="line">      h(</span><br><span class="line">        <span class="string">&quot;button&quot;</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">onClick</span>: ctx.add,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;add&quot;</span></span><br><span class="line">      ),</span><br><span class="line">    ];</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = h(Comp);</span><br><span class="line">render(vnode, <span class="built_in">document</span>.body);</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612164141.png" alt=""></p><p>åœ¨æ¡ˆä¾‹äºŒä¸­æˆ‘ä»¬å‘ç°è·‘å‡ºæ¥çš„ç»“æœå¹¶æ²¡æœ‰ countï¼Œè¿™ä¸ªæ˜¯å› ä¸ºçœŸæ­£çš„ vue é‡Œé¢å¤„ç†æ‰äº†è¿™ä¸ª value å€¼ï¼Œä¸éœ€è¦ value å€¼å°±å¯ä»¥è®¿é—®åŸºç¡€ç±»å‹å“åº”å¼æ•°æ®ï¼Œè€Œæˆ‘ä»¬å›¾æ–¹ä¾¿å°±ä¸è¿™æ ·åšäº†ï¼Œé€‰æ‹©ç›´æ¥æ”¹ä¸º<code>h(&quot;div&quot;, null, ctx.count.value)</code>é‡æ–°è·‘</p><p>æˆ‘ä»¬å‘ç° dom å·²ç»æ¸²æŸ“å‡ºæ¥äº†</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612164130.png" alt=""></p><p>ä½†æ˜¯ä¸è®ºæˆ‘ä»¬å¦‚ä½•ç‚¹å‡»éƒ½æ²¡æœ‰æ”¹å˜å€¼ï¼Œç°åœ¨æˆ‘ä»¬è¾“å‡ºä¸€ä¸‹ count å€¼è¯•ä¸€è¯•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  count.value++;</span><br><span class="line">  <span class="built_in">console</span>.log(count.value);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612164409.png" alt=""></p><p>æˆ‘ä»¬å‘ç°ç»“æœå·²ç»åŠ äº† ä½†æ˜¯ dom å¹¶æ²¡æœ‰æ›´æ–°ï¼ŒåŸå› å¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬åª mount äº†ä¸€æ¬¡ï¼Œæ²¡æœ‰å†™ update æ“ä½œ</p><h1 id="update"><a href="#update" class="headerlink" title="update"></a>update</h1><p>æ—¢ç„¶æ˜¯æ›´æ–°ï¼Œå°±éœ€è¦æ‹¿åˆ°ä¸Šä¸€æ¬¡çš„ç»“æœè¿›è¡Œ patchï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°† subTree å­˜èµ·æ¥ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">instance.update = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = instance.subTree;</span><br><span class="line">  <span class="keyword">const</span> subTree = (instance.subTree = normalizeVNode(</span><br><span class="line">    Component.render(instance.ctx)</span><br><span class="line">  ));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.keys(instance.attrs).length) &#123;</span><br><span class="line">    subTree.props = &#123;</span><br><span class="line">      ...subTree.props,</span><br><span class="line">      ...instance.attrs,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// éœ€è¦ä¸Šä¸€æ¬¡çš„subTreeæ¥æ›´æ–°ï¼Œæ‰€ä»¥è¦æŠŠsubTreeä¿å­˜èµ·æ¥ã€‚</span></span><br><span class="line">  patch(prev, subTree, container, anchor);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ€ä¹ˆè§¦å‘æ›´æ–°ã€‚</p><p>åœ¨æˆ‘ä»¬ä¹‹å‰çš„å“åº”å¼å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å“åº”å¼æ˜¯ç”± reactive å»ºç«‹ï¼Œç”± effect è§¦å‘çš„ï¼Œåªè¦æ”¹å˜äº†å“åº”å¼æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ proxy é‡Œé¢è§¦å‘ trigger æ–¹æ³•ï¼Œå¯¹ä¾èµ–è¿›è¡ŒæŸ¥æ‰¾å¹¶æ‰§è¡Œç›¸åº”çš„ effectã€‚</p><p>é‚£ä¹ˆå¯¹äºè¿™ä¸ª update å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ç”¨ effect æŠŠ update åŒ…è£¹èµ·æ¥å³å¯å®ç°æ›´æ–°ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">instance.update = effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = instance.subTree;</span><br><span class="line">  <span class="keyword">const</span> subTree = (instance.subTree = normalizeVNode(</span><br><span class="line">    Component.render(instance.ctx)</span><br><span class="line">  ));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.keys(instance.attrs).length) &#123;</span><br><span class="line">    subTree.props = &#123;</span><br><span class="line">      ...subTree.props,</span><br><span class="line">      ...instance.attrs,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// éœ€è¦ä¸Šä¸€æ¬¡çš„subTreeæ¥æ›´æ–°ï¼Œæ‰€ä»¥è¦æŠŠsubTreeä¿å­˜èµ·æ¥ã€‚</span></span><br><span class="line">  patch(prev, subTree, container, anchor);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="åˆå¹¶-mount-å’Œ-update"><a href="#åˆå¹¶-mount-å’Œ-update" class="headerlink" title="åˆå¹¶ mount å’Œ update"></a>åˆå¹¶ mount å’Œ update</h2><p>è¿™é‡Œåˆä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨å†™ effect çš„æ—¶å€™é»˜è®¤æ˜¯ç»™ä»–æ‰§è¡Œä¸€æ¬¡çš„ï¼Œé™¤äº†é…ç½®é¡¹ lazy ä¹‹å¤–ï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°† mount å’Œ update åˆå¹¶</p><p>ä¸ºäº†åŒºåˆ†å®ƒæ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡ mountï¼Œéœ€è¦ä¸€ä¸ªå˜é‡ isMounted</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†ç»“æœä¿å­˜èµ·æ¥</span></span><br><span class="line">  <span class="attr">setupState</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// è§‚æµ‹å®ä¾‹å‘ç°ctxå¯ä»¥å–åˆ°setupStateå’Œprops</span></span><br><span class="line">  <span class="attr">ctx</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†æ‰§è¡Œrenderçš„æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">  <span class="attr">update</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">subTree</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">isMounted</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line">instance.update = effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">    <span class="keyword">const</span> subTree = (instance.subTree = normalizeVNode(</span><br><span class="line">      Component.render(instance.ctx)</span><br><span class="line">    ));</span><br><span class="line">    <span class="comment">// æ­¤å¤„çš„fallThroughå°±æ˜¯ä¹‹å‰çš„éå†</span></span><br><span class="line">    fallThrough(instance, subTree);</span><br><span class="line">    <span class="comment">// ç›´æ¥patch ä½†æ˜¯æ³¨æ„è¿™é‡Œçš„å¼•å…¥æ–¹å¼</span></span><br><span class="line">    patch(<span class="literal">null</span>, subTree, container, anchor);</span><br><span class="line">    vnode.el = subTree.el;</span><br><span class="line">    instance.isMounted = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prev = instance.subTree;</span><br><span class="line">    <span class="keyword">const</span> subTree = (instance.subTree = normalizeVNode(</span><br><span class="line">      Component.render(instance.ctx)</span><br><span class="line">    ));</span><br><span class="line">    fallThrough(instance, subTree);</span><br><span class="line">    <span class="comment">// éœ€è¦ä¸Šä¸€æ¬¡çš„subTreeæ¥æ›´æ–°ï¼Œæ‰€ä»¥è¦æŠŠsubTreeä¿å­˜èµ·æ¥ã€‚</span></span><br><span class="line">    patch(prev, subTree, container, anchor);</span><br><span class="line">    vnode.el = subTree.el;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å°±å®Œæˆäº†ç»„ä»¶çš„ä¸»åŠ¨æ›´æ–°</p><h1 id="è¢«åŠ¨æ›´æ–°"><a href="#è¢«åŠ¨æ›´æ–°" class="headerlink" title="è¢«åŠ¨æ›´æ–°"></a>è¢«åŠ¨æ›´æ–°</h1><p>è§ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Child = &#123;</span><br><span class="line">  <span class="attr">props</span>: [<span class="string">&quot;foo&quot;</span>],</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;a&quot;</span>, <span class="attr">id</span>: ctx.bar &#125;, ctx.foo);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Parent = &#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> vnodeProps = reactive(&#123;</span><br><span class="line">      <span class="attr">foo</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">      <span class="attr">bar</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123; vnodeProps &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(Child, ctx.vnodeProps);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">render(h(Parent), root);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œçˆ¶ç»„ä»¶å‘ç”Ÿäº†ä¸€æ¬¡æ›´æ–°ï¼Œæ˜¯ä¸»åŠ¨æ›´æ–°ï¼Œä½†æ˜¯çˆ¶ç»„ä»¶çš„æ¸²æŸ“çš„æ—¶å€™ï¼Œè¿™ä¸ª child æ˜¯å·²ç»å­˜åœ¨çš„ç»„ä»¶ï¼Œå¦‚æœå­ç»„ä»¶å¯¹åº”çš„ props ä¹Ÿå‘ç”Ÿå˜åŒ–äº†ï¼Œå°±ä¼šè§¦å‘ updateComponentã€‚å¯¼è‡´äº†å­ç»„ä»¶çš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¢«åŠ¨æ›´æ–°ã€‚</p><h1 id="updateComponent"><a href="#updateComponent" class="headerlink" title="updateComponent"></a>updateComponent</h1><p>å…ˆä¸è€ƒè™‘å­ç»„ä»¶çš„ props å‘ç”Ÿå˜åŒ–çš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥å¤„ç†è¿™ä¸ª updateComponent</p><p>å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ prevVNode ä¸€ä¸ªæ˜¯ vnodeï¼Œç”±äºæ˜¯æ›´æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°½å¯èƒ½è€ƒè™‘èƒ½å¤ç”¨åŸå…ˆå®ä¾‹ instance ä¸­çš„ update æ–¹æ³•ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ä¾‹ instance æŒ‚è½½åˆ° vnode ä¸Šé¢ï¼Œ</p><h2 id="æŒ‚è½½å®ä¾‹åˆ°-vnode"><a href="#æŒ‚è½½å®ä¾‹åˆ°-vnode" class="headerlink" title="æŒ‚è½½å®ä¾‹åˆ° vnode"></a>æŒ‚è½½å®ä¾‹åˆ° vnode</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children,</span><br><span class="line">  shapeFlag,</span><br><span class="line">  <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">anchor</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">key</span>: props &amp;&amp; props.key,</span><br><span class="line">  <span class="attr">component</span>: <span class="literal">null</span>, <span class="comment">//ä¸“é—¨ç”¨äºå­˜å‚¨ç»„ä»¶çš„å®ä¾‹</span></span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">const</span> instance = (vnode.component = &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">setupState</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">ctx</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">update</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">subTree</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">isMounted</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// å›åˆ°updateComponent</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateComponent</span>(<span class="params">prevVNode,vnode</span>)</span>&#123;</span><br><span class="line">  vnode.component = prevVNode.component;</span><br><span class="line">  vnode.component.update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="next-ä¼ é€’èŠ‚ç‚¹"><a href="#next-ä¼ é€’èŠ‚ç‚¹" class="headerlink" title="next ä¼ é€’èŠ‚ç‚¹"></a>next ä¼ é€’èŠ‚ç‚¹</h2><p>è¿™å°±åˆ°äº†å®ä¾‹çš„ instance é‡Œé¢ï¼Œä½†æ­¤æ—¶æ‰§è¡Œçš„è¿˜æ˜¯åŸå…ˆçš„ prevVNodeï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ é€’ vnode æ–°èŠ‚ç‚¹è¿‡å»</p><p>è¿™é‡Œå°±å†ç»™å®ä¾‹æ·»åŠ ä¸€ä¸ªå±æ€§ next åˆå§‹å€¼è®¾ç½®ä¸º nullï¼Œç„¶ååœ¨ updateComponent é‡Œé¢ä¼ é€’</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = (vnode.component = &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">attrs</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†ç»“æœä¿å­˜èµ·æ¥</span></span><br><span class="line">  <span class="attr">setupState</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// è§‚æµ‹å®ä¾‹å‘ç°ctxå¯ä»¥å–åˆ°setupStateå’Œprops</span></span><br><span class="line">  <span class="attr">ctx</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// å°†æ‰§è¡Œrenderçš„æ“ä½œå°è£…æˆä¸€ä¸ªå‡½æ•°</span></span><br><span class="line">  <span class="attr">update</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">subTree</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">isMounted</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">// å­˜å‚¨æ–°çš„vnode</span></span><br><span class="line">  <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;);</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateComponent</span>(<span class="params">prevVNode, vnode</span>) </span>&#123;</span><br><span class="line">  vnode.component = prevVNode.component;</span><br><span class="line">  vnode.component.next = vnode;</span><br><span class="line">  vnode.component.update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é‡æ–°åˆå§‹åŒ–-next"><a href="#é‡æ–°åˆå§‹åŒ–-next" class="headerlink" title="é‡æ–°åˆå§‹åŒ– next"></a>é‡æ–°åˆå§‹åŒ– next</h2><p>ç°åœ¨å¦‚æœ next å­˜åœ¨å°±æ˜¯è¢«åŠ¨æ›´æ–°ã€‚æˆ‘ä»¬å¤ç”¨ vnodeï¼Œå°†èŠ‚ç‚¹ä¼ è¿›æ¥ å¹¶å°† next ç½®ä¸º null é˜²æ­¢ä¸‹æ¬¡ä¸»åŠ¨æ›´æ–°è§¦å‘è¢«åŠ¨æ›´æ–°å‡ºé”™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (instance.next) &#123;</span><br><span class="line">  <span class="comment">// è¢«åŠ¨æ›´æ–°</span></span><br><span class="line">  <span class="comment">// å¤ç”¨vnodeï¼Œå°†èŠ‚ç‚¹ä¼ è¿›æ¥ å¹¶å°†nextç½®ä¸ºnullé˜²æ­¢ä¸‹æ¬¡ä¸»åŠ¨æ›´æ–°è§¦å‘è¢«åŠ¨æ›´æ–°å‡ºé”™</span></span><br><span class="line">  vnode = instance.next;</span><br><span class="line">  instance.next = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è·å–æœ€æ–°-props"><a href="#è·å–æœ€æ–°-props" class="headerlink" title="è·å–æœ€æ–° props"></a>è·å–æœ€æ–° props</h2><p>å›é¡¾ä¸€ä¸‹æˆ‘ä»¬çš„æ¡ˆä¾‹ï¼Œä¸»è¦æ˜¯çˆ¶ç»„ä»¶çš„ props æ”¹å˜å¯¼è‡´äº†å­ç»„ä»¶çš„è¢«åŠ¨æ›´æ–°ã€‚æ‰€ä»¥å…¶åŸå› è¿˜æ˜¯åœ¨ propsï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿè¦å»è·å–æœ€æ–°çš„ props å€¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (instance.next) &#123;</span><br><span class="line">  <span class="comment">// è¢«åŠ¨æ›´æ–°</span></span><br><span class="line">  <span class="comment">// å¤ç”¨vnodeï¼Œå°†èŠ‚ç‚¹ä¼ è¿›æ¥ å¹¶å°†nextç½®ä¸ºnullé˜²æ­¢ä¸‹æ¬¡ä¸»åŠ¨æ›´æ–°è§¦å‘è¢«åŠ¨æ›´æ–°å‡ºé”™</span></span><br><span class="line">  vnode = instance.next;</span><br><span class="line">  instance.next = <span class="literal">null</span>;</span><br><span class="line">  initProps(instance, vnode);</span><br><span class="line">  instance.ctx = &#123;</span><br><span class="line">    ...instance.props,</span><br><span class="line">    ...instance.setupState,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬çš„ context æ˜¯åˆå¹¶æ¥çš„å¹¶ä¸æ˜¯åƒæºç ä¸€æ ·ä»£ç†æ¥çš„ï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨åˆå¹¶ä¸€æ¬¡</p><h1 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate"></a>shouldComponentUpdate</h1><p>æˆ‘ä»¬æœ€å¼€å§‹é—ç•™çš„é—®é¢˜ï¼Œå°±æ˜¯æ²¡è€ƒè™‘å­ç»„ä»¶çš„ props æ˜¯å¦æ”¹å˜ï¼Œæ”¹å˜äº†æ‰åº”è¯¥å»æ›´æ–°ã€‚</p><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯ react é‡Œé¢çš„æ–¹æ³•ï¼Œreact å°†è¿™ä¸ªæ–¹æ³•æš´éœ²å‡ºæ¥ç»™ç”¨æˆ·è®©ä»–å†³å®šæ˜¯å¦æ›´æ–°ï¼Œvue å°±å°†å…¶å†…ç½®ã€‚ä¸»è¦çš„æ“ä½œè¿™é‡Œå°±çœç•¥äº†ã€‚</p><h1 id="unmountComponent"><a href="#unmountComponent" class="headerlink" title="unmountComponent"></a>unmountComponent</h1><p>ç›´æ¥æŠŠ vnode é‡Œé¢æŒ‚è½½çš„ component ä¸­çš„ subTree å¸è½½å³å¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unmountComponent</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  unmount(vnode.component.subTree);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶çœŸå®çš„å¸è½½ç»„ä»¶æµç¨‹æ²¡é‚£ä¹ˆç®€å•ï¼Œä»–è¿˜è¦å»å¤„ç†destroyå’ŒbeforeDestroyçš„æƒ…å†µ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘¤--æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡</title>
    <link href="https://zlinni.github.io/posts/2778725059/"/>
    <id>https://zlinni.github.io/posts/2778725059/</id>
    <published>2022-06-11T01:57:31.000Z</published>
    <updated>2022-06-12T02:23:35.980Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯æœ€é•¿ä¸Šå‡å­åºåˆ— ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­ LIS çš„æ·±å…¥è®¨è®ºã€‚</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220612100818.png" alt=""></p><h1 id="LIS"><a href="#LIS" class="headerlink" title="LIS"></a>LIS</h1><p>Longest Increasing Subsequence æœ€é•¿ä¸Šå‡å­åºåˆ—ã€‚æ˜¯æŒ‡ä¸€ä¸ªåºåˆ—ä¸­æœ€é•¿çš„å•è°ƒé€’å¢çš„å­åºåˆ—ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‹¿ leetcode çš„é¢˜ä½œä¸ºä¾‹å­æ¥ç¼–å†™ï¼š<a href="https://leetcode.cn/problems/longest-increasing-subsequence/">æœ€é•¿é€’å¢å­åºåˆ—</a><br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220611154750.png" alt=""></p><h2 id="dp-O-nÂ²"><a href="#dp-O-nÂ²" class="headerlink" title="dp O(nÂ²)"></a>dp O(nÂ²)</h2><p>ä¾‹å­ï¼š<br><code>nums=[10,9,2,5,3,7,101,18]</code><br>dp çš„æ€è·¯å¦‚ä¸‹:</p><p>åˆå§‹åŒ– dp ä¸º 1 <code>dp=[1,1,1,1,1,1,1,1]</code>ï¼Œç„¶åå¾ªç¯æ¯”å¯¹å‰é¢çš„ï¼Œåªè¦å®ƒå¤§äºäº†å‰é¢çš„æ•°å°±æŠŠä¸‹æ ‡ç½®ä¸ºå‰é¢çš„æ•°çš„æœ€å¤§é•¿åº¦+1ï¼Œå½“ç„¶è¿™ä¸ªè¿‡ç¨‹è¿˜è¦æ¯”è¾ƒå’Œè‡ªèº«çš„å¤§å°ï¼Œå¦‚æœè‡ªèº«æ›´å¤§å–è‡ªèº«.æœ€åè¿”å›æœ€å¤§å€¼</p><p>è¿‡ç¨‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">3</span> <span class="number">7</span> <span class="number">101</span> <span class="number">18</span></span><br><span class="line"> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span>   <span class="number">4</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure><p>ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lengthOfLIS = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æœ€å°æ˜¯1</span></span><br><span class="line">  <span class="keyword">let</span> dp = <span class="keyword">new</span> <span class="built_in">Array</span>(nums.length).fill(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">let</span> max = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="comment">// æ¯”å¯¹å‰é¢çš„</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; i; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nums[i] &gt; nums[j]) &#123;</span><br><span class="line">        <span class="comment">// å–æœ€å¤§çš„</span></span><br><span class="line">        dp[i] = <span class="built_in">Math</span>.max(dp[i], dp[j] + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    max = <span class="built_in">Math</span>.max(dp[i], max);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> max;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="è´ªå¿ƒ-O-nÂ²"><a href="#è´ªå¿ƒ-O-nÂ²" class="headerlink" title="è´ªå¿ƒ O(nÂ²)"></a>è´ªå¿ƒ O(nÂ²)</h2><p>è¿™ä¸ªç®—æ³•çš„æ ¸å¿ƒæ˜¯çœ‹æœ€å¤§çš„æ•°ç„¶åæ›´æ–°</p><p>ä¾‹å­ï¼š<br><code>nums=[10,9,2,5,3,7,101,18,1]</code></p><p>è¿‡ç¨‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">init</span><br><span class="line">arr <span class="number">10</span></span><br><span class="line"><span class="number">9</span>&lt;<span class="number">10</span> replace</span><br><span class="line">arr <span class="number">9</span></span><br><span class="line"><span class="number">2</span>&lt;<span class="number">9</span> replace</span><br><span class="line">arr <span class="number">2</span></span><br><span class="line"><span class="number">5</span>&gt;<span class="number">2</span> add</span><br><span class="line">arr <span class="number">2</span> <span class="number">5</span></span><br><span class="line"><span class="number">101</span>&gt;<span class="number">5</span> add</span><br><span class="line">arr <span class="number">2</span> <span class="number">5</span> <span class="number">101</span></span><br><span class="line"><span class="number">3</span>&lt;<span class="number">101</span> but <span class="number">3</span>&gt;<span class="number">2</span> <span class="number">3</span>&lt;<span class="number">5</span>(find first num bigger than <span class="built_in">this</span>) replace</span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">101</span></span><br><span class="line"><span class="number">7</span>&lt;<span class="number">101</span> replace</span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">7</span></span><br><span class="line"><span class="number">18</span>&gt;<span class="number">7</span> add</span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line"><span class="number">1</span>&lt;<span class="number">18</span> but <span class="number">1</span>&lt;<span class="number">2</span> replace</span><br><span class="line">arr <span class="number">1</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line"><span class="attr">answer</span>:<span class="number">4</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ä»–å°äºç›®æ ‡æ•°ç»„ arr ä¸­æœ«å°¾çš„æ•°å­—çš„æ—¶å€™ä»å¤´åˆ¤æ–­æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¯”ä»–å¤§çš„æ•°å­—æ‰§è¡Œæ›¿æ¢çš„æ“ä½œï¼Œå¤§äºçš„æ—¶å€™æ‰§è¡Œæ–°å¢æ“ä½œã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lengthOfLIS = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arr = [nums[<span class="number">0</span>]];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] &lt;= arr[arr.length - <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; arr.length; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &lt;= arr[j]) &#123;</span><br><span class="line">          arr[j] = nums[i];</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      arr.push(nums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr.length;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="è´ªå¿ƒ-äºŒåˆ†-O-nlogn"><a href="#è´ªå¿ƒ-äºŒåˆ†-O-nlogn" class="headerlink" title="è´ªå¿ƒ+äºŒåˆ† O(nlogn)"></a>è´ªå¿ƒ+äºŒåˆ† O(nlogn)</h2><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­è¯¥æ•°ç»„æ˜¯ä¸€ä¸ªæœ‰åºæ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨äºŒåˆ†æŸ¥æ‰¾è¿›è¡Œä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lengthOfLIS = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arr = [nums[<span class="number">0</span>]];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] &lt;= arr[arr.length - <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">let</span> l = <span class="number">0</span>,</span><br><span class="line">        r = arr.length - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">let</span> mid = ~~((l + r) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; arr[mid]) &#123;</span><br><span class="line">          l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; arr[mid]) &#123;</span><br><span class="line">          r = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          l = mid;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      arr[l] = nums[i];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      arr.push(nums[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr.length;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="position-å½¢æˆ-LIS-çš„é›†åˆ"><a href="#position-å½¢æˆ-LIS-çš„é›†åˆ" class="headerlink" title="position å½¢æˆ LIS çš„é›†åˆ"></a>position å½¢æˆ LIS çš„é›†åˆ</h2><p>æˆ‘ä»¬çœŸæ­£éœ€è¦åšçš„å®é™…ä¸Šæ˜¯ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰åŸæ•°æ®ä¸­å¯¹åº”ä¸‹æ ‡çš„ LIS çš„ seq æ•°ç»„ï¼Œè€Œä¸æ˜¯é•¿åº¦ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å…ˆæ‰¾åˆ°è¿™ä¸€éƒ¨åˆ†çš„ LISï¼Œä½†ä¸ºäº†æ‰¾åˆ°è¿™ä¸€éƒ¨åˆ†çš„ LIS,æˆ‘ä»¬åˆéœ€è¦æŸ¥çœ‹å…¨éƒ¨çš„å…ƒç´ çš„ä½ç½®æ˜¯å¦æ»¡è¶³ LISï¼Œä¸¾ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">num <span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line">pos  <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>   <span class="number">2</span> <span class="number">1</span> <span class="number">2</span>  <span class="number">3</span> <span class="number">0</span></span><br><span class="line"><span class="comment">// å¾—åˆ°</span></span><br><span class="line">ans      <span class="number">2</span>       <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æœ‰è¿™ä¹ˆä¸€ä¸ª pos æ•°ç»„å‘Šè¯‰æˆ‘ä»¬å…·ä½“çš„ LIS ä¸‹æ ‡ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±èƒ½å¾ˆè½»æ˜“å¾—åˆ°å¯¹åº”çš„ LIS å…ƒç´ äº†ã€‚</p><p>æ‰€ä»¥ä»¥è¿™ä¸ªå‡ºå‘å»ç¼–å†™ pos æ•°ç»„ï¼Œå®ƒçš„è¿‡ç¨‹å¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">num <span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">init</span><br><span class="line">arr <span class="number">10</span></span><br><span class="line">pos <span class="number">0</span></span><br><span class="line"><span class="number">9</span>&lt;<span class="number">10</span> replace <span class="number">10.</span>index</span><br><span class="line">arr <span class="number">9</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">2</span>&lt;<span class="number">9</span> replace <span class="number">9.</span>index</span><br><span class="line">arr <span class="number">2</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">5</span>&gt;<span class="number">2</span> add len-<span class="number">1</span></span><br><span class="line">arr <span class="number">2</span> <span class="number">5</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">101</span>&gt;<span class="number">5</span> add len-<span class="number">1</span></span><br><span class="line">arr <span class="number">2</span> <span class="number">5</span> <span class="number">101</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span></span><br><span class="line"><span class="number">3</span>&lt;<span class="number">101</span> but <span class="number">3</span>&gt;<span class="number">2</span> <span class="number">3</span>&lt;<span class="number">5</span>(find first num bigger than <span class="built_in">this</span>) replace &amp;&amp; <span class="number">5.</span>index</span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">101</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">7</span>&lt;<span class="number">101</span> replace <span class="number">101.</span>index</span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">7</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span></span><br><span class="line"><span class="number">18</span>&gt;<span class="number">7</span> add len-<span class="number">1</span></span><br><span class="line">arr <span class="number">2</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="number">1</span>&lt;<span class="number">18</span> but <span class="number">1</span>&lt;<span class="number">2</span> replace <span class="number">2.</span>index</span><br><span class="line">arr <span class="number">1</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line">pos <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">num <span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line">idx  <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>   <span class="number">4</span> <span class="number">5</span> <span class="number">6</span>  <span class="number">7</span> <span class="number">8</span></span><br><span class="line">pos  <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>   <span class="number">2</span> <span class="number">1</span> <span class="number">2</span>  <span class="number">3</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">ans      <span class="number">2</span>       <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line">idx      <span class="number">2</span>       <span class="number">5</span> <span class="number">6</span>  <span class="number">7</span></span><br><span class="line"><span class="attr">answerIdx</span>:[<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>]</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçš„æ˜¯ï¼Œåœ¨æ¯æ¬¡ arr è¿›è¡Œ add æ“ä½œçš„æ—¶å€™ï¼Œpos å°±æŠŠ arr çš„é•¿åº¦-1 æ”¾è¿›æ¥ï¼›åœ¨æ¯æ¬¡æ‰§è¡Œ replace æ“ä½œçš„æ—¶å€™ï¼ŒæŠŠäºŒåˆ†æŸ¥æ‰¾æ›¿æ¢çš„ l ä¼ è¿›æ¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lengthOfLIS = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arr = [nums[<span class="number">0</span>]];</span><br><span class="line">  <span class="keyword">const</span> pos = [<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] &lt;= arr[arr.length - <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">let</span> l = <span class="number">0</span>,</span><br><span class="line">        r = arr.length - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">let</span> mid = ~~((l + r) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; arr[mid]) &#123;</span><br><span class="line">          l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; arr[mid]) &#123;</span><br><span class="line">          r = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          l = mid;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      arr[l] = nums[i];</span><br><span class="line">      pos.push(l);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      arr.push(nums[i]);</span><br><span class="line">      pos.push(arr.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pos;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸è¿‡æˆ‘ä»¬åœ¨æ“ä½œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œåªæ˜¯å¾—åˆ°äº†ä¸€ä¸ªä¸‹æ ‡é›†åˆï¼Œåˆšæ‰çš„ answerIdx æ˜¯æˆ‘ä»¬è‡ªå·±åˆ¤æ–­å‡ºæ¥çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å®ç° answerIdx è¿™ä¸€æ­¥</p><h2 id="cur-å¾—åˆ°-seq"><a href="#cur-å¾—åˆ°-seq" class="headerlink" title="cur å¾—åˆ° seq"></a>cur å¾—åˆ° seq</h2><p>answerIdx è¿™ä¸€æ­¥ï¼Œæ˜¯å°† pos ä¸­çš„ LIS è½¬ä¸ºäº†å¯¹åº”çš„ idxã€‚æˆ‘ä»¬ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œå…¶å® pos çš„é•¿åº¦æ˜¯å’Œ idx ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒå°±æ˜¯å…¨éƒ¨å…ƒç´ å½¢æˆ LIS çš„ä¸€ä¸ªé›†åˆï¼Œè€Œæˆ‘ä»¬åˆå‘ç°ä¹Ÿå¾—åˆ° arr äº†ï¼Œarr çš„é•¿åº¦-1 å°±æ˜¯ pos ä¸­æœ€å¤§çš„å…ƒç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¦¨è®¾ç½®ä¸€ä¸ªå˜é‡ curï¼Œè®©ä»–ç­‰äº arr çš„æœ€å¤§é•¿åº¦-1ï¼Œæ­¤æ—¶æˆ‘ä»¬åªè¦ä»åå¾€å‰éå† posï¼Œå½“ cur å’Œ pos çš„æ•°æ®æ˜¯ä¸€æ ·çš„æ—¶å€™ï¼Œå°±è¯´æ˜è¿™ä¸ªæ•°æ®æ˜¯ä¸ç”¨ç§»åŠ¨çš„ï¼Œå°±å¯ä»¥æŠŠ pos ä¸­å¯¹åº”çš„ä¸‹æ ‡åŠ å…¥åˆ° seq æ•°ç»„ä¸­ã€‚ç„¶ååˆå› ä¸ºæˆ‘ä»¬è¿™ä¸ª arr å…¶å®æ˜¯ä¸ä¼šå†ç”¨åˆ°çš„äº†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¤ç”¨ arrã€‚ä¸‹é¢æ¥æ¼”ç¤ºè¿™ä¸ªè¿‡ç¨‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">num <span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å·²çŸ¥</span></span><br><span class="line">num <span class="number">10</span> <span class="number">9</span> <span class="number">2</span> <span class="number">5</span> <span class="number">101</span> <span class="number">3</span> <span class="number">7</span> <span class="number">18</span> <span class="number">1</span></span><br><span class="line">idx <span class="number">0</span>  <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>   <span class="number">5</span> <span class="number">6</span> <span class="number">7</span>  <span class="number">8</span></span><br><span class="line">arr <span class="number">1</span>  <span class="number">3</span> <span class="number">7</span> <span class="number">18</span></span><br><span class="line">pos <span class="number">0</span>  <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span>   <span class="number">1</span> <span class="number">2</span> <span class="number">3</span>  <span class="number">0</span></span><br><span class="line">cur <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»åå¾€å‰éå†pos</span></span><br><span class="line">pos <span class="number">0</span></span><br><span class="line">pos <span class="number">3</span> cur-- arr[<span class="number">1</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">7</span>]</span><br><span class="line">pos <span class="number">2</span> cur-- arr[<span class="number">1</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">7</span>]</span><br><span class="line">pos <span class="number">1</span> cur-- arr[<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>]</span><br><span class="line">...</span><br><span class="line">pos <span class="number">0</span> cur-- arr[<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>]</span><br><span class="line">cur=-<span class="number">1</span> stop</span><br><span class="line"></span><br><span class="line"><span class="attr">arr</span>:   [<span class="number">2</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>]</span><br><span class="line"><span class="attr">answer</span>:[<span class="number">2</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">18</span>]</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±è·å¾—äº†è¿™ä¸ª seq æ•°ç»„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lengthOfLIS = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arr = [nums[<span class="number">0</span>]];</span><br><span class="line">  <span class="keyword">const</span> pos = [<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] &lt;= arr[arr.length - <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">let</span> l = <span class="number">0</span>,</span><br><span class="line">        r = arr.length - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">let</span> mid = ~~((l + r) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; arr[mid]) &#123;</span><br><span class="line">          l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; arr[mid]) &#123;</span><br><span class="line">          r = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          l = mid;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      arr[l] = nums[i];</span><br><span class="line">      pos.push(l);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      arr.push(nums[i]);</span><br><span class="line">      pos.push(arr.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> cur = arr.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = pos.length - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; cur &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur === pos[i]) &#123;</span><br><span class="line">      arr[cur--] = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="source"><a href="#source" class="headerlink" title="source"></a>source</h2><p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ source ä¸º-1 çš„æ—¶å€™æ˜¯ç›´æ¥æ›´æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿåº”è¯¥åœ¨ç®—æ³•é‡Œé¢ç§»é™¤-1 çš„è€ƒè™‘</p><p>æœ€åå…¨éƒ¨ä»£ç ä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSequence</span>(<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> arr = [nums[<span class="number">0</span>]];</span><br><span class="line">  <span class="keyword">const</span> pos = [<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] === -<span class="number">1</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (nums[i] &lt;= arr[arr.length - <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">let</span> l = <span class="number">0</span>,</span><br><span class="line">        r = arr.length - <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">let</span> mid = ~~((l + r) / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; arr[mid]) &#123;</span><br><span class="line">          l = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nums[i] &lt; arr[mid]) &#123;</span><br><span class="line">          r = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          l = mid;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      arr[l] = nums[i];</span><br><span class="line">      pos.push(l);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      arr.push(nums[i]);</span><br><span class="line">      pos.push(arr.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> cur = arr.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = pos.length - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; cur &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cur === pos[i]) &#123;</span><br><span class="line">      arr[cur--] = i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="key"><a href="#key" class="headerlink" title="key"></a>key</h2><p>æœ€åå›åˆ°æœ¬æºï¼Œæˆ‘ä»¬è¦ç»™ vnode æ·»åŠ ä¸€ä¸ª key å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children,</span><br><span class="line">  shapeFlag,</span><br><span class="line">  <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">anchor</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">key</span>: props &amp;&amp; props.key,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦å¤–åœ¨ patchProps é‡Œé¢ä¹Ÿè¦æ³¨æ„ key çš„åˆ¤æ–­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç§»é™¤æ—§å±æ€§æœ‰çš„ï¼Œæ–°å±æ€§æ²¡æœ‰çš„</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">  <span class="comment">// å½“å‰å±æ€§æ˜¯ &#x27;key&#x27; åˆ™è·³è¿‡</span></span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">&quot;key&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newProps[key] == <span class="literal">null</span>) &#123;</span><br><span class="line">    patchDomProp(oldProps[key], <span class="literal">null</span>, key, el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æ—§å±æ€§æ²¡æœ‰çš„ï¼Œæ–°å±æ€§æœ‰çš„</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">&quot;key&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldProps[key] !== newProps[key]) &#123;</span><br><span class="line">    patchDomProp(oldProps[key], newProps[key], key, el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨æœ¬èŠ‚ä¸­æˆ‘ä»¬ä»¥ leetcode ä¸ºä¾‹å­¦ä¹ äº† LIS ç®—æ³•çš„æ ¸å¿ƒåŸç†ï¼Œä½¿ç”¨ dpï¼Œè´ªå¿ƒå»å®ç°ï¼Œç„¶ååˆé€šè¿‡äºŒåˆ†ä¼˜åŒ–äº†æŸ¥æ‰¾è¿‡ç¨‹ï¼Œåé¢æˆ‘ä»¬å‘ç°æˆ‘ä»¬éœ€è¦çš„æ˜¯å®é™…çš„å…ƒç´ è€Œä¸æ˜¯ä¸‹æ ‡ï¼Œå°±é‡‡ç”¨äº† pos æ•°ç»„å¸®åŠ©æˆ‘ä»¬å¾—åˆ°äº†å½¢æˆ LIS çš„é›†åˆï¼Œå†è®¾ç½® cur å¹¶å¤ç”¨ arr å¾—åˆ°æˆ‘ä»¬çš„ seq æ•°ç»„ã€‚ä¸‹èŠ‚æˆ‘ä»¬å°†ä»‹ç»ç»„ä»¶ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘¢--patchç¯‡</title>
    <link href="https://zlinni.github.io/posts/2046694271/"/>
    <id>https://zlinni.github.io/posts/2046694271/</id>
    <published>2022-06-10T08:15:01.000Z</published>
    <updated>2022-06-11T02:15:25.473Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯patch ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­ patch çš„åŸºæœ¬ç†è§£å’Œå®è·µã€‚</p></div><h1 id="patchçš„ä»‹ç»"><a href="#patchçš„ä»‹ç»" class="headerlink" title="patchçš„ä»‹ç»"></a>patchçš„ä»‹ç»</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/patch.png" alt=""></p><p><code>patch</code> æ˜¯å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹çš„ç®—æ³•ï¼Œå½“æ–°èŠ‚ç‚¹ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰§è¡Œå¸è½½æ“ä½œï¼Œå½“æ–°èŠ‚ç‚¹å­˜åœ¨çš„æ—¶å€™ï¼Œè¿›è¡Œå¯¹æ¯”</p><p>å¸è½½æ“ä½œéœ€è¦åˆ¤æ–­å¯¹åº”èŠ‚ç‚¹çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ç»„ä»¶æ‰§è¡Œç»„ä»¶çš„å¸è½½ï¼Œå¦‚æœæ˜¯ <code>Fragment</code> æ‰§è¡Œ <code>Fragment</code> çš„å¸è½½ï¼Œæœ€ååˆ° <code>Text</code> å’Œ <code>Element</code> æ‰§è¡Œ <code>removeChild</code></p><p><code>patch</code> æ“ä½œéœ€è¦åˆ¤æ–­æ–°æ—§èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç›¸åŒï¼Œä¸åŒçš„è¯å°±è¦å¸è½½æ—§çš„èŠ‚ç‚¹å°†åŸæœ‰çš„èŠ‚ç‚¹æ ‘å®Œå…¨å¸è½½æ‰ã€‚</p><p>ç„¶åå†åˆ¤æ–­æ–°èŠ‚ç‚¹<br>æ–°èŠ‚ç‚¹æ˜¯å¦æ˜¯ç»„ä»¶ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œ <code>processComponent</code>ï¼›</p><p>æ–°èŠ‚ç‚¹å¦‚æœæ˜¯ <code>Text</code> ç±»å‹ï¼Œæ‰§è¡Œ <code>processText</code>ã€‚ä¹‹åå†æ¥åˆ¤æ–­æ—§èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨è¯´æ˜ä¹‹å‰å·²ç»åˆ›å»ºè¿‡æ—§çš„æ–‡æœ¬å†…å®¹äº†ï¼Œç›´æ¥å¤ç”¨è¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œæ›´æ–°ä»–çš„ <code>textContent</code>ï¼Œå¦‚æœä¸å­˜åœ¨æ—§èŠ‚ç‚¹ï¼Œç›´æ¥ä½¿ç”¨ <code>mountTextNode</code> æŒ‚è½½æ–‡æœ¬èŠ‚ç‚¹</p><p>æ–°èŠ‚ç‚¹å¦‚æœæ˜¯ <code>Fragment</code> ç±»å‹ï¼Œå°±æ‰§è¡Œ <code>processFragment</code>ï¼Œå¦‚æœæ­¤æ—¶æ—§èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ <code>mountChildren</code>ï¼Œå¦‚æœæ—§èŠ‚ç‚¹å­˜åœ¨å°±è¦è¿›è¡Œ <code>diff</code></p><p>æ–°èŠ‚ç‚¹æœ€åå°±åˆ¤æ–­ä¸º <code>Element</code> ç±»å‹ï¼Œæ‰§è¡Œ <code>processElement</code>ã€‚ä¹‹åæ¥åˆ¤æ–­æ—§èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ <code>mountElement</code> å¯¹æ–°èŠ‚ç‚¹è¿›è¡ŒæŒ‚è½½ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è¦å¯¹ä»–è¿›è¡Œ <code>diff</code> æ“ä½œäº†ã€‚</p><p>å› ä¸ºæ­¤æ—¶æ–°æ—§èŠ‚ç‚¹çš„ <code>type</code> ä¸€æ ·ï¼Œå°±ç›´æ¥å¤ç”¨ <code>type</code>ï¼Œåªè¦å¯¹ <code>props</code> å’Œ <code>children</code> è¿›è¡Œ <code>diff</code></p><p>åˆ†æå®Œäº†ä¹‹åå°±å¼€å§‹å‡†å¤‡å†™æ–°çš„ <code>render</code> å‡½æ•°äº†</p><h1 id="render"><a href="#render" class="headerlink" title="render"></a>render</h1><p>æˆ‘ä»¬ä¹‹å‰çš„ <code>render</code> æ˜¯æŒ‚è½½äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ€ä¹ˆæ‰èƒ½äº§ç”Ÿæ–°æ—§èŠ‚ç‚¹å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šæˆ‘ä»¬åªè¦å°† <code>vnode</code> æŒ‚è½½åœ¨ <code>container</code> ä¸Šé¢ï¼Œä¸‹æ¬¡è¿›å…¥çš„æ—¶å€™è·å– <code>container</code> ä¸Šé¢çš„ <code>vnode</code>ï¼Œæ­¤æ—¶è¿™ä¸ª <code>vnode</code> å°±æ˜¯æ—§èŠ‚ç‚¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevNode = container._vnode;</span><br><span class="line">  container._vnode = vnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›è¡Œåˆ¤æ–­äº†ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ¤æ–­æ–°èŠ‚ç‚¹å­˜ä¸å­˜åœ¨ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevNode = container._vnode;</span><br><span class="line">  <span class="keyword">if</span> (!vnode) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevNode) &#123;</span><br><span class="line">      unmount(prevNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    patch(prevNode, vnode, container);</span><br><span class="line">  &#125;</span><br><span class="line">  container._vnode = vnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦ç¼–å†™ <code>unmount</code> å’Œ <code>patch</code></p><h2 id="unmount"><a href="#unmount" class="headerlink" title="unmount"></a>unmount</h2><p>å‰é¢çš„æƒ…å†µå°±æ˜¯åˆ©ç”¨ shapeflag åˆ¤æ–­ç»„ä»¶çš„å¸è½½æˆ– <code>fragment</code> çš„å¸è½½ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params">vnode</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;shapeFlag,el&#125; = vnode;</span><br><span class="line">    <span class="keyword">if</span>(shapeFlag&amp;ShapeFlags.COMPONENT)&#123;</span><br><span class="line">        unmountComponent(vnode)</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(shapeFlag&amp;ShapeFlags.FRAGMENT)&#123;</span><br><span class="line">        unmountFragment(vnode)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      ...?</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬å‘ç°æœ€åä¸€ç§æƒ…å†µï¼šå¯¹ <code>Text</code> æˆ– <code>Element</code> è¿›è¡Œ <code>removeChild</code> çš„æ—¶å€™ï¼Œæ²¡æœ‰è·å–åˆ°å…·ä½“çš„ elï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä» <code>vnode</code> é‡Œé¢æ‹¿ elï¼Œä¹Ÿå°±æ˜¯è¦åœ¨ <code>vnode</code> çš„è¿”å›å€¼é‡Œé¢æ·»åŠ ä¸€ä¸ª el</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children,</span><br><span class="line">  shapeFlag,</span><br><span class="line">  <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸”åœ¨æŒ‚è½½ <code>element</code> å’Œ <code>textnode</code> ä¹‹åéœ€è¦å°† el æŒ‚è½½åˆ° <code>vnode</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–å‡ºå…ƒç´  æŒ‚è½½å…ƒç´  æŒ‚è½½props children</span></span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">  <span class="comment">// å°†propsæŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  mountProps(props, el);</span><br><span class="line">  <span class="comment">// æŠŠèŠ‚ç‚¹æŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  mountChildren(vnode, el);</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">  <span class="comment">// ä¿å­˜el</span></span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextNode</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="built_in">document</span>.createTextNode(vnode.children);</span><br><span class="line">  container.appendChild(textNode);</span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ç°åœ¨æœ€åä¸€ç§æƒ…å†µåº”è¯¥è¿™æ ·å†™äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, el &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.COMPONENT) &#123;</span><br><span class="line">    unmountComponent(vnode);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.FRAGMENT) &#123;</span><br><span class="line">    unmountFragment(vnode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å…¶æ¬¡æ˜¯Textæˆ–è€…Element ä½†è¦æ‹¿åˆ°childèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¦åœ¨vnodeé‡Œé¢åˆå§‹åŒ–ä¸€ä¸ªel</span></span><br><span class="line">    el.parentNode.removeChild(el);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>æ¥ä¸‹æ¥æ˜¯å®ç° <code>patch</code> çš„éƒ¨åˆ†ï¼Œè¦é€šè¿‡ä»–åˆ¤æ–­æ–°æ—§èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç›¸åŒï¼Œè®¾ç½®ä¸€ä¸ªå‡½æ•°ã€‚ç„¶ååˆ†æƒ…å†µã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode &amp;&amp; !isSameVNode(prevVNode, vnode)) &#123;</span><br><span class="line">    unmount(prevVNode);</span><br><span class="line">    <span class="comment">// æ³¨æ„å¸è½½ä¹‹åè¦å°†èŠ‚ç‚¹è®¾ç½®ä¸ºnull</span></span><br><span class="line">    prevVNode = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.COMPONENT) &#123;</span><br><span class="line">    processComponent(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT) &#123;</span><br><span class="line">    processText(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.FRAGMENT) &#123;</span><br><span class="line">    processFragment(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    processElement(prevVNode, vnode, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isSameVNode</span>(<span class="params">prevVNode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> prevVNode.type === vnode.type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åè¦å¤„ç†å‰©ä¸‹çš„å››ä¸ªå‡½æ•° <code>processComponentï¼ŒprocessTextï¼ŒprocessFragmentï¼ŒprocessElement</code></p><h3 id="processText"><a href="#processText" class="headerlink" title="processText"></a>processText</h3><p>å­˜åœ¨æ—§èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¤ç”¨æ—§èŠ‚ç‚¹çš„ <code>textContent</code>ã€‚å¦åˆ™æ‰§è¡Œ <code>mountTextNode</code>ï¼Œè¿™ä¸ªå‰é¢ä¹Ÿå†™è¿‡äº†ã€‚ç›´æ¥ cv å³å¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processText</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    vnode.el = prevVNode.el;</span><br><span class="line">    prevVNode.el.textContent = vnode.children;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountTextNode(vnode, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextNode</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="built_in">document</span>.createTextNode(vnode.children);</span><br><span class="line">  container.appendChild(textNode);</span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="processElement"><a href="#processElement" class="headerlink" title="processElement"></a>processElement</h3><p>å¯¹äºå­˜åœ¨æ—§èŠ‚ç‚¹çš„æƒ…å†µä¸‹è°ƒç”¨ <code>patchElement</code> è¿›è¡Œ <code>diff</code> æ¯”è¾ƒï¼Œä¸å­˜åœ¨çš„æƒ…å†µåˆ™è°ƒç”¨åŸå…ˆå†™è¿‡çš„ <code>mountElement</code> è¿›è¡ŒæŒ‚è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processElement</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    patchElement(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountElement(vnode, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ <code>mountChildren</code> ä¸­æˆ‘ä»¬ä¹‹å‰æ˜¯æ²¡æœ‰å®ç° <code>mount</code> çš„ï¼Œå…¶å®åœ¨è¿™é‡Œç”¨ <code>patch</code> å®ç°å³å¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, children &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">    mountTextNode(vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    <span class="comment">// é€’å½’è°ƒç”¨æŒ‚è½½</span></span><br><span class="line">    children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      patch(<span class="literal">null</span>, child, container);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–å°±æ˜¯ <code>patchElement</code>ï¼Œå› ä¸ºæ­¤æ—¶æ–°æ—§èŠ‚ç‚¹çš„ <code>type</code> éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°†æ—§èŠ‚ç‚¹çš„ el èµ‹å€¼ç»™æ–°èŠ‚ç‚¹çš„ elï¼Œç„¶åå¯¹æ¯”å®ƒä»¬ä¹‹é—´çš„ <code>props</code> å’Œ <code>children</code> çš„å¼‚åŒã€‚</p><h4 id="patchProps"><a href="#patchProps" class="headerlink" title="patchProps"></a>patchProps</h4><p>å…¶ä¸­åŒ…å«äº†ä¸¤ä¸ªå‡½æ•°ä¸€ä¸ªæ˜¯ <code>patchProps</code> ä¸€ä¸ªæ˜¯ <code>patchChildren</code></p><p>å¯¹äº <code>patchProps</code>ï¼Œå›é¡¾ä¸€ä¸‹ <code>props</code> çš„å†…å®¹,ä»–æ˜¯ä¸€ä¸ªå¯¹è±¡é‡Œé¢æœ‰å¾ˆå¤šå±æ€§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">class</span>: <span class="string">&#x27;a b&#x27;</span>,</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">    <span class="attr">fontSize</span>: <span class="string">&#x27;14px&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">onClick</span>: <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;click&#x27;</span>),</span><br><span class="line">  <span class="attr">checked</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">custom</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯¹äºæ–°æ—§èŠ‚ç‚¹çš„ <code>props</code>ï¼Œéœ€è¦å–å‡ºå¯¹åº”çš„ <code>value</code> å€¼ï¼Œå¯¹æ¯”æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒæˆ‘ä»¬æ‰å»è¿›è¡Œé‡æ–°èµ‹å€¼ã€‚å¹¶ä¸”æˆ‘ä»¬è¿˜è¦éå†æ—§å±æ€§ï¼Œç§»é™¤æ—§å±æ€§ä¸­æœ‰çš„ï¼Œæ–°å±æ€§ä¸­æ²¡æœ‰çš„ã€‚éå†æ–°å±æ€§ï¼Œæ·»åŠ æ—§å±æ€§æ²¡æœ‰çš„æ–°å±æ€§æœ‰çš„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchProps</span>(<span class="params">oldProps, newProps, el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (oldProps === newProps) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é˜²æ­¢ä¼ è¿‡æ¥çš„propsæ˜¯ç©º æ³¨æ„è¿™é‡Œæ²¡æœ‰ç”¨åˆ°es6èµ‹é»˜è®¤å€¼çš„å†™æ³•æ˜¯å› ä¸ºä»–æœ‰å¯èƒ½ä¼ é€’çš„æ˜¯nullï¼Œes6é»˜è®¤å€¼åªèƒ½å¤„ç†undefinedçš„æƒ…å†µ</span></span><br><span class="line">  oldProps = oldProps || &#123;&#125;;</span><br><span class="line">  newProps = newProps || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§»é™¤æ—§å±æ€§æœ‰çš„ï¼Œæ–°å±æ€§æ²¡æœ‰çš„</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">    <span class="comment">// å½“å‰å±æ€§æ˜¯ &#x27;key&#x27; åˆ™è·³è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;key&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newProps[key] == <span class="literal">null</span>) &#123;</span><br><span class="line">      patchDomProp(oldProps[key], <span class="literal">null</span>, key, el);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ æ—§å±æ€§æ²¡æœ‰çš„ï¼Œæ–°å±æ€§æœ‰çš„</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;key&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldProps[key] !== newProps[key]) &#123;</span><br><span class="line">      patchDomProp(oldProps[key], newProps[key], key, el);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="patchDomProp"><a href="#patchDomProp" class="headerlink" title="patchDomProp"></a>patchDomProp</h5><p><code>patchDomProp</code> è¿™ä¸€æ­¥æ“ä½œå’Œæˆ‘ä»¬ä¹‹å‰å†™çš„ <code>mountProps</code> æœ‰ç‚¹ç±»ä¼¼ã€‚ä¸è¿‡æœ‰å‡ ä¸ªç»†èŠ‚è¦æ³¨æ„ï¼š</p><p>å¦‚æœ <code>next</code> æ˜¯ <code>false</code> æˆ–è€…æ˜¯ <code>null</code> çš„è¯ï¼Œä»–å°±ä¼šå˜æˆå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å»æ‰ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯å»æ‰ã€‚æ‰€ä»¥è¦å†™<code>el.className = next || &#39;&#39;</code></p><p>å¦‚æœæ–°æ—§å±æ€§ä¸­çš„ <code>style</code> æœ‰ä¸ä¸€è‡´çš„ï¼Œæˆ‘ä»¬æ·»åŠ æ–°çš„ <code>styleName</code>ï¼Œç§»é™¤ä¸éœ€è¦çš„ <code>styleName</code>ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nextä¸ºç©ºç›´æ¥ç§»é™¤</span></span><br><span class="line"><span class="keyword">if</span> (next == <span class="literal">null</span>) &#123;</span><br><span class="line">  el.removeAttribute(<span class="string">&quot;style&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// æˆ‘ä»¬æ·»åŠ æ–°çš„ styleName</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> next) &#123;</span><br><span class="line">    el.style[styleName] = next[styleName];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç§»é™¤ä¸éœ€è¦çš„ `styleName`ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> prev) &#123;</span><br><span class="line">      <span class="keyword">if</span> (next[styleName] == <span class="literal">null</span>) &#123;</span><br><span class="line">        el.style[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœäº‹ä»¶ä¸­å­˜åœ¨æ—§äº‹ä»¶ï¼Œç§»é™¤æ—§äº‹ä»¶ï¼Œå¦‚æœå­˜åœ¨æ–°äº‹ä»¶ï¼Œæ·»åŠ æ–°äº‹ä»¶ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/^on[^a-z]/</span>.test(key)) &#123;</span><br><span class="line">  <span class="keyword">const</span> eventName = key.slice(<span class="number">2</span>).toLowerCase();</span><br><span class="line">  <span class="comment">// ç§»é™¤æ—§äº‹ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">    el.removeEventListener(eventName, prev);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ æ–°äº‹ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (next) &#123;</span><br><span class="line">    el.addEventListener(eventName, next);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (key) &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯class ç›´æ¥èµ‹className</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;class&quot;</span>:</span><br><span class="line">    el.className = next;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯style éå†èµ‹å€¼valueå€¼</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;style&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> next) &#123;</span><br><span class="line">      el.style[styleName] = next[styleName];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> prev) &#123;</span><br><span class="line">        <span class="keyword">if</span> (next[styleName] == <span class="literal">null</span>) &#123;</span><br><span class="line">          el.style[styleName] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯äº‹ä»¶ï¼Œæ­£åˆ™åŒ¹é…onå¼€å¤´ï¼Œå¹¶å°†åé¢çš„è½¬ä¸ºå°å†™å•è¯ ç„¶åæ·»åŠ äº‹ä»¶</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯åˆ«çš„å±æ€§ï¼Œåˆ†ç±»åˆ¤æ–­ï¼Œä¸èƒ½ç»Ÿä¸€è®¾ç½®attribute</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^on[^a-z]/</span>.test(key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> eventName = key.slice(<span class="number">2</span>).toLowerCase();</span><br><span class="line">      <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">        el.removeEventListener(eventName, prev);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (next) &#123;</span><br><span class="line">        el.addEventListener(eventName, next);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (domPropsRE.test(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (next === <span class="string">&quot;&quot;</span> || isBoolean(el[key])) &#123;</span><br><span class="line">        next = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      el[key] = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (next == <span class="literal">null</span> || next === <span class="literal">false</span>) &#123;</span><br><span class="line">        el.removeAttribute(key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        el.setAttribute(key, next);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶æˆ‘ä»¬å·²ç»å¯ä»¥åˆ©ç”¨ <code>patchProps</code> å–ä»£ <code>mountProps</code> äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–å‡ºå…ƒç´  æŒ‚è½½å…ƒç´  æŒ‚è½½props children</span></span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">  <span class="comment">// å°†propsæŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  <span class="comment">// mountProps(props, el);</span></span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    patchProps(<span class="literal">null</span>, props, el);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æŠŠèŠ‚ç‚¹æŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  mountChildren(vnode, el);</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">  <span class="comment">// ä¿å­˜el</span></span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="patchChildren"><a href="#patchChildren" class="headerlink" title="patchChildren"></a>patchChildren</h4><p>æˆ‘ä»¬é‡æ–°ä¿®æ”¹ä¸€ä¸‹ <code>mountChildren</code>ï¼Œè®©ä»–çš„èŒè´£æ›´åŠ å•ä¸€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–å‡ºå…ƒç´  æŒ‚è½½å…ƒç´  æŒ‚è½½props children</span></span><br><span class="line">  <span class="keyword">const</span> &#123; type, props, shapeFlag, children &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">  <span class="comment">// å°†propsæŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  <span class="comment">// mountProps(props, el);</span></span><br><span class="line">  patchProps(<span class="literal">null</span>, props, el);</span><br><span class="line">  <span class="comment">// æŠŠèŠ‚ç‚¹æŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">    mountTextNode(vnode, el);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    mountChildren(children, el);</span><br><span class="line">  &#125;</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">  <span class="comment">// ä¿å­˜el</span></span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">children, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// é€’å½’è°ƒç”¨æŒ‚è½½</span></span><br><span class="line">  children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">    patch(<span class="literal">null</span>, child, container);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹å†™ <code>patchChildren</code>ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¹ç§æƒ…å†µè¿›è¡Œåˆ¤æ–­<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/patchChildren.jpg" alt=""></p><p>ç®€å•å†™ä¸€ä¸‹æ¨¡æ¿å¤§è‡´å¦‚ä¸‹:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchChildren</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">shapeFlag</span>: prevShapeFlag, <span class="attr">children</span>: c1 &#125; = prevVNode;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, <span class="attr">children</span>: c2 &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">      container.textContent = c2;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">      unmountChildren(c1);</span><br><span class="line">      container.textContent = c2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      container.textContent = c2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">      container.textContent = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      mountChildren(c2, container);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">      patchArrayChildren(c1, c2, container);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mountChildren(c2, container);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">      container.textContent = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">      unmountChildren(c1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å‰©ä¸‹çš„ <code>unmountChildren</code> å’Œ <code>patchArrayChildren</code> ä¸¤ä¸ªå‡½æ•°æš‚æœªå®ç°ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å¯ä»¥å¯¹è¿™ä¸ªæ¨¡æ¿åšä¸€ä¸ªåˆå¹¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">  <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    unmountChildren(c1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (c1 !== c2) &#123;</span><br><span class="line">    container.textContent = c2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸€æ®µæ˜¯ vue æºç çš„åˆå¹¶ç»“æ„ï¼Œè™½ç„¶ç®€ä»‹ä½†æ˜¯è¿˜æ˜¯åˆ†æƒ…å†µæ¯”è¾ƒå¥½ç†è§£</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">  <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    unmountChildren(c1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (c2 !== c1) &#123;</span><br><span class="line">    container.textContent = c2;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// c2 is array or null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    <span class="comment">// c1 was array</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">      <span class="comment">// c2 is array</span></span><br><span class="line">      <span class="comment">// patchArrayChildren()</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// c2 is null</span></span><br><span class="line">      unmountChildren(c1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// c1 was text or null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">      container.textContent = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">      mountChildren(c2, container, anchor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ç¼–å†™ <code>unmountChildren</code>ï¼Œå…¶å®ä»–ä¹Ÿå°±æ˜¯éå† <code>children</code> ç„¶åå¸è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unmountChildren</span>(<span class="params">children</span>) </span>&#123;</span><br><span class="line">  children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">    unmount(child);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±åˆ°äº† <code>patchArrayChildren</code>ï¼Œè¿™ä¸ªéƒ¨åˆ†</p><h5 id="patchArrayChildren"><a href="#patchArrayChildren" class="headerlink" title="patchArrayChildren"></a>patchArrayChildren</h5><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬çœ‹ä»–å¦‚ä½•å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> n1 = h(<span class="string">&quot;ul&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;a&quot;</span>),</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;b&quot;</span>),</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;c&quot;</span>),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> n2 = h(<span class="string">&quot;ul&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;d&quot;</span>),</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;e&quot;</span>),</span><br><span class="line">  h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;f&quot;</span>),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><blockquote><p>c1: a b c<br>c2: d e f</p><p>c1: a b c<br>c2: d e f g h</p><p>c1: a b c g h<br>c2: d e f</p></blockquote><p>å¯¹æ¯”æ–°æ—§å­©å­ï¼Œå¦‚æœé•¿åº¦ç›¸åŒåˆ™æ‰§è¡Œ <code>patch</code> å¯¹æ¯”ï¼Œå¦‚æœæ–°å­©å­æ¯”æ—§å­©å­é•¿åˆ™æŒ‚è½½æ–°å­©å­å¤šå‡ºæ¥çš„éƒ¨åˆ†ï¼Œå¦‚æœæ—§å­©å­æ¯”æ–°å­©å­é•¿åˆ™åˆ é™¤æ—§å­©å­å¤šå‡ºæ¥çš„éƒ¨åˆ†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchArrayChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> oldLength = c1.length;</span><br><span class="line">  <span class="keyword">const</span> newLength = c2.length;</span><br><span class="line">  <span class="keyword">const</span> commonLength = <span class="built_in">Math</span>.min(oldLength, newLength);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; commonLength; i++) &#123;</span><br><span class="line">    patch(c1[i], c2[i], container);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (oldLength &gt; newLength) &#123;</span><br><span class="line">    unmountChildren(c1.slice(commonLength));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldLength &lt; newLength) &#123;</span><br><span class="line">    mountChildren(c2.slice(commonLength), container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯å¤„ç† <code>processFragment</code> äº†</p><h3 id="processFragment"><a href="#processFragment" class="headerlink" title="processFragment"></a>processFragment</h3><p>æ—§èŠ‚ç‚¹å­˜åœ¨çš„æ—¶å€™å¯¹æ¯”æ–°æ—§çš„å­©å­ï¼Œä¸å­˜åœ¨æ—¶å€™ç›´æ¥æŒ‚è½½æ–°èŠ‚ç‚¹çš„å­©å­ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processFragment</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    patchChildren(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountChildren(vnode.children, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæ¥ä¸ªä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, Fragment, h &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  h(<span class="string">&quot;ul&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">    h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;first&quot;</span>),</span><br><span class="line">    h(Fragment, <span class="literal">null</span>, []),</span><br><span class="line">    h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;last&quot;</span>),</span><br><span class="line">  ]),</span><br><span class="line">  <span class="built_in">document</span>.body</span><br><span class="line">);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  render(</span><br><span class="line">    h(<span class="string">&quot;ul&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;first&quot;</span>),</span><br><span class="line">      h(Fragment, <span class="literal">null</span>, [h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;middle&quot;</span>)]),</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;last&quot;</span>),</span><br><span class="line">    ]),</span><br><span class="line">    <span class="built_in">document</span>.body</span><br><span class="line">  );</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è·‘è¿™ä¸ªä¾‹å­ä¹‹å‰ï¼ŒçŸ¥é“è¿™ä¸ª <code>Fragment</code> èŠ‚ç‚¹åº”è¯¥æ˜¯ 2s åŠ å…¥åˆ° first å’Œ last ä¸­é—´çš„ï¼Œè€Œå®é™…çš„ç»“æœå´æ˜¯ä»–åˆ°äº†æœ€åé¢ã€‚</p><p>æˆ‘ä»¬å…ˆåˆ†æä¸€ä¸‹åŸå› ï¼šé¦–å…ˆ <code>patch</code> æ–°æ—§èŠ‚ç‚¹ï¼Œå®ƒä»¬ç±»å‹æ˜¯ç›¸åŒçš„ï¼Œæ˜¯ <code>Fragment</code>ï¼Œåˆ™è¿›å…¥ <code>processFragment</code>ã€‚æ­¤æ—¶æ—§èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œæ‰§è¡Œ <code>mountChildren</code>ï¼Œç„¶åæ‰§è¡Œ <code>patch</code>ï¼Œä¼ çš„å€¼æ˜¯<code>(null, child, container)</code>ï¼Œåˆ° <code>patch</code>ï¼Œæ­¤æ—¶å­©å­æ˜¯ä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ‰§è¡Œ <code>processElement</code>ã€‚ä¹‹å <code>mountElement</code>ã€‚</p><p>è¿™ä¸€æ­¥å°±æ˜¯é—®é¢˜æ‰€åœ¨äº†ï¼Œ<code>mountElement</code> ä¸­ï¼Œæˆ‘ä»¬çš„ el æ˜¯ç›´æ¥æŒ‚è½½åˆ° <code>container</code> ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯<code>container.appendChild(el);</code>ä»£ç ã€‚æ‰€ä»¥ä»–è¢«åŠ åˆ°äº†æœ€åé¢</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬è¦ä½¿ç”¨ <code>anchor</code> å±æ€§ã€‚</p><h4 id="Anchor"><a href="#Anchor" class="headerlink" title="Anchor"></a>Anchor</h4><p><code>anchor</code> å±æ€§å’Œ el ç±»ä¼¼ï¼Œå› ä¸º <code>Fragment</code> èŠ‚ç‚¹ä¹‹å‰æŒ‚è½½åˆ°çš„æ˜¯å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“åº”è¯¥åœ¨ä½•å¤„æ’å…¥æˆ–è€…åˆ é™¤æˆ‘ä»¬çš„ <code>Fragment</code> èŠ‚ç‚¹ï¼Œå°±è¦ä½¿ç”¨ el å’Œ <code>anchor</code> ç”ŸæˆèŠ‚ç‚¹ç„¶åå°±å¯ä»¥åœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸­é—´æ’å…¥ <code>Fragment</code>ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ <code>vnode</code> è¿”å›å€¼é‡Œé¢æ·»åŠ  <code>anchor</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children,</span><br><span class="line">  shapeFlag,</span><br><span class="line">  <span class="attr">el</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">anchor</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åé‡æ–°å†™ä¸€ä¸‹ <code>processFragment</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processFragment</span>(<span class="params">prevVNode, vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ—§èŠ‚ç‚¹çš„elå­˜åœ¨å°±å¤ç”¨ï¼Œanchorä¹Ÿæ˜¯ä¸€æ ·</span></span><br><span class="line">  <span class="keyword">const</span> fragmentStartAnchor = (vnode.el = prevVNode</span><br><span class="line">    ? prevVNode.el</span><br><span class="line">    : <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>));</span><br><span class="line">  <span class="keyword">const</span> fragmentEndAnchor = (vnode.anchor = prevVNode</span><br><span class="line">    ? prevVNode.anchor</span><br><span class="line">    : <span class="built_in">document</span>.createTextNode(<span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    patchChildren(prevVNode, vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.appendChild(fragmentStartAnchor);</span><br><span class="line">    container.appendChild(fragmentEndAnchor);</span><br><span class="line">    <span class="comment">// ä¼ é€’anchor</span></span><br><span class="line">    mountChildren(vnode.children, container, fragmentEndAnchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œå°±éœ€è¦åœ¨åç»­çš„åœ°æ–¹å¢åŠ  <code>anchor</code> å±æ€§äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">children, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// é€’å½’è°ƒç”¨æŒ‚è½½</span></span><br><span class="line">  children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">    patch(<span class="literal">null</span>, child, container,anchor);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">prevVNode, vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode &amp;&amp; !isSameVNode(prevVNode,vnode)) &#123;</span><br><span class="line">    unmount(prevVNode);</span><br><span class="line">    prevVNode = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    shapeFlag</span><br><span class="line">  &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.COMPONENT) &#123;</span><br><span class="line">    processComponent(prevVNode, vnode, container,anchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT) &#123;</span><br><span class="line">    processText(prevVNode, vnode, container,anchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.FRAGMENT) &#123;</span><br><span class="line">    processFragment(prevVNode, vnode, container,anchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    processElement(prevVNode, vnode, container,anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processElement</span>(<span class="params">prevVNode, vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    patchElement(prevVNode, vnode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountElement(vnode, container,anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–å‡ºå…ƒç´  æŒ‚è½½å…ƒç´  æŒ‚è½½props children</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    children</span><br><span class="line">  &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">  <span class="comment">// å°†propsæŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  <span class="comment">// mountProps(props, el);</span></span><br><span class="line">  patchProps(<span class="literal">null</span>, props, el);</span><br><span class="line">  <span class="comment">// æŠŠèŠ‚ç‚¹æŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">    mountTextNode(vnode, el);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    mountChildren(children, el);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// container.appendChild(el);</span></span><br><span class="line">  container.insertBefore(el,anchor);</span><br><span class="line">  <span class="comment">// ä¿å­˜el</span></span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processText</span>(<span class="params">prevVNode, vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    vnode.el = prevVNode.el;</span><br><span class="line">    prevVNode.el.textContent = vnode.children;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountTextNode(vnode, container,anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextNode</span>(<span class="params">vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="built_in">document</span>.createTextNode(vnode.children);</span><br><span class="line">  <span class="comment">// container.appendChild(textNode);</span></span><br><span class="line">  container.insertBefore(textNode,anchor);</span><br><span class="line">  vnode.el = textNode;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processFragment</span>(<span class="params">prevVNode, vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> fragmentStartAnchor = vnode.el = prevVNode ? prevVNode.el : <span class="built_in">document</span>.createTextNode(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> fragmentEndAnchor = vnode.anchor = prevVNode ? prevVNode.anchor : <span class="built_in">document</span>.createTextNode(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevVNode) &#123;</span><br><span class="line">    <span class="comment">// ç”¨fragmentEndAnchorä½œä¸ºä»–çš„anchor</span></span><br><span class="line">    patchChildren(prevVNode, vnode, container,fragmentEndAnchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ­¤å¤„ä¹Ÿè¦insertuu</span></span><br><span class="line">    container.insertBefore(fragmentStartAnchor,anchor)</span><br><span class="line">    container.insertBefore(fragmentEndAnchor,anchor)</span><br><span class="line">    mountChildren(vnode.children, container,fragmentEndAnchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ€»ä¹‹åœ¨éœ€è¦ <code>anchor</code> çš„èŠ‚ç‚¹éƒ½éœ€è¦æ·»åŠ  <code>anchor</code> å±æ€§ï¼Œå¹¶ä¸”æœ€åçš„æ—¶å€™éœ€è¦æ›¿æ¢ <code>appendChild</code> ä¸º <code>insertBefore</code></p><p>ä¹‹åæˆ‘ä»¬ç¼–å†™é—ç•™çš„ <code>unmountFragment</code>ï¼Œè¿™ä¸ªå‡½æ•°æœ¬èº«æˆ‘ä»¬å¯ä»¥ç”¨ <code>unmountChildren</code> çš„å½¢å¼æ¥å†™ï¼Œä½†æ˜¯ç°åœ¨ç”±äºæ·»åŠ äº† el å’Œ <code>anchor</code> ä¸¤ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ¢ç§æ–¹å¼äº†ã€‚</p><p>æ€è·¯å¤§æ¦‚å°±æ˜¯å°†ä»–ä»¬å¾ªç¯åˆ é™¤</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unmountFragment</span>(<span class="params">vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">el</span>: cur, <span class="attr">anchor</span>: end &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> &#123; parentNode &#125; = cur;</span><br><span class="line">  <span class="keyword">while</span> (cur != end) &#123;</span><br><span class="line">    <span class="keyword">let</span> next = cur.nextSibling;</span><br><span class="line">    parentNode.removeChild(cur);</span><br><span class="line">    cur = next;</span><br><span class="line">  &#125;</span><br><span class="line">  parentNode.removeChild(end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å›å»æµ‹è¯•æˆ‘ä»¬çš„ç”¨ä¾‹ï¼Œå‘ç°å¯ä»¥æˆåŠŸ <code>patch</code> äº†ã€‚</p><p>æœ€åè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯å…³äº <code>patchArrayChildren</code> é‡Œé¢çš„ã€‚æˆ‘ä»¬çœ‹è¿™ä¹ˆä¸ªä¾‹å­</p><blockquote><p>h1, h1, h1<br>h1, h2, h1</p></blockquote><p>ä¾‹å¦‚ï¼Œå¯¹ä¸Šé¢è¿™ä¸ªä¾‹å­è¿›è¡Œ <code>patchChildren</code> ç¬¬ä¸€æ¬¡ <code>patch</code> æ—¶ï¼Œ<code>n2.el = n1.el</code>ï¼Œæ²¡æœ‰åˆ›å»ºå…ƒç´ ï¼Œ<code>anchor</code> æ²¡æœ‰ç”¨ã€‚ ç¬¬äºŒæ¬¡ <code>patch</code> æ—¶ï¼Œå…ˆåˆ é™¤äº† n1ï¼Œå¯¹ n2 è¿›è¡Œåˆ›å»ºï¼Œæ‰§è¡Œ <code>insertBefore</code>ï¼Œ<code>anchor</code> å°±éœ€è¦è®¾ç½®ä¸º <code>n1</code> çš„ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">prevVNode, vnode, container,anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prevVNode &amp;&amp; !isSameVNode(prevVNode,vnode)) &#123;</span><br><span class="line">    anchor = prevVNode.el.nextSibling;</span><br><span class="line">    unmount(prevVNode);</span><br><span class="line">    prevVNode = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œå¦‚æœæ˜¯</p><blockquote><p>n1, â€œâ€ n1 â€œâ€,<br>n1 n1, n2, n1</p></blockquote><p>å¦‚æœ <code>n1</code> æ˜¯ <code>Fragment</code>ï¼Œé‚£ä¹ˆ <code>anchor</code> åº”è¯¥è®¾ç½®ä¸º <code>n1</code> çš„ <code>anchor</code> çš„ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ã€‚</p><p>æ‰€ä»¥ä¸å¦¨å°†ä¸¤ä¸ªæƒ…å†µåˆå¹¶ä¸ºä»¥ä¸‹çš„ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anchor = (prevVNode.anchor || prevVNode.el).nextSibling;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨æœ¬èŠ‚é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†patchç®—æ³•ç®€å•çš„å¯¹æ–°æ—§èŠ‚ç‚¹è¿›è¡Œæ¯”å¯¹ï¼Œç„¶åæ ¹æ®å¯¹åº”çš„æƒ…å†µå»æŒ‚è½½æ–°èŠ‚ç‚¹æˆ–åˆ é™¤æ—§èŠ‚ç‚¹ï¼Œåé¢åˆé‡æ–°ç¼–å†™äº†renderæ–¹æ³•æ¥å¯¹æˆ‘ä»¬ä¹‹å‰çš„æ“ä½œåšä¸€äº›è¡¥å……å’Œä¿®æ”¹ã€‚ä¸‹èŠ‚å°†è¿›è¡Œæ ¸å¿ƒdiffç®—æ³•çš„å­¦ä¹ ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueæ€»é›†ç¯‡</title>
    <link href="https://zlinni.github.io/posts/3894586884/"/>
    <id>https://zlinni.github.io/posts/3894586884/</id>
    <published>2022-06-10T00:48:38.000Z</published>
    <updated>2022-06-13T13:51:18.203Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯æ€»é›†ç¯‡ï¼ŒåŒ…å«äº† mini-vue çš„å…¨éƒ¨åŸºæœ¬å®ç°ï¼Œå‚è§ä¼ é€é—¨å†…å®¹</p></div><h1 id="ä¼ é€é—¨"><a href="#ä¼ é€é—¨" class="headerlink" title="ä¼ é€é—¨"></a>ä¼ é€é—¨</h1><h1 id="reactive-ç¯‡"><a href="#reactive-ç¯‡" class="headerlink" title="reactive ç¯‡"></a>reactive ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/3451170570">ä»é›¶å¼€å§‹çš„ mini-vueâ‘ â€”reactive ç¯‡</a></p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/reactivedaotu.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/computedandref.png" alt=""></p><h1 id="vnode-ç¯‡"><a href="#vnode-ç¯‡" class="headerlink" title="vnode ç¯‡"></a>vnode ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/2797606246">ä»é›¶å¼€å§‹çš„ mini-vueâ‘¡â€”vnode ç¯‡</a></p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/è™šæ‹ŸDOM.png" alt=""></p><h1 id="patch-ç¯‡"><a href="#patch-ç¯‡" class="headerlink" title="patch ç¯‡"></a>patch ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/2046694271">ä»é›¶å¼€å§‹çš„ mini-vueâ‘¢â€”patch ç¯‡</a></p></div><h1 id="æ ¸å¿ƒ-diff-ç¯‡"><a href="#æ ¸å¿ƒ-diff-ç¯‡" class="headerlink" title="æ ¸å¿ƒ diff ç¯‡"></a>æ ¸å¿ƒ diff ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/606001916">ä»é›¶å¼€å§‹çš„ mini-vueâ‘£â€”æ ¸å¿ƒ diff ç¯‡</a></p></div><h1 id="æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡"><a href="#æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡" class="headerlink" title="æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡"></a>æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/2778725059">ä»é›¶å¼€å§‹çš„ mini-vueâ‘¤â€”æœ€é•¿ä¸Šå‡å­åºåˆ—ç¯‡</a></p></div><h1 id="Component-ç¯‡"><a href="#Component-ç¯‡" class="headerlink" title="Component ç¯‡"></a>Component ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/1033180007">ä»é›¶å¼€å§‹çš„ mini-vueâ‘¥â€”Component ç¯‡</a></p></div><h1 id="Scheduler-ç¯‡"><a href="#Scheduler-ç¯‡" class="headerlink" title="Scheduler ç¯‡"></a>Scheduler ç¯‡</h1><div class="note primary flat"><p><a href="https://zlinni.github.io/posts/3541433463">ä»é›¶å¼€å§‹çš„ mini-vueâ‘¦â€”Scheduler ç¯‡</a></p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘£--æ ¸å¿ƒdiffç¯‡</title>
    <link href="https://zlinni.github.io/posts/606001916/"/>
    <id>https://zlinni.github.io/posts/606001916/</id>
    <published>2022-06-08T08:52:44.000Z</published>
    <updated>2022-06-12T02:07:53.740Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯æ ¸å¿ƒ diff ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­ patch çš„æ·±å…¥è®¨è®ºã€‚</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/æ ¸å¿ƒdiff.png" alt=""></p><h1 id="patchArrayChildren-çš„é—®é¢˜"><a href="#patchArrayChildren-çš„é—®é¢˜" class="headerlink" title="patchArrayChildren çš„é—®é¢˜"></a>patchArrayChildren çš„é—®é¢˜</h1><p>åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬å®ç°äº†<code>patchArrayChildren</code>ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™ä¸ªå®ç°æ˜¯æ¯”è¾ƒç®€å•ç²—æš´çš„ï¼Œç›´æ¥å¯¹æ•°ç»„ä¸€å¯¹ä¸€è¿›è¡Œçš„ diff æ“ä½œã€‚</p><p>å®é™…ä¸Šå®ƒè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­</p><blockquote><p>c1: a b c<br>c2: x a b c</p></blockquote><p>æˆ‘ä»¬åœ¨æ–°å­©å­å¤´éƒ¨æ’å…¥äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬åªè¦åœ¨ a å‰é¢æ’å…¥ä¸€ä¸ª x å³å¯ã€‚ä½†æ˜¯æŒ‰ç…§æˆ‘ä»¬ç°åœ¨çš„åšæ³•ï¼Œå®ƒéœ€è¦æ¯ä¸ªéƒ½å˜åŒ–ä¸€æ¬¡ã€‚</p><p>æ‰€ä»¥æœ‰æ²¡æœ‰åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿæœ‰çš„ï¼Œå°±æ˜¯è¦å¼•å…¥ä¸€ä¸ª key å»å‘Šè¯‰æ¡†æ¶ä»€ä¹ˆèŠ‚ç‚¹æ˜¯åº”è¯¥å»å¤ç”¨çš„ï¼Œä»è€Œå‡å°æ“ä½œè™šæ‹Ÿ DOM çš„æ¬¡æ•°</p><p>è€Œæˆ‘ä»¬å‰é¢å®ç°çš„ patchArrayChildren å…¶å®å°±æ˜¯ patchUnkeyedChildren</p><p>è¿™é‡Œå…ˆå·ä¸ªæ‡’ åªè¦ç¬¬ä¸€ä¸ªå…ƒç´ æœ‰ key å°±å½“ä½œæœ‰ key</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (prevShapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">  <span class="comment">// åªè¦ç¬¬ä¸€ä¸ªå…ƒç´ æœ‰keyå°±å½“ä½œæœ‰key</span></span><br><span class="line">  <span class="keyword">if</span> (c1[<span class="number">0</span>] &amp;&amp; c1[<span class="number">0</span>].key != <span class="literal">null</span> &amp;&amp; c2[<span class="number">0</span>] &amp;&amp; c2[<span class="number">0</span>].key != <span class="literal">null</span>) &#123;</span><br><span class="line">    patchkeyedChildren(c1, c2, container, anchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    patchUnkeyedChildren(c1, c2, container, anchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="patchUnkeyedChildren"><a href="#patchUnkeyedChildren" class="headerlink" title="patchUnkeyedChildren"></a>patchUnkeyedChildren</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220608202141.png" alt=""></p><p>æ ¹æ®ä¸Šé¢çš„å›¾ï¼Œæˆ‘ä»¬å…ˆæŒ‰æœ€ç®€å•çš„æ–¹å¼å»å†™ patchkeyedChildrenï¼Œé¦–å…ˆæˆ‘ä»¬éå†æ–°æ—§å­©å­ï¼Œç„¶åï¼Œæ‰¾åˆ° key ä¸€è‡´çš„æ–°æ—§å­©å­å»è¿›è¡Œ patchã€‚patch ä¹‹åå†ç§»åŠ¨åˆ°æ–°èŠ‚ç‚¹çš„ä½ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchkeyedChildren</span>(<span class="params">c1, c2, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾c2</span></span><br><span class="line">    <span class="keyword">const</span> next = c2[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="comment">// æ‰¾c1</span></span><br><span class="line">      <span class="keyword">const</span> prev = c1[i];</span><br><span class="line">      <span class="comment">// keyç›¸åŒ patch</span></span><br><span class="line">      <span class="keyword">if</span> (next.key === prev.key) &#123;</span><br><span class="line">        patch(prev, next, container, anchor);</span><br><span class="line">        <span class="comment">// è€ƒè™‘anchor,æ­¤æ—¶æˆ‘ä»¬patchä¹‹åè¦é‡æ–°æ’åˆ—,æ‰€ä»¥c2çš„ç¬¬ä¸€ä¸ªæ˜¯è¦æ”¾åœ¨c1çš„æœ€å‰é¢çš„,</span></span><br><span class="line">        <span class="comment">// const curAnchor = c1[0].el;</span></span><br><span class="line">        <span class="comment">// ç„¶åc2çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯è¦æ”¾åœ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åé¢,ä»¥æ­¤ç±»æ¨</span></span><br><span class="line">        <span class="comment">// const curAnchor = c2[i-1].el.nextSibling;</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å¯¹è¿™ä¸¤ä¸ªæƒ…å†µè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="keyword">const</span> curAnchor = i === <span class="number">0</span> ? c1[<span class="number">0</span>].el : c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨ insertBeforeç‰¹æ€§,å¦‚æœæ­¤èŠ‚ç‚¹ä¸å­˜åœ¨,åˆ™è¿›è¡Œç§»åŠ¨æ“ä½œ,å­˜åœ¨åˆ™æ’å…¥</span></span><br><span class="line">        container.insertBefore(next.el, curAnchor);</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°å°±break</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maxNewIndexSoFar"><a href="#maxNewIndexSoFar" class="headerlink" title="maxNewIndexSoFar"></a>maxNewIndexSoFar</h2><p>è¿›ä¸€æ­¥ä¼˜åŒ–,å› ä¸ºä¸Šä¸ªç‰ˆæœ¬ä¸ç®¡é¡ºåºå¦‚ä½•éƒ½ä¼šè¿›è¡Œ insertBefore æ“ä½œ.å½“ä»–ç¡®å®éœ€è¦ç§»åŠ¨çš„æ—¶å€™æˆ‘ä»¬æ‰å»ç§»åŠ¨</p><p>ä¸¾ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c1 &gt; a b c</span><br><span class="line">c2 &gt; a c b</span><br><span class="line">maxNewIndexSoFar = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">a -- a c1 = <span class="number">0</span> = <span class="number">0</span> =&gt; maxNewIndexSoFar = <span class="number">0</span></span><br><span class="line">c -- c c1 = <span class="number">2</span> &gt; <span class="number">0</span> =&gt; update maxNewIndexSoFar = <span class="number">2</span></span><br><span class="line">b -- b c1 = <span class="number">1</span> &lt; <span class="number">2</span> =&gt; move b</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªå˜é‡æ¥è®°å½• next åœ¨ c1 ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼,å¦‚æœå°äºè¿™ä¸ªå€¼åˆ™ç§»åŠ¨å¤§äºæˆ–ç­‰äºåˆ™æ›´æ–°è¿™ä¸ªå€¼.è¿™æ ·å°±åšåˆ°äº†æœ‰éœ€è¦ç§»åŠ¨çš„æ—¶å€™æ‰ç§»åŠ¨.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchkeyedChildren</span>(<span class="params">c1, c2, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®°å½•å½“å‰nextåœ¨c1ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼</span></span><br><span class="line">  <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾c2</span></span><br><span class="line">    <span class="keyword">const</span> next = c2[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="comment">// æ‰¾c1</span></span><br><span class="line">      <span class="keyword">const</span> prev = c1[i];</span><br><span class="line">      <span class="comment">// keyç›¸åŒ patch</span></span><br><span class="line">      <span class="keyword">if</span> (next.key === prev.key) &#123;</span><br><span class="line">        patch(prev, next, container, anchor);</span><br><span class="line">        <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">          <span class="comment">// move æ­¤æ—¶iå¿…å®šå¤§äº0 æ‰€ä»¥ä¸éœ€è¦åˆ¤æ–­i===0çš„æƒ…å†µäº†</span></span><br><span class="line">          <span class="keyword">const</span> curAnchor = c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">          container.insertBefore(next.el, curAnchor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// update</span></span><br><span class="line">          maxNewIndexSoFar = j;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="find-æ ‡å¿—ä½"><a href="#find-æ ‡å¿—ä½" class="headerlink" title="find æ ‡å¿—ä½"></a>find æ ‡å¿—ä½</h2><p>å†è€ƒè™‘ c1 ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸åŒ key çš„æƒ…å†µ</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220608214640.png" alt=""></p><p>æ‰€ä»¥æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½,æ¥å†³å®šæ˜¯å¦å­˜åœ¨è¿™ç§æƒ…å†µ,å¦‚æœå¾ªç¯ç»“æŸéƒ½æ²¡ç”¨æ”¹å˜çŠ¶æ€åˆ™è¯´æ˜æ˜¯æ–°çš„èŠ‚ç‚¹,ç›´æ¥æ’å…¥å³å¯.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchkeyedChildren</span>(<span class="params">c1, c2, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®°å½•å½“å‰nextåœ¨c1ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼</span></span><br><span class="line">  <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾c2</span></span><br><span class="line">    <span class="keyword">const</span> next = c2[i];</span><br><span class="line">    <span class="comment">// æ ‡å¿—ä½åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">let</span> find = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="comment">// æ‰¾c1</span></span><br><span class="line">      <span class="keyword">const</span> prev = c1[i];</span><br><span class="line">      <span class="comment">// keyç›¸åŒ patch</span></span><br><span class="line">      <span class="keyword">if</span> (next.key === prev.key) &#123;</span><br><span class="line">        find = <span class="literal">true</span>;</span><br><span class="line">        patch(prev, next, container, anchor);</span><br><span class="line">        <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">          <span class="comment">// move æ­¤æ—¶iå¿…å®šå¤§äº0 æ‰€ä»¥ä¸éœ€è¦åˆ¤æ–­i===0çš„æƒ…å†µäº†</span></span><br><span class="line">          <span class="keyword">const</span> curAnchor = c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">          container.insertBefore(next.el, curAnchor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// update</span></span><br><span class="line">          maxNewIndexSoFar = j;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœåˆ°æœ€åéƒ½æ²¡æ‰¾åˆ°è¯´æ˜è¦æ’å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (!find) &#123;</span><br><span class="line">      <span class="keyword">const</span> curAnchor = i === <span class="number">0</span> ? c1[<span class="number">0</span>].el : c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">      patch(<span class="literal">null</span>, next, container, curAnchor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æ—¶å€™"><a href="#æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æ—¶å€™" class="headerlink" title="æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æ—¶å€™"></a>æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æ—¶å€™</h2><p>è¿˜æœ‰ä¸€ç§æƒ…å†µ,å°±æ˜¯æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æ—¶å€™</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220608215815.png" alt=""></p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±è¦ç§»é™¤å¤šä½™çš„æ—§èŠ‚ç‚¹,éå†æ—§èŠ‚ç‚¹å¦‚æœ c2 ä¸­æ‰¾ä¸åˆ°æ­¤èŠ‚ç‚¹å°±å¸è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éå†c1å¦‚æœæ‰¾ä¸åˆ°åˆ™å¸è½½</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c1.length; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = c1[i];</span><br><span class="line">  <span class="keyword">if</span> (!c2.find(<span class="function">(<span class="params">next</span>) =&gt;</span> next.key === prev.key)) &#123;</span><br><span class="line">    unmount(prev);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="map-ä¼˜åŒ–"><a href="#map-ä¼˜åŒ–" class="headerlink" title="map ä¼˜åŒ–"></a>map ä¼˜åŒ–</h2><p>æ­¤æ—¶æˆ‘ä»¬çš„ç®—æ³•å¤æ‚åº¦æ˜¯ O(nÂ²),æˆ‘ä»¬å¯ä»¥æ‹¿ map æ¥ä¼˜åŒ–ä¸€ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="comment">// ä¿å­˜prevå’Œå®ƒçš„ä¸‹æ ‡</span></span><br><span class="line">c1.forEach(<span class="function">(<span class="params">prev, j</span>) =&gt;</span> &#123;</span><br><span class="line">  map.set(prev.key, &#123;</span><br><span class="line">    prev,</span><br><span class="line">    j,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// è®°å½•å½“å‰nextåœ¨c1ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">  <span class="comment">// æ‰¾c2</span></span><br><span class="line">  <span class="keyword">const</span> next = c2[i];</span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨å°±çœ‹æƒ…å†µæ›¿æ¢</span></span><br><span class="line">  <span class="keyword">if</span> (map.has(next.key)) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; prev, j &#125; = map.get(next.key);</span><br><span class="line">    patch(prev, next, container, anchor);</span><br><span class="line">    <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">      <span class="comment">// move æ­¤æ—¶iå¿…å®šå¤§äº0 æ‰€ä»¥ä¸éœ€è¦åˆ¤æ–­i===0çš„æƒ…å†µäº†</span></span><br><span class="line">      <span class="keyword">const</span> curAnchor = c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">      container.insertBefore(next.el, curAnchor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// update</span></span><br><span class="line">      maxNewIndexSoFar = j;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨å°±ç›¸å½“äºä¹‹å‰find=falseçš„æƒ…å†µ.ç›´æ¥patchæŒ‚è½½</span></span><br><span class="line">    <span class="keyword">const</span> curAnchor = i === <span class="number">0</span> ? c1[<span class="number">0</span>].el : c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">    patch(<span class="literal">null</span>, next, container, curAnchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæˆ‘ä»¬æœ€åçš„æ—§èŠ‚ç‚¹å¤šä½™çš„æƒ…å†µçš„ä¼˜åŒ–,å¯ä»¥é‡‡ç”¨è¿™æ ·çš„æ€è·¯,å¦‚æœå‰é¢çš„èŠ‚ç‚¹æ‰¾åˆ°å°±åˆ é™¤,ä¸€ç›´åˆ°æœ€å,å¦‚æœè¿˜æœ‰å­˜åœ¨çš„èŠ‚ç‚¹,å°±æ˜¯å¤šä½™çš„èŠ‚ç‚¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.has(next.key)) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; prev, j &#125; = map.get(next.key);</span><br><span class="line">  patch(prev, next, container, anchor);</span><br><span class="line">  <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">    <span class="comment">// move æ­¤æ—¶iå¿…å®šå¤§äº0 æ‰€ä»¥ä¸éœ€è¦åˆ¤æ–­i===0çš„æƒ…å†µäº†</span></span><br><span class="line">    <span class="keyword">const</span> curAnchor = c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">    container.insertBefore(next.el, curAnchor);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// update</span></span><br><span class="line">    maxNewIndexSoFar = j;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ¯æ¬¡åŒ¹é…å®Œå°±åˆ é™¤</span></span><br><span class="line">  map.delete(next.key);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// æœ€åå¤šä½™çš„èŠ‚ç‚¹å°±å¸è½½</span></span><br><span class="line">map.forEach(<span class="function">(<span class="params">&#123;prev&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  unmount(prev);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ç®—æ³•å¤æ‚åº¦å°±é™ä½åˆ°äº† O(N)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchkeyedChildren</span>(<span class="params">c1, c2, container, anchor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  c1.forEach(<span class="function">(<span class="params">prev, j</span>) =&gt;</span> &#123;</span><br><span class="line">    map.set(prev.key, &#123;</span><br><span class="line">      prev,</span><br><span class="line">      j,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// è®°å½•å½“å‰nextåœ¨c1ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼</span></span><br><span class="line">  <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾c2</span></span><br><span class="line">    <span class="keyword">const</span> next = c2[i];</span><br><span class="line">    <span class="keyword">const</span> curAnchor = i === <span class="number">0</span> ? c1[<span class="number">0</span>].el : c2[i - <span class="number">1</span>].el.nextSibling;</span><br><span class="line">    <span class="keyword">if</span> (map.has(next.key)) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; prev, j &#125; = map.get(next.key);</span><br><span class="line">      patch(prev, next, container, anchor);</span><br><span class="line">      <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">        container.insertBefore(next.el, curAnchor);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// update</span></span><br><span class="line">        maxNewIndexSoFar = j;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ¯æ¬¡åŒ¹é…å®Œå°±åˆ é™¤</span></span><br><span class="line">      map.delete(next.key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      patch(<span class="literal">null</span>, next, container, curAnchor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ€åå¤šä½™çš„èŠ‚ç‚¹å°±å¸è½½</span></span><br><span class="line">  map.forEach(<span class="function">(<span class="params">&#123; prev &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    unmount(prev);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ®è¯´ä»¥ä¸Šçš„ diff ç®—æ³•å°±æ˜¯ react çš„ diff ç®—æ³•</p><h1 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h1><p>å¯¹äºæ­¤ç®—æ³•æ¥è¯´,æœ‰ä¸€ä¸ªç¼ºç‚¹:<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220608221923.png" alt=""></p><p>è¿™ä¸ªæƒ…å†µè‚‰çœ¼å¯è§åªéœ€è¦ç§»åŠ¨ä¸€æ¬¡ li-c èŠ‚ç‚¹å³å¯.ä½†å®é™…ä¸Š,react çš„ diff ç®—æ³•ç§»åŠ¨äº†ä¸¤æ¬¡</p><p>åŸå› æ˜¯:é¦–å…ˆæ¯”è¾ƒ li-c å‘ç°æ—§èŠ‚ç‚¹ä¸‹æ ‡ 2 çš„åœ°æ–¹å°±æ˜¯ li-c,äºæ˜¯åˆ·æ–° maxNewIndexSoFar ä¸º 2,æ¥ç€ li-a å¼€å§‹æ‰¾,æ‰¾åˆ°ä¸‹æ ‡ 0,0 å°äº 2,æ­¤æ—¶éœ€è¦äº¤æ¢ li-a,li-b å¼€å§‹æ‰¾,æ‰¾åˆ°ä¸‹æ ‡ 1,1 å°äº 2,ä¹Ÿéœ€è¦äº¤æ¢,æ‰€ä»¥è¿™é‡Œæœ‰ç¼ºç‚¹.</p><h1 id="vue2-diff"><a href="#vue2-diff" class="headerlink" title="vue2 diff"></a>vue2 diff</h1><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜,vue2 é‡‡ç”¨äº†åŒç«¯æ¯”è¾ƒçš„æ–¹æ³•,æ¥å¯¹å››ä¸ªç«¯ç‚¹è¿›è¡Œæ¯”è¾ƒå’Œç§»åŠ¨,å¦‚æœéƒ½ä¸è¡Œå†é€ä¸ªæ¯”è¾ƒ.<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220609230958.png" alt=""></p><h1 id="vue3-diff"><a href="#vue3-diff" class="headerlink" title="vue3 diff"></a>vue3 diff</h1><p>åœ¨ Vue3 ä¸­å°†é‡‡ç”¨å¦å¤–ä¸€ç§æ ¸å¿ƒ Diff ç®—æ³•ï¼Œå®ƒå€Ÿé‰´äº ivi å’Œ inferno</p><h2 id="ä»å·¦å¾€å³å†ä»å³å¾€å·¦"><a href="#ä»å·¦å¾€å³å†ä»å³å¾€å·¦" class="headerlink" title="ä»å·¦å¾€å³å†ä»å³å¾€å·¦"></a>ä»å·¦å¾€å³å†ä»å³å¾€å·¦</h2><p>é¦–å…ˆä»å·¦å¾€å³ä¾æ¬¡æ¯”å¯¹ ç„¶åä»å³å¾€å·¦ä¾æ¬¡æ¯”å¯¹<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220609231057.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> e1 = c1.length - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> e2 = c2.length - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ä»å·¦åˆ°å³ä¾æ¬¡æ¯”å¯¹</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2 &amp;&amp; c1[i].key === c2[i].key) &#123;</span><br><span class="line">  patch(c1[i], c2[i], container, anchor);</span><br><span class="line">  i++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä»å³è‡³å·¦ä¾æ¬¡æ¯”å¯¹</span></span><br><span class="line"><span class="keyword">while</span> (i &lt;= e1 &amp;&amp; i &lt;= e2 &amp;&amp; c1[e1].key === c2[e2].key) &#123;</span><br><span class="line">  patch(c1[e1], c2[e2], container, anchor);</span><br><span class="line">  e1--;</span><br><span class="line">  e2--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯¹æ¯”å®Œçš„æƒ…å†µä¸€"><a href="#å¯¹æ¯”å®Œçš„æƒ…å†µä¸€" class="headerlink" title="å¯¹æ¯”å®Œçš„æƒ…å†µä¸€"></a>å¯¹æ¯”å®Œçš„æƒ…å†µä¸€</h2><p>ç»è¿‡ä¸Šè¿°æ“ä½œå¦‚æœå°†æ—§èŠ‚ç‚¹æ¯”å¯¹å®Œ,åˆ™ mount å‰©ä¸‹çš„æ–°èŠ‚ç‚¹ æ­¤æ—¶ i&gt;e1<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220609231202.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (i &gt; e1) &#123;</span><br><span class="line">  <span class="comment">// ä½œä¸ºæ­¤åŒºé—´çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½mount</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> j = i; j &lt;= e2; j++) &#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">const</span> nextPos = e2 + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ­¤æ—¶è¿™ä¸ªèŠ‚ç‚¹å¯èƒ½ä¸ºæœ«å°¾èŠ‚ç‚¹ï¼Œæ‰€ä»¥å¾—å­˜åœ¨æ‰å–</span></span><br><span class="line">    <span class="comment">// å¦åˆ™å°±å–åŸæ¥çš„anchor</span></span><br><span class="line">    <span class="keyword">const</span> curAnchor = (c2[nextPos] &amp;&amp; c2[nextPos].el) || anchor;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ’å…¥</span></span><br><span class="line">    patch(<span class="literal">null</span>, c2[j], container, curAnchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯¹æ¯”å®Œçš„æƒ…å†µäºŒ"><a href="#å¯¹æ¯”å®Œçš„æƒ…å†µäºŒ" class="headerlink" title="å¯¹æ¯”å®Œçš„æƒ…å†µäºŒ"></a>å¯¹æ¯”å®Œçš„æƒ…å†µäºŒ</h2><p>ç»è¿‡ä¸Šè¿°æ“ä½œå¦‚æœå°†æ–°èŠ‚ç‚¹å¯¹æ¯”å®Œ,åˆ™ unmount å‰©ä¸‹çš„æ—§èŠ‚ç‚¹ æ­¤æ—¶ i&gt;e2<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220609231337.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (i &gt; e2) &#123;</span><br><span class="line"> <span class="comment">// è¯´æ˜æ–°çš„èŠ‚ç‚¹è¢«æ¯”å¯¹å®Œæ¯•ï¼Œè¦å»å¸è½½æ—§çš„èŠ‚ç‚¹</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">let</span> j = i; j &lt;= e1; j++) &#123;</span><br><span class="line">   unmount(c1[j]);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸æ»¡è¶³åˆ™é‡‡ç”¨ä¼ ç»Ÿ-diff-æ ‡è®°å’Œåˆ é™¤"><a href="#ä¸æ»¡è¶³åˆ™é‡‡ç”¨ä¼ ç»Ÿ-diff-æ ‡è®°å’Œåˆ é™¤" class="headerlink" title="ä¸æ»¡è¶³åˆ™é‡‡ç”¨ä¼ ç»Ÿ diff(æ ‡è®°å’Œåˆ é™¤)"></a>ä¸æ»¡è¶³åˆ™é‡‡ç”¨ä¼ ç»Ÿ diff(æ ‡è®°å’Œåˆ é™¤)</h2><p>è‹¥ä¸æ»¡è¶³ä»¥ä¸Šçš„æƒ…å†µ,åˆ™é‡‡ç”¨ä¼ ç»Ÿçš„ diff ç®—æ³•,ä½†ä¸çœŸçš„æ·»åŠ å’Œç§»åŠ¨,åªè¿›è¡Œæ ‡è®°å’Œåˆ é™¤ å–å¾—ä¸€ä¸ª source æ•°ç»„ï¼Œ<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220609231503.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="comment">// è‹¥ä»¥ä¸Šéƒ½ä¸æ»¡è¶³åˆ™é‡‡ç”¨ä¼ ç»Ÿçš„diffç®—æ³•ï¼Œä½†ä¸çœŸçš„æ·»åŠ å’Œç§»åŠ¨ï¼Œåªåšæ ‡è®°å’Œåˆ é™¤</span></span><br><span class="line"> <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="comment">//  c1ä¹Ÿå¯èƒ½è¢«æˆªæ–­äº† æ‰€ä»¥æ˜¯</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> j = i; j &lt;= e1; j++) &#123;</span><br><span class="line">  <span class="keyword">const</span> prev = c1[j];</span><br><span class="line">  map.set(prev.key, &#123;</span><br><span class="line">    prev,</span><br><span class="line">    j</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  c1.forEach((prev, j) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//    map.set(prev.key, &#123;</span></span><br><span class="line"><span class="comment">//      prev,</span></span><br><span class="line"><span class="comment">//      j</span></span><br><span class="line"><span class="comment">//    &#125;);</span></span><br><span class="line"><span class="comment">//  &#125;)</span></span><br><span class="line"> <span class="comment">// è®°å½•å½“å‰nextåœ¨c1ä¸­æ‰¾åˆ°çš„æœ€å¤§å€¼</span></span><br><span class="line"> <span class="keyword">let</span> maxNewIndexSoFar = <span class="number">0</span>;</span><br><span class="line"> <span class="comment">// ç§»åŠ¨åˆ¤æ–­æ ‡è¯†</span></span><br><span class="line"> <span class="keyword">let</span> move = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">//  è¿™ä¸ªsourceæ•°ç»„é‡Œé¢å°±æ˜¯å¯¹åº”çš„c1çš„ä¸‹æ ‡ï¼Œå¤šä½™çš„æƒ…å†µå°±æ˜¯-1ï¼Œ-1å°±æ˜¯éœ€è¦ç›´æ¥mountçš„æƒ…å†µ</span></span><br><span class="line"><span class="comment">// ä¸”é•¿åº¦æ˜¯ä¹‹å‰e2çš„é•¿åº¦å‡å»iå†+1</span></span><br><span class="line"> <span class="keyword">const</span> source = <span class="keyword">new</span> <span class="built_in">Array</span>(e2-i+<span class="number">1</span>).fill(-<span class="number">1</span>);</span><br><span class="line"><span class="comment">// c2ä¹Ÿå¯èƒ½è¢«æˆªæ–­äº†æ‰€ä»¥æ˜¯</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>; k &lt; source.length; k++) &#123;</span><br><span class="line">   <span class="comment">// æ‰¾c2</span></span><br><span class="line">   <span class="keyword">const</span> next = c2[k+i];</span><br><span class="line">   <span class="comment">// const curAnchor = i === 0 ? c1[0].el : c2[i - 1].el.nextSibling;</span></span><br><span class="line">   <span class="keyword">if</span> (map.has(next.key)) &#123;</span><br><span class="line">     <span class="keyword">const</span> &#123;</span><br><span class="line">       prev,</span><br><span class="line">       j</span><br><span class="line">     &#125; = map.get(next.key);</span><br><span class="line">     patch(prev, next, container, anchor);</span><br><span class="line">     <span class="keyword">if</span> (j &lt; maxNewIndexSoFar) &#123;</span><br><span class="line">       <span class="comment">// ä»£è¡¨éœ€è¦ç§»åŠ¨</span></span><br><span class="line">       move = <span class="literal">true</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// update</span></span><br><span class="line">       maxNewIndexSoFar = j;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// å¾—åˆ°sourceæ•°ç»„</span></span><br><span class="line">     source[k] = j;</span><br><span class="line">     <span class="comment">// æ¯æ¬¡åŒ¹é…å®Œå°±åˆ é™¤</span></span><br><span class="line">     map.delete(next.key);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="comment">// todo</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// æœ€åå¤šä½™çš„èŠ‚ç‚¹å°±å¸è½½</span></span><br><span class="line"> map.forEach(<span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">   prev</span></span></span><br><span class="line"><span class="params"><span class="function"> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">   unmount(prev)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¦ç¼–å†™ move çš„æƒ…å†µäº†,éœ€è¦ç§»åŠ¨çš„è¯,æˆ‘ä»¬è¦é‡‡ç”¨æœ€é•¿ä¸Šå‡å­åºåˆ—ç®—æ³•.</p><h2 id="æœ€é•¿ä¸Šå‡å­åºåˆ—"><a href="#æœ€é•¿ä¸Šå‡å­åºåˆ—" class="headerlink" title="æœ€é•¿ä¸Šå‡å­åºåˆ—"></a>æœ€é•¿ä¸Šå‡å­åºåˆ—</h2><p>å…ˆè¯´ç»“è®º,æœ€é•¿ä¸Šå‡å­åºåˆ—çš„èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨,ç”¨è¿™ä¸ªç®—æ³•ä¼šå¾—åˆ° source æ•°ç»„é‡Œé¢æœ€é•¿ä¸Šå‡å­åºåˆ—çš„å¯¹åº”ä¸‹æ ‡ï¼Œåˆèµ·æ¥æ˜¯ä¸€ä¸ª seq æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„é‡Œé¢çš„å…ƒç´ ä¸éœ€è¦ç§»åŠ¨ã€‚</p><div class="note primary flat"><p>TIP</p><p>ä»€ä¹ˆæ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼šç»™å®šä¸€ä¸ªæ•°å€¼åºåˆ—ï¼Œæ‰¾åˆ°å®ƒçš„ä¸€ä¸ªå­åºåˆ—ï¼Œå¹¶ä¸”å­åºåˆ—ä¸­çš„å€¼æ˜¯é€’å¢çš„ï¼Œå­åºåˆ—ä¸­çš„å…ƒç´ åœ¨åŸåºåˆ—ä¸­ä¸ä¸€å®šè¿ç»­ã€‚</p><p>ä¾‹å¦‚ç»™å®šæ•°å€¼åºåˆ—ä¸ºï¼š[ 0, 8, 4, 12 ]</p><p>é‚£ä¹ˆå®ƒçš„æœ€é•¿é€’å¢å­åºåˆ—å°±æ˜¯ï¼š[0, 8, 12]</p><p>å½“ç„¶ç­”æ¡ˆå¯èƒ½æœ‰å¤šç§æƒ…å†µï¼Œä¾‹å¦‚ï¼š[0, 4, 12] ä¹Ÿæ˜¯å¯ä»¥çš„</p></div><p>å‡è®¾æˆ‘ä»¬ç°åœ¨å·²ç»é‡‡å–äº†æœ€é•¿ä¸Šå‡å­åºåˆ—ç®—æ³•å®Œæˆäº† seq æ•°ç»„ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥çš„åˆ¤æ–­ã€‚</p><p>è®¾ä¸¤ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘ source å’Œ seq çš„æœ«å°¾ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seq = getSequence(source);</span><br><span class="line"><span class="comment">// ä»æœ«å°¾å‘å‰éå†</span></span><br><span class="line"><span class="keyword">let</span> j = seq.length - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> k = source.length - <span class="number">1</span>; k &gt;= <span class="number">0</span>; k--) &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸éœ€è¦ç§»åŠ¨çš„æƒ…å†µ"><a href="#ä¸éœ€è¦ç§»åŠ¨çš„æƒ…å†µ" class="headerlink" title="ä¸éœ€è¦ç§»åŠ¨çš„æƒ…å†µ"></a>ä¸éœ€è¦ç§»åŠ¨çš„æƒ…å†µ</h3><p>å¦‚æœæ­¤æ—¶ seq ä¸­çš„å€¼å’Œ source çš„ä¸‹æ ‡å¯¹åº”ï¼Œè¯´æ˜ä¸éœ€è¦ç§»åŠ¨,ä¸¤æŒ‡é’ˆéƒ½å‡ä¸€è¿›è¡Œä¸‹ä¸€è½®æ¯”è¾ƒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (seq[j] == k) &#123;</span><br><span class="line">  <span class="comment">// ä¸ç”¨ç§»åŠ¨</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶kå’Œæœ€é•¿ä¸Šå‡å­åºåˆ—çš„å€¼ä¸€æ ·,ç›´æ¥j--è®©ä»–è¿›å…¥ä¸‹ä¸€è½®çš„æ¯”è¾ƒ</span></span><br><span class="line">  j--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éœ€è¦-mount-çš„æƒ…å†µ"><a href="#éœ€è¦-mount-çš„æƒ…å†µ" class="headerlink" title="éœ€è¦ mount çš„æƒ…å†µ"></a>éœ€è¦ mount çš„æƒ…å†µ</h3><p>å¦‚æœæ­¤æ—¶ source çš„å€¼ä¸º-1ï¼Œè¯´æ˜è¿™ä¸ªèŠ‚ç‚¹éœ€è¦ mountï¼Œsource æŒ‡é’ˆå‡ä¸€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (source[k] === -<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// mount todo curAnchor pos</span></span><br><span class="line">  patch(<span class="literal">null</span>, c2[pos], container, curAnchor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éœ€è¦ç§»åŠ¨çš„æƒ…å†µ"><a href="#éœ€è¦ç§»åŠ¨çš„æƒ…å†µ" class="headerlink" title="éœ€è¦ç§»åŠ¨çš„æƒ…å†µ"></a>éœ€è¦ç§»åŠ¨çš„æƒ…å†µ</h3><p>å¦‚æœæ­¤æ—¶ source çš„å€¼ä¸ä¸º-1 ä¸”å®ƒçš„ä¸‹æ ‡åˆä¸å’Œ seq ä¸­çš„å€¼å¯¹åº”ï¼Œåˆ™éœ€è¦ç§»åŠ¨ï¼Œsource å‡ä¸€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (...) &#123;</span><br><span class="line">  <span class="comment">// ç§»åŠ¨ todo curAnchor pos</span></span><br><span class="line">  container.insertBefore(c2[pos].el, curAnchor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„-anchor"><a href="#æ³¨æ„-anchor" class="headerlink" title="æ³¨æ„ anchor"></a>æ³¨æ„ anchor</h3><p>é‚£ä¹ˆç°åœ¨çš„é—®é¢˜æ˜¯è¿™ä¸ª anchor å’Œ pos è¦æ€ä¹ˆå†™ï¼Œå¯¹äº posï¼Œå› ä¸ºæ­¤æ—¶æˆ‘ä»¬æ˜¯è¿›è¡Œäº†å‰é¢è¯´çš„ä¸€äºŒå¤§æ­¥éª¤æ‰è¿›å…¥è¿™ä¸ªä¼ ç»Ÿ diff çš„ï¼Œå·²ç»èµ°äº† i æ­¥ï¼Œæ‰€ä»¥èµ·ç‚¹è¦åŠ  iã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pos = k + i;</span><br></pre></td></tr></table></figure><p>å¯¹äº anchor æ¥è¯´ï¼Œå®ƒå…¶å®å°±æ˜¯å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä½ï¼Œå½“ç„¶è¿˜è¦è€ƒè™‘æœ«å°¾çš„æƒ…å†µæ‰€ä»¥æ˜¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nextPos = pos + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> curAnchor = (c2[nextPos] &amp;&amp; c2[nextPos].el) || anchor;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°ä¸Šé¢æœ‰ä¸¤ç§æƒ…å†µéƒ½éœ€è¦ anchor å’Œ posï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆå¹¶ä¸€ä¸‹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (move) &#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°æœ€é•¿ä¸Šå‡å­åºåˆ—çš„ä¸‹æ ‡</span></span><br><span class="line">  <span class="keyword">const</span> seq = getSequence(source);</span><br><span class="line">  <span class="comment">// ä»æœ«å°¾å‘å‰éå†</span></span><br><span class="line">  <span class="keyword">let</span> j = seq.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> k = source.length - <span class="number">1</span>; k &gt;= <span class="number">0</span>; k--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (seq[j] == k) &#123;</span><br><span class="line">      <span class="comment">// ä¸ç”¨ç§»åŠ¨</span></span><br><span class="line">      <span class="comment">// æ­¤æ—¶kå’Œæœ€é•¿ä¸Šå‡å­åºåˆ—çš„å€¼ä¸€æ ·,ç›´æ¥j--è®©ä»–è¿›å…¥ä¸‹ä¸€è½®çš„æ¯”è¾ƒ</span></span><br><span class="line">      j--;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// æŒ‚è½½èŠ‚ç‚¹çš„ä¸‹æ ‡å°±æ˜¯kï¼Œå› ä¸ºèµ·ç‚¹å˜äº†æ‰€ä»¥è¦åŠ i</span></span><br><span class="line">      <span class="keyword">const</span> pos = k + i;</span><br><span class="line">      <span class="comment">// anchorå°±æ˜¯å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä½</span></span><br><span class="line">      <span class="keyword">const</span> nextPos = pos + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">const</span> curAnchor = (c2[nextPos] &amp;&amp; c2[nextPos].el) || anchor;</span><br><span class="line">      <span class="keyword">if</span> (source[k] === -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// mount</span></span><br><span class="line">        patch(<span class="literal">null</span>, c2[pos], container, curAnchor);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ç§»åŠ¨</span></span><br><span class="line">        container.insertBefore(c2[pos].el, curAnchor);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç‰¹æ®Šæƒ…å†µï¼šä¸éœ€è¦ç§»åŠ¨ï¼Œä½†è¿˜æœ‰æœªæ·»åŠ çš„å…ƒç´ "><a href="#ç‰¹æ®Šæƒ…å†µï¼šä¸éœ€è¦ç§»åŠ¨ï¼Œä½†è¿˜æœ‰æœªæ·»åŠ çš„å…ƒç´ " class="headerlink" title="ç‰¹æ®Šæƒ…å†µï¼šä¸éœ€è¦ç§»åŠ¨ï¼Œä½†è¿˜æœ‰æœªæ·»åŠ çš„å…ƒç´ "></a>ç‰¹æ®Šæƒ…å†µï¼šä¸éœ€è¦ç§»åŠ¨ï¼Œä½†è¿˜æœ‰æœªæ·»åŠ çš„å…ƒç´ </h2><blockquote><p>c1: a b c<br>c2: a x b y c<br>source: [1,-1,2,-1,3]<br>seq: [1,2,3]</p></blockquote><p>ä¸Šé¢çš„ä¾‹å­ï¼Œ<code>move</code> æ˜¯ <code>false</code>ï¼Œå› æ­¤ä¸“é—¨ç”¨ä¸€ä¸ª <code>toMounted</code> å»å¤„ç†è¿™ç§æƒ…å†µ<br><code>toMounted</code> è®°å½•å¾…æ–°å¢çš„å…ƒç´ çš„ä¸‹æ ‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toMounted = [];</span><br><span class="line">...</span><br><span class="line"><span class="comment">// å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼ŒæŠŠä¸‹æ ‡æ·»åŠ ç»™toMounted</span></span><br><span class="line"><span class="keyword">if</span>(...)&#123;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  toMounted(k+i);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(toMounted.length)&#123;</span><br><span class="line">  <span class="comment">// å› ä¸ºåˆ¤æ–­æ’å…¥æ‰€ä»¥ä¾æ—§æ˜¯ä»åå¾€å‰</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> k=toMounted.length-<span class="number">1</span>;k&gt;=<span class="number">0</span>;k--)&#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºåˆšåˆšä¸‹æ ‡å°±æ˜¯ç»™äº†toMounted æ‰€ä»¥æ­¤æ—¶çš„åæ ‡å°±æ˜¯toMountedä¸­çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">const</span> pos = toMounted[k];</span><br><span class="line">    <span class="keyword">const</span> nextPos = pos+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> curAnchor = (c2[nextPos]&amp;&amp;c2[nextPos].el) || anchor;</span><br><span class="line">    patch(<span class="literal">null</span>,c2[pos],container,curAnchor);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note primary flat"><p>è‡³æ­¤é™¤äº†æœ€é•¿ä¸Šå‡å­åºåˆ—æ–¹æ³•ä¹‹å¤–éƒ½å®Œæˆäº†</p></div><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘ä»¬åœ¨è¿™ä¸€èŠ‚é€šè¿‡ patchArrayChildren æš´éœ²å‡ºæ¥çš„ä¸€å¯¹ä¸€å¯¹æ¯”ä½æ•ˆçš„é—®é¢˜,æ‰¾åˆ°äº†æ·»åŠ  key å»åˆ¤æ–­çš„è§£å†³æ–¹æ³•,å…¶ä¸­ç¼–å†™äº† patchUnkeyedChildren æ¥å¯¹æ¯”æ–°æ—§å­©å­,æ‰¾åˆ° key ä¸€è‡´çš„å­©å­å»è¿›è¡Œ patch,ç„¶åæˆ‘ä»¬é€šè¿‡ maxNewIndexSoFar å»ä¼˜åŒ– insertBefore çš„æƒ…å†µï¼Œè®©å®ƒåœ¨åˆé€‚çš„æ—¶å€™æ‰æ’å…¥ï¼Œå†é€šè¿‡ find æ ‡å¿—ä½æ ‡å¿—æ–°èŠ‚ç‚¹æ²¡æœ‰æ‰¾åˆ°æ—§èŠ‚ç‚¹çš„æƒ…å†µï¼Œç›´æ¥ mountï¼Œéšåå†åˆ¤æ–­æ—§èŠ‚ç‚¹å¤šäºæ–°èŠ‚ç‚¹çš„æƒ…å†µï¼Œç›´æ¥å¸è½½å¤šä½™çš„æ—§èŠ‚ç‚¹ã€‚æ¥ç€æˆ‘ä»¬é€šè¿‡ map ä¼˜åŒ–äº†ä¸Šè¿°çš„å¾ªç¯ä»£ç ï¼Œè®©å¤æ‚åº¦ä» O(nÂ²)é™ä½åˆ° O(n).</p><p>å½“æˆ‘ä»¬å®Œæˆååˆæ ¹æ®ä¸€ä¸ªç®€å•çš„ä¾‹å­(ç§»åŠ¨å¤šæ¬¡)å‘ç°è¯¥ diff ç®—æ³•çš„ç¼ºç‚¹ï¼Œéšåçœ‹åˆ°äº† vue2 vue3 è§£å†³è¯¥é—®é¢˜çš„æ–¹æ³•ã€‚å…¶ä¸­æˆ‘ä»¬å¯¹ vue3 çš„ diff ç®—æ³•è¿›è¡Œæ·±å…¥äº†è§£ã€‚vue3 çš„ diff æ˜¯å…ˆä»å·¦å¾€å³å¯¹æ¯”å†ä»å³å¾€å·¦å¯¹æ¯”ï¼Œæ‰¾åˆ°éœ€è¦ mount çš„æ–°èŠ‚ç‚¹åŒºé—´æˆ–éœ€è¦å¸è½½çš„æ—§èŠ‚ç‚¹åŒºé—´ã€‚æ‰¾ä¸åˆ°è¿™ä¸¤ä¸ªæƒ…å†µå°±è¿›è¡Œä¼ ç»Ÿçš„ diffï¼Œä¸è¿‡ä¸è¿›è¡ŒæŒ‚è½½å’Œç§»åŠ¨ï¼Œè¿˜æ˜¯ç”¨ä¸€ä¸ª map è¿›è¡Œæ ‡è®°å’Œåˆ é™¤ã€‚ä¹‹åå¯¹äºå…ˆå‰ react ç®—æ³•çš„ç¼ºç‚¹ï¼Œç”¨æœ€é•¿ä¸Šå‡å­åºåˆ—è§£å†³ã€‚æœ€é•¿ä¸Šå‡å­åºåˆ—çš„æ•°ç»„å†…çš„å…ƒç´ ä¸éœ€è¦ç§»åŠ¨ã€‚æˆ‘ä»¬åˆåˆ¤æ–­äº†æŒ‚è½½(source ä¸º-1)å’Œç§»åŠ¨(ä¸ä¸º-1 åˆä¸å’Œ seq å¯¹ä¸Š)çš„æƒ…å†µï¼Œæ¥è¿›è¡ŒæŒ‚è½½å’Œç§»åŠ¨çš„æ“ä½œã€‚æœ€åå¯¹äºç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯æ—§èŠ‚ç‚¹é—´å¤¹æ‚éœ€è¦æŒ‚è½½çš„æ–°èŠ‚ç‚¹çš„æƒ…å†µã€‚å»è®¾ç½®ä¸€ä¸ª toMounted æ•°ç»„ï¼Œåœ¨é move çš„æƒ…å†µæ—¶æŠŠå¯¹åº”çš„ä¸‹æ ‡åŠ å…¥åˆ°æ•°ç»„ä¸­ï¼Œåé¢å•ç‹¬æ‹¿å‡ºæ¥æŒ‚è½½ã€‚</p><p>æœ¬èŠ‚çš„é—æ¼çš„æœ€é•¿ä¸Šå‡å­åºåˆ—ç®—æ³•å°†åœ¨ä¸‹ä¸€èŠ‚è®²è¿°ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘¡--vnodeç¯‡</title>
    <link href="https://zlinni.github.io/posts/2797606246/"/>
    <id>https://zlinni.github.io/posts/2797606246/</id>
    <published>2022-06-06T02:26:33.000Z</published>
    <updated>2022-06-10T08:29:49.555Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯è™šæ‹Ÿ DOM ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­å“åº”å¼çš„ç¯‡ç« ï¼ŒåŒ…å«äº†<code>vnode</code>,<code>render</code>çš„å®ç°</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/è™šæ‹ŸDOM.png" alt=""></p><h1 id="vnode"><a href="#vnode" class="headerlink" title="vnode"></a>vnode</h1><p>æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†ä¼šå®ç°è¿™æ ·çš„ä¾‹å­(æ³¨æ„ html ä¸­ä½¿ç”¨ <code>defer</code> æŒ‚è½½ jsï¼Œä»¥åŠä½¿ç”¨æ ·å¼)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; render, h, Text &#125; <span class="keyword">from</span> <span class="string">&quot;./runtime&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ©ç”¨hç”Ÿæˆvnode</span></span><br><span class="line"><span class="keyword">const</span> vnode = h(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">class</span>: <span class="string">&quot;a b&quot;</span>,</span><br><span class="line">    <span class="attr">style</span>: &#123;</span><br><span class="line">      <span class="attr">border</span>: <span class="string">&quot;1px solid&quot;</span>,</span><br><span class="line">      <span class="attr">fontSize</span>: <span class="string">&quot;14px&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onClick</span>: <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;click&quot;</span>),</span><br><span class="line">    <span class="attr">checked</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">custom</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  [</span><br><span class="line">    h(<span class="string">&quot;ul&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">&quot;red&quot;</span> &#125; &#125;, <span class="number">1</span>),</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, <span class="number">2</span>),</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">style</span>: &#123; <span class="attr">color</span>: <span class="string">&quot;blue&quot;</span> &#125; &#125;, <span class="number">3</span>),</span><br><span class="line">      h(<span class="string">&quot;li&quot;</span>, <span class="literal">null</span>, [h(Text, <span class="literal">null</span>, <span class="string">&quot;hello world&quot;</span>)]),</span><br><span class="line">    ]),</span><br><span class="line">  ]</span><br><span class="line">);</span><br><span class="line"><span class="comment">// å°†ç”Ÿæˆçš„vnodeæŒ‚è½½åˆ°bodyä¸Š</span></span><br><span class="line">render(vnode, <span class="built_in">document</span>.body);</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* &lt;style&gt;</span></span><br><span class="line"><span class="comment">  .a &#123;</span></span><br><span class="line"><span class="comment">    background-color: aqua;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  .b &#123;</span></span><br><span class="line"><span class="comment">    padding: 20px;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&lt;/style&gt; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨å®Œæˆè¿™ä¸ªä¾‹å­ä¹‹å‰ï¼Œè¿˜æ˜¯æœ‰å¿…è¦äº†è§£ä¸€ä¸‹è™šæ‹Ÿ DOM çš„ç§ç±»</p><h1 id="è™šæ‹Ÿ-DOM-çš„ç§ç±»"><a href="#è™šæ‹Ÿ-DOM-çš„ç§ç±»" class="headerlink" title="è™šæ‹Ÿ DOM çš„ç§ç±»"></a>è™šæ‹Ÿ DOM çš„ç§ç±»</h1><ol><li>Element<br>element å¯¹åº”æ™®é€šå…ƒç´ ï¼ŒåŸç†æ˜¯ä½¿ç”¨ <code>document.createElement()</code>åˆ›å»ºçš„ã€‚<code>type</code> æŒ‡çš„æ˜¯æ ‡ç­¾åï¼Œ<code>props</code> æŒ‡çš„æ˜¯å…ƒç´ å±æ€§ï¼Œ<code>children</code> æŒ‡å­å…ƒç´ ï¼Œå¯ä»¥ä¸ºå­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™ä»£è¡¨åªæœ‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹å®šä¹‰</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">props</span>:<span class="built_in">Object</span>,</span><br><span class="line">  <span class="attr">children</span>:<span class="built_in">string</span> | VNode[]</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸¾ä¾‹</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  <span class="attr">props</span>:&#123;<span class="attr">class</span>:<span class="string">&#x27;a&#x27;</span>&#125;,</span><br><span class="line">  <span class="attr">children</span>:<span class="string">&#x27;hello&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Text<br>text å¯¹åº”æ–‡æœ¬èŠ‚ç‚¹ï¼ŒåŸç†æ˜¯ä½¿ç”¨ <code>document.createTextNode()</code>åˆ›å»ºçš„ã€‚<code>type</code> å®šä¹‰ä¸ºä¸€ä¸ª <code>Symbol</code>ï¼Œ<code>props</code> ä¸ºç©ºï¼Œ<code>children</code> ä¸ºå­—ç¬¦ä¸²ï¼ŒæŒ‡å…·ä½“çš„æ–‡æœ¬å†…å®¹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹å®šä¹‰</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">Symbol</span>,</span><br><span class="line">  <span class="attr">props</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">children</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Fragment<br>Fragment ä¸ºä¸€ä¸ªä¸ä¼šçœŸå®æ¸²æŸ“çš„èŠ‚ç‚¹ã€‚ç›¸å½“äº <code>template</code> æˆ– <code>react</code> çš„ Fragmentã€‚<code>type</code> ä¸ºä¸€ä¸ª <code>Symbol</code>ï¼Œ<code>props</code> ä¸ºç©ºï¼Œ<code>children</code> ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºå­èŠ‚ç‚¹ã€‚æœ€åæ¸²æŸ“çš„æ—¶å€™ä¼šæŒ‚è½½åˆ° Fragment çš„çˆ¶èŠ‚ç‚¹ä¸Šé¢ã€‚</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹å®šä¹‰</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">Symbol</span>,</span><br><span class="line">  <span class="attr">props</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">children</span>:[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Component<br>Component æ˜¯ç»„ä»¶ï¼Œç»„ä»¶æœ‰è‡ªå·±çš„ä¸€å¥—ç‰¹æ®Šçš„æ¸²æŸ“æ–¹æ³•ï¼Œä½†ç»„ä»¶æœ€ç»ˆçš„äº§ç‰©ä¹Ÿæ˜¯ä¸Šé¢ä¸‰ç§ VNode çš„é›†åˆã€‚ç»„ä»¶çš„ <code>type</code>ï¼Œå°±æ˜¯å®šä¹‰ç»„ä»¶çš„å¯¹è±¡ï¼Œ<code>props</code> å³æ˜¯å¤–éƒ¨ä¼ å…¥ç»„ä»¶çš„ <code>props</code> æ•°æ®ï¼Œ<code>children</code> å³æ˜¯ç»„ä»¶çš„ <code>slot</code>(ä¸å‡†å¤‡å®ç° <code>slot</code> è·³è¿‡)</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç±»å‹å®šä¹‰</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">Object</span>,</span><br><span class="line">  <span class="attr">props</span>:<span class="built_in">Object</span>,</span><br><span class="line">  <span class="attr">children</span>:<span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸¾ä¾‹</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:&#123;</span><br><span class="line">    <span class="attr">template</span>:<span class="string">`&#123;&#123;msg&#125;&#125;&#123;&#123;name&#125;&#125;`</span>,</span><br><span class="line">    <span class="attr">props</span>:[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">    <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">props</span>:&#123;</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&#x27;world&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ShapeFlags-å¿«é€Ÿæ ‡è¯†-VNode-çš„ç±»å‹"><a href="#ShapeFlags-å¿«é€Ÿæ ‡è¯†-VNode-çš„ç±»å‹" class="headerlink" title="ShapeFlags å¿«é€Ÿæ ‡è¯† VNode çš„ç±»å‹"></a>ShapeFlags å¿«é€Ÿæ ‡è¯† VNode çš„ç±»å‹</h1><p><code>ShapeFlags</code> æ˜¯ä¸€ç»„æ ‡è®°ï¼Œç”¨äºå¿«é€Ÿè¾¨è¯† VNode çš„ç±»å‹</p><h2 id="å¤ä¹ ä½è¿ç®—"><a href="#å¤ä¹ ä½è¿ç®—" class="headerlink" title="å¤ä¹ ä½è¿ç®—"></a>å¤ä¹ ä½è¿ç®—</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰ä½ä¸è¿ç®— ç›¸åŒçš„ä¸å˜ ä¸åŒçš„ä¸º0</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line">&amp;</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="comment">// æŒ‰ä½æˆ–è¿ç®— ç›¸åŒçš„ä¸å˜ ä¸åŒçš„ä¸º1</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line">|</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="ShapeFlags-çš„ç”Ÿæˆ"><a href="#ShapeFlags-çš„ç”Ÿæˆ" class="headerlink" title="ShapeFlags çš„ç”Ÿæˆ"></a>ShapeFlags çš„ç”Ÿæˆ</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ShapeFlags = &#123;</span><br><span class="line">  <span class="attr">ELEMENT</span>: <span class="number">1</span>, <span class="comment">// 00000001</span></span><br><span class="line">  <span class="attr">TEXT</span>: <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="comment">// 00000010</span></span><br><span class="line">  <span class="attr">FRAGMENT</span>: <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="comment">// 00000100</span></span><br><span class="line">  <span class="attr">COMPONENT</span>: <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="comment">// 00001000</span></span><br><span class="line">  <span class="attr">TEXT_CHILDREN</span>: <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="comment">// 00010000</span></span><br><span class="line">  <span class="attr">ARRAY_CHILDREN</span>: <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="comment">// 00100000</span></span><br><span class="line">  <span class="attr">CHILDREN</span>: (<span class="number">1</span> &lt;&lt; <span class="number">4</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>), <span class="comment">//00110000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ä»–åˆ©ç”¨äº†äºŒè¿›åˆ¶ä½è¿ç®—<code>&lt;&lt;</code>å’Œ<code>|</code>ç”Ÿæˆï¼Œä½¿ç”¨çš„æ—¶å€™ç”¨<code>&amp;</code>åˆ¤æ–­ï¼Œå¦‚ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flag &amp; ShapeFlags.ELEMENT)</span><br></pre></td></tr></table></figure><p>å†ä¾‹å¦‚ï¼Œä¸€ä¸ªå€¼ä¸º 33 çš„ flagï¼Œå®ƒçš„äºŒè¿›åˆ¶å€¼ä¸º 00100001ï¼Œé‚£ä¹ˆå®ƒï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> flag = <span class="number">33</span>;</span><br><span class="line">flag &amp; ShapeFlags.ELEMENT; <span class="comment">// true</span></span><br><span class="line">flag &amp; ShapeFlags.ARRAY_CHILDREN; <span class="comment">// true</span></span><br><span class="line">flag &amp; ShapeFlags.CHILDREN; <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>å®ƒçš„ç”Ÿæˆè¿˜å¯ä»¥ç”¨ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> flag = ShapeFlags.ELEMENT | ShapeFlags.ARRAY_CHILDREN;</span><br></pre></td></tr></table></figure><h1 id="VNode-åˆæ­¥å½¢æ€"><a href="#VNode-åˆæ­¥å½¢æ€" class="headerlink" title="VNode åˆæ­¥å½¢æ€"></a>VNode åˆæ­¥å½¢æ€</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type,</span><br><span class="line">  props,</span><br><span class="line">  children,</span><br><span class="line">  shapeFlag,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="h-å‡½æ•°â€”ç”Ÿæˆ-VNode"><a href="#h-å‡½æ•°â€”ç”Ÿæˆ-VNode" class="headerlink" title="h å‡½æ•°â€”ç”Ÿæˆ VNode"></a>h å‡½æ•°â€”ç”Ÿæˆ VNode</h1><p><code>h</code> å‡½æ•°çš„ç”¨é€”å°±æ˜¯ç”Ÿæˆ VNodeã€‚<br>å®ƒæ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š<code>type</code>, <code>props</code>, <code>children</code>, è¿”å›ä¸€ä¸ª VNode</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isArray, isNumber, isString &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ShapeFlags = &#123;</span><br><span class="line">  <span class="attr">ELEMENT</span>: <span class="number">1</span>, <span class="comment">// 00000001</span></span><br><span class="line">  <span class="attr">TEXT</span>: <span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="comment">// 00000010</span></span><br><span class="line">  <span class="attr">FRAGMENT</span>: <span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="comment">// 00000100</span></span><br><span class="line">  <span class="attr">COMPONENT</span>: <span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="comment">// 00001000</span></span><br><span class="line">  <span class="attr">TEXT_CHILDREN</span>: <span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="comment">// 00010000</span></span><br><span class="line">  <span class="attr">ARRAY_CHILDREN</span>: <span class="number">1</span> &lt;&lt; <span class="number">5</span>, <span class="comment">// 00100000</span></span><br><span class="line">  <span class="attr">CHILDREN</span>: (<span class="number">1</span> &lt;&lt; <span class="number">4</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>), <span class="comment">//00110000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Text = <span class="built_in">Symbol</span>(<span class="string">&quot;Text&quot;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Fragment = <span class="built_in">Symbol</span>(<span class="string">&quot;Fragment&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String | Object | Text | Fragment&#125;</span> <span class="variable">type</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Object | null&#125;</span> <span class="variable">props</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String | Number | Array | null&#125;</span> <span class="variable">children</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="variable">VNode</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">type, props, children</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­shapeFlagå¾—åˆ°å®ƒçš„ç±»å‹</span></span><br><span class="line">  <span class="keyword">let</span> shapeFlag = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (isString(type)) &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.ELEMENT;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === Text) &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.TEXT;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === Fragment) &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.FRAGMENT;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.COMPONENT;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å†åˆ¤æ–­children</span></span><br><span class="line">  <span class="keyword">if</span> (isString(children) || isNumber(children)) &#123;</span><br><span class="line">    shapeFlag |= ShapeFlags.TEXT_CHILDREN;</span><br><span class="line">    <span class="comment">// æ•°å­—è½¬å­—ç¬¦ä¸²</span></span><br><span class="line">    children = children.toString();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(children)) &#123;</span><br><span class="line">    shapeFlag |= ShapeFlags.ARRAY_CHILDREN;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    children,</span><br><span class="line">    shapeFlag,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="render-æŒ‚è½½è™šæ‹Ÿ-DOM"><a href="#render-æŒ‚è½½è™šæ‹Ÿ-DOM" class="headerlink" title="render æŒ‚è½½è™šæ‹Ÿ DOM"></a>render æŒ‚è½½è™šæ‹Ÿ DOM</h1><p>è¿™ä¸€æ­¥æˆ‘ä»¬è¦å°† <code>vnode</code> ä¸­çš„ shapeFlag è§£æå¹¶åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„èŠ‚ç‚¹ç±»å‹è¿›è¡Œä¸åŒçš„æŒ‚è½½æ“ä½œ</p><p><code>render</code> éœ€è¦æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯èŠ‚ç‚¹ <code>vnode</code>ï¼Œä¸€ä¸ªæ˜¯æŒ‚è½½çš„å®¹å™¨ <code>container</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isBoolean &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ShapeFlags &#125; <span class="keyword">from</span> <span class="string">&quot;./vnode&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  mount(vnode, container);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŒ‚è½½è™šæ‹Ÿdom</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è§£æshapeFlag</span></span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag &#125; = vnode;</span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">    mountElement(vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT) &#123;</span><br><span class="line">    mountTextNode(vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.FRAGMENT) &#123;</span><br><span class="line">    mountFragment(vnode, container);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mountComponent(vnode, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬è¿˜è¦æ“ä½œå››ç§ç±»å‹çš„æŒ‚è½½ï¼Œåˆ†åˆ«æ˜¯</p><ol><li>å…ƒç´ æŒ‚è½½ <code>mountElement</code></li><li>æ–‡æœ¬èŠ‚ç‚¹æŒ‚è½½ <code>mountTextNode</code></li><li>è™šæ‹ŸèŠ‚ç‚¹æŒ‚è½½ <code>mountFragment</code></li><li>ç»„ä»¶æŒ‚è½½ <code>mountComponent</code></li></ol><h2 id="mountElement"><a href="#mountElement" class="headerlink" title="mountElement"></a>mountElement</h2><p>å¯¹äºæˆ‘ä»¬çš„ element ç±»å‹ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“äº†ä»–çš„åº•å±‚æ˜¯é  <code>document.createElement</code> æ–¹æ³•æ¥ç”Ÿæˆå…ƒç´ çš„ï¼Œç”Ÿæˆä¹‹åæˆ‘ä»¬éœ€è¦å°† <code>props</code> æŒ‚è½½åˆ°è¯¥å…ƒç´ ä¸Šï¼Œå†å°†å­èŠ‚ç‚¹æŒ‚è½½åˆ°å…ƒç´ ä¸Šï¼Œç„¶åæŒ‚è½½åˆ°å®¹å™¨å†…ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>ç”Ÿæˆå…ƒç´  el</li><li>æŒ‚è½½ <code>props</code> åˆ° el <code>mountProps</code></li><li>æŒ‚è½½å­èŠ‚ç‚¹åˆ° el <code>mountChildren</code></li><li>æŒ‚è½½ el åˆ° <code>container</code></li></ol><p>ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å–å‡ºå…ƒç´  æŒ‚è½½å…ƒç´  æŒ‚è½½props children</span></span><br><span class="line">  <span class="keyword">const</span> &#123; type, props &#125; = vnode;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(type);</span><br><span class="line">  <span class="comment">// å°†propsæŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  mountProps(props, el);</span><br><span class="line">  <span class="comment">// æŠŠèŠ‚ç‚¹æŒ‚è½½åˆ°elä¸Š</span></span><br><span class="line">  mountChildren(vnode, el);</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº <code>mountProps</code> å’Œ <code>mountChildren</code>ï¼Œæˆ‘ä»¬å…ˆæ¥åšåè€…</p><h3 id="mountChildren"><a href="#mountChildren" class="headerlink" title="mountChildren"></a>mountChildren</h3><p>å‰é¢ä»‹ç» element çš„æ—¶å€™æˆ‘ä»¬è®²åˆ°ï¼š</p><div class="note primary flat"><p>children æŒ‡å­å…ƒç´ ï¼Œå¯ä»¥ä¸ºå­—ç¬¦ä¸²æˆ–è€…æ•°ç»„ï¼Œä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™ä»£è¡¨åªæœ‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚</p></div><p>æ‰€ä»¥æˆ‘ä»¬å°±è¦å¯¹å­å…ƒç´ çš„ä¸¤ç§æƒ…å†µè¿›è¡Œåˆ¤æ–­å¹¶æŒ‚è½½</p><p><code>mountChildren</code> ä¹Ÿæ˜¯æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯èŠ‚ç‚¹ <code>vnode</code>ï¼Œä¸€ä¸ªæ˜¯å®¹å™¨ <code>container</code></p><p>å¯¹äºæ•°ç»„çš„æ“ä½œæˆ‘ä»¬é€’å½’è°ƒç”¨æŒ‚è½½å³å¯ã€‚å¯¹äºå­—ç¬¦ä¸²æˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™æŒ‚è½½æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µï¼Œè¿™ä¸ªä¸‹é¢ä¼šè®²åˆ°æ–‡æœ¬èŠ‚ç‚¹æ‰€ä»¥å…ˆæ è¿‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountChildren</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; shapeFlag, children &#125; = vnode;</span><br><span class="line">  <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TEXT_CHILDREN) &#123;</span><br><span class="line">    mountTextNode(vnode, container);</span><br><span class="line">    <span class="comment">// æ•°ç»„çš„æ—¶å€™</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ARRAY_CHILDREN) &#123;</span><br><span class="line">    <span class="comment">// é€’å½’è°ƒç”¨æŒ‚è½½</span></span><br><span class="line">    children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      mount(child, container);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mountProps"><a href="#mountProps" class="headerlink" title="mountProps"></a>mountProps</h3><p><code>mountProps</code> æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ <code>props</code> æ¸²æŸ“å™¨ï¼Œä¸€ä¸ªæ˜¯ç”Ÿæˆçš„å…ƒç´  <code>el</code></p><p>å¯¹äºæˆ‘ä»¬çš„ <code>props</code> æœ‰ä»¥ä¸‹å‡ ä¸ªç§ç±»</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">class</span>: <span class="string">&#x27;a b&#x27;</span>,</span><br><span class="line">  <span class="attr">style</span>: &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">    <span class="attr">fontSize</span>: <span class="string">&#x27;14px&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">onClick</span>: <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&#x27;click&#x27;</span>),</span><br><span class="line">  <span class="attr">checked</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">custom</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¦åˆ†æä¸€ä¸‹æˆ‘ä»¬æœ‰å‡ ç§æƒ…å†µ</p><ol><li><code>class</code> å­—ç¬¦ä¸²</li><li><code>style</code> å¯¹è±¡</li><li><code>event</code> äº‹ä»¶</li><li>å…¶ä»–å±æ€§</li></ol><p>é‚£ä¹ˆæ¥æŒ‰ç‚¹åˆ†æï¼š</p><h4 id="class-å­—ç¬¦ä¸²"><a href="#class-å­—ç¬¦ä¸²" class="headerlink" title="class å­—ç¬¦ä¸²"></a>class å­—ç¬¦ä¸²</h4><p>å¦‚æœæ˜¯ <code>class</code>ï¼Œç›´æ¥èµ‹ <code>className</code> å³å¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;class&#x27;</span>:</span><br><span class="line">    el.className = value;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><h4 id="style-å¯¹è±¡"><a href="#style-å¯¹è±¡" class="headerlink" title="style å¯¹è±¡"></a>style å¯¹è±¡</h4><p>å¦‚æœæ˜¯ <code>style</code>ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦éå†è¿™ä¸ª <code>style</code>ï¼ŒæŠŠå¯¹åº”çš„å€¼èµ‹ç»™<code>el.style[styleName]</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæ˜¯style éå†èµ‹å€¼valueå€¼</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;style&quot;</span>:</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> value) &#123;</span><br><span class="line">    el.style[styleName] = value[styleName];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><h4 id="event-äº‹ä»¶"><a href="#event-äº‹ä»¶" class="headerlink" title="event äº‹ä»¶"></a>event äº‹ä»¶</h4><p>å¦‚æœæ˜¯äº‹ä»¶ï¼Œè¿™é‡Œå·æ‡’ä¸€ä¸‹ï¼Œåªè§¦å‘ä»¥ <code>on</code> å¼€å¤´çš„äº‹ä»¶ï¼Œåˆ©ç”¨æ­£åˆ™æˆ‘ä»¬å¾ˆå¿«å¯ä»¥åŒ¹é…ä¸Šï¼Œå†æŠŠ <code>Click</code> å˜å°å†™ï¼Œç„¶ååˆ©ç”¨<code>el.addEventListener(eventName, value);</code>è¿™ä¸ª api å³å¯ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="regexp">/^on[^a-z]/</span>.test(key)) &#123;</span><br><span class="line">  <span class="keyword">const</span> eventName = key.slice(<span class="number">2</span>).toLowerCase();</span><br><span class="line">  el.addEventListener(eventName, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å…¶ä»–å±æ€§"><a href="#å…¶ä»–å±æ€§" class="headerlink" title="å…¶ä»–å±æ€§"></a>å…¶ä»–å±æ€§</h4><p>å¦‚æœæ˜¯å…¶ä»–å±æ€§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦æ³¨æ„äº†ï¼Œè™½ç„¶ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ç”¨<code>setAttribute</code>è¿™ä¸ª <code>api</code>ï¼Œå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬è®¾ç½®å±æ€§ä»¥åŠå±æ€§å¯¹åº”çš„å€¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„å±æ€§æ˜¯<code>value|checked|selected|muted|disabled</code>è¿™å‡ ç§ï¼Œé‚£ä¹ˆæˆ‘ä»¬è®¾ç½®<code>true|false</code>çš„æ—¶å€™ï¼Œä»–ä¼šè¢«è½¬æ¢æˆå­—ç¬¦ä¸²å¯¼è‡´èµ‹å€¼å¤±æ•ˆã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æ­£åˆ™åŒ¹é…è¿™ç§æƒ…å†µï¼Œå•ç‹¬ç»™ä»–èµ‹å€¼è¿™ä¸ªå±æ€§<code>el[key] = value;</code></p><p>å¦å¤–ä¸ä»…å¦‚æ­¤,ä¹Ÿå¯èƒ½å­˜åœ¨æ²¡æœ‰èµ‹å€¼çš„æƒ…å†µï¼Œæ¯”å¦‚æˆ‘åªæƒ³è®©å¤šé€‰æ¡†é€‰ä¸­ï¼Œé‚£ä¹ˆå°±ç»™ä»–<code>checked</code>ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»–å¤„ç†æˆ true</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (domPropsRE.test(key)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (value === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    value = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  el[key] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è®¾ç½®æˆ <code>false</code> æˆ–è€… <code>null</code> çš„æ—¶å€™ï¼Œä»£è¡¨æˆ‘ä»¬å¸Œæœ›ç§»é™¤æ‰è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è¦åˆ©ç”¨åˆ° <code>removeAttribute</code>ï¼Œæœ€åçš„æƒ…å†µå°±æ˜¯ <code>setAttribute</code> äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span> || value === <span class="literal">false</span>) &#123;</span><br><span class="line">  el.removeAttribute(key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  el.setAttribute(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h4><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> domPropsRE = <span class="regexp">/[A-Z]|^(value|checked|selected|muted|disabled)$/</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountProps</span>(<span class="params">props, el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">let</span> value = props[key];</span><br><span class="line">    <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯class ç›´æ¥èµ‹className</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;class&quot;</span>:</span><br><span class="line">        el.className = value;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯style éå†èµ‹å€¼valueå€¼</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;style&quot;</span>:</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> value) &#123;</span><br><span class="line">          el.style[styleName] = value[styleName];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯äº‹ä»¶ï¼Œæ­£åˆ™åŒ¹é…onå¼€å¤´ï¼Œå¹¶å°†åé¢çš„è½¬ä¸ºå°å†™å•è¯ ç„¶åæ·»åŠ äº‹ä»¶</span></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯åˆ«çš„å±æ€§ï¼Œåˆ†ç±»åˆ¤æ–­ï¼Œä¸èƒ½ç»Ÿä¸€è®¾ç½®attribute</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/^on[^a-z]/</span>.test(key)) &#123;</span><br><span class="line">          <span class="keyword">const</span> eventName = key.slice(<span class="number">2</span>).toLowerCase();</span><br><span class="line">          el.addEventListener(eventName, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (domPropsRE.test(key)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (value === <span class="string">&quot;&quot;</span> &amp;&amp; isBoolean(el[key])) &#123;</span><br><span class="line">            value = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          el[key] = value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (value == <span class="literal">null</span> || value === <span class="literal">false</span>) &#123;</span><br><span class="line">            el.removeAttribute(key);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            el.setAttribute(key, value);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note primary flat"><p>è‡³æ­¤å¤„ç†å®Œäº† <code>mountElement</code>ï¼Œæˆ‘ä»¬çŸ¥é“äº† <code>element</code> ä¸­å¯¹äºå­å…ƒç´ çš„å¤„ç†ä¸ºæ•°ç»„éå†å’Œæ–‡æœ¬æŒ‚è½½ï¼Œå¯¹äº <code>props</code> çš„å¤„ç†æŒ‰å››ç§å¤§æƒ…å†µè®¨è®ºï¼Œå…¶ä¸­å¯¹äºå…¶ä»–å±æ€§æˆ‘ä»¬è¿˜è¦æŒ‰ç…§ä¸€èˆ¬çš„å±æ€§å’Œç‰¹æ®Šçš„å‡ ç§å±æ€§è®¨è®ºï¼Œä»¥åŠèµ‹å€¼çš„æƒ…å†µä¸‹ç»™ç§»é™¤è¿˜æ˜¯æŒ‚è½½ã€‚ä¸‹é¢è¿›å…¥ <code>mountTextNode</code> ç¯èŠ‚</p></div><h2 id="mountTextNode"><a href="#mountTextNode" class="headerlink" title="mountTextNode"></a>mountTextNode</h2><div class="note primary flat"><p>ä¸Šé¢æˆ‘ä»¬é—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å…³äºå­å…ƒç´ çš„æ–‡æœ¬èŠ‚ç‚¹å¤„ç†çš„é—®é¢˜ã€‚</p></div><p>å…¶å® <code>mountTextNode</code> åŸç†å°±æ˜¯ <code>document.createTextNode()</code>ï¼Œå…·ä½“ä¼ å…¥çš„å†…å®¹æ˜¯ <code>vnode</code>.<code>children</code>,å› ä¸ºæˆ‘ä»¬å‰é¢è®²åˆ°,<code>TEXT</code> èŠ‚ç‚¹ä»–çš„å­©å­å°±æ˜¯å…·ä½“çš„æ–‡æœ¬å†…å®¹ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="built_in">Symbol</span>,</span><br><span class="line">  <span class="attr">props</span>:<span class="literal">null</span>,</span><br><span class="line">  <span class="attr">children</span>:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextNode</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="built_in">document</span>.createTextNode(vnode.children);</span><br><span class="line">  container.appendChild(textNode);</span><br><span class="line">  vnode.el = el;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mountFragment"><a href="#mountFragment" class="headerlink" title="mountFragment"></a>mountFragment</h2><p>ä»–æœ¬èº«ä¸æ¸²æŸ“ï¼Œç›´æ¥æŠŠçˆ¶èŠ‚ç‚¹æŒ‚è½½ä¸Šå»</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountFragment</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æœ¬èº«ä¸æ¸²æŸ“ ç›´æ¥æŠŠçˆ¶èŠ‚ç‚¹æŒ‚è½½ä¸Šå»</span></span><br><span class="line">  mountChildren(vnode, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a>mountComponent</h2><p>æš‚æ—¶ä¸å†™</p><div class="note primary flat"><p>è‡³æ­¤æˆ‘ä»¬çš„æŒ‚è½½è™šæ‹Ÿ DOM æš‚æ—¶å®Œæˆï¼Œä¸‹é¢çœ‹æˆ‘ä»¬çš„ <code>patch</code> éƒ¨åˆ†</p></div><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸ªéƒ¨åˆ†çš„ç¯‡å¹…æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ä½•ä¸ºvnodeï¼Œç„¶ååˆæ­¥çš„ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿ DOM å¹¶ç”Ÿæˆvnodeç„¶åæŒ‚è½½å¹¶æ¸²æŸ“ï¼Œä¸‹èŠ‚è¿›è¡Œ<code>patch</code>çš„å­¦ä¹ ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>ä»é›¶å¼€å§‹çš„mini-vueâ‘ --reactiveç¯‡</title>
    <link href="https://zlinni.github.io/posts/3451170570/"/>
    <id>https://zlinni.github.io/posts/3451170570/</id>
    <published>2022-05-30T02:33:04.000Z</published>
    <updated>2022-06-10T08:29:28.670Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>mini-Vue æ˜¯ç²¾ç®€ç‰ˆæœ¬çš„ Vue3ï¼ŒåŒ…å«äº† vue3 æºç ä¸­çš„æ ¸å¿ƒå†…å®¹ï¼Œé™„åŠ ä¸Š demo çš„å…·ä½“å®ç°ã€‚<br>æœ¬ç¯‡æ˜¯ reactive ç¯‡ï¼Œæ˜¯å…³äº Vue3 ä¸­å“åº”å¼çš„ç¯‡ç« ï¼ŒåŒ…å«äº†<code>reactive</code>,<code>ref</code>,<code>computed</code>çš„å®ç°</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/reactivedaotu.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/computedandref.png" alt=""></p><h1 id="é¡¹ç›®æ„å»º"><a href="#é¡¹ç›®æ„å»º" class="headerlink" title="é¡¹ç›®æ„å»º"></a>é¡¹ç›®æ„å»º</h1><p>é¡¹ç›®ä½¿ç”¨ webpack æ„å»ºï¼Œdemo çš„ä»£ç æ”¾åœ¨<code>index.js</code>ä¹‹ä¸­ï¼Œå°†å…¶æ‰“åŒ…æˆä¸º<code>mini-vue.js</code>,ä¹‹å<code>index.html</code>å¼•å…¥ï¼Œæ§åˆ¶å°æŸ¥çœ‹ demo è¾“å‡ºã€‚</p><h1 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h1><p>Vue3 ä¸­çš„<code>reactive</code>ç”¨äºå¤„ç†å¯¹è±¡æ•°æ®ï¼Œå°†å¼•ç”¨ç±»å‹çš„æ•°æ®è½¬åŒ–ä¸ºå“åº”å¼ã€‚å…¶å®å®ƒæ˜¯ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆçš„ï¼Œè§ä¾‹å­ã€‚æˆ‘ä»¬çŸ¥é“å®ƒç”± <code>reactive</code> å’Œ <code>effect</code> ç»„æˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observed = reactive(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">&#125;);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;observed.count is:&quot;</span>, observed.count);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠè¿™ä¸ª effect å«åšå‰¯ä½œç”¨å‡½æ•°ï¼Œå‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œä¼šå½±å“å…¶ä»–å˜é‡æˆ–è€…å‡½æ•°çš„æ‰§è¡Œã€‚è¿™é‡Œå®ƒæ˜¯ä½œç”¨æ˜¯æ”¶é›†ä¾èµ–ï¼Œåœ¨ä¾èµ–å‘ç”Ÿæ”¹å˜çš„æ—¶å€™è§¦å‘æ›´æ–°ã€‚</p><p>å®ƒä»¬ä¸¤ä¸ªæ˜¯æ€ä¹ˆäº§ç”Ÿè”ç³»çš„å‘¢?æ ¸å¿ƒæ˜¯è¿›è¡Œä¾èµ–æ”¶é›† track å’Œè§¦å‘ä¾èµ–æ›´æ–° trigger</p><p>ä¾èµ–æ”¶é›†å°±æ˜¯ä¿å­˜ä¾èµ–å’Œå‰¯ä½œç”¨ä¹‹é—´çš„å…³ç³».</p><p>è§¦å‘ä¾èµ–æ›´æ–°å°±æ˜¯å½“ä¾èµ–å˜æ›´çš„æ—¶å€™,æ‰¾åˆ°å¹¶æ‰§è¡Œä¾èµ–å®ƒçš„å‰¯ä½œç”¨</p><p>æˆ‘ä»¬çŸ¥é“äº†ä¸Šè¿°çš„æ“ä½œï¼Œå°†å®ƒä»¬åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†è¿›è¡Œç¼–å†™ï¼Œä¸€æ˜¯<code>reactive.js</code> äºŒæ˜¯<code>effect.js</code></p><h2 id="reactive-éƒ¨åˆ†"><a href="#reactive-éƒ¨åˆ†" class="headerlink" title="reactive éƒ¨åˆ†"></a>reactive éƒ¨åˆ†</h2><p>åˆšæ‰æåŠåˆ°ï¼Œreactive å¤„ç†çš„æ˜¯å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªæ–¹æ³•åˆ¤æ–­å¯¹è±¡</p><p>æ‰€ä»¥æˆ‘ä»¬æ–°å»º<code>utils</code>æ–‡ä»¶å¤¹ï¼Œå†™å…¥<code>index.js</code>,ç”¨äºç¼–å†™æˆ‘ä»¬çš„å·¥å…·ç±»æ–¹æ³•</p><p>åˆ¤æ–­å¯¹è±¡ç±»å‹çš„æ•°æ®çš„æ–¹æ³•,éœ€è¦æ³¨æ„çš„æ˜¯ç”±äº<code>null</code>ä¹Ÿä¼šè¢«åˆ¤æ–­ä¸º objectï¼Œæ‰€ä»¥è¦å¤šåŠ åˆ¤æ–­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> funtcion <span class="function"><span class="title">isObject</span>(<span class="params">target</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> target === <span class="string">&#x27;object&#x27;</span> &amp;&amp; target !== <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è€ƒè™‘æ€ä¹ˆå»å°†æ•°æ®å˜ä¸ºå“åº”å¼ã€‚</p><p>å­¦è¿‡ vue3 åŸºç¡€çš„éƒ½çŸ¥é“ï¼Œvue3 ä½¿ç”¨çš„æ˜¯ Proxy æ¥å¯¹å“åº”å¼æ•°æ®è¿›è¡Œ track å’Œ trigger</p><p>proxy æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ target ä¸€ä¸ªæ˜¯ handlerï¼Œå‰è€…æ˜¯æ‹¦æˆªçš„å¯¹è±¡ï¼Œåè€…æ˜¯åˆ†ä¸ºäº† get å’Œ set ä¸¤æ­¥æ“ä½œã€‚</p><p>åŒæ—¶ get æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œå¯¹è±¡ï¼Œéœ€è¦æ‹¦æˆªçš„å±æ€§ keyï¼Œæ¥æ”¶è€… receiver</p><p>è¿™ä¸ª receiver æŒ‡å‘åŸå§‹è¯»æ“ä½œæ‰€åœ¨çš„å¯¹è±¡ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯ Proxy å®ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="function"><span class="keyword">function</span> (<span class="params">target, property, receiver</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> receiver;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> d = <span class="built_in">Object</span>.create(proxy);</span><br><span class="line">d.a === d; <span class="comment">// true</span></span><br><span class="line"><span class="comment">//då¯¹è±¡æœ¬èº«æ²¡æœ‰aå±æ€§ï¼Œæ‰€ä»¥è¯»å–d.açš„æ—¶å€™ï¼Œä¼šå»dçš„åŸå‹proxyå¯¹è±¡æ‰¾ã€‚è¿™æ—¶ï¼Œreceiverå°±æŒ‡å‘dï¼Œä»£è¡¨åŸå§‹çš„è¯»æ“ä½œæ‰€åœ¨çš„é‚£ä¸ªå¯¹è±¡ã€‚</span></span><br></pre></td></tr></table></figure><p>set æ¥æ”¶å››ä¸ªå‚æ•°ï¼Œå¯¹è±¡ï¼Œéœ€è¦æ‹¦æˆªçš„å±æ€§ï¼Œæ”¹å˜çš„ value å€¼ï¼Œæ¥æ”¶è€… receiverã€‚æœ€åè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼</p><p>æˆ‘ä»¬è¿˜éœ€è¦åå°„å¯¹è±¡ Reflectï¼Œæˆ‘ä»¬é€šè¿‡å®ƒå¯ä»¥è·å–å¯¹è±¡ä¸Šçš„æŸä¸ªæŒ‡å®šå±æ€§çš„æ–¹æ³•(get)ï¼Œä¹Ÿå¯ä»¥å»ä¿®æ”¹å¯¹è±¡å±æ€§ä¸Šçš„å€¼(set)ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      track(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      trigger(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å…¥æ‰‹<code>effect.js</code></p><h2 id="effect-éƒ¨åˆ†"><a href="#effect-éƒ¨åˆ†" class="headerlink" title="effect éƒ¨åˆ†"></a>effect éƒ¨åˆ†</h2><p>æˆ‘ä»¬åœ¨è¿™ä¸ªéƒ¨åˆ†éœ€è¦å¯¹å‰¯ä½œç”¨å‡½æ•°è¿›è¡Œå¤„ç†å’Œå‰–æï¼Œä»¥åŠå¯¹æˆ‘ä»¬çš„ track å’Œ trigger è¿›è¡Œç¼–å†™</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‹¿åˆ°å¹¶æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">//todo</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn();</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯ç”¨æˆ·å†™çš„ effectï¼Œå¯èƒ½ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥è¦ç”¨ try æ¥åŒ…è£¹ä½,ä¸”æˆ‘ä»¬çš„ track è¦æ”¶é›†æˆ‘ä»¬çš„ä¾èµ–ï¼Œå°±è¦çŸ¥é“ä¾èµ–æœ‰æ²¡æœ‰è¢«æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æœ‰æ²¡æœ‰è°ƒç”¨ effect ä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è®¾è®¡ä¸€ä¸ªæ ‡è¯†è®°å½•è¯¥æ–¹æ³•ã€‚è¿™é‡Œå°±ç”¨åˆ°å…¨å±€å˜é‡<code>activeEffect</code>,å»ç¼“å­˜æˆ‘ä»¬çš„ effectï¼Œç„¶ååœ¨æ‰§è¡Œå®Œä¹‹åç»™å®ƒè¿˜åŸå›å»ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effectFn;</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      activeEffect = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn();</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬è¦æ¥å†™ track å’Œ trigger éƒ¨åˆ†ï¼Œä½†æˆ‘ä»¬å¾—å…ˆè€ƒè™‘ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¾èµ–çš„æ•°æ®ç»“æ„åº”è¯¥æ€ä¹ˆè®¾è®¡</p><p>å…ˆäº†è§£ä¸€ä¸‹è¿™æ ·çš„ä¸€ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼š</p><p>å‰¯ä½œç”¨æ‰§è¡Œ=&gt;å‰¯ä½œç”¨ä¾èµ–çš„å“åº”å¼å¯¹è±¡æ”¹å˜=&gt;å“åº”å¼å¯¹è±¡æ”¹å˜=&gt;å“åº”å¼å¯¹è±¡çš„å±æ€§æ”¹å˜</p><p>ä¸”å“åº”å¼å¯¹è±¡çš„å±æ€§å¯ä»¥ç”±å¤šä¸ªå‰¯ä½œç”¨ä¾èµ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  å“åº”å¼å¯¹è±¡<span class="number">1</span>:&#123;</span><br><span class="line">    å±æ€§<span class="number">1</span>:[å‰¯ä½œç”¨<span class="number">1</span>ï¼Œå‰¯ä½œç”¨<span class="number">2</span>ï¼Œå‰¯ä½œç”¨<span class="number">3.</span>..],</span><br><span class="line">    å±æ€§<span class="number">2</span>:[å‰¯ä½œç”¨<span class="number">1</span>ï¼Œå‰¯ä½œç”¨<span class="number">2</span>ï¼Œå‰¯ä½œç”¨<span class="number">3.</span>..],</span><br><span class="line">  &#125;,</span><br><span class="line">  å“åº”å¼å¯¹è±¡<span class="number">2</span>:&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±çŸ¥é“å¾—å…ˆå­˜å‚¨å“åº”å¼å¯¹è±¡ï¼Œè¿™é‡Œå°±ä½¿ç”¨<code>WeakMap</code>ä½œä¸ºå®ƒçš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯é‡Œé¢çš„å“åº”å¼å¯¹è±¡åœ¨ä¸è¢«ä½¿ç”¨çš„æ—¶å€™ä¼šè¢«åƒåœ¾å›æ”¶ã€‚å‘½åä¸º<code>targetMap</code></p><p>å†è€ƒè™‘å“åº”å¼å¯¹è±¡çš„å±æ€§ï¼Œæˆ‘ä»¬å°†ä»–å­˜æ”¾åœ¨ä¸€ä¸ª<code>map</code>ä¸­ï¼Œå‘½åä¸º<code>depsMap</code></p><p>æ¥ç€æ˜¯å®ƒçš„å‰¯ä½œç”¨ï¼Œå‰¯ä½œç”¨å­˜æ”¾åœ¨ä¸€ä¸ª<code>set</code>ä¸­ï¼Œå› ä¸ºå¯èƒ½æœ‰å¤šä¸ªå‰¯ä½œç”¨ä¾èµ–åŒæ ·çš„å±æ€§ï¼Œå‘½åä¸º<code>deps</code></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„ç»“æ„å°±æ˜¯å¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">targetMap:&#123;</span><br><span class="line">  å“åº”å¼å¯¹è±¡(target):&#123;</span><br><span class="line">    <span class="attr">depsMap</span>:&#123;</span><br><span class="line">      å±æ€§(key):&#123;</span><br><span class="line">        <span class="attr">deps</span>:&#123;</span><br><span class="line">          å‰¯ä½œç”¨(activeEffect)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™å®Œä¾èµ–çš„æ•°æ®ç»“æ„ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹å†™ track äº†</p><p>æˆ‘ä»¬ç°åœ¨å†æ¬¡äº†è§£ä¸€ä¸‹ track çš„ä½œç”¨:æ·»åŠ ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¦æ‰¾åˆ°å±‚çº§ç»“æ„ä¸­çš„ä¾èµ–ï¼Œå¯¹æ­¤ï¼Œæˆ‘ä»¬è¿›è¡Œä¸‹é¢å†™æ³•ã€‚</p><h3 id="track-éƒ¨åˆ†"><a href="#track-éƒ¨åˆ†" class="headerlink" title="track éƒ¨åˆ†"></a>track éƒ¨åˆ†</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="comment">// trackçš„ä½œç”¨æ˜¯æ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ˜¯æ­£åœ¨æ‰§è¡Œçš„ä¾èµ– ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ„å»ºdepsMap</span></span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ„å»ºdeps</span></span><br><span class="line">  <span class="keyword">let</span> deps = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span> (!deps) &#123;</span><br><span class="line">    depsMap.set(key, (deps = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ·»åŠ ä¾èµ–</span></span><br><span class="line">  deps.add(activeEffect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="trigger-éƒ¨åˆ†"><a href="#trigger-éƒ¨åˆ†" class="headerlink" title="trigger éƒ¨åˆ†"></a>trigger éƒ¨åˆ†</h3><p>å¯¹äº trigger éƒ¨åˆ†ï¼Œå…¶å®å°±æ˜¯ track çš„é€†è¿ç®—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// triggerç”¨äºè§¦å‘æ›´æ–°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå®ƒæœ‰å‰¯ä½œç”¨,æ‰æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> deps = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span> (!deps) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  deps.forEach(<span class="function">(<span class="params">effectFn</span>) =&gt;</span> &#123;</span><br><span class="line">    effectFn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ä¸€ä¸ªæœ€ç®€å•çš„å“åº”å¼å·²ç»è®¾è®¡å¥½äº†,æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€äº›ç‰¹ä¾‹,æ¥å¤„ç†ç‰¹æ®Šæƒ…å†µä»¥åŠä¼˜åŒ–</p><h1 id="ç‰¹ä¾‹å¤„ç†ä¸ä¼˜åŒ–"><a href="#ç‰¹ä¾‹å¤„ç†ä¸ä¼˜åŒ–" class="headerlink" title="ç‰¹ä¾‹å¤„ç†ä¸ä¼˜åŒ–"></a>ç‰¹ä¾‹å¤„ç†ä¸ä¼˜åŒ–</h1><div class="note primary flat"><p>ä¸‹é¢æœ‰å…­ä¸ªç‰¹ä¾‹ï¼Œå¯¹åº”å¤„ç† reactive çš„å…­ç§æƒ…å†µ</p></div><ol><li><code>reactive(reactive(obj))</code></li><li><code>let a = reactive(obj), b = reactive(obj)</code></li><li><code>hasChanged</code></li><li>æ·±å±‚å¯¹è±¡ä»£ç†</li><li>æ•°ç»„</li><li>åµŒå¥— effect</li></ol><h2 id="åµŒå¥—-reactive"><a href="#åµŒå¥—-reactive" class="headerlink" title="åµŒå¥— reactive"></a>åµŒå¥— reactive</h2><p><code>reactive(reactive(obj))</code></p><p>å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œæ˜¯åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šæ¬¡å“åº”å¼å¤„ç†äº†ã€‚æ­£å¸¸çš„æƒ…å†µåº”è¯¥æ˜¯åªå¤„ç†ä¸€æ¬¡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç»™å“åº”å¼å¯¹è±¡æ·»åŠ ä¸€ä¸ª<code>_isReactive</code>å±æ€§ï¼Œä¾æ­¤æ¥åˆ¤æ–­.</p><p>æ³¨æ„è¿™é‡Œç”¨äº†<code>!!</code>å°†ç»“æœè½¬ä¸º boolean</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(target &amp;&amp; target._isReactive);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»æ˜¯å“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (isReactive(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      <span class="comment">//åˆ¤æ–­keyæ˜¯å¦ä¸º__isReactive</span></span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&quot;__isReactive&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      track(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      trigger(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(target &amp;&amp; target.__isReactive);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¤šæ¬¡å¯¹åŒä¸ªå¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†"><a href="#å¤šæ¬¡å¯¹åŒä¸ªå¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†" class="headerlink" title="å¤šæ¬¡å¯¹åŒä¸ªå¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†"></a>å¤šæ¬¡å¯¹åŒä¸ªå¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†</h2><div class="note primary flat"><p><code>let a = reactive(obj), b = reactive(obj)</code></p><p>è¿™ä¸ªå¯ä»¥è¯´æ˜¯å’Œä¸Šé¢çš„ç‰¹ä¾‹ä¼˜ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯å®é™…ä¸Šçš„å¤„ç†å´ä¸å¤ªä¸€æ ·ã€‚</p></div><p>å¯¹äºç¬¬ä¸€ä¸ªç‰¹ä¾‹ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡åˆ¤æ–­æ ‡è¯†<code>__isReactive</code>æ¥åˆ¤æ–­å®ƒæ˜¯å¦è¢«ä»£ç†è¿‡ï¼Œç„¶åå¦‚æœå·²ç»å­˜åœ¨è¿™ä¸ªå±æ€§ï¼Œåˆ™å°†å…¶æ‹¦æˆªä¸º trueã€‚</p><p>å¯¹äºç¬¬äºŒä¸ªç‰¹ä¾‹ï¼Œæˆ‘ä»¬è¦é€šè¿‡ä¸€ä¸ªæ•°æ®ç»“æ„æ¥å­˜å‚¨æˆ‘ä»¬çš„å“åº”å¼å¯¹è±¡ï¼Œå½“ç›®æ ‡å¯¹è±¡ä¸‹æ¬¡è¢«å“åº”å¼å¤„ç†çš„æ—¶å€™ï¼Œåˆ¤æ–­æ•°æ®ç»“æ„ä¸­æ˜¯å¦æœ‰è¯¥å“åº”å¼å¯¹è±¡ï¼Œæœ‰åˆ™ç›´æ¥è¿”å›è¯¥å“åº”å¼å¯¹è±¡ã€‚</p><!-- æ‰€ä»¥è¿™ä¸¤ä¸ªå¤„ç†ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼Œæ˜¯å¦è¿”å›åŒæ ·çš„å“åº”å¼ï¼Œå¯¹äºç¬¬ä¸€ç§ï¼Œå¤šæ¬¡åµŒå¥—ï¼Œå®ƒè¿”å›çš„æ˜¯åµŒå¥—å†…å®¹ï¼Œå¯¹äºç¬¬äºŒç§ï¼Œå®ƒè¿”å›çš„æ˜¯å¤„ç†è¿‡çš„å“åº”å¼å¯¹è±¡ã€‚ --><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="comment">// åˆ›å»ºproxyMap</span></span><br><span class="line"><span class="keyword">const</span> proxyMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isReactive(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ‰åˆ™ç›´æ¥è¿”å›è¯¥å“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (proxyMap.get(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&quot;__isReative&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      track(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      trigger(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// è®¾ç½®</span></span><br><span class="line">  proxyMap.set(target, proxy);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(target &amp;&amp; target.__isReative);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å“åº”å¼å†…å®¹æ˜¯å¦æ”¹å˜-æ‡’å¤„ç†ä¸è§¦å‘æ›´æ–°"><a href="#å“åº”å¼å†…å®¹æ˜¯å¦æ”¹å˜-æ‡’å¤„ç†ä¸è§¦å‘æ›´æ–°" class="headerlink" title="å“åº”å¼å†…å®¹æ˜¯å¦æ”¹å˜(æ‡’å¤„ç†ä¸è§¦å‘æ›´æ–°)"></a>å“åº”å¼å†…å®¹æ˜¯å¦æ”¹å˜(æ‡’å¤„ç†ä¸è§¦å‘æ›´æ–°)</h2><p><code>hasChanged</code>æ˜¯ä»£è¡¨ç€å“åº”å¼å¯¹è±¡æ˜¯å¦è¢«æ”¹å˜çš„æ“ä½œã€‚åœ¨ vue3 ä¸­ï¼Œå¦‚æœå“åº”å¼çš„æ•°æ®å’Œä¸Šä¸€æ¬¡çš„æ²¡æœ‰æ”¹å˜ï¼Œåˆ™ä¸è§¦å‘æ›´æ–°</p><p>é‚£ä¹ˆå¾ˆå¿«å°±çŸ¥é“å…¥æ‰‹ç‚¹åœ¨ proxy çš„ set ä¸­äº†ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å¾—ç¼–å†™<code>hasChanged</code>å‡½æ•°,å®ƒéœ€è¦å¯¹æˆ‘ä»¬æ­¤æ¬¡çš„å€¼å’Œä¸Šä¸€æ¬¡çš„å€¼æ¯”è¾ƒã€‚</p><p>ä¸è¿‡å…‰æ˜¯å¯¹æ¯”ï¼Œå¾ˆå®¹æ˜“å°±é—ç•™ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œå°±æ˜¯<code>NaN</code>å’Œ<code>NaN</code>çš„æƒ…å†µï¼Œçœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„å€¼ï¼Œå®é™…ä¸Šçš„æ¯”è¾ƒæ˜¯ false çš„ï¼Œæ‰€ä»¥è¦å¯¹è¿™ä¸ªç‰¹æ®Šå€¼è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">hasChanged</span>(<span class="params">oldValue, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> oldValue !== value &amp;&amp; !(<span class="built_in">Number</span>.isNaN(oldValue) &amp;&amp; <span class="built_in">Number</span>.isNaN(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å¼€å§‹å¤„ç† set äº†ï¼Œæˆ‘ä»¬å°±è¿˜è¦ææ¸…æ¥š<code>oldValue</code>å’Œ<code>value</code>æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚å¯¹äºå‰è€…ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬ç°åœ¨å“åº”å¼å¯¹è±¡ä¸­çš„å±æ€§å€¼ï¼Œ<code>target[key]</code>ï¼Œvalue åˆ™æ˜¯æœ¬æ¬¡ä¼ å…¥çš„å€¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; hasChanged, isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxyMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isReactive(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (proxyMap.get(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&quot;__isReative&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      track(target, key);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      <span class="comment">// å¤„ç†hasChanged</span></span><br><span class="line">      <span class="keyword">let</span> oldValue = target[key];</span><br><span class="line">      <span class="keyword">if</span> (hasChanged(oldValue, value)) &#123;</span><br><span class="line">        trigger(target, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  proxyMap.set(target, proxy);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(target &amp;&amp; target.__isReative);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·±å±‚å¯¹è±¡ä»£ç†"><a href="#æ·±å±‚å¯¹è±¡ä»£ç†" class="headerlink" title="æ·±å±‚å¯¹è±¡ä»£ç†"></a>æ·±å±‚å¯¹è±¡ä»£ç†</h2><p>æˆ‘ä»¬çš„å“åº”å¼å¯¹è±¡å¯èƒ½æ˜¯å¤šå±‚åµŒå¥—çš„ï¼Œé¦–å…ˆè¿™ä¸ªåœ¨ vue2 ä¸­ï¼Œå®ƒå¯¹äºæ·±å±‚å¯¹è±¡çš„å¤„ç†æ–¹å¼æ˜¯æš´åŠ›éå†ç„¶åä¸ºæ¯ä¸ªå¯¹è±¡èµ‹ä¸Šå“åº”å¼ã€‚ä½†åœ¨ vue3 ä¸­ï¼Œå¯¹äºè¿™äº›æ·±å±‚å¯¹è±¡æ˜¯è¿›è¡Œä¸€ä¸ªæ‡’å¤„ç†ã€‚ä¹Ÿå°±æ˜¯å®ƒæ²¡æœ‰å¯¹æ¯ä¸ªå¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œåªå¯¹å½“å‰å±‚æ¬¡çš„å¯¹è±¡è¿›è¡Œå“åº”å¼å¤„ç†ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;__isReative&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    track(target, key);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">    <span class="keyword">let</span> oldValue = target[key];</span><br><span class="line">    <span class="keyword">if</span> (hasChanged(oldValue, value)) &#123;</span><br><span class="line">      trigger(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å¯¹è±¡ç»§ç»­å“åº”å¼å¤„ç†ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±åªå¤„ç†å½“å‰å±‚æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> isObject(res) ? reactive(res) : res;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">proxyMap.set(target, proxy);</span><br><span class="line"><span class="keyword">return</span> proxy;</span><br></pre></td></tr></table></figure><p>ä¾‹å­:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observed1 = reactive(&#123;</span><br><span class="line">  <span class="attr">count1</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">count2</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">obj</span>: &#123;</span><br><span class="line">    <span class="attr">obj</span>: &#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observed2 = reactive(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">100</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;sum is:&quot;</span>, observed1.count1 + observed1.count2 + observed2.count);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;sum is:&quot;</span>, observed1.count1 + observed1.count2 + observed2.count);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="æ•°ç»„å¤„ç†"><a href="#æ•°ç»„å¤„ç†" class="headerlink" title="æ•°ç»„å¤„ç†"></a>æ•°ç»„å¤„ç†</h2><p>åœ¨ vue2 ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒæ˜¯é‡å†™äº†æ•°æ®çš„å‡ ä¸ª apiï¼Œç„¶åæ‹¦æˆªäº†æ•°ç»„è¿›è¡Œå¤„ç†ï¼Œä¸”å› ä¸º vue2 å¯¹<code>defineProperty</code>å¤„ç†ï¼Œæ€§èƒ½çš„åŸå› ï¼Œæˆ‘ä»¬ä¿®æ”¹æ•°ç»„ä¸‹æ ‡å’Œé•¿åº¦æ˜¯æ²¡åŠæ³•è¢«æ£€æµ‹çš„ï¼Œä½†åœ¨ vue3 ä¸­ proxy è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p><p>åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œå¯¹äºæ•°ç»„çš„å¤„ç†ä¸»è¦æ˜¯é¿å… length å¤šæ¬¡è¢«è§¦å‘ï¼Œåªæœ‰åœ¨å€¼çœŸæ­£è¢«æ”¹å˜äº†æ‰å» trigger è¿™ä¸ª length</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">    <span class="keyword">let</span> oldLength = target.length;</span><br><span class="line">    <span class="keyword">let</span> oldValue = target[key];</span><br><span class="line">    <span class="keyword">if</span>(hasChanged(oldValue,value))&#123;</span><br><span class="line">        <span class="keyword">if</span>(isArray(target)&amp;&amp;hasChanged(oldLength,target.length))&#123;</span><br><span class="line">            trigger(target,<span class="string">&#x27;length&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        trigger(target, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isObject(res)?reactive(res):res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observed = (<span class="built_in">window</span>.observed = reactiv([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;index 4 is:&quot;</span>, observed[<span class="number">4</span>]);</span><br><span class="line">&#125;);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;length is:&quot;</span>, observed.length);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="åµŒå¥—-effect"><a href="#åµŒå¥—-effect" class="headerlink" title="åµŒå¥— effect"></a>åµŒå¥— effect</h2><p>è¯´å®Œäº†è¿™äº›ï¼Œå‰©ä¸‹ä¸€ä¸ªåµŒå¥— effect çš„éƒ¨åˆ†ï¼Œè§ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observed = (<span class="built_in">window</span>.observed = reactive(&#123;</span><br><span class="line">  <span class="attr">count1</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">count2</span>: <span class="number">10</span>,</span><br><span class="line">&#125;));</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;count2 is:&quot;</span>, observed.count2);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;count1 is:&quot;</span>, observed.count1);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ¥æµ‹è¯•ä¸€ä¸‹ç›®å‰å†™çš„ä¾‹å­ï¼Œä¼šå‘ç°æˆ‘ä»¬è§¦å‘<code>count2</code>æ˜¯æ­£å¸¸çš„ï¼Œè§¦å‘<code>count1</code>æ˜¯ä¸æ­£å¸¸çš„,æ²¡æœ‰æ‰“å°å‡º<code>count2</code>ã€‚</p><p>æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å†…å±‚ä¾èµ–æ­£å¸¸è§¦å‘æ›´æ–°ï¼Œä½†æ˜¯å¤–å±‚ä¾èµ–æ²¡æœ‰æ­£ç¡®è§¦å‘ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå…ˆæ‰§è¡Œäº†å¤–å±‚ï¼Œä¹‹åå†æ‰§è¡Œå†…å±‚ï¼Œæ­¤æ—¶å¤–å±‚çš„ effect å·²ç»ä¸¢å¤±äº†ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effectFn;</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      activeEffect = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn();</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬è¦æ¢ä¸ªè§’åº¦æ¥è¯´ï¼Œå°±æ˜¯è¦ç”¨æ•°æ®ç»“æ„å»ä¿å­˜æˆ‘ä»¬çš„<code>activeEffect</code>ç„¶åå†ç»“æŸçš„æ—¶å€™å»å¼¹å‡ºæœ«å°¾çš„<code>activeEffect</code>å¹¶è¿˜åŸ<code>activeEffect</code>ä¸ºæ–°çš„æœ«å°¾é¡¹ã€‚</p><p>äºæ˜¯å¯ä»¥æƒ³åˆ°æ ˆç»“æ„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="keyword">const</span> effectStack = [];</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effectFn;</span><br><span class="line">      effectStack.push(activeEffect);</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      effectStack.pop();</span><br><span class="line">      activeEffect = effectStack[effectStack.length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn();</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±è§£å†³äº†åµŒå¥— effect çš„é—®é¢˜</p><h2 id="å®Œæ•´-reactive"><a href="#å®Œæ•´-reactive" class="headerlink" title="å®Œæ•´ reactive"></a>å®Œæ•´ reactive</h2><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject, hasChanged, isArray &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="comment">// å­˜å‚¨proxyå¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> proxyMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ç±»å‹åˆ¤æ–­æ˜¯å¦éœ€è¦åšå“åº”å¼ä»£ç†</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åªèƒ½ä»£ç†ä¸€æ¬¡</span></span><br><span class="line">  <span class="keyword">if</span> (isReactive(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœå·²ç»æœ‰è¿™ä¸ªä»£ç†å¯¹è±¡ ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (proxyMap.get(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// proxy</span></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&quot;__isReactive&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      track(target, key);</span><br><span class="line">      <span class="comment">// ä¸éœ€è¦å¯¹æ¯å±‚å¯¹è±¡è¿›è¡ŒåŠ«æŒï¼Œåªå¯¹éœ€è¦çš„å¯¹è±¡è¿›è¡Œã€‚</span></span><br><span class="line">      <span class="keyword">return</span> isObject(res) ? reactive(res) : res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> oldLength = target.length;</span><br><span class="line">      <span class="keyword">const</span> oldValue = target[key];</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      <span class="keyword">if</span> (hasChanged(oldValue, value)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isArray(target) &amp;&amp; hasChanged(oldLength, target.length)) &#123;</span><br><span class="line">          trigger(target, <span class="string">&quot;length&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        trigger(target, key);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  proxyMap.set(target, proxy);</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(target &amp;&amp; target.__isReactive);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ effect</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®°å½•å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°</span></span><br><span class="line"><span class="keyword">let</span> activeEffect;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ä¸€ä¸ªæ ˆè®°å½•å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨</span></span><br><span class="line"><span class="keyword">const</span> effectStack = [];</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯ç”¨æˆ·è¾“å…¥çš„fnå¯èƒ½æœ‰é”™è¦åŒ…è£¹</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effectFn;</span><br><span class="line">      effectStack.push(activeEffect);</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå®Œå‡½æ•°ä¹‹åè¿˜åŸå½“å‰å‰¯ä½œç”¨</span></span><br><span class="line">      effectStack.pop();</span><br><span class="line">      <span class="comment">// å°†å¤–å±‚å‰¯ä½œç”¨è®°å½•ä¸‹æ¥</span></span><br><span class="line">      activeEffect = effectStack[effectStack.length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="comment">// å­˜å‚¨æˆ‘ä»¬çš„ä¾èµ–</span></span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// targetæ˜¯å“åº”å¼å¯¹è±¡ keyæ˜¯å¯¹è±¡çš„å±æ€§</span></span><br><span class="line">  <span class="keyword">if</span> (!activeEffect) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> deps = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span> (!deps) &#123;</span><br><span class="line">    depsMap.set(key, (deps = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">  deps.add(activeEffect);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è§¦å‘æ›´æ–°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> deps = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span> (!deps) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  deps.forEach(<span class="function">(<span class="params">effectFn</span>) =&gt;</span> &#123;</span><br><span class="line">    effectFn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note primary flat"><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„å“åº”å¼å°±éƒ½å·²ç»å¤„ç†å®Œäº†ï¼Œä¸‹é¢è¿›å…¥<code>ref</code>ç« èŠ‚</p></div><h1 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h1><p><code>ref</code>æ˜¯ vue3 çš„ä¸€ä¸ªæ–° apiï¼Œç›®çš„æ˜¯ä¸ºäº†å¤„ç†åŸºæœ¬æ•°æ®ç±»å‹çš„å“åº”å¼ï¼Œè®¿é—®<code>ref</code>å¤„ç†è¿‡çš„æ•°æ®éœ€è¦ä½¿ç”¨<code>.value</code></p><p>æœ‰äº†å‰é¢<code>reactive</code>çš„åŸºç¡€ï¼Œä¸‹é¢æˆ‘ä»¬è¦å®ç°<code>ref</code>api å°±å®¹æ˜“å¤šäº†ï¼Œä¾‹å­å¦‚ä¸‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = ref(<span class="number">1</span>);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;foo: &quot;</span>, foo.value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ<code>ref</code>è¿”å›çš„æ˜¯ä¸€ä¸ª<code>RefImpl</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡æ¥æ”¶çš„æ˜¯<code>value</code>ï¼Œæ‹¥æœ‰<code>get</code>å’Œ<code>set</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¹‹ä¸­å®ƒä¹Ÿæ˜¯ä½¿ç”¨åˆ°äº†<code>track</code>å’Œ<code>trigger</code>å»è·Ÿè¸ªå’Œæ›´æ–°å€¼</p><p>å…¶æ¬¡å®ƒåªå¯¹åŸºç¡€ç±»å‹è¿›è¡Œå¤„ç†ï¼Œå…¶ä»–æƒ…å†µäº¤ç»™<code>reactive</code>å»åš</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isObject &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›RefImplå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RefImpl(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefImpl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._value = convert(value);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    track(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>._value = newValue;</span><br><span class="line">    trigger(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é’ˆå¯¹ä¸åŒç±»å‹çš„æ•°æ® ä½¿ç”¨reativeæˆ–è€…ref</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isObject(value) ? reactive(value) : value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸¤ç‚¹ä¼˜åŒ–"><a href="#ä¸¤ç‚¹ä¼˜åŒ–" class="headerlink" title="ä¸¤ç‚¹ä¼˜åŒ–"></a>ä¸¤ç‚¹ä¼˜åŒ–</h2><p>åˆ°äº†è¿™ä¸€æ­¥å…¶å®å·²ç»åšå¥½äº†ä¸€ä¸ª<code>ref</code>apiï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¯¹ä»¥ä¸‹ä¸¤ç‚¹ä¼˜åŒ–:</p><ol><li>å·²ç» ref è¿‡çš„æ•°æ®ä¸éœ€è¦å†è¿›è¡Œå“åº”å¼å¤„ç†</li><li>å¦‚æœå‰ä¸€æ¬¡çš„å€¼å’Œåä¸€æ¬¡çš„å€¼ä¸€æ ·ï¼Œä¸è§¦å‘æ›´æ–°</li></ol><p>å¯¹äºç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ª<code>isRef</code>å‡½æ•°å³å¯ã€‚å¤„ç†çš„æ–¹å¼å’Œä¹‹å‰<code>isReactive</code>ç±»ä¼¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isRef</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(value &amp;&amp; value.__isRef);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç¬¬äºŒç‚¹ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç…§æ ·ä½¿ç”¨<code>hasChanged</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasChanged(newValue, <span class="built_in">this</span>._value)) &#123;</span><br><span class="line">        <span class="built_in">this</span>._value = convert(newValue);</span><br><span class="line">        <span class="comment">// triggeråç½® å› ä¸ºå€¼æ”¹å˜äº†æ‰åˆ‡æ¢</span></span><br><span class="line">        trigger(<span class="built_in">this</span>, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®Œæ•´-ref"><a href="#å®Œæ•´-ref" class="headerlink" title="å®Œæ•´ ref"></a>å®Œæ•´ ref</h2><p>å®Œæ•´ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    hasChanged,</span><br><span class="line">    isObject</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    reactive</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    track,</span><br><span class="line">    trigger</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isRef(value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RefImpl(value);Â·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isRef</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(value &amp;&amp; value.__isRef)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefImpl</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.__isRef = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>._value = convert(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">        track(<span class="built_in">this</span>, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasChanged(newValue, <span class="built_in">this</span>._value)) &#123;</span><br><span class="line">            <span class="built_in">this</span>._value = convert(newValue);</span><br><span class="line">            <span class="comment">// triggeråç½® å› ä¸ºå€¼æ”¹å˜äº†æ‰åˆ‡æ¢</span></span><br><span class="line">            trigger(<span class="built_in">this</span>, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isObject(value) ? reactive(value) : value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note primary flat"><p>é‚£ä¹ˆè‡³æ­¤å¯¹<code>ref</code>çš„å¤„ç†ä¹Ÿç»“æŸäº†ï¼Œä¸‹é¢è½®åˆ°<code>computed</code></p></div><h1 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h1><p>åœ¨è¿™ä¸ªæ¨¡å—å¼€å§‹æˆ‘ä»¬ä¸å†è¯¦ç»†çš„ä¸€æ­¥æ­¥å†™æ–¹æ³•,ä»¥åˆ†æä»£ç çš„æ–¹å¼èµ°ä¼šæ¯”è¾ƒå®¹æ˜“ç†è§£.</p><p>åœ¨ vue3 ä¸­è®¡ç®—å±æ€§è¢«å½’ä¸ºäº†ä¸€ä¸ª apiï¼Œå› ä¸ºä¸å†åƒ vue2 ä¸€æ ·ï¼Œå°†<code>method</code>å’Œ<code>computed</code>åˆ†å¼€ï¼Œè€Œæ˜¯éƒ½ç»„åˆåœ¨äº†ä¸€èµ·ï¼Œæœ‰ç‚¹åƒåˆå›åˆ°äº†ä¸€å¼€å§‹ js ç¼–ç¨‹çš„æ—¶å€™äº†ã€‚</p><p>ä¾‹å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> num = ref(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">let</span> sum = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> num * <span class="number">2</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="computed-æœºåˆ¶"><a href="#computed-æœºåˆ¶" class="headerlink" title="computed æœºåˆ¶"></a>computed æœºåˆ¶</h2><p>å†™è¿™ä¸ª <code>computed</code> ä¹‹å‰,æˆ‘ä»¬è¦æ˜ç™½ <code>computed</code> çš„æœºåˆ¶<br>ä½¿ç”¨äº†ä»€ä¹ˆ?</p><ol><li><code>computed</code> ä½¿ç”¨äº†å’Œ <code>effect</code> ç›¸åŒçš„ä¸€å¥—æœºåˆ¶,ä½†ä¸åŒåœ¨äº <code>computed</code> ä¸ä¼šç«‹åˆ»è§¦å‘</li><li><code>computed</code> ä½¿ç”¨äº† <code>track</code> å’Œ <code>trigger</code> æ”¶é›†ä¾èµ–å’Œè§¦å‘æ›´æ–°</li></ol><p>åšäº†ä»€ä¹ˆ?</p><ol><li>è°ƒç”¨äº† <code>computed</code>,æ‰è¿”å›æ›´æ–°å€¼</li><li><code>computed</code> ä¸­çš„ä¾èµ–æ›´æ–°,computed æ‰èƒ½æ›´æ–°</li></ol><p>é‚£ä¹ˆå¯¹äºç¬¬ä¸€ç‚¹,<code>computed</code> ä¸ä¼šç«‹åˆ»è§¦å‘,é‚£ä¹ˆè§¦å‘çš„æƒåŠ›å°±æ˜¯äº¤ç»™äº†è°ƒç”¨ <code>computed</code> çš„å˜é‡,è¿™é‡Œæ‹¿ <code>sum</code> ä½œä¸ºä¾‹å­.</p><p>æœ¬æ¥æˆ‘ä»¬çš„ <code>effect</code>,æ˜¯åœ¨å‡½æ•°å†…éƒ¨ç›´æ¥è°ƒç”¨ <code>effectFn</code> è¿™ä¸ªæ–¹æ³•,è¿”å›è§¦å‘çš„ä¾èµ–,ç°åœ¨æˆ‘ä»¬ä¸éœ€è¦ç›´æ¥è°ƒç”¨ <code>effectFn</code>,æˆ‘ä»¬éœ€è¦å°†è°ƒç”¨ <code>effectFn</code> çš„æƒåŠ›äº¤ç»™æˆ‘ä»¬çš„ <code>computed</code>,è®©ä»–å»è°ƒç”¨ç„¶åè·å–æ›´æ–°å€¼.æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå˜é‡å»æ ‡è¯†è¿™ä¸ªæƒ…å†µ.</p><h2 id="lazy-æ‡’å¤„ç†-effectFn"><a href="#lazy-æ‡’å¤„ç†-effectFn" class="headerlink" title="lazy æ‡’å¤„ç† effectFn"></a>lazy æ‡’å¤„ç† effectFn</h2><p>ä¹Ÿå°±æ˜¯è¦åœ¨ <code>effect</code> ä¸­å¢åŠ ä¸€ä¸ª <code>option</code> å¯¹è±¡,ä¼ å…¥çš„å˜é‡æ˜¯ <code>lazy</code>,<code>lazy</code> ä¸ºçœŸçš„æ—¶å€™,ç›´æ¥è¿”å› <code>effectFn</code> æ–¹æ³•(<code>computed</code> ä½¿ç”¨),<code>lazy</code> ä¸ºå‡æˆ–è€…ä¸å­˜åœ¨çš„æ—¶å€™,ç›´æ¥è§¦å‘.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ¬æ¥effectä¼šç›´æ¥æ‰§è¡Œ,ç°åœ¨ä¼ å…¥é…ç½®é¡¹è®©ä»–æ ¹æ®é…ç½®é¡¹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// å¢åŠ optioné€‰é¡¹</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn, option = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      activeEffect = effectFn;</span><br><span class="line">      effectStack.push(activeEffect);</span><br><span class="line">      <span class="keyword">return</span> fn();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      effectStack.pop();</span><br><span class="line">      activeEffect = effectStack[effectStack.length - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// lazyä¸ºfalseçš„æ—¶å€™æ‰§è¡Œ,å¦åˆ™å°±ç›´æ¥è¿”å›effectFnç»™computedè‡ªè¡Œæ“ä½œ</span></span><br><span class="line">  <span class="keyword">if</span> (!option.lazy) &#123;</span><br><span class="line">    effectFn();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="dirty-æ ‡è¯†å†…éƒ¨ä¾èµ–æ˜¯å¦æ›´æ–°"><a href="#dirty-æ ‡è¯†å†…éƒ¨ä¾èµ–æ˜¯å¦æ›´æ–°" class="headerlink" title="dirty æ ‡è¯†å†…éƒ¨ä¾èµ–æ˜¯å¦æ›´æ–°"></a>dirty æ ‡è¯†å†…éƒ¨ä¾èµ–æ˜¯å¦æ›´æ–°</h2><p>å¯¹äºç¬¬äºŒç‚¹,é¦–å…ˆ,<code>computed</code> è®¾è®¡äº†ä¸€ä¸ª <code>dirty</code> å˜é‡,ç”¨äºæ ‡è¯†å†…éƒ¨ä¾èµ–æ˜¯å¦æ›´æ–°,é»˜è®¤ä¸º <code>true</code>,æ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ä»–ä¼šæ‹¿åˆ° <code>effect</code> è¿”å›çš„ <code>effectFn</code> å¹¶è§¦å‘ç»™<code>_value</code> å»ç¼“å­˜.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedImpl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">getter</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜å®ƒçš„å€¼</span></span><br><span class="line">    <span class="built_in">this</span>._value = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="comment">// æ ‡è¯†ä¾èµ–æ˜¯å¦æ›´æ–°</span></span><br><span class="line">    <span class="built_in">this</span>._dirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// åŒºåˆ«åœ¨äºcomputedä¸ä¼šç«‹åˆ»æ‰§è¡Œ effectä¼š</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¦æ‹“å±•ä¸€ä¸‹effect</span></span><br><span class="line">    <span class="built_in">this</span>.effect = effect(getter, &#123;</span><br><span class="line">      <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¾èµ–æ›´æ–°äº†å°±è¦é‡æ–°è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">      <span class="built_in">this</span>._value = <span class="built_in">this</span>.effect();</span><br><span class="line">      <span class="built_in">this</span>._dirty = <span class="literal">false</span>;</span><br><span class="line">      track(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="value-ç¼“å­˜ä¾èµ–æ•°æ®"><a href="#value-ç¼“å­˜ä¾èµ–æ•°æ®" class="headerlink" title="value ç¼“å­˜ä¾èµ–æ•°æ®"></a>value ç¼“å­˜ä¾èµ–æ•°æ®</h2><p>å¦‚æœä¸‹æ¬¡ä¾èµ–æ²¡æœ‰æ›´æ–°æˆ‘ä»¬ç›´æ¥è¿”å›<code>_value</code> ç¼“å­˜çš„å€¼.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">        <span class="built_in">this</span>._value = <span class="built_in">this</span>.effect();</span><br><span class="line">        <span class="built_in">this</span>._dirty = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥èµ°_value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬ä¸‹æ¬¡å†…éƒ¨ä¾èµ–æ›´æ–°äº†ä¹‹åæ€ä¹ˆç»§ç»­è·å¾— <code>effectFn</code> å‘¢?</p><h2 id="scheduler-è°ƒåº¦å‡½æ•°"><a href="#scheduler-è°ƒåº¦å‡½æ•°" class="headerlink" title="scheduler è°ƒåº¦å‡½æ•°"></a>scheduler è°ƒåº¦å‡½æ•°</h2><p>è¿™å°±è¦ä½¿ç”¨åˆ°è°ƒåº¦å‡½æ•°,ä»–çš„ä½œç”¨å°±æ˜¯,å½“ <code>computed</code> å†…éƒ¨çš„ä¾èµ–å‘ç”Ÿæ›´æ–°çš„æ—¶å€™,å»é€šçŸ¥ <code>computed</code> æ”¹å˜ <code>dirty</code>,åœ¨ä¸‹æ¬¡è°ƒç”¨ <code>sum</code> çš„æ—¶å€™è§¦å‘æ›´æ–°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.effect = effect(getter, &#123;</span><br><span class="line">  <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// è¿˜è¦å°†dirtyå˜ä¸ºtrue æ‰€ä»¥è¦ç”¨ä¸€ä¸ªè°ƒåº¦æœºåˆ¶</span></span><br><span class="line">  <span class="comment">// è®©ä»–å»è§¦å‘æ›´æ–°çš„æ—¶å€™ä¸æ˜¯ç«‹å³å»æ‰§è¡Œgetter,è€Œæ˜¯å»æ‰§è¡Œè°ƒåº¦ç¨‹åº</span></span><br><span class="line">  <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">      <span class="built_in">this</span>._dirty = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>effect</code> æŒ‚è½½è¿™ä¸ª <code>scheduler</code> å¹¶ä¼˜å…ˆè§¦å‘ <code>scheduler</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn,options=&#123;&#125;</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(!options.lazy)&#123;</span><br><span class="line">        effectFn();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŒ‚è½½åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸Š</span></span><br><span class="line">    effectFn.scheduler = options.scheduler;</span><br><span class="line">    <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦å‘æ›´æ–°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target,key</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    deps.forEach(<span class="function"><span class="params">effectFn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå®ƒæœ‰è°ƒåº¦ç¨‹åº ä¼˜å…ˆæ‰§è¡Œ å¦åˆ™æ‰å»æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°æœ¬èº«</span></span><br><span class="line">        <span class="keyword">if</span>(effectFn.scheduler)&#123;</span><br><span class="line">            effectFn.scheduler(effectFn)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            effectFn();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è§£å†³åµŒå¥—-effect"><a href="#è§£å†³åµŒå¥—-effect" class="headerlink" title="è§£å†³åµŒå¥— effect"></a>è§£å†³åµŒå¥— effect</h2><p>è¿™ä¸‹ä¸€ä¸ªå®Œæ•´çš„ <code>computed</code> å·²ç»åšå¥½äº†,ä½†è¿˜æ˜¯æœ‰ä¸€äº›ä¸è¶³çš„åœ°æ–¹.æ¯”å¦‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sumRes = computed(<span class="function">() =&gt;</span> obj.foo + obj.bar);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// åœ¨è¯¥å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å– sumRes.value</span></span><br><span class="line">  <span class="built_in">console</span>.log(sumRes.value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹obj.fooçš„å€¼</span></span><br><span class="line">obj.foo++;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åŸæ„æ˜¯ä¿®æ”¹ <code>obj</code> çš„ <code>foo</code> ç„¶åå‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ,ä½†åšåˆ°è¿™é‡Œ,ä¼šå‘ç°ä¿®æ”¹ <code>foo</code> çš„å€¼å¹¶ä¸ä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ¸²æŸ“.</p><p>å›æƒ³ä¸€ä¸‹æˆ‘ä»¬çš„ä¾èµ–æ•°æ®ç»“æ„,å“åº”å¼å¯¹è±¡çš„å±æ€§å¯ä»¥è¢«å¤šä¸ªå‰¯ä½œç”¨ä¾èµ–,é‚£ä¹ˆè¿™ä¸ªé—®é¢˜å°±å¾ˆç®€å•äº†,å°±æ˜¯ <code>effect</code> åµŒå¥—çš„é—®é¢˜,æˆ‘ä»¬ <code>computed</code> åªæ”¶é›†äº†å†…éƒ¨çš„ <code>effect</code> ä½œä¸ºä¾èµ–,å¹¶æ²¡æœ‰å¤–å±‚çš„è¿™ä¸ª <code>effect</code>,è‡ªç„¶å°±ä¸è§¦å‘æ›´æ–°äº†</p><p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•,å°±æ˜¯é€šè¿‡æ‰‹åŠ¨è§¦å‘çš„æ–¹å¼,åœ¨æˆ‘ä»¬è®¡ç®—å±æ€§æ‰€ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™æ‰‹åŠ¨è°ƒç”¨ <code>trigger</code> è§¦å‘æ›´æ–°,åœ¨æ¯æ¬¡è¯»å–ç»“æŸå°±æ‰‹åŠ¨ <code>track</code> å“åº”å¼æ•°æ®.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">getter, setter</span>)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="built_in">this</span>.effect = effect(getter, &#123;</span><br><span class="line">        <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// è¿˜è¦å°†dirtyå˜ä¸ºtrue æ‰€ä»¥è¦ç”¨ä¸€ä¸ªè°ƒåº¦æœºåˆ¶</span></span><br><span class="line">        <span class="comment">// è®©ä»–å»è§¦å‘æ›´æ–°çš„æ—¶å€™ä¸æ˜¯ç«‹å³å»æ‰§è¡Œgetter,è€Œæ˜¯å»æ‰§è¡Œè°ƒåº¦ç¨‹åº</span></span><br><span class="line">        <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">                <span class="built_in">this</span>._dirty = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// æ‰‹åŠ¨trigger</span></span><br><span class="line">                trigger(<span class="built_in">this</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¾èµ–æ›´æ–°äº†å°±è¦é‡æ–°è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">        <span class="built_in">this</span>._value = <span class="built_in">this</span>.effect();</span><br><span class="line">        <span class="built_in">this</span>._dirty = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ‰‹åŠ¨track</span></span><br><span class="line">        track(<span class="built_in">this</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ç»¼ä¸Šæ‰€è¿°,<code>computed</code> æ¯”è¾ƒå…³é”®çš„å‡ ä¸ªå˜é‡,<code>_value</code>,<code>lazy</code>,<code>_dirty</code> å’Œ <code>scheduler</code></p><h2 id="å®Œæ•´-computed"><a href="#å®Œæ•´-computed" class="headerlink" title="å®Œæ•´ computed"></a>å®Œæ•´ computed</h2><p>å®Œæ•´çš„ <code>computed</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isFunction &#125; <span class="keyword">from</span> <span class="string">&quot;../utils&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; effect, track, trigger &#125; <span class="keyword">from</span> <span class="string">&quot;./effect&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">getterOrOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> getter, setter;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (isFunction(getterOrOption)) &#123;</span><br><span class="line">    getter = getterOrOption;</span><br><span class="line">    setter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">&quot;computed is readonly&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = getterOrOption.get;</span><br><span class="line">    setter = getterOrOption.set;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ComputedImpl(getter, setter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedImpl</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">getter, setter</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜setter</span></span><br><span class="line">    <span class="built_in">this</span>._setter = setter;</span><br><span class="line">    <span class="comment">// ç¼“å­˜å®ƒçš„å€¼</span></span><br><span class="line">    <span class="built_in">this</span>._value = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="comment">// æ ‡è¯†ä¾èµ–æ˜¯å¦æ›´æ–°</span></span><br><span class="line">    <span class="built_in">this</span>._dirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// åŒºåˆ«åœ¨äºcomputedä¸ä¼šç«‹åˆ»æ‰§è¡Œ effectä¼š</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¦æ‹“å±•ä¸€ä¸‹effect</span></span><br><span class="line">    <span class="built_in">this</span>.effect = effect(getter, &#123;</span><br><span class="line">      <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">// è¿˜è¦å°†dirtyå˜ä¸ºtrue æ‰€ä»¥è¦ç”¨ä¸€ä¸ªè°ƒåº¦æœºåˆ¶</span></span><br><span class="line">      <span class="comment">// è®©ä»–å»è§¦å‘æ›´æ–°çš„æ—¶å€™ä¸æ˜¯ç«‹å³å»æ‰§è¡Œgetter,è€Œæ˜¯å»æ‰§è¡Œè°ƒåº¦ç¨‹åº</span></span><br><span class="line">      <span class="attr">scheduler</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">          <span class="built_in">this</span>._dirty = <span class="literal">true</span>;</span><br><span class="line">          trigger(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¾èµ–æ›´æ–°äº†å°±è¦é‡æ–°è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>._dirty) &#123;</span><br><span class="line">      <span class="built_in">this</span>._value = <span class="built_in">this</span>.effect();</span><br><span class="line">      <span class="built_in">this</span>._dirty = <span class="literal">false</span>;</span><br><span class="line">      track(<span class="built_in">this</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">    <span class="comment">// todo</span></span><br><span class="line">    <span class="built_in">this</span>._setter(newValue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><div class="note primary flat"><p>é‚£ä¹ˆè‡³æ­¤reactiveç¯‡å¹…çš„å…¨éƒ¨å†…å®¹éƒ½å·²ç»è®²å®Œï¼Œæ¥ä¸‹æ¥ä¼šè¿›å…¥patchç¯‡ç« ç ”ç©¶vueæ˜¯æ€ä¹ˆè®¾è®¡å¹¶æŒ‚è½½èŠ‚ç‚¹åˆ°è™šæ‹Ÿdomçš„</p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>å¿«é€Ÿä¸Šæ‰‹mongoose</title>
    <link href="https://zlinni.github.io/posts/1323151960/"/>
    <id>https://zlinni.github.io/posts/1323151960/</id>
    <published>2022-05-30T01:10:28.000Z</published>
    <updated>2022-05-30T02:19:21.444Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>Mongoose æ˜¯ MongoDB çš„ä¸€ä¸ªå¯¹è±¡æ¨¡å‹å·¥å…·ï¼Œæ˜¯åŸºäº node-mongodb-native å¼€å‘çš„ MongoDB nodejs é©±åŠ¨ï¼Œå¯ä»¥åœ¨å¼‚æ­¥çš„ç¯å¢ƒä¸‹æ‰§è¡Œã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯é’ˆå¯¹ MongoDB æ“ä½œçš„ä¸€ä¸ªå¯¹è±¡æ¨¡å‹åº“ï¼Œå°è£…äº†MongoDB å¯¹æ–‡æ¡£çš„çš„ä¸€äº›å¢åˆ æ”¹æŸ¥ç­‰å¸¸ç”¨æ–¹æ³•ï¼Œè®© NodeJS æ“ä½œ Mongodb æ•°æ®åº“å˜å¾—æ›´åŠ çµæ´»ç®€å•ã€‚<br>è®°å½•ä½¿ç”¨MongoDBéå…³ç³»å‹æ•°æ®åº“æ—¶ï¼Œä½¿ç”¨Express+Mongooseçš„æ“ä½œã€‚</p></div><h1 id="é¡¹ç›®ä¾èµ–"><a href="#é¡¹ç›®ä¾èµ–" class="headerlink" title="é¡¹ç›®ä¾èµ–"></a>é¡¹ç›®ä¾èµ–</h1><p>åˆå§‹åŒ–é¡¹ç›®ä¹‹åå¤åˆ¶å¦‚ä¸‹åˆ°package.jsonå®‰è£…å³å¯<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;body-parser&quot;</span>: <span class="string">&quot;^1.20.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cors&quot;</span>: <span class="string">&quot;^2.8.5&quot;</span>,</span><br><span class="line">  <span class="string">&quot;express&quot;</span>: <span class="string">&quot;^4.18.1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mongoose&quot;</span>: <span class="string">&quot;^6.3.4&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="expressæ¨¡æ¿"><a href="#expressæ¨¡æ¿" class="headerlink" title="expressæ¨¡æ¿"></a>expressæ¨¡æ¿</h1><p>ç”±äºåªæ˜¯æ¼”ç¤ºæ“ä½œï¼Œä¸‹åˆ—å…¨éƒ¨éƒ½å†™åœ¨äº†app.jsä¸­ï¼Œå…·ä½“ä½¿ç”¨æŒ‰ä¸šåŠ¡åœºæ™¯åˆ’åˆ†æ–‡ä»¶æ¨¡å—<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>); <span class="comment">// å¼•å…¥body-parseræ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>); <span class="comment">// å¼•å…¥expressæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>); <span class="comment">// å¼•å…¥corsæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(bodyParser.json()); <span class="comment">// è§£æjsonæ•°æ®æ ¼å¼</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    <span class="attr">extended</span>: <span class="literal">true</span></span><br><span class="line">&#125;)); <span class="comment">// è§£æformè¡¨å•æäº¤çš„æ•°æ®application/x-www-form-urlencoded</span></span><br><span class="line">app.use(cors()); <span class="comment">// æ³¨å…¥corsæ¨¡å—è§£å†³è·¨åŸŸ</span></span><br></pre></td></tr></table></figure></p><h1 id="mongooseæ¨¡æ¿"><a href="#mongooseæ¨¡æ¿" class="headerlink" title="mongooseæ¨¡æ¿"></a>mongooseæ¨¡æ¿</h1><p>åˆ†ä¸ºå‡ éƒ¨åˆ†ï¼š</p><ol><li>å¼•å…¥mongoose</li><li>å®šä¹‰è¿æ¥çš„æ•°æ®åº“</li><li>è¿æ¥æ•°æ®åº“</li></ol><p>ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¼•å…¥mongoose</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"><span class="comment">//å®šä¹‰å­—ç¬¦ä¸²å¸¸é‡</span></span><br><span class="line"><span class="keyword">const</span> db_url = <span class="string">&quot;mongodb://localhost:27017/miniprogram&quot;</span></span><br><span class="line"><span class="comment">//1.è¿æ¥æ•°æ®åº“</span></span><br><span class="line">mongoose.connect(db_url, &#123;</span><br><span class="line">    <span class="attr">useNewUrlParser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">useUnifiedTopology</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//2.è¿æ¥æˆåŠŸ</span></span><br><span class="line">mongoose.connection.on(<span class="string">&#x27;connected&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;è¿æ¥æˆåŠŸï¼š&#x27;</span>, db_url);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//3.è¿æ¥å¤±è´¥</span></span><br><span class="line">mongoose.connection.on(<span class="string">&#x27;error&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;è¿æ¥é”™è¯¯ï¼š&#x27;</span>, err);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//4.æ–­å¼€è¿æ¥</span></span><br><span class="line">mongoose.connection.on(<span class="string">&#x27;disconnection&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;æ–­å¼€è¿æ¥&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h2 id="æ–°å»ºschema"><a href="#æ–°å»ºschema" class="headerlink" title="æ–°å»ºschema"></a>æ–°å»ºschema</h2><p>mongooseæ˜¯å°è£…è¿‡åçš„mongodbæŒ‡ä»¤ï¼Œå®ƒéœ€è¦æˆ‘ä»¬å…ˆæ–°å»ºä¸€ä¸ªschemaï¼Œå†…éƒ¨æ˜¯æ‰€éœ€çš„å­—æ®µåç§°å’Œç±»å‹ã€‚</p><p>ä¸‹é¢æ˜¯schemaçš„ä»‹ç»<br><div class="note primary flat"><p>Schemaæ˜¯ä¸€ç§ä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨çš„æ•°æ®åº“æ¨¡å‹éª¨æ¶ï¼Œæ— æ³•ç›´æ¥é€šå¾€æ•°æ®åº“ç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¸å…·å¤‡å¯¹æ•°æ®åº“çš„æ“ä½œèƒ½åŠ›ï¼Œä»…ä»…åªæ˜¯å®šä¹‰æ•°æ®åº“æ¨¡å‹åœ¨ç¨‹åºç‰‡æ®µä¸­çš„ä¸€ç§è¡¨ç°ï¼Œå¯ä»¥è¯´æ˜¯æ•°æ®å±æ€§æ¨¡å‹(ä¼ ç»Ÿæ„ä¹‰çš„è¡¨ç»“æ„)ï¼Œåˆæˆ–ç€æ˜¯â€œé›†åˆâ€çš„æ¨¡å‹éª¨æ¶ã€‚</p></div></p><p>ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commoditiesSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">    <span class="attr">_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="built_in">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="built_in">Object</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">typeID</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="built_in">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">typeImage</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="built_in">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">typeTitle</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="built_in">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h2 id="åˆ›å»ºæ¨¡å‹"><a href="#åˆ›å»ºæ¨¡å‹" class="headerlink" title="åˆ›å»ºæ¨¡å‹"></a>åˆ›å»ºæ¨¡å‹</h2><p>æ¨¡å‹çš„å®šä¹‰<br><div class="note primary flat"><p>æ¨¡å‹(Model)æ˜¯ç”±Schemaæ„é€ ç”Ÿæˆçš„æ¨¡å‹ï¼Œé™¤äº†Schemaå®šä¹‰çš„æ•°æ®åº“éª¨æ¶ä»¥å¤–ï¼Œè¿˜å…·æœ‰æ•°æ®åº“æ“ä½œçš„è¡Œä¸ºï¼Œç±»ä¼¼äºç®¡ç†æ•°æ®åº“å±æ€§ã€è¡Œä¸ºçš„ç±»</p></div><br>ç¬¬äºŒæ­¥éœ€è¦åˆ›å»ºæ¨¡å‹ï¼Œå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è¿™å¼ è¡¨(å¤æ•°åç§°)ï¼Œåˆ™æ–°å»ºä¸€å¼ ã€‚</p><p>åˆ›å»ºè¡¨åçš„è§„åˆ™æ˜¯ï¼šä¼ å…¥çš„å•è¯çš„å¤æ•°ï¼Œå¦‚æœå·²ç»æ˜¯å¤æ•°ï¼Œåˆ™ä½¿ç”¨å¤æ•°</p><p>eg<br><code>food</code> -&gt; <code>foods</code></p><p>code<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•å·å†…ä¼ å…¥çš„æ˜¯è¡¨å è‡ªåŠ¨è½¬ä¸ºå¤æ•°</span></span><br><span class="line"><span class="keyword">const</span> commodities = mongoose.model(<span class="string">&#x27;commodities&#x27;</span>, commoditiesSchema);</span><br></pre></td></tr></table></figure></p><div class="note warning flat"><p>schemaå’Œmodelæœ€å¥½ä¸è¦åœ¨æ¥å£é‡Œé¢å†™<br>åŸå› 1: è¯·æ±‚å¤šæ¬¡ä¼šç”±äºåˆ©ç”¨äº†é‡å¤çš„æ¨¡å‹æŠ¥é”™(æ¨¡å‹ä¸å…è®¸overwrite)<br>åŸå› 2: å…¨å±€å¯å¤ç”¨</p></div><h1 id="æŸ¥è¯¢find"><a href="#æŸ¥è¯¢find" class="headerlink" title="æŸ¥è¯¢find"></a>æŸ¥è¯¢find</h1><p>mongooseä¸­æä¾›äº†å‡ ç§æŸ¥è¯¢æ–¹æ³•ï¼Œ<code>find</code>ã€<code>findById</code>ã€<code>findOne</code>ã€‚éƒ½æ˜¯æ¨¡å‹çš„apiï¼Œæ‰€ä»¥ä¸€å®šè¦æ–°å»ºæ¨¡å‹</p><p><code>findById</code> è¿”å›çš„ç»“æœæ˜¯æ•°ç»„<br>éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡åŒ…è£¹çš„idï¼Œå¯ä»¥æ˜¯<code>_id</code>,ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°<code>err</code>å’Œ<code>data</code>ï¼Œè¿”å›æŸ¥è¯¢çš„ç»“æœæˆ–è€…å¼‚å¸¸æƒ…å†µã€‚<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">commodities.findById(&#123;</span><br><span class="line">    _id</span><br><span class="line">&#125;, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸€èˆ¬è¿”å›ä¸‰ä¸ªå€¼ code msg å’Œ result</span></span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">result</span>: data</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p><code>find</code> è¿”å›çš„ç»“æœæ˜¯æ•°ç»„<br>ä¸¤ç§æƒ…å†µ<br>ç¬¬ä¸€ç§åªä¼ ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåˆ™è¿”å›å¯¹åº”æ¨¡å‹çš„å…¨éƒ¨å­—æ®µå€¼</p><p>ç¬¬äºŒç§ï¼š<br>éœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¯¹è±¡åŒ…è£¹çš„æŸ¥è¯¢æ¡ä»¶ï¼Œç¬¬äºŒä¸ªæ˜¯å¯¹è±¡åŒ…è£¹çš„è¿”å›ç»“æœ(ç”¨äºç­›é€‰),keyæ˜¯æ¨¡å‹çš„å­—æ®µï¼Œvalueæ˜¯1æˆ–è€…0ï¼Œå¦‚æœæ˜¯1åˆ™è¿”å›è¯¥ç»“æœï¼Œå¦‚æœæ˜¯0åˆ™ä¸è¿”å›ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å›è°ƒå‡½æ•°<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">commodities.find(&#123;</span><br><span class="line">    _id,</span><br><span class="line">&#125;,&#123;<span class="attr">goods</span>:<span class="number">1</span>&#125;,<span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;æŸ¥æ‰¾å¼‚å¸¸&#x27;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;data&#x27;</span>,data)</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="attr">result</span>:data</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p><code>findOne</code>è¿”å›å•ä¸ªç»“æœï¼Œæ˜¯ä¸€ä¸ªæ•°æ®å¯¹è±¡ã€‚ä¹Ÿæ˜¯å¯ä»¥ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œä¾æ®æ˜¯å¦å¤§é‡æŸ¥è¯¢ä½¿ç”¨ä¸åŒçš„æŒ‡ä»¤å¯¹æ€§èƒ½çš„å½±å“å¯èƒ½ä¸ä¸€æ ·</p><h1 id="æ–°å¢-åˆ›å»ºå®ä½“"><a href="#æ–°å¢-åˆ›å»ºå®ä½“" class="headerlink" title="æ–°å¢(åˆ›å»ºå®ä½“)"></a>æ–°å¢(åˆ›å»ºå®ä½“)</h1><p>å®ä½“çš„å®šä¹‰å¦‚ä¸‹<br><div class="note primary flat"><p>å®ä½“(Entity)æ˜¯ç”±Modelåˆ›å»ºçš„å®ä½“ï¼Œä½¿ç”¨saveæ–¹æ³•ä¿å­˜æ•°æ®ï¼ŒModelå’ŒEntityéƒ½æœ‰èƒ½å½±å“æ•°æ®åº“çš„æ“ä½œï¼Œä½†Modelæ¯”Entityæ›´å…·æ“ä½œæ€§ã€‚</p></div></p><p>æ–°å¢éœ€è¦å»ºç«‹å®ä½“ï¼Œå®ä½“æ˜¯æ ¹æ®æ¨¡å‹å»ºç«‹çš„ã€‚å®ä½“ä¸­æœ‰saveæ–¹æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹æ•°æ®åº“è¿›è¡Œæ’å…¥æ“ä½œï¼Œä¹Ÿæ˜¯ä¼ é€’ä¸€ä¸ªå›è°ƒå‚æ•°<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–queryå‚æ•°</span></span><br><span class="line"><span class="keyword">let</span> &#123;</span><br><span class="line">    addr,</span><br><span class="line">    name,</span><br><span class="line">    phone,</span><br><span class="line">    time</span><br><span class="line">&#125; = req.query;</span><br><span class="line"><span class="comment">//åˆ›å»ºå®ä½“</span></span><br><span class="line"><span class="keyword">let</span> AddEntity = <span class="keyword">new</span> address(&#123;</span><br><span class="line">    addr,</span><br><span class="line">    name,</span><br><span class="line">    phone,</span><br><span class="line">    time</span><br><span class="line">&#125;)</span><br><span class="line">AddEntity.save(<span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;æ’å…¥å¤±è´¥ï¼š&#x27;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;æ’å…¥æˆåŠŸ&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="åˆ é™¤delete"><a href="#åˆ é™¤delete" class="headerlink" title="åˆ é™¤delete"></a>åˆ é™¤delete</h1><p>åˆ é™¤çš„æ“ä½œæ˜¯åŸºäºæ¨¡å‹çš„ï¼Œæ˜¯æ¨¡å‹ä¸­çš„æ–¹æ³•<br>åˆ é™¤æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯<code>deleteOne</code>å’Œ<code>remove</code></p><p><code>deleteOne</code>ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æŸ¥æ‰¾æ¡ä»¶ï¼Œä¸€ä¸ªæ˜¯å›è°ƒå‡½æ•°</p><p>ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">address.deleteOne(&#123;</span><br><span class="line">    _id</span><br><span class="line">&#125;, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;åˆ é™¤å¤±è´¥ï¼š&#x27;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;åˆ é™¤æˆåŠŸ&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="æ›´æ–°update"><a href="#æ›´æ–°update" class="headerlink" title="æ›´æ–°update"></a>æ›´æ–°update</h1><p>æ›´æ–°çš„æ“ä½œæ˜¯åŸºäºæ¨¡å‹çš„ï¼Œæ˜¯æ¨¡å‹çš„api</p><p><code>updateOne</code>æ–¹æ³•ï¼Œä¼ å…¥ä¸‰ä¸ªå‚æ•°</p><ol><li>å¯¹è±¡åŒ…è£¹çš„æŸ¥è¯¢æ¡ä»¶</li><li>å¯¹è±¡åŒ…è£¹çš„æ›´æ–°æ•°æ®</li><li>å›è°ƒå‚æ•°</li></ol><p>ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">address.updateOne(&#123;</span><br><span class="line">    _id</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    addr,</span><br><span class="line">    name,</span><br><span class="line">    phone,</span><br><span class="line">    time</span><br><span class="line">&#125;, <span class="function">(<span class="params">err, data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;ä¿®æ”¹å¤±è´¥ï¼š&#x27;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.json(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;ä¿®æ”¹æˆåŠŸ&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>å¦å¤–è¿˜æœ‰<code>findByIdAndUpdate</code>,<code>findOneAndUpdate</code>æ–¹æ³•</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨mongooseæ“ä½œä¸­éœ€è¦æ³¨æ„å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è¯¥è¡¨ï¼Œä¼šæ–°å»ºä¸ºå¤æ•°åç§°çš„è¡¨ï¼Œæ‰€ä»¥å¯¼å…¥æ•°æ®çš„æ—¶å€™åº”è¯¥åœ¨åº“å»ºç«‹å¥½ä¹‹åå†è€ƒè™‘å¯¼å…¥</p><p>å¦‚æœå·²ç»æœ‰è¡¨ï¼Œå¯¹åº”çš„è§„åˆ™åœ¨schemaä¸­ä¹Ÿä¸èƒ½å‡ºé”™ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç±»å‹çš„çº¦æŸ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="JSç³»åˆ—" scheme="https://zlinni.github.io/categories/JS%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="nodejs" scheme="https://zlinni.github.io/tags/nodejs/"/>
    
    <category term="nosql" scheme="https://zlinni.github.io/tags/nosql/"/>
    
  </entry>
  
  <entry>
    <title>Httpæ‰“æ€ªå‡çº§1.0-3.0</title>
    <link href="https://zlinni.github.io/posts/1703341700/"/>
    <id>https://zlinni.github.io/posts/1703341700/</id>
    <published>2022-05-21T01:49:01.000Z</published>
    <updated>2022-06-01T07:32:43.369Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>ä»‹ç»http1.0-3.0çš„ç‰ˆæœ¬ä¼˜ç¼ºç‚¹</p></div><h1 id="Http1-0"><a href="#Http1-0" class="headerlink" title="Http1.0"></a>Http1.0</h1><div class="note warning flat"><p>http1.0ä¹‹å‰è¿˜æœ‰åˆ«çš„ç‰ˆæœ¬å—ï¼Ÿ<br>ç­”:http0.9</p></div><p>ç‰¹ç‚¹ï¼š</p><ul><li>å¯ä»¥ä¼ è¾“ä»»ä½•æ ¼å¼çš„å†…å®¹ 0.9åªèƒ½æ–‡æœ¬</li><li>å¼•å…¥äº†POSTå’ŒHEAD 0.9åªæœ‰GET</li><li>æ¯æ¬¡é€šä¿¡éƒ½å¾—æºå¸¦å¤´ä¿¡æ¯ 0.9æ²¡æœ‰æ ‡è®°ä¿¡æ¯çš„æ‰‹æ®µ</li><li>å¢åŠ äº†å“åº”çŠ¶æ€ç </li><li>ç¼“å­˜çš„æ ‡å‡†æ˜¯<code>Expires</code>å’Œ<code>If-Modified-Since</code></li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ </li><li>æ²¡æœ‰ä¼ é€’ä¸»æœºåhostname</li></ul><h2 id="æ²¡æœ‰è§£å†³çš„é—®é¢˜"><a href="#æ²¡æœ‰è§£å†³çš„é—®é¢˜" class="headerlink" title="æ²¡æœ‰è§£å†³çš„é—®é¢˜"></a>æ²¡æœ‰è§£å†³çš„é—®é¢˜</h2><p>æœåŠ¡å™¨å‘é€å®Œå“åº”å°±å…³é—­äº†TCPè¿æ¥ã€‚</p><p>httpè¿æ¥æ˜¯åœ¨TCPè¿æ¥é‡Œé¢çš„ï¼Œå¦‚æœè¿™æ ·åšï¼Œåé¢å†æ¬¡è¯·æ±‚ï¼Œå°±è¦é‡æ–°å»ºç«‹è¿æ¥ï¼Œç„¶é¹…æˆ‘ä»¬çŸ¥é“TCPä¸‰æ¬¡æ¡æ‰‹çš„æˆæœ¬æ˜¯æ¯”è¾ƒé«˜çš„</p><p>1.0ç¼“è§£çš„æ–¹æ³•ï¼š</p><p>1.0å¯ä»¥ä½¿ç”¨headerså‘é€ä¿¡æ¯ï¼Œå…¶ä¸­<code>Connectionï¼škeep-alive</code>ï¼Œå°±èƒ½å‘Šè¯‰æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯åé¢å¯èƒ½è¿˜ä¼šè¯·æ±‚ï¼Œå…ˆä¸è¦å…³é—­TCPè¿æ¥ï¼Œä»è€Œè¾¾åˆ°äº†ç±»ä¼¼äºTCPå¤ç”¨çš„ç›®çš„ã€‚</p><p>ä¸ºä»€ä¹ˆè¯´æ˜¯ç¼“è§£çš„æ–¹æ³•å‘¢ï¼Ÿ<br>å› ä¸ºè¿™ä¸ªå¤´éƒ¨å­—æ®µä¸æ˜¯æ ‡å‡†çš„ï¼Œä¸åŒçš„å®ç°å¯èƒ½å¯¼è‡´è¡¨ç°å¾—ä¸ä¸€è‡´ï¼Œå› æ­¤ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h1 id="Http1-1"><a href="#Http1-1" class="headerlink" title="Http1.1"></a>Http1.1</h1><p>è§£å†³äº†ä¸Šä¸ªç‰ˆæœ¬çš„é—®é¢˜ï¼š</p><ol><li>å¼•å…¥é•¿è¿æ¥ï¼Œé»˜è®¤TCPä¸å…³é—­ï¼Œå¯ä»¥è¢«å¤šä¸ªè¯·æ±‚å¤ç”¨</li><li>æ”¯æŒæ–­ç‚¹ç»­ä¼ </li></ol><p>ç‰¹ç‚¹ï¼š</p><ol><li>å¼•å…¥å¹¶å‘è¿æ¥</li><li>ç®¡é“æœºåˆ¶(ä¸€ä¸ªTCPè¿æ¥é‡Œå¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯å“åº”çš„é¡ºåºå’Œè¯·æ±‚çš„é¡ºåºä¸€è‡´ï¼Œå› æ­¤ä¸å¸¸ç”¨)</li><li>å¢åŠ äº†PUTã€DELETEã€OPTIONSã€PATCHç­‰æ–¹æ³•</li><li>å…è®¸å“åº”æ•°æ®åˆ†å—chunkedï¼Œåˆ©äºä¼ è¾“å¤§æ–‡ä»¶</li><li>å¼ºåˆ¶è¦æ±‚hostå¤´ï¼Œè®©ä¸»æœºæ‰˜ç®¡æˆä¸ºå¯èƒ½</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>é˜Ÿå¤´é˜»å¡(é•¿è¿æ¥å¸¦æ¥)</li><li>æ— çŠ¶æ€</li><li>æ˜æ–‡ä¼ è¾“</li><li>ä¸æ”¯æŒæœåŠ¡å™¨ç«¯æ¨é€</li></ol><h1 id="é˜Ÿå¤´é˜»å¡çš„æ€è€ƒ"><a href="#é˜Ÿå¤´é˜»å¡çš„æ€è€ƒ" class="headerlink" title="é˜Ÿå¤´é˜»å¡çš„æ€è€ƒ"></a>é˜Ÿå¤´é˜»å¡çš„æ€è€ƒ</h1><p>é˜Ÿå¤´é˜»å¡ç‰¹ç‚¹ï¼šé¡ºåºå‘é€çš„è¯·æ±‚å› ä¸ºæŸäº›åŸå› è¢«é˜»å¡çš„æ—¶å€™ï¼Œåé¢æ’é˜Ÿçš„è¯·æ±‚ä¹Ÿä¼šä¸€å¹¶è¢«é˜»å¡ï¼Œå¯¼è‡´æœåŠ¡ç«¯æ”¶ä¸åˆ°æ•°æ®ã€‚</p><p>HTTP1.1ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p><ol><li>åŸŸååˆ†ç‰‡+å¹¶å‘è¿æ¥</li><li>ç®¡é“æœºåˆ¶</li></ol><h2 id="åŸŸååˆ†ç‰‡-å¹¶å‘è¿æ¥"><a href="#åŸŸååˆ†ç‰‡-å¹¶å‘è¿æ¥" class="headerlink" title="åŸŸååˆ†ç‰‡+å¹¶å‘è¿æ¥"></a>åŸŸååˆ†ç‰‡+å¹¶å‘è¿æ¥</h2><p>åœ¨chromeä¸­ï¼Œå…è®¸ä¸€ä¸ªåŸŸåæ‹¥æœ‰6ä¸ªTCPæŒä¹…è¿æ¥ï¼Œé‚£ä¹ˆå½“æ‹¥æœ‰å¤šçº§åŸŸåçš„æ—¶å€™ï¼Œå°±èƒ½å°†æ›´å¤šçš„èµ„æºåˆ†é…å‡ºæ¥ã€‚</p><p>ä½†æ˜¯ä¹Ÿä¼šå¼•èµ·ä¸€äº›åˆ«çš„é—®é¢˜ï¼Œå› ä¸ºTCPçš„è¿æ¥éœ€è¦ç»è¿‡dnsï¼Œä¸‰æ¬¡æ¡æ‰‹ï¼Œæ…¢å¯åŠ¨ç­‰æ“ä½œï¼Œæ‰€ä»¥å¯¹äºæœåŠ¡å™¨æ¥è¯´è¿æ¥å¤ªå¤šå®¹æ˜“é€ æˆç½‘ç»œæ‹¥æŒ¤ã€‚</p><h2 id="ç®¡é“æœºåˆ¶"><a href="#ç®¡é“æœºåˆ¶" class="headerlink" title="ç®¡é“æœºåˆ¶"></a>ç®¡é“æœºåˆ¶</h2><p>æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªTCPè¿æ¥é‡Œé¢ï¼Œå¤šä¸ªHTTPè¯·æ±‚å¯ä»¥å¹¶è¡Œï¼Œå®¢æˆ·ç«¯ä¸ç”¨ç­‰å¾…ä¸Šä¸€æ¬¡è¯·æ±‚ç»“æœè¿”å›ï¼Œå°±å¯ä»¥å‘å‡ºä¸‹ä¸€æ¬¡è¯·æ±‚ï¼Œä½†æœåŠ¡ç«¯å†…å¿…é¡»æŒ‰ç…§æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚çš„å…ˆåé¡ºåºä¾æ¬¡å›é€å“åº”ç»“æœï¼Œä»¥ä¿è¯å®¢æˆ·ç«¯èƒ½åŒºåˆ†æ¯æ¬¡å“åº”çš„å†…å®¹</p><p>ç®€å•æ¥è¯´å°±æ˜¯å®¢æˆ·ç«¯å¯ä»¥ä¸€ç›´å‘ï¼Œä½†æœåŠ¡ç«¯è¦æŒ‰é¡ºåºå›</p><p>ä¸€å®šç¨‹åº¦ä¸Šèƒ½è§£å†³é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼Œä½†æ²»æ ‡ä¸æ²»æœ¬ï¼Œå› ä¸ºå¦‚æœå‰é¢çš„ä¸€ä¸ªè¯·æ±‚å¾ˆè€—è´¹æ—¶é—´ï¼Œæ¯”å¦‚å¤§å›¾ç‰‡çš„å¤„ç†ï¼Œé‚£ä¹ˆåé¢çš„å³ä½¿æœåŠ¡å™¨å¤„ç†å®Œäº†ä¹Ÿåªèƒ½ç­‰å¾…è¿™ä¸ªè¯·æ±‚å¤„ç†å®Œæ‰èƒ½è¿”å›</p><h2 id="å…¶ä»–æ–¹æ¡ˆ"><a href="#å…¶ä»–æ–¹æ¡ˆ" class="headerlink" title="å…¶ä»–æ–¹æ¡ˆ"></a>å…¶ä»–æ–¹æ¡ˆ</h2><ul><li>åˆå¹¶å°æ–‡ä»¶å‡å°èµ„æºæ•°ã€‚ç²¾çµå›¾</li><li>å†…è”èµ„æºã€‚å›¾ç‰‡æ”¾åˆ°cssçš„urlé‡Œé¢ï¼Œå‡å°‘è¯·æ±‚æ¬¡æ•°</li><li>å‡å°è¯·æ±‚æ•°é‡ã€‚æ‹¼æ¥ï¼Œå°†å¤šä¸ªä½“ç§¯è¾ƒå°çš„jsæ‰“åŒ…æˆä¸€ä¸ªå¤§jsï¼Œä½†å¦‚æœå…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æ”¹åŠ¨å°±ä¼šå¯¼è‡´å¤§é‡æ•°æ®è¢«é‡æ–°ä¸‹è½½å’Œä¼ è¾“</li></ul><h1 id="æ— çŠ¶æ€ç‰¹æ€§â€”å·¨å¤§çš„HTTPå¤´éƒ¨"><a href="#æ— çŠ¶æ€ç‰¹æ€§â€”å·¨å¤§çš„HTTPå¤´éƒ¨" class="headerlink" title="æ— çŠ¶æ€ç‰¹æ€§â€”å·¨å¤§çš„HTTPå¤´éƒ¨"></a>æ— çŠ¶æ€ç‰¹æ€§â€”å·¨å¤§çš„HTTPå¤´éƒ¨</h1><p>æ— çŠ¶æ€æŒ‡çš„æ˜¯å¯¹äºè¿æ¥çŠ¶æ€æ²¡æœ‰è®°å¿†èƒ½åŠ›ã€‚çº¯å‡€çš„httpæ˜¯æ²¡æœ‰cookieç­‰æœºåˆ¶çš„ï¼Œæ¯ä¸ªè¿æ¥éƒ½æ˜¯æ–°çš„è¿æ¥ã€‚</p><p>ä½†æ˜¯ç”±äºæ–°å¢äº†headeræ ‡è¯†ä¿¡æ¯çš„æ“ä½œï¼Œæ¯æ¬¡æ”¶å‘éƒ½ä¼šæºå¸¦å¤§é‡çš„headerå­—æ®µåˆ°æœåŠ¡ç«¯ï¼Œè¿™æ ·å°±é€æ¸çš„å¢åŠ äº†ä¼ è¾“çš„æˆæœ¬</p><p>æ‰€ä»¥2.0è®¾è®¡çš„Hpackç®—æ³•å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è¯ç”Ÿçš„ã€‚</p><h1 id="æ˜æ–‡ä¼ è¾“â€”ä¸å®‰å…¨æ€§"><a href="#æ˜æ–‡ä¼ è¾“â€”ä¸å®‰å…¨æ€§" class="headerlink" title="æ˜æ–‡ä¼ è¾“â€”ä¸å®‰å…¨æ€§"></a>æ˜æ–‡ä¼ è¾“â€”ä¸å®‰å…¨æ€§</h1><p>1.1åœ¨ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯æ˜æ–‡çš„ï¼Œè¿™æ ·æ„å‘³ç€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ²¡åŠæ³•éªŒè¯å¯¹æ–¹çš„èº«ä»½ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ— æ³•ä¿è¯æ•°æ®çš„å®‰å…¨æ€§</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>http1.1å› ä¸ºå¼•å…¥äº†é•¿è¿æ¥å¸¦æ¥äº†é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼Œä½¿ç”¨äº†åŸŸååˆ†ç‰‡å’Œç®¡é“æœºåˆ¶ç¼“è§£ï¼Œä½†æ˜¯æ²¡æœ‰ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼Œä¸”å¼•å…¥äº†headerå¤´å­—æ®µæ ‡è¯†ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰å‹ç¼©ä»¥åŠå­˜å‚¨å¯¼è‡´å¤´éƒ¨ä¿¡æ¯å¾ˆå¤§ï¼Œæœ€åæ˜¯æ˜æ–‡ä¼ è¾“çš„é—®é¢˜ï¼Œä¸å®‰å…¨ã€‚</p><h1 id="SPDY-æ”¹è¿›ç‰ˆHttp1-1"><a href="#SPDY-æ”¹è¿›ç‰ˆHttp1-1" class="headerlink" title="SPDY æ”¹è¿›ç‰ˆHttp1.1"></a>SPDY æ”¹è¿›ç‰ˆHttp1.1</h1><p>SPDYï¼šspeedy è¿…é€Ÿçš„ã€‚SPDYåè®®æ˜¯2012å¹´è°·æ­Œæå‡ºçš„æ–¹æ¡ˆï¼Œä¼˜åŒ–äº†http1.xçš„è¯·æ±‚å»¶è¿Ÿï¼Œè§£å†³äº†httpçš„å®‰å…¨æ€§ã€‚</p><ol><li>é’ˆå¯¹httpé«˜å»¶è¿Ÿçš„é—®é¢˜,speedyé‡‡ç”¨äº†å¤šè·¯å¤ç”¨.å®ƒé€šè¿‡å¤šä¸ªè¯·æ±‚streamå…±äº«ä¸€ä¸ªtcpè¿æ¥çš„æ–¹å¼,è§£å†³äº†httpé˜Ÿå¤´é˜»å¡çš„é—®é¢˜.</li><li>è®¾ç½®äº†è¯·æ±‚ä¼˜å…ˆçº§,é‡è¦çš„è¯·æ±‚ä¼˜å…ˆå“åº”</li><li>headerå‹ç¼©</li><li>åŠ å¯†ä¼ è¾“</li><li>æœåŠ¡ç«¯æ¨é€</li></ol><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220525114043.png" alt=""></p><p>å¦‚ä¸Šå›¾æ‰€ç¤º,SPDYä½äºHTTPä¹‹ä¸‹ï¼ŒTCPå’ŒSSLä¹‹ä¸Šï¼Œè¿™æ ·å¯ä»¥è½»æ¾å…¼å®¹è€ç‰ˆæœ¬çš„HTTPåè®®(å°†HTTP1.xçš„å†…å®¹å°è£…æˆä¸€ç§æ–°çš„frameæ ¼å¼)ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨å·²æœ‰çš„SSLåŠŸèƒ½ã€‚</p><p>åé¢çš„http2.0å°±æ˜¯åŸºäºspeedyåè®®æ“ä½œçš„</p><h1 id="Http2"><a href="#Http2" class="headerlink" title="Http2"></a>Http2</h1><p>è§£å†³äº†ä¸Šç‰ˆæœ¬ä»€ä¹ˆé—®é¢˜ï¼š</p><ol><li>HTTPé˜Ÿå¤´é˜»å¡(æµ)(å¤šè·¯å¤ç”¨)</li><li>å¤´éƒ¨è¿‡å¤§çš„é—®é¢˜(å¤´éƒ¨å‹ç¼©)</li></ol><p>ç‰¹æ€§ï¼š</p><ol><li>äºŒè¿›åˆ¶åˆ†å¸§</li><li>å¤´éƒ¨å‹ç¼©</li><li>å¤šè·¯å¤ç”¨</li><li>æœåŠ¡ç«¯æ¨é€</li><li>æµ</li></ol><h2 id="äºŒè¿›åˆ¶ä¼ è¾“"><a href="#äºŒè¿›åˆ¶ä¼ è¾“" class="headerlink" title="äºŒè¿›åˆ¶ä¼ è¾“"></a>äºŒè¿›åˆ¶ä¼ è¾“</h2><p>HTTP2ä¼ è¾“çš„æ•°æ®é‡å‡å°‘ï¼Œä¸¤ä¸ªåŸå› ï¼Œä¸€ä¸ªæ˜¯äºŒè¿›åˆ¶åˆ†å¸§ä¸€ä¸ªæ˜¯å¤´éƒ¨å‹ç¼©ã€‚</p><p>é¦–å…ˆäºŒè¿›åˆ¶åˆ†å¸§å°±æ˜¯é‡‡ç”¨äºŒè¿›åˆ¶çš„å½¢å¼ä¼ è¾“æ•°æ®ï¼Œæ¯”èµ·1.xçš„æ—¶å€™é‡‡ç”¨çš„çº¯æ–‡æœ¬çš„å½¢å¼ï¼Œæ›´å®¹æ˜“è§£æã€‚</p><p>è¯¦ç»†çš„æ¥è®²ï¼Œå®ƒå°†Headers+Bodyçš„æŠ¥æ–‡å½¢å¼æ‹†åˆ†æˆä¸€ä¸ªä¸ªäºŒè¿›åˆ¶çš„å¸§ï¼Œç”¨Headerså¸§å­˜æ”¾å¤´éƒ¨å­—æ®µï¼Œç”¨Dataå¸§å­˜æ”¾è¯·æ±‚ä½“æ•°æ®ã€‚</p><p>åˆ†å¸§å¸¦æ¥çš„å½±å“å°±æ˜¯ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ˜¯ä¸€å †ä¹±åºçš„äºŒè¿›åˆ¶å¸§ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯ä¸å­˜åœ¨å…ˆåçš„é—®é¢˜ï¼Œä¹Ÿå°±è§£å†³äº†HTTPé˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚ï¼ˆä½†æ˜¯TCPé˜Ÿå¤´é˜»å¡è¿˜æ²¡æœ‰è§£å†³ï¼‰</p><p>ä¹±åºçš„å¸§ã€‚æŒ‡çš„æ˜¯å¯¹äºä¸åŒIDçš„æµæ˜¯ä¹±åºçš„ï¼Œä½†æ˜¯åŒä¸€ä¸ªIDçš„æµè¿˜æ˜¯é¡ºåºçš„ã€‚åˆ°è¾¾æœåŠ¡ç«¯åå°†é¡ºåºçš„IDç»„åˆæˆå®Œæ•´çš„æŠ¥æ–‡ã€‚</p><p>æœ‰å…¶ä»–çš„å­—æ®µå¯ä»¥å®ç°ä¼˜å…ˆçº§å’Œæµé‡æ§åˆ¶</p><h2 id="å¤šè·¯å¤ç”¨"><a href="#å¤šè·¯å¤ç”¨" class="headerlink" title="å¤šè·¯å¤ç”¨"></a>å¤šè·¯å¤ç”¨</h2><p>åºŸå¼ƒäº†1.xä¸­çš„ç®¡é“ã€‚åŒä¸€ä¸ªTCPè¿æ¥é‡Œé¢å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚å’Œå¤šä¸ªå“åº”ï¼Œä¸”ä¸ç”¨æŒ‰ç…§é¡ºåºæ¥ã€‚</p><h2 id="å¤´éƒ¨å‹ç¼©"><a href="#å¤´éƒ¨å‹ç¼©" class="headerlink" title="å¤´éƒ¨å‹ç¼©"></a>å¤´éƒ¨å‹ç¼©</h2><p>HPACKç®—æ³•ï¼Œåœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´å»ºç«‹å“ˆå¸Œè¡¨ï¼Œç”¨åˆ°çš„å­—æ®µå­˜æ”¾åœ¨è¿™å¼ è¡¨é‡Œé¢ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­å·²ç»å‡ºç°è¿‡çš„å­—æ®µå°±ç©¿ç´¢å¼•ç»™å¯¹æ–¹å³å¯ã€‚</p><p>å¯¹äºæ•´æ•°å’Œå­—ç¬¦ä¸²è¿›è¡Œå“ˆå¤«æ›¼ç¼–ç ï¼ŒåŸç†æ˜¯å°†æ‰€æœ‰å‡ºç°çš„å­—ç¬¦å»ºç«‹ä¸€å¼ ç´¢å¼•è¡¨ï¼Œè®©å‡ºç°æ¬¡æ•°å¤šçš„å­—ç¬¦å¯¹äºçš„ç´¢å¼•å°½å¯èƒ½çŸ­ï¼Œä¼ è¾“çš„æ—¶å€™ä¹Ÿæ˜¯ä¼ è¾“è¿™æ ·çš„ç´¢å¼•åºåˆ—ï¼Œå¯ä»¥è¾¾åˆ°éå¸¸é«˜çš„å‹ç¼©æ•ˆç‡ã€‚</p><h2 id="æœåŠ¡ç«¯æ¨é€"><a href="#æœåŠ¡ç«¯æ¨é€" class="headerlink" title="æœåŠ¡ç«¯æ¨é€"></a>æœåŠ¡ç«¯æ¨é€</h2><p>å¦å¤–å€¼å¾—ä¸€è¯´çš„æ˜¯HTTP2çš„æœåŠ¡å™¨æ¨é€Server Pushã€‚åœ¨HTTP2ä¸­ï¼ŒæœåŠ¡å™¨å·²ç»ä¸å†æ˜¯è¢«åŠ¨çš„æ¥æ”¶è¯·æ±‚ï¼Œå“åº”è¯·æ±‚ï¼Œä»–ä¹Ÿèƒ½æ–°å»ºStreamæ¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯ï¼Œå½“TCPè¿æ¥å»ºç«‹ä¹‹åï¼Œæ¯”å¦‚æµè§ˆå™¨è¯·æ±‚ä¸€ä¸ªHTMLæ–‡ä»¶ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨è¿”å›HTMLçš„åŸºç¡€ä¸Šï¼Œå°†HTMLä¸­å¼•ç”¨åˆ°çš„ä¸€äº›å…¶ä»–èµ„æºæ–‡ä»¶ä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå‡å°‘å®¢æˆ·ç«¯ç­‰å¾…ã€‚</p><h1 id="2-0ç¼ºç‚¹"><a href="#2-0ç¼ºç‚¹" class="headerlink" title="2.0ç¼ºç‚¹"></a>2.0ç¼ºç‚¹</h1><p>2.0æ²¡æœ‰è§£å†³TCPé˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œè€ŒTCPä»ç„¶æ˜¯webçš„æ„å»ºåŸºç¡€ï¼Œå½“TCPä¼ è¾“çš„æ•°æ®åŒ…åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±çš„æ—¶å€™ï¼Œåœ¨æœåŠ¡ç«¯é‡æ–°å‘é€ä¸¢å¤±çš„æ•°æ®åŒ…ä¹‹å‰ï¼Œæ¥æ”¶æ–¹æ— æ³•ç¡®è®¤ä¼ å…¥çš„æ•°æ®åŒ…ã€‚ç”±äºTCPåœ¨è®¾è®¡ä¸Šä¸éµå¾ªHTTPä¹‹ç±»çš„é«˜çº§åè®®ï¼Œå› æ­¤å•ä¸ªä¸¢å¤±çš„æ•°æ®åŒ…å°†é˜»å¡æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„HTTPè¯·æ±‚ä¸­çš„æµï¼Œç›´åˆ°é‡æ–°å‘é€ä¸¢å¤±çš„æ•°æ®ä¸ºæ­¢ã€‚è¿™ä¸ªé—®é¢˜åœ¨ä¸å¯é çš„è¿æ¥ä¸Šå°¤ä¸ºçªå‡ºã€‚</p><p>å¤šè·¯å¤ç”¨å¯¼è‡´æœåŠ¡å™¨å‹åŠ›ä¸Šå‡</p><p>å¤šè·¯å¤ç”¨æ²¡æœ‰é™åˆ¶åŒæ—¶è¯·æ±‚æ•°ï¼Œè¯·æ±‚çš„å¹³å‡æ•°é‡ä¸å¾€å¸¸ç›¸åŒï¼Œä½†å®é™…ä¸Šä¼šæœ‰å¾ˆå¤šè¯·æ±‚çŸ­æš‚çˆ†å‘ï¼Œé€ æˆç¬æ—¶QPSæš´å¢</p><p>å¤šè·¯å¤ç”¨å®¹æ˜“timeout<br>å¤§æ‰¹é‡çš„è¯·æ±‚åŒæ—¶å‘é€ï¼Œç”±äºHTTP2è¿æ¥å†…å­˜åœ¨å¤šä¸ªå¹¶è¡Œçš„æµï¼Œè€Œç½‘ç»œè¯·æ±‚å’ŒæœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œæ¯ä¸ªæµçš„èµ„æºéƒ½ä¼šè¢«ç¨€é‡Šï¼Œè™½ç„¶å®ƒä»¬å¼€å§‹ç›¸å·®æ›´çŸ­ï¼Œä½†éƒ½å¯èƒ½è¶…æ—¶</p><p>å³ä½¿æ˜¯ä½¿ç”¨NGINXè¿™æ ·çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œæƒ³æ­£ç¡®çš„è¿›è¡ŒèŠ‚æµä¹Ÿå¯èƒ½å¾ˆæ£˜æ‰‹ã€‚ å…¶æ¬¡ï¼Œå°±ç®—ä½ å‘åº”ç”¨ç¨‹åºå¼•å…¥æˆ–è°ƒæ•´æ’é˜Ÿæœºåˆ¶ï¼Œä½†ä¸€æ¬¡èƒ½å¤„ç†çš„è¿æ¥ä¹Ÿæ˜¯æœ‰é™çš„ã€‚å¦‚æœå¯¹è¯·æ±‚è¿›è¡Œæ’é˜Ÿï¼Œè¿˜è¦æ³¨æ„åœ¨å“åº”è¶…æ—¶åä¸¢å¼ƒè¯·æ±‚ï¼Œä»¥é¿å…æµªè´¹ä¸å¿…è¦çš„èµ„æºã€‚</p><h1 id="HTTP3-0"><a href="#HTTP3-0" class="headerlink" title="HTTP3.0"></a>HTTP3.0</h1><p>è§£å†³äº†ä¸Šä¸ªç‰ˆæœ¬çš„é—®é¢˜ï¼š</p><ol><li>TCPé˜Ÿå¤´é˜»å¡</li></ol><h2 id="é¢å‘UDPå¯»æ‰¾æ–°å¯èƒ½"><a href="#é¢å‘UDPå¯»æ‰¾æ–°å¯èƒ½" class="headerlink" title="é¢å‘UDPå¯»æ‰¾æ–°å¯èƒ½"></a>é¢å‘UDPå¯»æ‰¾æ–°å¯èƒ½</h2><p>HTTP2ç”±äºé‡‡ç”¨äºŒè¿›åˆ¶åˆ†å¸§è¿›è¡Œå¤šè·¯å¤ç”¨ï¼Œé€šå¸¸åªä½¿ç”¨ä¸€ä¸ªTCPè¿æ¥è¿›è¡Œä¼ è¾“ï¼Œä¸¢åŒ…æˆ–è€…ç½‘ç»œä¸­æ–­çš„æƒ…å†µä¸‹åé¢æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šè¢«é˜»å¡ã€‚</p><p>HTTP/2 çš„é—®é¢˜ä¸èƒ½ä»…é åº”ç”¨ç¨‹åºå±‚æ¥è§£å†³ï¼Œå› æ­¤åè®®çš„æ–°è¿­ä»£å¿…é¡»æ›´æ–°ä¼ è¾“å±‚ã€‚ä½†æ˜¯ï¼Œåˆ›å»ºæ–°çš„ä¼ è¾“å±‚åè®®å¹¶éæ˜“äº‹ã€‚ä¼ è¾“åè®®éœ€è¦ç¡¬ä»¶ä¾›åº”å•†çš„æ”¯æŒï¼Œå¹¶ä¸”éœ€è¦å¤§å¤šæ•°ç½‘ç»œè¿è¥å•†çš„éƒ¨ç½²æ‰èƒ½æ™®åŠã€‚<br>å¹¸è¿çš„æ˜¯è¿˜æœ‰å¦ä¸€ç§é€‰æ‹©ã€‚UDP åè®®ä¸ TCP ä¸€æ ·å¾—åˆ°å¹¿æ³›æ”¯æŒï¼Œä½†å‰è€…è¶³å¤Ÿç®€å•ï¼Œå¯ä»¥ä½œä¸ºåœ¨å…¶ä¹‹ä¸Šè¿è¡Œçš„è‡ªå®šä¹‰åè®®çš„åŸºç¡€ã€‚UDP æ•°æ®åŒ…æ˜¯ä¸€åŠ³æ°¸é€¸çš„ï¼šæ²¡æœ‰æ¡æ‰‹ã€æŒä¹…è¿æ¥æˆ–é”™è¯¯æ ¡æ­£ã€‚HTTP3 èƒŒåçš„ä¸»è¦æ€æƒ³æ˜¯æ”¾å¼ƒ TCPï¼Œè½¬è€Œä½¿ç”¨åŸºäº UDP çš„ QUIC ï¼ˆå¿«é€ŸUDPäº’è”ç½‘è¿æ¥ï¼‰åè®®ã€‚</p><p>ä¸ HTTP2 åœ¨æŠ€æœ¯ä¸Šå…è®¸æœªåŠ å¯†çš„é€šä¿¡ä¸åŒï¼ŒQUIC ä¸¥æ ¼è¦æ±‚åŠ å¯†åæ‰èƒ½å»ºç«‹è¿æ¥ã€‚æ­¤å¤–ï¼ŒåŠ å¯†ä¸ä»…é€‚ç”¨äº HTTP è´Ÿè½½ï¼Œè¿˜é€‚ç”¨äºæµç»è¿æ¥çš„æ‰€æœ‰æ•°æ®ï¼Œä»è€Œé¿å…äº†ä¸€å¤§å †å®‰å…¨é—®é¢˜ã€‚å»ºç«‹æŒä¹…è¿æ¥ã€åå•†åŠ å¯†åè®®ï¼Œç”šè‡³å‘é€ç¬¬ä¸€æ‰¹æ•°æ®éƒ½è¢«åˆå¹¶åˆ° QUIC ä¸­çš„å•ä¸ªè¯·æ±‚/å“åº”å‘¨æœŸä¸­ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†è¿æ¥ç­‰å¾…æ—¶é—´ã€‚å¦‚æœå®¢æˆ·ç«¯å…·æœ‰æœ¬åœ°ç¼“å­˜çš„å¯†ç å‚æ•°ï¼Œåˆ™å¯ä»¥é€šè¿‡ç®€åŒ–çš„æ¡æ‰‹é‡æ–°å»ºç«‹ä¸å·²çŸ¥ä¸»æœºçš„è¿æ¥ã€‚<br>ä¸ºäº†è§£å†³ä¼ è¾“çº§åˆ«çš„çº¿å¤´é˜»å¡é—®é¢˜ï¼Œé€šè¿‡ QUIC è¿æ¥ä¼ è¾“çš„æ•°æ®è¢«åˆ†ä¸ºä¸€äº›æµã€‚æµæ˜¯æŒä¹…æ€§ QUIC è¿æ¥ä¸­çŸ­æš‚ã€ç‹¬ç«‹çš„â€œå­è¿æ¥â€ã€‚æ¯ä¸ªæµéƒ½å¤„ç†è‡ªå·±çš„é”™è¯¯çº æ­£å’Œä¼ é€’ä¿è¯ï¼Œä½†ä½¿ç”¨è¿æ¥å…¨å±€å‹ç¼©å’ŒåŠ å¯†å±æ€§ã€‚æ¯ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„ HTTP è¯·æ±‚éƒ½åœ¨å•ç‹¬çš„æµä¸Šè¿è¡Œï¼Œå› æ­¤ä¸¢å¤±æ•°æ®åŒ…ä¸ä¼šå½±å“å…¶ä»–æµ/è¯·æ±‚çš„æ•°æ®ä¼ è¾“ã€‚</p><h2 id="å®ç°äº†å¿«é€Ÿæ¡æ‰‹åŠŸèƒ½"><a href="#å®ç°äº†å¿«é€Ÿæ¡æ‰‹åŠŸèƒ½" class="headerlink" title="å®ç°äº†å¿«é€Ÿæ¡æ‰‹åŠŸèƒ½"></a>å®ç°äº†å¿«é€Ÿæ¡æ‰‹åŠŸèƒ½</h2><p>ç”±äºQUICæ˜¯åŸºäºUDPçš„ï¼Œæ‰€ä»¥QUICå¯ä»¥å®ç°ä½¿ç”¨0RTTæˆ–1RTTæ¥å»ºç«‹è¿æ¥ï¼Œæ„å‘³ç€QUICå¯ä»¥ç”¨æœ€å¿«çš„é€Ÿåº¦æ¥å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æå‡é¦–æ¬¡æ‰“å¼€é¡µé¢çš„é€Ÿåº¦ã€‚0RTT å»ºè¿å¯ä»¥è¯´æ˜¯ QUIC ç›¸æ¯” HTTP2 æœ€å¤§çš„æ€§èƒ½ä¼˜åŠ¿ã€‚</p><h2 id="é›†æˆäº†TLSåŠ å¯†åŠŸèƒ½"><a href="#é›†æˆäº†TLSåŠ å¯†åŠŸèƒ½" class="headerlink" title="é›†æˆäº†TLSåŠ å¯†åŠŸèƒ½"></a>é›†æˆäº†TLSåŠ å¯†åŠŸèƒ½</h2><p>ç›®å‰QUICä½¿ç”¨çš„æ˜¯TLS1.3ï¼Œç›¸è¾ƒäºæ—©æœŸç‰ˆæœ¬TLS1.3æœ‰æ›´å¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å‡å°‘äº†æ¡æ‰‹æ‰€èŠ±è´¹çš„RTTä¸ªæ•°ã€‚<br>åœ¨å®Œå…¨æ¡æ‰‹æƒ…å†µä¸‹ï¼Œéœ€è¦ 1-RTT å»ºç«‹è¿æ¥ã€‚ TLS1.3 æ¢å¤ä¼šè¯å¯ä»¥ç›´æ¥å‘é€åŠ å¯†åçš„åº”ç”¨æ•°æ®ï¼Œä¸éœ€è¦é¢å¤–çš„ TLS æ¡æ‰‹ï¼Œä¹Ÿå°±æ˜¯ 0-RTTã€‚<br>ä½†æ˜¯ TLS1.3 ä¹Ÿå¹¶ä¸å®Œç¾ã€‚TLS 1.3 çš„ 0-RTT æ— æ³•ä¿è¯å‰å‘å®‰å…¨æ€§(Forward secrecy)ã€‚ç®€å•è®²å°±æ˜¯ï¼Œå¦‚æœå½“æ”»å‡»è€…é€šè¿‡æŸç§æ‰‹æ®µè·å–åˆ°äº† Session Ticket Keyï¼Œé‚£ä¹ˆè¯¥æ”»å‡»è€…å¯ä»¥è§£å¯†ä»¥å‰çš„åŠ å¯†æ•°æ®ã€‚<br>è¦ç¼“è§£è¯¥é—®é¢˜å¯ä»¥é€šè¿‡è®¾ç½®ä½¿å¾—ä¸ Session Ticket Key ç›¸å…³çš„ DH é™æ€å‚æ•°åœ¨çŸ­æ—¶é—´å†…è¿‡æœŸï¼ˆä¸€èˆ¬å‡ ä¸ªå°æ—¶ï¼‰ã€‚</p><h2 id="å¤šè·¯å¤ç”¨ï¼Œå½»åº•è§£å†³TCPä¸­é˜Ÿå¤´é˜»å¡çš„é—®é¢˜"><a href="#å¤šè·¯å¤ç”¨ï¼Œå½»åº•è§£å†³TCPä¸­é˜Ÿå¤´é˜»å¡çš„é—®é¢˜" class="headerlink" title="å¤šè·¯å¤ç”¨ï¼Œå½»åº•è§£å†³TCPä¸­é˜Ÿå¤´é˜»å¡çš„é—®é¢˜"></a>å¤šè·¯å¤ç”¨ï¼Œå½»åº•è§£å†³TCPä¸­é˜Ÿå¤´é˜»å¡çš„é—®é¢˜</h2><p>å’ŒTCPä¸åŒï¼ŒQUICå®ç°äº†åœ¨åŒä¸€ç‰©ç†è¿æ¥ä¸Šå¯ä»¥æœ‰å¤šä¸ªç‹¬ç«‹çš„é€»è¾‘æ•°æ®æµï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚å®ç°äº†æ•°æ®æµçš„å•ç‹¬ä¼ è¾“ï¼Œå°±è§£å†³äº†TCPä¸­é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ã€‚<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e114f32c7404a4fab04b17910453111~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt=""></p><h2 id="è¿æ¥è¿ç§»"><a href="#è¿æ¥è¿ç§»" class="headerlink" title="è¿æ¥è¿ç§»"></a>è¿æ¥è¿ç§»</h2><p>TCP æ˜¯æŒ‰ç…§ 4 è¦ç´ ï¼ˆå®¢æˆ·ç«¯ IPã€ç«¯å£, æœåŠ¡å™¨ IPã€ç«¯å£ï¼‰ç¡®å®šä¸€ä¸ªè¿æ¥çš„ã€‚è€Œ QUIC åˆ™æ˜¯è®©å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ª Connection ID ï¼ˆ64 ä½ï¼‰æ¥åŒºåˆ«ä¸åŒè¿æ¥ã€‚åªè¦ Connection ID ä¸å˜ï¼Œè¿æ¥å°±ä¸éœ€è¦é‡æ–°å»ºç«‹ï¼Œå³ä¾¿æ˜¯å®¢æˆ·ç«¯çš„ç½‘ç»œå‘ç”Ÿå˜åŒ–ã€‚ç”±äºè¿ç§»å®¢æˆ·ç«¯ç»§ç»­ä½¿ç”¨ç›¸åŒçš„ä¼šè¯å¯†é’¥æ¥åŠ å¯†å’Œè§£å¯†æ•°æ®åŒ…ï¼ŒQUIC è¿˜æä¾›äº†è¿ç§»å®¢æˆ·ç«¯çš„è‡ªåŠ¨åŠ å¯†éªŒè¯ã€‚</p><h1 id="Http0-9"><a href="#Http0-9" class="headerlink" title="Http0.9"></a>Http0.9</h1><p>1991å¹´ç”±W3Cåˆ¶å®šçš„æ ‡å‡†ï¼Œè¯ç”Ÿä¹‹åˆæ˜¯ä¸ºäº†ä¼ è¾“HTMLï¼Œå¹¶ä¸”æ”¯æŒGETè¯·æ±‚ã€‚</p><p>å½“æ—¶çš„è¯·æ±‚æŠ¥æ–‡åªæœ‰ä¸€è¡Œï¼ŒGET+è¯·æ±‚çš„è·¯å¾„ã€‚æœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚ä¹‹åä¼šè¿”å›ä¸€ä¸ªä»¥ASCIIç¼–ç çš„HTMLæ–‡æ¡£ã€‚</p><p>ç¼ºç‚¹ï¼š</p><ol><li>æ²¡æœ‰æè¿°æ•°æ®çš„ä¿¡æ¯ï¼Œ1.0å¼•å…¥äº†headers</li><li>ä¹Ÿåªæœ‰ä¸€ä¸ªå‘½ä»¤</li><li>å‘é€å®Œå°±å…³é—­TCPè¿æ¥</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç½‘ç»œç³»åˆ—" scheme="https://zlinni.github.io/categories/%E7%BD%91%E7%BB%9C%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="å‰ç«¯" scheme="https://zlinni.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="è®¡ç®—æœºç½‘ç»œ" scheme="https://zlinni.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    
    <category term="HTTP" scheme="https://zlinni.github.io/tags/HTTP/"/>
    
  </entry>
  
  <entry>
    <title>Node.jsç»“åˆexpress-jwtçš„å®æˆ˜æ•™ç¨‹</title>
    <link href="https://zlinni.github.io/posts/2906490375/"/>
    <id>https://zlinni.github.io/posts/2906490375/</id>
    <published>2022-05-15T08:42:29.000Z</published>
    <updated>2022-05-15T13:58:32.131Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>æœ¬æ–‡è®°å½•nodeä½¿ç”¨express-jwtæ ¡éªŒtokenä»¥åŠå‰ç«¯å‘é€tokençš„å…¨è¿‡ç¨‹</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220515191529.png" alt=""></p><h1 id="ä»€ä¹ˆæ˜¯Token-ä»€ä¹ˆæ˜¯JWT"><a href="#ä»€ä¹ˆæ˜¯Token-ä»€ä¹ˆæ˜¯JWT" class="headerlink" title="ä»€ä¹ˆæ˜¯Token?ä»€ä¹ˆæ˜¯JWT?"></a>ä»€ä¹ˆæ˜¯Token?ä»€ä¹ˆæ˜¯JWT?</h1><p>Tokenäº§ç”ŸåŸå› :å¸¸è§„æ¨¡å¼çš„sessionå­˜æ”¾ç”¨æˆ·ç™»å½•æ€å¯¼è‡´æœåŠ¡å™¨å‹åŠ›å¤§,æœåŠ¡å™¨å¤šçš„æ—¶å€™,éœ€è¦åŒæ­¥session,äºæ˜¯è¯ç”Ÿäº†token,å­˜åˆ°å®¢æˆ·ç«¯,ç”±æœåŠ¡ç«¯è¢«åŠ¨éªŒè¯</p><p>ç¼ºç‚¹:</p><ol><li>è¢«åŠ¨éªŒè¯,å¯¼è‡´æ”¶å›æƒé™ç¨å¾®å›°éš¾.</li><li>æ¯æ¬¡è¯·æ±‚éƒ½è¦æºå¸¦,å¢åŠ æ€§èƒ½å¼€é”€</li></ol><p>JWT: Json Web Token,ä¸€ç§tokençš„éªŒè¯æ–¹å¼,æœ¬è´¨ä¸Šæ˜¯å¸¦æœ‰å‰é¢çš„jsonæ•°æ®.</p><p>JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆ:</p><ol><li>Header:æè¿°JWTçš„å…ƒæ•°æ®,å®šä¹‰äº†ç”Ÿæˆç­¾åçš„ç®—æ³•ä»¥åŠTokençš„ç±»å‹</li><li>Payload:ç”¨äºå­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®</li><li>Signature:ç­¾å,æœåŠ¡å™¨é€šè¿‡Payloadã€Headerå’Œä¸€ä¸ªå¯†é’¥(secret)ä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æ˜¯ HMAC SHA256ï¼‰ç”Ÿæˆã€‚</li></ol><h1 id="åç«¯èŒè´£"><a href="#åç«¯èŒè´£" class="headerlink" title="åç«¯èŒè´£"></a>åç«¯èŒè´£</h1><p>ä½¿ç”¨md5å¯¹å¯†ç è¿›è¡ŒåŠ ç›åŠ å¯†æ”¾å…¥æ•°æ®åº“,ä½¿ç”¨jwtåœ¨åˆé€‚çš„æ—¶æœºå‘æ”¾tokenä»¥åŠtokençš„æ ¡éªŒ,æ¨¡å—åŒ–ä»¥åŠä»£ç å¤ç”¨.</p><h1 id="åç«¯é¡¹ç›®ç›®å½•"><a href="#åç«¯é¡¹ç›®ç›®å½•" class="headerlink" title="åç«¯é¡¹ç›®ç›®å½•"></a>åç«¯é¡¹ç›®ç›®å½•</h1><div class="note primary flat"><p>vscodeçš„project-treeæ’ä»¶ç”Ÿæˆ</p></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">footok</span><br><span class="line">â”œâ”€ app.js</span><br><span class="line">â”œâ”€ db</span><br><span class="line">â”‚  â””â”€ dbConfig.js</span><br><span class="line">â”œâ”€ package-lock.json</span><br><span class="line">â”œâ”€ package.json</span><br><span class="line">â”œâ”€ routes</span><br><span class="line">â”‚  â”œâ”€ index.js //è·¯ç”±åˆå§‹åŒ–+è‡ªå®šä¹‰çŠ¶æ€å¼‚å¸¸</span><br><span class="line">â”‚  â”œâ”€ tasks.js //ä»»åŠ¡æ¨¡å—</span><br><span class="line">â”‚  â””â”€ user.js //ç”¨æˆ·æ¨¡å—</span><br><span class="line">â”œâ”€ services</span><br><span class="line">â”‚  â”œâ”€ taskService.js //ä¸šåŠ¡é€»è¾‘å±‚ ä»»åŠ¡æ¥å£</span><br><span class="line">â”‚  â””â”€ userService.js //ç”¨æˆ·æ¥å£</span><br><span class="line">â”œâ”€ utils</span><br><span class="line">â”‚  â”œâ”€ constant.js //è‡ªå®šä¹‰å¸¸é‡</span><br><span class="line">â”‚  â”œâ”€ index.js //å°è£…è¿æ¥mysql</span><br><span class="line">â”‚  â”œâ”€ md5.js //md5</span><br><span class="line">â”‚  â””â”€ user-jwt.js //jwtéªŒè¯å’Œè§£æå‡½æ•°</span><br><span class="line">â””â”€ views</span><br></pre></td></tr></table></figure><h1 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm i --save express</span><br><span class="line">npm i --save body-parser</span><br><span class="line">npm i --save express-validator</span><br><span class="line">npm i --save cors</span><br><span class="line">npm i --save jsonwebtoken</span><br><span class="line">npm i --save express-jwt</span><br><span class="line">npm i --save mysql</span><br></pre></td></tr></table></figure><h1 id="dbéƒ¨åˆ†-æ•°æ®åº“çš„é…ç½®"><a href="#dbéƒ¨åˆ†-æ•°æ®åº“çš„é…ç½®" class="headerlink" title="dbéƒ¨åˆ†(æ•°æ®åº“çš„é…ç½®)"></a>dbéƒ¨åˆ†(æ•°æ®åº“çš„é…ç½®)</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// ä¸»æœºåç§°ï¼Œä¸€èˆ¬æ˜¯æœ¬æœº</span></span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span>, <span class="comment">// æ•°æ®åº“çš„ç«¯å£å·ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œé»˜è®¤æ˜¯3306</span></span><br><span class="line">    <span class="attr">user</span>: <span class="string">&#x27;yourname&#x27;</span>, <span class="comment">// åˆ›å»ºæ•°æ®åº“æ—¶è®¾ç½®ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;yourpassword&#x27;</span>, <span class="comment">// åˆ›å»ºæ•°æ®åº“æ—¶è®¾ç½®çš„å¯†ç </span></span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;yourdatabase&#x27;</span>, <span class="comment">// åˆ›å»ºçš„æ•°æ®åº“</span></span><br><span class="line">    <span class="attr">connectTimeout</span>: <span class="number">5000</span> <span class="comment">// è¿æ¥è¶…æ—¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mysql;</span><br></pre></td></tr></table></figure><h1 id="utilséƒ¨åˆ†"><a href="#utilséƒ¨åˆ†" class="headerlink" title="utilséƒ¨åˆ†"></a>utilséƒ¨åˆ†</h1><div class="note primary flat"><p>è¯¥éƒ¨åˆ†è´Ÿè´£md5.jwtå’Œmysqlçš„è¿æ¥é…ç½®</p></div><h2 id="constant-js-å®šä¹‰å›ºå®šå‚æ•°"><a href="#constant-js-å®šä¹‰å›ºå®šå‚æ•°" class="headerlink" title="constant.js å®šä¹‰å›ºå®šå‚æ•°"></a><code>constant.js</code> å®šä¹‰å›ºå®šå‚æ•°</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">CODE_ERROR</span>: -<span class="number">1</span>, <span class="comment">// è¯·æ±‚å“åº”å¤±è´¥codeç </span></span><br><span class="line">  <span class="attr">CODE_SUCCESS</span>: <span class="number">0</span>, <span class="comment">// è¯·æ±‚å“åº”æˆåŠŸcodeç </span></span><br><span class="line">  <span class="attr">CODE_TOKEN_EXPIRED</span>: <span class="number">401</span>, <span class="comment">// æˆæƒå¤±è´¥</span></span><br><span class="line">  <span class="attr">PRIVATE_KEY</span>: <span class="string">&#x27;yourKey&#x27;</span>, <span class="comment">// è‡ªå®šä¹‰jwtåŠ å¯†çš„ç§é’¥</span></span><br><span class="line">  <span class="attr">JWT_EXPIRED</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>, <span class="comment">// è¿‡æœŸæ—¶é—´24å°æ—¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å®šä¹‰å‚æ•°çš„åœ°æ–¹,è¿˜æœ‰äº›æˆåŠŸå’Œå¤±è´¥çš„å“åº”ç å¯ä»¥å’Œå‰ç«¯åå•†.</p><h2 id="user-jwt-js-å®šä¹‰jwtæ ¡éªŒè§„åˆ™"><a href="#user-jwt-js-å®šä¹‰jwtæ ¡éªŒè§„åˆ™" class="headerlink" title="user-jwt.js å®šä¹‰jwtæ ¡éªŒè§„åˆ™"></a><code>user-jwt.js</code> å®šä¹‰jwtæ ¡éªŒè§„åˆ™</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>); <span class="comment">// å¼•å…¥éªŒè¯jsonwebtokenæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> expressJwt = <span class="built_in">require</span>(<span class="string">&#x27;express-jwt&#x27;</span>); <span class="comment">// å¼•å…¥express-jwtæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> &#123; PRIVATE_KEY &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./constant&#x27;</span>); <span class="comment">// å¼•å…¥è‡ªå®šä¹‰çš„jwtå¯†é’¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éªŒè¯tokenæ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"><span class="keyword">const</span> jwtAuth = expressJwt(&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®å¯†é’¥</span></span><br><span class="line">  <span class="attr">secret</span>: PRIVATE_KEY,</span><br><span class="line">  <span class="comment">// è®¾ç½®ä¸ºtrueè¡¨ç¤ºæ ¡éªŒï¼Œfalseè¡¨ç¤ºä¸æ ¡éªŒ</span></span><br><span class="line">  <span class="attr">credentialsRequired</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// åŠ å…¥ç®—æ³• </span></span><br><span class="line">  <span class="attr">algorithms</span>:[<span class="string">&#x27;HS256&#x27;</span>],</span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰è·å–tokençš„å‡½æ•°</span></span><br><span class="line">  <span class="attr">getToken</span>: <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.headers.authorization &amp;&amp; req.headers.authorization.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>] === <span class="string">&#x27;Bearer&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> req.headers.authorization.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.query &amp;&amp; req.query.token) &#123;</span><br><span class="line">      <span class="keyword">return</span> req.query.token</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¾ç½®jwtè®¤è¯ç™½åå•ï¼Œæ¯”å¦‚/loginç™»å½•æ¥å£ä¸éœ€è¦æ‹¦æˆª</span></span><br><span class="line">&#125;).unless(&#123;</span><br><span class="line">  <span class="attr">path</span>: [</span><br><span class="line">    <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/login&#x27;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  jwtAuth,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¯”è¾ƒå®¹æ˜“è¸©å‘çš„åœ°æ–¹æ˜¯è¿™ä¸ªBearer,è¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µ:</p><ol><li>å‰ç«¯è¯·æ±‚å‘é€tokençš„æ—¶å€™,è‡ªå·±æ·»åŠ äº†Bearer,ç»„æˆ<code>Bearer token</code></li><li>åç«¯å“åº”å‘é€tokençš„æ—¶å€™,è‡ªå·±æ·»åŠ äº†Bearer,ç»„æˆ<code>Bearer token</code></li></ol><p>ä¸ç®¡æ˜¯ä¸Šé¢å“ªä¸€ç§ç­¾å‘,éªŒè¯éƒ½éœ€è¦å»æ‰Bearer,ç”¨åé¢çš„ä¸œè¥¿è¿›è¡Œæ ¡éªŒ.</p><p>è¿™ä¸ªunlessä¹Ÿæ¯”è¾ƒå®¹æ˜“è¸©å‘,ä¸€èˆ¬æ¥è¯´,ç™»é™†å’Œæ³¨å†Œæ˜¯ä¸éœ€è¦æƒé™çš„,æ‰€ä»¥é»˜è®¤ä¼šæœ‰è¿™ä¸¤ä¸ª.</p><h2 id="md5-js-å®šä¹‰md5"><a href="#md5-js-å®šä¹‰md5" class="headerlink" title="md5.js å®šä¹‰md5"></a><code>md5.js</code> å®šä¹‰md5</h2><p>è¿™éƒ¨åˆ†å°±ä¸ç”¨å¤šè¯´äº†,å¸¸è§„æ“ä½œ<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>); <span class="comment">// å¼•å…¥cryptoåŠ å¯†æ¨¡å—</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">&#x27;md5&#x27;</span>).update(<span class="string">&#x27;&#x27;</span> + s).digest(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = md5;</span><br></pre></td></tr></table></figure></p><h2 id="index-js-å°è£…æ•°æ®åº“çš„æŸ¥è¯¢"><a href="#index-js-å°è£…æ•°æ®åº“çš„æŸ¥è¯¢" class="headerlink" title="index.js å°è£…æ•°æ®åº“çš„æŸ¥è¯¢"></a>index.js å°è£…æ•°æ®åº“çš„æŸ¥è¯¢</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;../db/dbConfig&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿æ¥mysql</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; host, user, password, database &#125; = config;</span><br><span class="line">  <span class="keyword">return</span> mysql.createConnection(&#123;</span><br><span class="line">    host,</span><br><span class="line">    user,</span><br><span class="line">    password,</span><br><span class="line">    database</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°å»ºæŸ¥è¯¢è¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">querySql</span>(<span class="params">sql</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">const</span> conn = connect();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      conn.query(sql, <span class="function">(<span class="params">err, res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(res);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      reject(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">//é‡Šæ”¾è¿æ¥</span></span><br><span class="line">      conn.end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥è¯¢ä¸€æ¡è¯­å¥</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queryOne</span>(<span class="params">sql</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    querySql(sql).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;res===&#x27;</span>,res)</span><br><span class="line">      <span class="keyword">if</span> (res &amp;&amp; res.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        resolve(res[<span class="number">0</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(<span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      reject(err);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  querySql,</span><br><span class="line">  queryOne</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="serviceså±‚"><a href="#serviceså±‚" class="headerlink" title="serviceså±‚"></a>serviceså±‚</h1><p>å¯¹äºå¾ˆä¹…æ²¡æœ‰ä½¿ç”¨nodeçš„å°ä¼™ä¼´,è¿™é‡Œæé†’ä¸€ä¸‹,nodeè·å–getè¯·æ±‚çš„è¯·æ±‚ä½“ä½¿ç”¨çš„æ–¹æ³•æ˜¯<code>req.query.xxx</code>,è·å–postçš„è¯·æ±‚ä½“çš„æ–¹æ³•æ˜¯<code>req.body.xxx</code>(å‰ææ˜¯è£…äº†body-parser),ä»¥åŠå•æ¡æ•°æ®æŸ¥è¯¢çš„æ—¶å€™,æœ€å¥½ä½¿ç”¨è§£æ„çš„æ–¹å¼,æ¯”å¦‚è¯´å¯¹äºä¸‹é¢çš„sqlæŸ¥è¯¢<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> count <span class="keyword">from</span> foodData <span class="keyword">where</span> tag <span class="operator">=</span> <span class="string">&#x27;ç‚’&#x27;</span></span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆè·å–çš„æ—¶å€™,å°±åº”è¯¥æ˜¯<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;count&#125; = result[<span class="number">0</span>];</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä¸‹é¢çš„ä»£ç æµ‹è¯•ä¸è¡Œ,å¯ä»¥å°†ä»£ç å†™åœ¨app.jsé‡Œé¢æµ‹è¯•,å› ä¸ºå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä½ çš„è·¯å¾„æ²¡æœ‰å†™å¯¹.</p><h2 id="userService"><a href="#userService" class="headerlink" title="userService"></a>userService</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    querySql,</span><br><span class="line">    queryOne</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/index&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">&#x27;../utils/md5&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    CODE_ERROR,</span><br><span class="line">    CODE_SUCCESS,</span><br><span class="line">    PRIVATE_KEY,</span><br><span class="line">    JWT_EXPIRED</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/constant&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;</span><br><span class="line">        username,</span><br><span class="line">        password</span><br><span class="line">    &#125; = req.body;</span><br><span class="line">    <span class="comment">// md5åŠ ç›åŠ å¯†</span></span><br><span class="line">    password = md5(md5(username + md5(password))) <span class="comment">//å‚¨å­˜å¯†ç </span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;psw&#x27;</span>, password);</span><br><span class="line">    <span class="keyword">const</span> query = <span class="string">`select * from userdata where username=&#x27;<span class="subst">$&#123;username&#125;</span>&#x27; and password=&#x27;<span class="subst">$&#123;password&#125;</span>&#x27;`</span>;</span><br><span class="line">    querySql(query)</span><br><span class="line">        .then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!user || user.length === <span class="number">0</span>) &#123;</span><br><span class="line">                res.json(&#123;</span><br><span class="line">                    <span class="attr">code</span>: CODE_ERROR,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯&#x27;</span>,</span><br><span class="line">                    <span class="attr">records</span>: <span class="literal">null</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ç™»å½•æˆåŠŸï¼Œç­¾å‘ä¸€ä¸ªtokenå¹¶è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">                <span class="keyword">const</span> tokenStr = jwt.sign(</span><br><span class="line">                    <span class="comment">// payloadï¼šç­¾å‘çš„ token é‡Œé¢è¦åŒ…å«çš„ä¸€äº›æ•°æ®ã€‚</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        username</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="comment">// ç§é’¥</span></span><br><span class="line">                    PRIVATE_KEY,</span><br><span class="line">                    <span class="comment">// è®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">expiresIn</span>: JWT_EXPIRED</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                <span class="keyword">let</span> userData = &#123;</span><br><span class="line">                    <span class="attr">id</span>: user[<span class="number">0</span>].id,</span><br><span class="line">                    <span class="attr">username</span>: user[<span class="number">0</span>].username,</span><br><span class="line">                    <span class="attr">nickname</span>: user[<span class="number">0</span>].nickname,</span><br><span class="line">                    <span class="attr">avator</span>: user[<span class="number">0</span>].avator,</span><br><span class="line">                    <span class="attr">sex</span>: user[<span class="number">0</span>].sex,</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                res.json(&#123;</span><br><span class="line">                    <span class="attr">code</span>: CODE_SUCCESS,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;ç™»å½•æˆåŠŸ&#x27;</span>,</span><br><span class="line">                    <span class="attr">records</span>: &#123;</span><br><span class="line">                        <span class="attr">token</span>: <span class="string">&#x27;Bearer &#x27;</span> + tokenStr,</span><br><span class="line">                        userData</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;</span><br><span class="line">        username,</span><br><span class="line">        password</span><br><span class="line">    &#125; = req.body;</span><br><span class="line">    findUser(username)</span><br><span class="line">        .then(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                res.json(&#123;</span><br><span class="line">                    <span class="attr">code</span>: CODE_ERROR,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;ç”¨æˆ·å·²å­˜åœ¨&#x27;</span>,</span><br><span class="line">                    <span class="attr">records</span>: <span class="literal">null</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// md5åŠ ç›åŠ å¯†</span></span><br><span class="line">                password = md5(md5(username + md5(password)));</span><br><span class="line">                <span class="keyword">const</span> query = <span class="string">`insert into userdata(username, password) values(&#x27;<span class="subst">$&#123;username&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;password&#125;</span>&#x27;)`</span>;</span><br><span class="line">                querySql(query)</span><br><span class="line">                    .then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!result || result.length === <span class="number">0</span>) &#123;</span><br><span class="line">                            res.json(&#123;</span><br><span class="line">                                <span class="attr">code</span>: CODE_ERROR,</span><br><span class="line">                                <span class="attr">msg</span>: <span class="string">&#x27;æ³¨å†Œå¤±è´¥&#x27;</span>,</span><br><span class="line">                                <span class="attr">records</span>: <span class="literal">null</span></span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">const</span> queryUser = <span class="string">`select * from userdata where username=&#x27;<span class="subst">$&#123;username&#125;</span>&#x27; and password=&#x27;<span class="subst">$&#123;password&#125;</span>&#x27;`</span>;</span><br><span class="line">                            querySql(queryUser)</span><br><span class="line">                                .then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">                                    <span class="keyword">const</span> tokenStr = jwt.sign(&#123;</span><br><span class="line">                                            username</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        PRIVATE_KEY, &#123;</span><br><span class="line">                                            <span class="attr">expiresIn</span>: JWT_EXPIRED</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    )</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">let</span> userData = &#123;</span><br><span class="line">                                        <span class="attr">id</span>: user[<span class="number">0</span>].id,</span><br><span class="line">                                        <span class="attr">username</span>: user[<span class="number">0</span>].username,</span><br><span class="line">                                        <span class="attr">nickname</span>: user[<span class="number">0</span>].nickname,</span><br><span class="line">                                        <span class="attr">avator</span>: user[<span class="number">0</span>].avator,</span><br><span class="line">                                        <span class="attr">sex</span>: user[<span class="number">0</span>].sex,</span><br><span class="line">                                    &#125;;</span><br><span class="line"></span><br><span class="line">                                    res.json(&#123;</span><br><span class="line">                                        <span class="attr">code</span>: CODE_SUCCESS,</span><br><span class="line">                                        <span class="attr">msg</span>: <span class="string">&#x27;æ³¨å†ŒæˆåŠŸ&#x27;</span>,</span><br><span class="line">                                        <span class="attr">records</span>: &#123;</span><br><span class="line">                                            <span class="attr">token</span>: <span class="string">&#x27;Bearer &#x27;</span> + tokenStr,</span><br><span class="line">                                            userData</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;)</span><br><span class="line">                                &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findUser</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> query = <span class="string">`select id, username from userdata where username=&#x27;<span class="subst">$&#123;username&#125;</span>&#x27;`</span>;</span><br><span class="line">    <span class="keyword">return</span> queryOne(query);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    login,</span><br><span class="line">    register,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>md5çš„åŠ ç›å¯ä»¥è‡ªå·±å®šä¹‰,æ¯”å¦‚ä¸€ä¸ª<code>secret key</code>æˆ–è€…æ˜¯ä»€ä¹ˆåˆ«çš„å¸¸é‡,å±‚çº§ä¹Ÿå¯ä»¥ç›¸åº”æ·±ä¸€ç‚¹</p><p>è¿™é‡Œçš„tokenæˆ‘é€‰æ‹©äº†åœ¨åç«¯åŠ ä¸ŠBearerè¿”å›ç»™å‰ç«¯</p><h1 id="routeså±‚"><a href="#routeså±‚" class="headerlink" title="routeså±‚"></a>routeså±‚</h1><h2 id="users"><a href="#users" class="headerlink" title="users"></a>users</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../services/userService&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·ç™»å½•è·¯ç”±</span></span><br><span class="line">router.post(<span class="string">&#x27;/login&#x27;</span>,service.login);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·æ³¨å†Œè·¯ç”±</span></span><br><span class="line">router.post(<span class="string">&#x27;/register&#x27;</span>,service.register);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./user.js&#x27;</span>); <span class="comment">// å¼•å…¥userè·¯ç”±æ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> &#123; jwtAuth,decode &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/user-jwt&#x27;</span>); <span class="comment">// å¼•å…¥jwtè®¤è¯å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router(); <span class="comment">// æ³¨å†Œè·¯ç”± </span></span><br><span class="line"></span><br><span class="line">router.use(jwtAuth); <span class="comment">// æ³¨å…¥è®¤è¯æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">router.use(<span class="string">&#x27;/&#x27;</span>, userRouter); <span class="comment">// æ³¨å…¥ç”¨æˆ·è·¯ç”±æ¨¡å—</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ç»Ÿä¸€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶ï¼Œéœ€è¦æ”¾åœ¨ä»£ç æœ€å</span></span><br><span class="line">router.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯å¤±è´¥çš„é”™è¯¯è¿”å›</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;err===&#x27;</span>, err);</span><br><span class="line">  <span class="keyword">if</span> (err &amp;&amp; err.name === <span class="string">&#x27;UnauthorizedError&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status = <span class="number">401</span>, message &#125; = err;</span><br><span class="line">    <span class="comment">// æŠ›å‡º401å¼‚å¸¸</span></span><br><span class="line">    res.status(status).json(&#123;</span><br><span class="line">      <span class="attr">code</span>: status,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&#x27;tokenå¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; output &#125; = err || &#123;&#125;;</span><br><span class="line">    <span class="comment">// é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> errCode = (output &amp;&amp; output.statusCode) || <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">const</span> errMsg = (output &amp;&amp; output.payload &amp;&amp; output.payload.error) || err.message;</span><br><span class="line">    res.status(errCode).json(&#123;</span><br><span class="line">      <span class="attr">code</span>: errCode,</span><br><span class="line">      <span class="attr">msg</span>: errMsg</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ç‚¹æ¯”è¾ƒé‡è¦,å¦‚æœæ²¡æœ‰åˆ†ç±»çš„è¯,é‚£ä¹ˆè¿™é‡Œçš„<code>router.use(&#39;/&#39;, userRouter);</code>è·¯å¾„ç›´æ¥å†™æ–œæ å³å¯</p><h1 id="appå±‚"><a href="#appå±‚" class="headerlink" title="appå±‚"></a>appå±‚</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>); <span class="comment">// å¼•å…¥body-parseræ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>); <span class="comment">// å¼•å…¥expressæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>); <span class="comment">// å¼•å…¥corsæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&#x27;./routes/index&#x27;</span>); <span class="comment">//å¯¼å…¥è‡ªå®šä¹‰è·¯ç”±æ–‡ä»¶ï¼Œåˆ›å»ºæ¨¡å—åŒ–è·¯ç”±</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json()); <span class="comment">// è§£æjsonæ•°æ®æ ¼å¼</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;)); <span class="comment">// è§£æformè¡¨å•æäº¤çš„æ•°æ®application/x-www-form-urlencoded</span></span><br><span class="line"></span><br><span class="line">app.use(cors()); <span class="comment">// æ³¨å…¥corsæ¨¡å—è§£å†³è·¨åŸŸ</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="string">&#x27;/&#x27;</span>, routes);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8081</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// ç›‘å¬8081ç«¯å£</span></span><br><span class="line"> <span class="built_in">console</span>.log(<span class="string">&#x27;æœåŠ¡å·²å¯åŠ¨ http://localhost:8081&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¾ç„¶æ˜¯è·¯å¾„éœ€è¦æ³¨æ„</p><p>è‡³æ­¤åç«¯çš„éƒ¨åˆ†å°±å·²ç»å†™å®Œäº†,æ¥ä¸‹æ¥æ˜¯å‰ç«¯çš„éƒ¨åˆ†</p><h1 id="å‰ç«¯èŒè´£"><a href="#å‰ç«¯èŒè´£" class="headerlink" title="å‰ç«¯èŒè´£"></a>å‰ç«¯èŒè´£</h1><p>å‰ç«¯è´Ÿè´£ç™»é™†å’Œæ³¨å†Œçš„é¡µé¢ç¼–å†™,è¯·æ±‚çš„ç¼–å†™,axiosçš„å°è£…</p><h1 id="å‰ç«¯ç›®å½•"><a href="#å‰ç«¯ç›®å½•" class="headerlink" title="å‰ç«¯ç›®å½•"></a>å‰ç«¯ç›®å½•</h1><p>è¿™é‡Œæ¯”è¾ƒå¤š,ç®€å•è¯´ä¸€ä¸‹å‡ ä¸ªæ¨¡å—<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- components</span><br><span class="line">    - userLogin.vue //ç™»é™†æ¨¡å—</span><br><span class="line">    - userRegister.vue //æ³¨å†Œæ¨¡å—</span><br><span class="line">- api</span><br><span class="line">    - apiInfo.js //æ¥å£ä¿¡æ¯</span><br><span class="line">    - axios.js /å°è£…axios</span><br><span class="line">- vite.config.js //viteé…ç½®</span><br></pre></td></tr></table></figure></p><h1 id="viteé…ç½®"><a href="#viteé…ç½®" class="headerlink" title="viteé…ç½®"></a>viteé…ç½®</h1><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯è§£å†³è·¨åŸŸçš„é—®é¢˜,ç„¶åèµ·åˆ«åæ–¹ä¾¿åç»­çš„ä»£ç è·¯å¾„ç¼–å†™<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    defineConfig</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pathResolve</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> resolve(__dirname, <span class="string">&quot;.&quot;</span>, dir)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineConfig(&#123;</span><br><span class="line">    <span class="attr">plugins</span>: [vue()],</span><br><span class="line">    <span class="attr">resolve</span>:&#123;</span><br><span class="line">        <span class="attr">alias</span>:&#123;</span><br><span class="line">            <span class="string">&quot;@&quot;</span>:pathResolve(<span class="string">&quot;src/&quot;</span>),</span><br><span class="line">            <span class="string">&quot;assets&quot;</span>:pathResolve(<span class="string">&quot;src/assets&quot;</span>),</span><br><span class="line">            <span class="string">&quot;common&quot;</span>:pathResolve(<span class="string">&quot;src/components/common&quot;</span>),</span><br><span class="line">            <span class="string">&quot;userLogin&quot;</span>:pathResolve(<span class="string">&quot;src/components/userLogin&quot;</span>),</span><br><span class="line">            <span class="string">&quot;swiper&quot;</span>:pathResolve(<span class="string">&quot;src/components/swiper&quot;</span>),</span><br><span class="line">            <span class="string">&quot;share&quot;</span>:pathResolve(<span class="string">&quot;src/components/share&quot;</span>),</span><br><span class="line">            <span class="string">&quot;category&quot;</span>:pathResolve(<span class="string">&quot;src/components/category&quot;</span>),</span><br><span class="line">            <span class="string">&quot;map&quot;</span>:pathResolve(<span class="string">&quot;src/components/map&quot;</span>),</span><br><span class="line">            <span class="string">&quot;person&quot;</span>:pathResolve(<span class="string">&quot;src/components/person&quot;</span>),</span><br><span class="line">            <span class="string">&quot;store&quot;</span>:pathResolve(<span class="string">&quot;src/stores&quot;</span>),</span><br><span class="line">            <span class="string">&quot;plugins&quot;</span>:pathResolve(<span class="string">&quot;src/plugins&quot;</span>),</span><br><span class="line">            <span class="string">&quot;myApi&quot;</span>:pathResolve(<span class="string">&quot;src/api&quot;</span>),</span><br><span class="line">            <span class="string">&quot;utils&quot;</span>:pathResolve(<span class="string">&quot;src/utils&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">extensions</span>:[<span class="string">&#x27;.js&#x27;</span>,<span class="string">&#x27;.json&#x27;</span>,<span class="string">&#x27;.ts&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">base</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">    <span class="attr">build</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">        <span class="attr">outDir</span>: <span class="string">&#x27;dist&#x27;</span>, <span class="comment">//æŒ‡å®šè¾“å‡ºè·¯å¾„</span></span><br><span class="line">        <span class="attr">assetsDir</span>: <span class="string">&#x27;assets&#x27;</span>, <span class="comment">// æŒ‡å®šç”Ÿæˆé™æ€èµ„æºçš„å­˜æ”¾è·¯å¾„</span></span><br><span class="line">        <span class="attr">minify</span>: <span class="string">&#x27;terser&#x27;</span> <span class="comment">// æ··æ·†å™¨ï¼Œterseræ„å»ºåæ–‡ä»¶ä½“ç§¯æ›´å°</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">        <span class="attr">cors</span>: <span class="literal">true</span>, <span class="comment">// é»˜è®¤å¯ç”¨å¹¶å…è®¸ä»»ä½•æº</span></span><br><span class="line">        <span class="attr">open</span>: <span class="literal">true</span>, <span class="comment">// åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åº”ç”¨ç¨‹åº</span></span><br><span class="line">        <span class="comment">//åå‘ä»£ç†é…ç½®ï¼Œæ³¨æ„rewriteå†™æ³•ï¼Œå¼€å§‹æ²¡çœ‹æ–‡æ¡£åœ¨è¿™é‡Œè¸©äº†å‘</span></span><br><span class="line">        <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">        <span class="attr">https</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">proxy</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;/api&#x27;</span>: &#123;</span><br><span class="line">                <span class="attr">target</span>: <span class="string">&#x27;http://localhost:8081&#x27;</span>,</span><br><span class="line">                <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.replace(<span class="regexp">/^\/api/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;/ipApi&#x27;</span>: &#123;</span><br><span class="line">                <span class="attr">target</span>: <span class="string">&#x27;http://pv.sohu.com&#x27;</span>,</span><br><span class="line">                <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">rewrite</span>: <span class="function">(<span class="params">path</span>) =&gt;</span> path.replace(<span class="regexp">/^\/ipApi/</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><h1 id="axiosçš„å°è£…"><a href="#axiosçš„å°è£…" class="headerlink" title="axiosçš„å°è£…"></a>axiosçš„å°è£…</h1><p>å…ˆè®²ä¸€ä¸‹axiosçš„å°è£…,è¿™ä¸ªå¯¹äºåç»­çš„tokenå‘é€ç‰¹åˆ«é‡è¦,å¦‚æœä½ å·²ç»ä¼šè®¾ç½®æ‹¦æˆªå™¨,è¿™ä¸€éƒ¨åˆ†å¯ä»¥è·³è¿‡</p><p>ç›®çš„:é€šè¿‡è¯·æ±‚æ‹¦æˆªå™¨,å¯¹éœ€è¦æƒé™çš„æ¥å£è‡ªåŠ¨æºå¸¦tokenéªŒè¯.</p><p>åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªpart:</p><ol><li>åŸºç¡€é…ç½®</li><li>å–æ¶ˆé‡å¤è¯·æ±‚</li><li>è‡ªåŠ¨æºå¸¦token</li></ol><h2 id="åŸºç¡€é…ç½®"><a href="#åŸºç¡€é…ç½®" class="headerlink" title="åŸºç¡€é…ç½®"></a>åŸºç¡€é…ç½®</h2><p>å°±æ˜¯é…ç½®ç»Ÿä¸€çš„urlå’Œè¶…æ—¶é…ç½®<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAxios</span>(<span class="params">axiosConfig</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> service = axios.create(&#123;</span><br><span class="line">        <span class="attr">baseURL</span>:<span class="string">&#x27;http://localhost:3000&#x27;</span>,<span class="comment">//è®¾ç½®ç»Ÿä¸€url</span></span><br><span class="line">        <span class="attr">timeout</span>:<span class="number">10000</span> <span class="comment">//åç§’è¶…æ—¶</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> myAxios;</span><br></pre></td></tr></table></figure></p><h2 id="å–æ¶ˆé‡å¤è¯·æ±‚"><a href="#å–æ¶ˆé‡å¤è¯·æ±‚" class="headerlink" title="å–æ¶ˆé‡å¤è¯·æ±‚"></a>å–æ¶ˆé‡å¤è¯·æ±‚</h2><p>è¿™ä¸ªéƒ¨åˆ†ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹,å¯ä»¥é€‚å½“è·³è¿‡</p><h2 id="è‡ªåŠ¨æºå¸¦token"><a href="#è‡ªåŠ¨æºå¸¦token" class="headerlink" title="è‡ªåŠ¨æºå¸¦token"></a>è‡ªåŠ¨æºå¸¦token</h2><p>ä¸ºäº†ç…§é¡¾ssr,è¿™é‡Œè¦åšä¸€æ¬¡åˆ¤æ–­ç„¶åå†è·å–,å‘é€tokenæˆ‘ä»¬é‡‡å–çš„æ–¹æ¡ˆæ˜¯åç«¯è®¾ç½®Bearer,æ‰€ä»¥è¿™é‡Œå‰ç«¯ç›´æ¥å‘é€å³å¯.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">service.interceptors.request.use(</span><br><span class="line">       <span class="function"><span class="params">config</span>=&gt;</span>&#123;</span><br><span class="line">           removePending(config);</span><br><span class="line">           <span class="comment">// è‡ªåŠ¨æºå¸¦token</span></span><br><span class="line">           <span class="keyword">if</span>(getTokenAuth()&amp;&amp;<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">               config.headers.Authorization = getTokenAuth();</span><br><span class="line">           &#125;</span><br><span class="line">           options.repeat_request_cancel&amp;&amp;addPending(config);</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">&#x27;config&#x27;</span>,config)</span><br><span class="line">           <span class="keyword">return</span> config;</span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">       &#125;</span><br><span class="line">   )</span><br></pre></td></tr></table></figure></p><p>å®Œæ•´ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;getTokenAuth&#125; <span class="keyword">from</span> <span class="string">&#x27;utils/auth&#x27;</span>;</span><br><span class="line"><span class="comment">// æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">// customOption:boolean æ˜¯å¦å¼€å¯å–æ¶ˆé‡å¤è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myAxios</span>(<span class="params">axiosConfig,customOption</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> service = axios.create(&#123;</span><br><span class="line">        <span class="attr">baseURL</span>:<span class="string">&#x27;http://localhost:3000&#x27;</span>,<span class="comment">//è®¾ç½®ç»Ÿä¸€url</span></span><br><span class="line">        <span class="attr">timeout</span>:<span class="number">10000</span> <span class="comment">//åç§’è¶…æ—¶</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">let</span> options = <span class="built_in">Object</span>.assign(&#123;<span class="attr">repeat_request_cancel</span>:<span class="literal">false</span>&#125;,customOption);</span><br><span class="line">    service.interceptors.request.use(</span><br><span class="line">        <span class="function"><span class="params">config</span>=&gt;</span>&#123;</span><br><span class="line">            removePending(config);</span><br><span class="line">            <span class="comment">// è‡ªåŠ¨æºå¸¦token</span></span><br><span class="line">            <span class="keyword">if</span>(getTokenAuth()&amp;&amp;<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">&#x27;undefined&#x27;</span>)&#123;</span><br><span class="line">                config.headers.Authorization = getTokenAuth();</span><br><span class="line">            &#125;</span><br><span class="line">            options.repeat_request_cancel&amp;&amp;addPending(config);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;config&#x27;</span>,config)</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    service.interceptors.response.use(</span><br><span class="line">        <span class="function"><span class="params">response</span>=&gt;</span>&#123;</span><br><span class="line">            removePending(response);</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="params">error</span>=&gt;</span>&#123;</span><br><span class="line">            error.config&amp;&amp;removePending(error.config);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> service(axiosConfig);<span class="comment">//è¿”å›çš„æ˜¯ä¸€ä¸ªpromsieå¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å–æ¶ˆé‡å¤è¯·æ±‚</span></span><br><span class="line"><span class="comment">// åˆ¤æ–­é‡å¤è¯·æ±‚å¹¶å­˜å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">const</span> pendingMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿæˆæ¯ä¸ªè¯·æ±‚å”¯ä¸€çš„é”®</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPendingKey</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;url,method,params,data&#125; = config;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data === <span class="string">&#x27;string&#x27;</span>)data=<span class="built_in">JSON</span>.parse(data)<span class="comment">//å“åº”å›æ¥çš„config dataæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">return</span> [url,method,<span class="built_in">JSON</span>.stringify(params),<span class="built_in">JSON</span>.stringify(data)].join(<span class="string">&#x27;&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜å‚¨æ¯ä¸ªè¯·æ±‚çš„å€¼ï¼Œä¹Ÿå°±æ˜¯cancelæ–¹æ³•ï¼Œç”¨äºå–æ¶ˆè¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addPending</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pendingKey = getPendingKey(config);</span><br><span class="line">    config.cancelToken = config.cancelToken || <span class="keyword">new</span> axios.CancelToken(<span class="function">(<span class="params">cancel</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!pendingMap.has(pendingKey))&#123;</span><br><span class="line">            pendingMap.set(pendingKey,cancel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤é‡å¤çš„è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removePending</span>(<span class="params">config</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pendingKey = getPendingKey(config);</span><br><span class="line">    <span class="keyword">if</span>(pendingMap.has(pendingKey))&#123;</span><br><span class="line">        <span class="keyword">const</span> cancelToken = pendingMap.get(pendingKey);</span><br><span class="line">        cancelToken(pendingKey);</span><br><span class="line">        pendingMap.delete(pendingKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> myAxios;</span><br></pre></td></tr></table></figure></p><h1 id="æ¥å£ä¿¡æ¯"><a href="#æ¥å£ä¿¡æ¯" class="headerlink" title="æ¥å£ä¿¡æ¯"></a>æ¥å£ä¿¡æ¯</h1><p>è¿™ä¸€éƒ¨åˆ†æ˜¯ä¸ºäº†æ–¹ä¾¿åæœŸæ¥å£çš„ç®¡ç†è€Œå†™<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> myAxios <span class="keyword">from</span> <span class="string">&#x27;./axios&#x27;</span>;</span><br><span class="line"><span class="comment">// ç”¨æˆ·ç™»é™†</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">userLoginAPI</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> myAxios(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/api/login&#x27;</span>,</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">userRegisterAPI</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> myAxios(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&#x27;/api/register&#x27;</span>,</span><br><span class="line">        <span class="attr">method</span>:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        data</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="ç™»é™†æ¨¡å—é€»è¾‘"><a href="#ç™»é™†æ¨¡å—é€»è¾‘" class="headerlink" title="ç™»é™†æ¨¡å—é€»è¾‘"></a>ç™»é™†æ¨¡å—é€»è¾‘</h1><p>é¡µé¢çš„ä»£ç å°±ä¸æ”¾äº†,å¤§è‡´çš„è¯·æ±‚é€»è¾‘å¦‚ä¸‹<br>å°†æ•°æ®å‘é€åˆ°åç«¯,å¾—åˆ°æˆåŠŸçš„å“åº”åå°†tokenæ”¾ç½®åœ¨å‰ç«¯çš„localStorageä¸­,æˆ–è€…cookieä¸­.è¿™é‡Œé€‰æ‹©äº†localStorage</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;userLoginAPI&#125; <span class="keyword">from</span> <span class="string">&quot;myApi/apiInfo&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> rawData = toRaw(userData);</span><br><span class="line">userLoginAPI(rawData)</span><br><span class="line">  .then(</span><br><span class="line">    <span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">      data: &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        code,</span></span></span><br><span class="line"><span class="params"><span class="function">        msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        records: &#123; token, userData &#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">      &#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (code === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">localStorage</span>.setItem(<span class="string">&quot;token&quot;</span>,token);<span class="comment">//å°†tokenå­˜æ”¾åˆ°</span></span><br><span class="line">        router.push(&#123; <span class="attr">name</span>: <span class="string">&quot;index&quot;</span> &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        loginTips.passwordTips = <span class="string">&quot;&quot;</span>;<span class="comment">//æ¸…ç©ºå¯†ç æç¤º</span></span><br><span class="line">        loginTips.userNameTips = msg;<span class="comment">//å›æ˜¾é”™è¯¯å†…å®¹</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    loginTips.passwordTips = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    loginTips.userNameTips = <span class="string">&quot;è¯¥ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><h1 id="æ³¨å†Œæ¨¡å—é€»è¾‘"><a href="#æ³¨å†Œæ¨¡å—é€»è¾‘" class="headerlink" title="æ³¨å†Œæ¨¡å—é€»è¾‘"></a>æ³¨å†Œæ¨¡å—é€»è¾‘</h1><p>é¡µé¢çš„ä»£ç å°±ä¸æ”¾äº†,æ³¨å†Œçš„é€»è¾‘å¤§æ¦‚å¦‚ä¸‹</p><ol><li>åšå¯†ç çš„æ ¡éªŒ,æ¯”å¦‚é™åˆ¶é•¿åº¦,å¤§å°å†™ç­‰.</li><li>å‘é€ç”¨æˆ·ä¿¡æ¯,æˆåŠŸåè®¾ç½®tokenåˆ°æœ¬åœ°,è·³è½¬åˆ°ä¸»é¡µ</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;userRegisterAPI&#125; <span class="keyword">from</span> <span class="string">&#x27;myApi/apiInfo&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> userRegister = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isSuccess.userNameSuccess &amp;&amp;</span><br><span class="line">    isSuccess.passWordSuccess &amp;&amp;</span><br><span class="line">    isSuccess.commitpswSuccess</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> rawData = toRaw(userData);</span><br><span class="line">    userRegisterAPI(rawData)</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123; data: &#123; code, msg,records &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (code === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> &#123;token,userData&#125; = records;</span><br><span class="line">          <span class="built_in">localStorage</span>.setItem(<span class="string">&#x27;token&#x27;</span>,token);</span><br><span class="line">          router.push(&#123; <span class="attr">name</span>: <span class="string">&quot;index&quot;</span> &#125;);</span><br><span class="line">          </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resgisterTips.userNameTips = <span class="string">&quot;ç”¨æˆ·åå·²å­˜åœ¨&quot;</span>;</span><br><span class="line">          isSuccess.userNameSuccess = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        resgisterTips.userNameTips = <span class="string">&quot;ç”¨æˆ·åå·²å­˜åœ¨&quot;</span>;</span><br><span class="line">        isSuccess.userNameSuccess = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    <span class="keyword">if</span> (!userData.username) &#123;</span><br><span class="line">      resgisterTips.userNameTips = <span class="string">&quot;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!userData.password) &#123;</span><br><span class="line">      resgisterTips.passwordTips = <span class="string">&quot;å¯†ç ä¸èƒ½ä¸ºç©º&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="è·å–token"><a href="#è·å–token" class="headerlink" title="è·å–token"></a>è·å–token</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TOKEN_KEY = <span class="string">&#x27;token&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenAuth</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">localStorage</span>.getItem(TOKEN_KEY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ¬¡å¯¹jwtå’Œmd5åŠ å¯†çš„ç™»é™†æ³¨å†Œè¿›è¡Œäº†ä¸€æ¬¡ç¼–å†™,è¿˜æœ‰ä¸€äº›æ²¡æœ‰äº†è§£åˆ°çš„,æ¯”å¦‚ä»¥ä¸‹é—®é¢˜:</p><ol><li>åŠé”€token(äº†è§£åˆ°æ˜¯express-jwté‡Œé¢çš„isRevoked)</li><li>æ˜¯å¦éœ€è¦æ¯æ¬¡è®¿é—®æœ‰æƒé™çš„æ¥å£éƒ½æºå¸¦token(éœ€è¦,å› ä¸ºåªæœ‰è¿™æ ·æ‰èƒ½åˆ¤æ–­)</li><li>tokençš„ç»­ç­¾</li></ol><p>å…³è”çŸ¥è¯†ç‚¹:<br>webç½‘ç»œå®‰å…¨XSS,CSRF<br>token,cookie,session</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="JSç³»åˆ—" scheme="https://zlinni.github.io/categories/JS%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="nodejs" scheme="https://zlinni.github.io/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>ä»£ç ä¹‹ç¾JSç¯‡</title>
    <link href="https://zlinni.github.io/posts/811989321/"/>
    <id>https://zlinni.github.io/posts/811989321/</id>
    <published>2022-05-08T11:40:08.000Z</published>
    <updated>2022-05-09T01:31:58.168Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>æœ¬ç¯‡æ–‡ç« è®²è¿°å¦‚ä½•ç¼–å†™é«˜æ•ˆç¾ä¸½çš„JavaScriptä»£ç ï¼Œè®©ä½ åœ¨å¼€å‘ä¸­æœ‰æ›´å¤šçš„é€‰æ‹©è€Œä¸æ˜¯åœç•™åœ¨åŸºç¡€ç¼–ç ç¯èŠ‚ã€‚</p></div><h1 id="çº¯å‡½æ•°"><a href="#çº¯å‡½æ•°" class="headerlink" title="çº¯å‡½æ•°"></a>çº¯å‡½æ•°</h1><div class="note primary flat"><p>çº¯å‡½æ•°æŒ‡çš„æ˜¯åœ¨ç»™å®šç›¸åŒè¾“å…¥çš„æƒ…å†µä¸‹å§‹ç»ˆè¿”å›ç›¸åŒè¾“å‡ºçš„å‡½æ•°ã€‚é™¤äº†ä»–æä¾›çš„è¾“å…¥ä»¥å¤–ï¼Œä»–ä¸ä¾èµ–äºä»»ä½•å¤–éƒ¨å˜é‡ï¼Œä¹Ÿä¸æ›´æ”¹ä»»ä½•å¤–éƒ¨å˜é‡ã€‚æ‹¥æœ‰çº¯å‡½æ•°ä½¿å¾—æµ‹è¯•æ›´åŠ å®¹æ˜“ï¼Œå› ä¸ºå¯ä»¥éšæ—¶æ¨¡æ‹Ÿå¹¶æµ‹è¯•è¾“å…¥çš„å€¼,å¦‚ä¸‹ï¼š</p></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">plusAbc</span>(<span class="params">a, b, c</span>)Â </span>&#123;Â Â <span class="comment">//Â è¿™ä¸ªå‡½æ•°çš„è¾“å‡ºå°†å˜åŒ–æ— å¸¸ï¼Œå› ä¸ºapiè¿”å›çš„å€¼ä¸€æ—¦æ”¹å˜ï¼ŒåŒæ ·è¾“å…¥å‡½æ•°çš„aï¼Œb,cçš„å€¼ï¼Œä½†å‡½æ•°è¿”å›çš„ç»“æœå´ä¸ä¸€å®šç›¸åŒã€‚</span></span><br><span class="line">Â Â <span class="keyword">var</span>Â cÂ =Â fetch(<span class="string">&#x27;../api&#x27;</span>);</span><br><span class="line">Â Â <span class="keyword">return</span>Â a+b+c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥å¾ˆåˆç†ï¼Œä½†æ˜¯è¯¥å‡½æ•°æœ¬èº«ä¾èµ–ä¸€ä¸ªå¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥å¦‚æœè¿™ä¸ªå˜é‡ä»–è¢«ä¿®æ”¹ï¼Œå°±ä¼šæœ‰ä¸åŒçš„è¾“å‡ºï¼Œåœ¨æˆ‘ä»¬æ’æŸ¥é”™è¯¯çš„æ—¶å€™å°±æ¯”è¾ƒä¸æ–¹ä¾¿ã€‚å¦‚æœå†™äº†çº¯å‡½æ•°ï¼Œç¡®ä¿ä»–æ²¡æœ‰å¼•å…¥å’Œä¿®æ”¹å¤–éƒ¨çš„å˜é‡ï¼Œé‚£ä¹ˆå°±èƒ½é™ä½é”™è¯¯çš„å‘ç”Ÿã€‚ä¸‹é¢æ˜¯ç»è¿‡æ”¹é€ åçš„ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">plusAbc</span>(<span class="params">a, b, c</span>) </span>&#123;  <span class="comment">// åŒæ ·è¾“å…¥å‡½æ•°çš„aï¼Œb,cçš„å€¼ï¼Œä½†å‡½æ•°è¿”å›çš„ç»“æœæ°¸è¿œç›¸åŒã€‚</span></span><br><span class="line">  <span class="keyword">return</span> a+b+c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å‚æ•°ä¼ é€’ä¸è§£æ"><a href="#å‚æ•°ä¼ é€’ä¸è§£æ" class="headerlink" title="å‚æ•°ä¼ é€’ä¸è§£æ"></a>å‚æ•°ä¼ é€’ä¸è§£æ</h1><p>ä½¿ç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¤§é‡çš„ä¼ å…¥å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¼šåœ¨è°ƒç”¨çš„æ—¶å€™å˜æˆä¸€ä»¶éå¸¸å¯æ€•çš„äº‹æƒ…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createButton = <span class="function">(<span class="params">title, color, disabled, padding, margin, border, shadow</span>)  =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(title, color, disabled, padding, margin, border, shadow)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è°ƒç”¨</span></span><br><span class="line">createButton(<span class="string">&#x27;Sudongyu er&#x27;</span>, <span class="literal">undefined</span> <span class="comment">/* optional color */</span>, <span class="literal">true</span> ,<span class="string">&#x27;2px....&#x27;</span>, <span class="literal">undefined</span>  <span class="comment">/* optional margin*/</span>);</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨å¯¹è±¡çš„å½¢å¼æ¥ä¼ å…¥æ•°æ®ä¹Ÿè®¸ä¼šå˜å¾—æ›´å®¹æ˜“è§‚çœ‹<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createButton = <span class="function">(<span class="params">&#123;title, color, disabled, padding, margin, border, shadow&#125;</span>)  =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(title, color, disabled, padding, margin, border, shadow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createButton(&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;Sudongyu er&#x27;</span>,</span><br><span class="line">  <span class="attr">disabled</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">shadow</span>: <span class="string">&#x27;2px....&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰åœ¨ç”¨å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ï¼Œå†™è¿‡ä¸‹é¢çš„ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">&#x27;/api/xxx&#x27;</span>,<span class="attr">params</span>:&#123;</span><br><span class="line">    mydata</span><br><span class="line">&#125;,<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res = res.data;</span><br><span class="line">    <span class="keyword">if</span>(res.code === <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="comment">//doSomething</span></span><br><span class="line">        res.data.records...    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨æ•°æ®è§£æ„çš„æ–¹å¼è®©ä»£ç æ›´åŠ æ¸…æ™°<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">&#x27;/api/xxx&#x27;</span>,</span><br><span class="line">    <span class="attr">params</span>:&#123;</span><br><span class="line">        mydata</span><br><span class="line">&#125;,<span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    data:&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        code,</span></span></span><br><span class="line"><span class="params"><span class="function">        msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        foodData:&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            records</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(code === <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="comment">//doSomething...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><h1 id="å¯¹è±¡æ•°ç»„è§£æ„"><a href="#å¯¹è±¡æ•°ç»„è§£æ„" class="headerlink" title="å¯¹è±¡æ•°ç»„è§£æ„"></a>å¯¹è±¡æ•°ç»„è§£æ„</h1><p>ä¹Ÿè®¸å¤§å®¶éƒ½çŸ¥é“è¿™æ ·çš„è§£æ„<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line"> <span class="attr">name</span>: <span class="string">&#x27;Sudongyu&#x27;</span>,</span><br><span class="line">  <span class="attr">email</span>: <span class="string">&#x27;hi@xxx&#x27;</span>,</span><br><span class="line">  <span class="attr">designation</span>: <span class="string">&#x27;Software Architect&#x27;</span>,</span><br><span class="line">  <span class="attr">loves</span>: <span class="string">&#x27;The Code&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> &#123;name, email, loves&#125; = user;</span><br></pre></td></tr></table></figure></p><p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œèƒ½æ˜¾ç¤ºå¾ˆå¤šé—®é¢˜<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getDetails = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="string">&#x27;xxx&#x27;</span>, <span class="string">&#x27;sudongyu&#x27;</span>, <span class="string">&#x27;Some Street&#x27;</span>, <span class="string">&#x27;Some City&#x27;</span>, <span class="string">&#x27;Some Zip&#x27;</span>, <span class="string">&#x27;Some Country&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> details = getDetails();</span><br><span class="line"><span class="keyword">const</span> uName = details[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> uEmail = details[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">const</span> uAddress = <span class="string">`<span class="subst">$&#123;details[<span class="number">2</span>]&#125;</span>, <span class="subst">$&#123;details[<span class="number">3</span>]&#125;</span>, <span class="subst">$&#123;details[<span class="number">4</span>]&#125;</span>, <span class="subst">$&#123;details[<span class="number">5</span>]&#125;</span>`</span>;</span><br><span class="line"><span class="keyword">const</span> uFirstName = uName.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> uLastName = uName.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>éå¸¸çš„æ¶å¿ƒï¼Œä¸‹é¢æ¥çœ‹è§£æ„ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getDetails = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="string">&#x27;xxx&#x27;</span>, <span class="string">&#x27;sudongyu&#x27;</span>, <span class="string">&#x27;Some Street&#x27;</span>, <span class="string">&#x27;Some City&#x27;</span>, <span class="string">&#x27;Some Zip&#x27;</span>, <span class="string">&#x27;Some Country&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> [uName, uEmail, ...uAddressArr] = getDetails();</span><br><span class="line"><span class="keyword">const</span> uAddress = uAddressArr.join(<span class="string">&#x27;, &#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> [uFirstName, uLastName] = uName.split(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(&#123;</span><br><span class="line">  uFirstName,</span><br><span class="line">  uLastName,</span><br><span class="line">  uEmail,</span><br><span class="line">  uAddress</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„ä»£ç äº†è§£åˆ°å¯¹äºä¸€æ¡æ•°æ®çš„è§£æ„æ—¶æœº</p><ol><li>éœ€è¦ç›´æ¥è·å–å°±èƒ½ä½¿ç”¨çš„æ•°æ®ï¼Œç›´æ¥è§£æ„</li><li>éœ€è¦è·å–ä¹‹åé€šè¿‡ç›¸åŒåŠŸèƒ½åŠ å·¥çš„æ•°æ®ï¼Œç”¨å‰©ä½™å‚æ•°è§£æ„å‡ºæ¥åŠ å·¥</li><li>splitä¹‹åçš„æ•°æ®ï¼Œå»ºè®®ç›´æ¥ç”¨æ•°ç»„è§£æ„</li></ol><p>æ€»ä¹‹å°±æ˜¯å‡å°‘æ•°ç»„ä¸‹æ ‡çš„è®¿é—®</p><h1 id="é¿å…ç¡¬ç¼–ç "><a href="#é¿å…ç¡¬ç¼–ç " class="headerlink" title="é¿å…ç¡¬ç¼–ç "></a>é¿å…ç¡¬ç¼–ç </h1><p>çœ‹ä¾‹å­<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;, <span class="number">86400000</span>);</span><br><span class="line"><span class="comment">// WHAT IS THIS 86400000 ??? ğŸ¤”</span></span><br></pre></td></tr></table></figure></p><p>çœ‹ä»£ç çš„äººå¯èƒ½ä¸çŸ¥é“è¿™ä¸ªæ•°å­—ä»£è¡¨ä»€ä¹ˆä»¥åŠä»–æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Œä»¥åŠä»–èƒŒåçš„ä¸šåŠ¡é€»è¾‘æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¸é‡æ¥ä»£æ›¿å®ƒã€‚<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DAY_IN_MILLISECONDS = <span class="number">3600</span> * <span class="number">24</span> * <span class="number">1000</span>; <span class="comment">// 86400000</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;, DAY_IN_MILLISECONDS);</span><br><span class="line"><span class="comment">// now this makes sense</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createUser = <span class="function">(<span class="params">name, designation, type</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(&#123;name, designation, type&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createUser(<span class="string">&#x27;SudongYu&#x27;</span>, <span class="string">&#x27;Software Architect&#x27;</span>, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="comment">// WHAT IS this &#x27;1&#x27;? ğŸ¤”</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œè¿™ä¸ª1å¾ˆéš¾è®©äººç†è§£ä»£è¡¨çš„å«ä¹‰æ˜¯ä»€ä¹ˆï¼Œå³typeè¿™æ˜¯ä»€ä¹ˆç”¨æˆ·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬æ‹¥æœ‰çš„ç”¨æˆ·ç±»å‹çš„å¯¹è±¡æ˜ å°„ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œå¯¹å€¼è¿›è¡Œç¡¬ç¼–ç â€™1â€™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> USER_TYPES = &#123;</span><br><span class="line">  <span class="attr">REGULAR_EMPLOYEE</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createUser = <span class="function">(<span class="params">name, designation, type</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(&#123;name, designation, type&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createUser(<span class="string">&#x27;Sudongyu&#x27;</span>, <span class="string">&#x27;Software Architect&#x27;</span>, USER_TYPES.REGULAR_EMPLOYEE);</span><br><span class="line"><span class="comment">// smoooooooth ğŸ˜</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="é¿å…ä½¿ç”¨ç®€å†™å˜é‡å"><a href="#é¿å…ä½¿ç”¨ç®€å†™å˜é‡å" class="headerlink" title="é¿å…ä½¿ç”¨ç®€å†™å˜é‡å"></a>é¿å…ä½¿ç”¨ç®€å†™å˜é‡å</h1><p>é€Ÿè®°å˜é‡åœ¨éœ€è¦å®ƒä»¬çš„åœ°æ–¹æ‰æœ‰æ„ä¹‰ã€‚å°±åƒå¦‚æœä½ æœ‰åƒxandè¿™æ ·çš„ä½ç½®åæ ‡yï¼Œé‚£æ˜¯å¯è¡Œçš„ã€‚pä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹åˆ›å»ºåƒ,tä¹‹ç±»çš„å˜é‡cï¼Œé‚£ä¹ˆçœŸçš„å¾ˆéš¾é˜…è¯»ã€è·Ÿè¸ªå’Œç»´æŠ¤è¿™æ ·çš„ä»£ç ã€‚ä¾‹å¦‚çœ‹è¿™ä¸ªä¾‹å­ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> t = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> users = [<span class="string">&#x27;Sudongyuer&#x27;</span>, <span class="string">&#x27;xxx&#x27;</span>];</span><br><span class="line"></span><br><span class="line">users = users.map(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...user,</span><br><span class="line">    <span class="attr">tax</span>: user.salary * t / <span class="number">100</span> <span class="comment">// WHAT IS `t` again? ğŸ¤”</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢çš„ä¾‹å­è¡¨æ˜ï¼Œç°åœ¨å¼€å‘äººå‘˜/è¯»è€…å¿…é¡»ä¸€ç›´å‘ä¸Šæ»šåŠ¨æˆ–è½¬åˆ°å®šä¹‰æ¥å°è¯•ç†è§£è¿™ä¸ªå˜é‡æ˜¯ä»€ä¹ˆã€‚å› æ­¤æ˜¯ä¸å¹²å‡€çš„ä»£ç ğŸ˜ ã€‚è¿™ä¹Ÿç§°ä¸ºå¯¹å˜é‡è¿›è¡Œæ€ç»´å¯¼å›¾ï¼Œå…¶ä¸­åªæœ‰ä½œè€…çŸ¥é“å®ƒä»¬çš„å«ä¹‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å®ƒä¸€ä¸ªé€‚å½“çš„åç§°ï¼Œè€Œä¸æ˜¯ç®€å†™å˜é‡åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> taxFactor = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> users = [<span class="string">&#x27;Sudongyuer&#x27;</span>, <span class="string">&#x27;xxx&#x27;</span>];</span><br><span class="line"></span><br><span class="line">users = users.map(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// some code</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...user,</span><br><span class="line">    <span class="attr">tax</span>: user.salary * taxFactor / <span class="number">100</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><h1 id="è®¾ç½®é»˜è®¤å¯¹è±¡å€¼"><a href="#è®¾ç½®é»˜è®¤å¯¹è±¡å€¼" class="headerlink" title="è®¾ç½®é»˜è®¤å¯¹è±¡å€¼"></a>è®¾ç½®é»˜è®¤å¯¹è±¡å€¼</h1><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›ä½ çš„å¯¹è±¡èƒ½å¤Ÿæä¾›ä¸€äº›é»˜è®¤å€¼ï¼Œå¦‚æœæ²¡æœ‰å°±ä½¿ç”¨ä¼ å…¥çš„å€¼<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createButton = <span class="function">(<span class="params">&#123;title, color, disabled, padding&#125;</span>)  =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> button = &#123;&#125;;</span><br><span class="line">  button.color = color || <span class="string">&#x27;#333&#x27;</span>;</span><br><span class="line">  button.disabled = disabled || <span class="literal">false</span>;</span><br><span class="line">  button.title = title || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  button.padding = padding || <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> button;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buttonConfig = &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;Click me!&#x27;</span>,</span><br><span class="line">  <span class="attr">disabled</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newButton = createButton(buttonConfig);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;newButton&#x27;</span>, newButton)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹å<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createButton = <span class="function">(<span class="params">config</span>)  =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...&#123;</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;#dcdcdc&#x27;</span>,</span><br><span class="line">      <span class="attr">disabled</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">padding</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...config </span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buttonConfig = &#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&#x27;Click me!&#x27;</span>,</span><br><span class="line">  <span class="attr">disabled</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newButton = createButton(buttonConfig);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;newButton&#x27;</span>, newButton)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><h1 id="ä½¿ç”¨æ–¹æ³•é“¾"><a href="#ä½¿ç”¨æ–¹æ³•é“¾" class="headerlink" title="ä½¿ç”¨æ–¹æ³•é“¾"></a>ä½¿ç”¨æ–¹æ³•é“¾</h1><p>å¦‚æœæˆ‘ä»¬çŸ¥é“ç±»/å¯¹è±¡çš„ç”¨æˆ·å°†ä¸€èµ·ä½¿ç”¨å¤šä¸ªå‡½æ•°ï¼Œåˆ™æ–¹æ³•é“¾æ¥æ˜¯ä¸€ç§å¾ˆæœ‰ç”¨çš„æŠ€æœ¯ã€‚æ‚¨å¯èƒ½å·²ç»åœ¨è¯¸å¦‚ moment.js ä¹‹ç±»çš„åº“ä¸­çœ‹åˆ°äº†è¿™ä¸€ç‚¹ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">name, score, position</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.position = position;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setName</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setPosition</span>(<span class="params">position</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.position = position;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setScore</span>(<span class="params">score</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> player = <span class="keyword">new</span> Player();</span><br><span class="line">player.setScore(<span class="number">0</span>);</span><br><span class="line">player.setName(<span class="string">&#x27;Sudongyuer&#x27;</span>);</span><br><span class="line">player..setPosition([<span class="number">2</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(player)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªå®ä¾‹è°ƒç”¨ä¸€ç³»åˆ—çš„å‡½æ•°ï¼Œè¿™çœ‹èµ·æ¥æœ‰ç‚¹ä¸å¤ªç¾è§‚ï¼Œä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Player</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">name, score, position</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.position = position;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setName</span>(<span class="params">name</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>; <span class="comment">// &lt;-- THIS</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setPosition</span>(<span class="params">position</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.position = position;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>; <span class="comment">// &lt;-- THIS</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">setScore</span>(<span class="params">score</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.score = score;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>; <span class="comment">// &lt;-- THIS</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> player = <span class="keyword">new</span> Player();</span><br><span class="line">player.setScore(<span class="number">0</span>).setName(<span class="string">&#x27;Sudongyuer&#x27;</span>).setPosition([<span class="number">2</span>, <span class="number">0</span>]);</span><br><span class="line"><span class="comment">// SUPER COOL ğŸ˜</span></span><br><span class="line"><span class="built_in">console</span>.log(player)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>è¯¥æ–¹æ³•çš„æ ¸å¿ƒæ˜¯æ¯ä¸ªæ–¹æ³•éƒ½è¿”å›thiså¯¹è±¡ï¼Œè®©ä»–èƒ½å¤Ÿé“¾å¼è°ƒç”¨</p><h1 id="åœ¨å›è°ƒä¸Šä½¿ç”¨Promise"><a href="#åœ¨å›è°ƒä¸Šä½¿ç”¨Promise" class="headerlink" title="åœ¨å›è°ƒä¸Šä½¿ç”¨Promise"></a>åœ¨å›è°ƒä¸Šä½¿ç”¨Promise</h1><p>å›è°ƒåœ°ç‹±.jpg<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508202356.png" alt=""></p><p>çœ‹ä¾‹å­<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> getSocials = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      callback(&#123;<span class="attr">socials</span>: &#123;<span class="attr">youtube</span>: <span class="string">&#x27;xxx&#x27;</span>, <span class="attr">twitter</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getBooks = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    callback(&#123;<span class="attr">books</span>: [<span class="string">&#x27;React Cookbook&#x27;</span>]&#125;);</span><br><span class="line">  &#125;, <span class="number">1500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getDesignation = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    callback(&#123;<span class="attr">designation</span>: <span class="string">&#x27;Software Architect&#x27;</span>&#125;);</span><br><span class="line">  &#125;, <span class="number">1500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUser = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    callback(&#123;<span class="attr">user</span>: <span class="string">&#x27;Sudongyuer&#x27;</span>&#125;);</span><br><span class="line">  &#125;, <span class="number">1500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> getUser(<span class="function">(<span class="params">&#123;user&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;user retrieved&#x27;</span>, user)</span><br><span class="line">    getDesignation(<span class="function">(<span class="params">&#123;designation&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;designation retrieved&#x27;</span>, designation)</span><br><span class="line">      getBooks(<span class="function">(<span class="params">&#123;books&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;books retrieved&#x27;</span>, books)</span><br><span class="line">        getSocials(<span class="function">(<span class="params">&#123;socials&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;socials retrieved&#x27;</span>, socials)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>è¿™ä»£ç çœ‹èµ·æ¥éå¸¸ä¸é¡ºçœ¼ï¼Œå¦‚æœæœ‰å¤§é‡çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå†™èµ·æ¥ä¼šæ›´åŠ éš¾çœ‹ï¼Œç‰¹åˆ«æ˜¯ç¼©è¿›ã€‚ä¸ºäº†æ›´å¥½çš„å¯è¯»æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨PromiseåŒ…è£…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getSocials = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">socials</span>: &#123;<span class="attr">youtube</span>: <span class="string">&#x27;xxx&#x27;</span>, <span class="attr">twitter</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getBooks = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">books</span>: [<span class="string">&#x27;React Cookbook&#x27;</span>]&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getDesignation = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">designation</span>: <span class="string">&#x27;Software Architect&#x27;</span>&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUser = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">user</span>: <span class="string">&#x27;Sudongyuer&#x27;</span>&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  getUser()</span><br><span class="line">    .then(<span class="function">(<span class="params">&#123;user&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;user retrieved&#x27;</span>, user);</span><br><span class="line">      <span class="keyword">return</span> getDesignation();</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">&#123;designation&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;designation retrieved&#x27;</span>, designation)</span><br><span class="line">      <span class="keyword">return</span> getBooks();</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">&#123;books&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;books retrieved&#x27;</span>, books);</span><br><span class="line">      <span class="keyword">return</span> getSocials();</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function">(<span class="params">&#123;socials&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;socials retrieved&#x27;</span>, socials)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>è¿™æ ·çš„è¯ï¼Œå¾ˆå¤§ç¨‹åº¦å°±è§£å†³äº†ç¼©è¿›çš„é—®é¢˜ï¼Œè€Œä¸”ä¹Ÿæ¯”è¾ƒç¾è§‚ï¼Œå½“ç„¶æˆ‘ä»¬è¿˜æœ‰æ›´å…·å¯è¯»æ€§çš„æ–¹æ³•,åˆ©ç”¨åˆ°asyncå’Œawait</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getSocials = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">socials</span>: &#123;<span class="attr">youtube</span>: <span class="string">&#x27;xxx&#x27;</span>, <span class="attr">twitter</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getBooks = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">books</span>: [<span class="string">&#x27;React Cookbook&#x27;</span>]&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getDesignation = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">designation</span>: <span class="string">&#x27;Software Architect&#x27;</span>&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUser = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(&#123;<span class="attr">user</span>: <span class="string">&#x27;Sudongyuer&#x27;</span>&#125;);</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> performTasks = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;user&#125; = <span class="keyword">await</span> getUser();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;user retrieved&#x27;</span>, user);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;designation&#125; = <span class="keyword">await</span> getDesignation();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;designation retrieved&#x27;</span>, designation);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;books&#125; = <span class="keyword">await</span> getBooks();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;books retrieved&#x27;</span>, books);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;socials&#125; = <span class="keyword">await</span> getSocials();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;socials retrieved&#x27;</span>, socials);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`     </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æ˜ç¡®å‡½æ•°æ„å›¾</span></span><br><span class="line"><span class="string">å¯¹äºè¿”å›çš„æ˜¯true/falseçš„å‡½æ•°,æœ€å¥½ä»¥should/can/is/haså¼€å¤´</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="comment">// ğŸ‘ è‡ªæˆ‘æ„Ÿè§‰è‰¯å¥½çš„ç¼©å†™:</span></span><br><span class="line"><span class="keyword">let</span>Â rContentÂ =Â <span class="string">&#x27;willen&#x27;</span>;Â </span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘ æ— éœ€å¯¹æ¯ä¸ªå˜é‡éƒ½å†™æ³¨é‡Šï¼Œä»åå­—ä¸Šå°±çœ‹æ‡‚</span></span><br><span class="line"><span class="keyword">let</span>Â firstNameÂ =Â <span class="string">&#x27;jackie&#x27;</span>;Â </span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘ ä»å‘½åæ— æ³•çŸ¥é“è¿”å›å€¼ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">showFriendsList</span>(<span class="params"></span>)Â </span>&#123;....&#125;Â <span class="comment">//Â // æ— æ³•è¾¨åˆ«å‡½æ•°æ„å›¾,è¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯trueÂ orÂ false?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘ æ˜ç¡®å‡½æ•°æ„å›¾ï¼Œå¯¹äºè¿”å›true or falseçš„å‡½æ•°ï¼Œæœ€å¥½ä»¥should/is/can/haså¼€å¤´</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">shouldShowFriendsList</span>(<span class="params"></span>)Â </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">isEmpty</span>(<span class="params"></span>)Â </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">canCreateDocuments</span>(<span class="params"></span>)Â </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">hasLicense</span>(<span class="params"></span>)Â </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span>Â <span class="title">sendEmailToUser</span>(<span class="params">user</span>)Â </span>&#123;.... &#125; <span class="comment">//åŠ¨è¯å¼€å¤´ï¼Œå‡½æ•°æ„å›¾å°±å¾ˆæ˜æ˜¾</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="å˜é‡å…œåº•"><a href="#å˜é‡å…œåº•" class="headerlink" title="å˜é‡å…œåº•"></a>å˜é‡å…œåº•</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ‘ å¯¹äºæ±‚å€¼è·å–çš„å˜é‡ï¼Œæ²¡æœ‰å…œåº•</span></span><br><span class="line"><span class="keyword">const</span> &#123; data &#125; = getApiRequest();</span><br><span class="line">data.map(<span class="function">(<span class="params">s</span>) =&gt;</span> s.id); <span class="comment">//æ²¡æœ‰è€ƒè™‘dataå¼‚å¸¸çš„æƒ…å†µï¼Œä»£ç ä¸€è·‘å°±çˆ†ç‚¸</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘ å¯¹äºæ±‚å€¼å˜é‡ï¼Œåšå¥½å…œåº•</span></span><br><span class="line"><span class="keyword">const</span> &#123; data = [] &#125; = getApiRequest();</span><br><span class="line">data.map(<span class="function">(<span class="params">s</span>) =&gt;</span> s?.id); <span class="comment">//æ²¡æœ‰è€ƒè™‘dataå¼‚å¸¸çš„æƒ…å†µï¼Œä»£ç ä¸€è·‘å°±çˆ†ç‚¸</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="å¾…è¡¥å……"><a href="#å¾…è¡¥å……" class="headerlink" title="å¾…è¡¥å……"></a>å¾…è¡¥å……</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="JSç³»åˆ—" scheme="https://zlinni.github.io/categories/JS%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="js" scheme="https://zlinni.github.io/tags/js/"/>
    
  </entry>
  
  <entry>
    <title>Binary Search TreeäºŒå‰æœç´¢æ ‘ç¬”è®°â‘§--æ„é€ ç¯‡</title>
    <link href="https://zlinni.github.io/posts/3090245434/"/>
    <id>https://zlinni.github.io/posts/3090245434/</id>
    <published>2022-05-08T06:57:01.000Z</published>
    <updated>2022-05-08T11:13:29.306Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨ä¸Šä¸€ç¯‡åŸºæ“ç¯‡æˆ‘ä»¬è®²è¿°äº†BSTçš„åˆ¤æ–­åˆæ³•æ€§å’Œå¢åˆ æ”¹æŸ¥ï¼Œä¸‹é¢æ¥å­¦ä¹ BSTçš„æ„é€ ï¼Œè¯»å®Œæœ¬æ–‡ä½ å¯¹ä¸‹é¢çš„é¢˜ç›®ä¼šæœ‰æ›´æ·±å…¥çš„äº†è§£ã€‚</p></div><p>Leetcode<br><a href="https://leetcode-cn.com/problems/unique-binary-search-trees/">96.ä¸åŒçš„äºŒå‰æœç´¢æ ‘</a><br><a href="https://leetcode-cn.com/problems/unique-binary-search-trees-ii/">95.ä¸åŒçš„äºŒå‰æœç´¢æ ‘ II</a></p><h1 id="ä¸åŒçš„äºŒå‰æœç´¢æ ‘"><a href="#ä¸åŒçš„äºŒå‰æœç´¢æ ‘" class="headerlink" title="ä¸åŒçš„äºŒå‰æœç´¢æ ‘"></a>ä¸åŒçš„äºŒå‰æœç´¢æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508155308.png" alt=""></p><p>è¿™æ˜¯ä¸€é“ç©·ä¸¾çš„é¢˜ç›®ï¼Œé¦–å…ˆæˆ‘ä»¬åšä¸ªä¾‹å­:æ¯”å¦‚è¾“å…¥<code>n=3</code>ï¼Œé‚£ä¹ˆå°±æœ‰ä»¥ä¸‹å‡ ä¸ªæƒ…å†µ</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508155735.png" alt=""></p><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªæ­£å®—çš„ç©·ä¸¾é—®é¢˜ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥æ­£ç¡®çš„ç©·ä¸¾BSTçš„æ•°é‡å‘¢ï¼Ÿ</p><p>å†çœ‹ä¸€ä¸ªä¾‹å­ æ¯”å¦‚ç»™ç®—æ³•è¾“å…¥<code>n=5</code>ä¹Ÿå°±æ˜¯è¦æ±‚ä»–ä»<code>1,2,3,4,5</code>é‡Œé¢æ‰¾æ•°å­—æ„æˆBST</p><p>æ˜¾ç„¶ä¼šæœ‰äº”ç§æƒ…å†µï¼Œå› ä¸ºæ¯ä¸ªæ•°å­—éƒ½å¯ä»¥ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å›ºå®š3ä¸ºæ ¹èŠ‚ç‚¹ï¼Œçœ‹åˆ°åº•èƒ½æ„æˆå¤šå°‘ä¸ªBST</p><p>å› ä¸ºBSTå·¦å°å³å¤§çš„æ€§è´¨ï¼Œå¾ˆæ˜æ˜¾3ä¸ºæ ¹èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå·¦å­æ ‘èŠ‚ç‚¹å°±æ˜¯<code>1,2</code>å³å­æ ‘èŠ‚ç‚¹å°±æ˜¯<code>4,5</code></p><p>é‚£ä¹ˆå·¦å­æ ‘çš„ç»„åˆæ•°å’Œå³å­æ ‘çš„ç»„åˆæ•°çš„ä¹˜ç§¯å°±æ˜¯3ä½œä¸ºæ ¹èŠ‚ç‚¹çš„æ—¶å€™çš„BSTä¸ªæ•°</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508160416.png" alt=""></p><p>åœ¨ä»£ç æ–¹é¢ï¼Œå…¶å®æˆ‘ä»¬åªéœ€è¦é€’å½’å°±å¯ä»¥äº†<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—é—­åŒºé—´[1,n]ç»„æˆçš„BSTæ•°é‡</span></span><br><span class="line"><span class="keyword">const</span> numTree = <span class="function"><span class="params">n</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> count(<span class="number">1</span>,n);</span><br><span class="line">  <span class="keyword">const</span> count = <span class="function">(<span class="params">start,end</span>)=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">// base case</span></span><br><span class="line">      <span class="keyword">if</span>(start&gt;end)<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">let</span> res = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> i=start;i&lt;=end;i++)&#123;</span><br><span class="line">          <span class="keyword">let</span> left = count(start,i-<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">let</span> right = count(i+<span class="number">1</span>,end);</span><br><span class="line">          res += left*right;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯è¿™æ ·åšæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºä¼šå­˜åœ¨å¾ˆå¤šé‡å å­é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªmemoå¤‡å¿˜å½•æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numTrees = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> memo = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    <span class="keyword">const</span> count = <span class="function">(<span class="params">lo,hi</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// base case</span></span><br><span class="line">        <span class="keyword">if</span>(lo&gt;hi)<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> memoKey = <span class="string">`<span class="subst">$&#123;lo&#125;</span>&amp;<span class="subst">$&#123;hi&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">if</span>(memo.has(memoKey))&#123;</span><br><span class="line">          <span class="keyword">return</span> memo.get(memoKey)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> mid = lo;mid&lt;=hi;mid++)&#123;</span><br><span class="line">          <span class="keyword">let</span> left = count(lo,mid-<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">let</span> right = count(mid+<span class="number">1</span>,hi);</span><br><span class="line">          res += left*right;</span><br><span class="line">        &#125;</span><br><span class="line">        memo.set(memoKey,res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count(<span class="number">1</span>,n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä¸åŒçš„äºŒå‰æœç´¢æ ‘II"><a href="#ä¸åŒçš„äºŒå‰æœç´¢æ ‘II" class="headerlink" title="ä¸åŒçš„äºŒå‰æœç´¢æ ‘II"></a>ä¸åŒçš„äºŒå‰æœç´¢æ ‘II</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508163630.png" alt=""></p><p>é¢˜ç›®ç±»ä¼¼ï¼Œä½†æ˜¯æœ€åè¦è¿”å›å…¨éƒ¨ç»„åˆçš„BST</p><p>æˆ‘ä»¬ä¸éš¾æƒ³åˆ°è¿˜æ˜¯è¦ç”¨memoå»è®°å½•æˆ‘ä»¬çš„å­é—®é¢˜ï¼Œå¹¶ä¸”è¿™é‡Œè¿˜å­˜åœ¨ä¸€ä¸ªå…³é”®ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨ç®€å•çš„memoKeyæ¥å¸®åŠ©æˆ‘ä»¬è®°å½•<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> generateTrees = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n===<span class="number">0</span>)<span class="keyword">return</span> [];</span><br><span class="line">    <span class="keyword">const</span> memo = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> count = <span class="function">(<span class="params">lo,hi</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> res = [];</span><br><span class="line">        <span class="comment">// base case</span></span><br><span class="line">        <span class="keyword">if</span>(lo&gt;hi)&#123;</span><br><span class="line">            res.push(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å®šä¹‰memoKey</span></span><br><span class="line">        <span class="keyword">let</span> memoKey = <span class="string">`<span class="subst">$&#123;lo&#125;</span>&amp;<span class="subst">$&#123;hi&#125;</span>`</span>;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾å¤‡å¿˜å½•</span></span><br><span class="line">        <span class="keyword">if</span>(memo.has(memoKey))&#123;</span><br><span class="line">            <span class="keyword">return</span> memo.get(memoKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç©·ä¸¾rootèŠ‚ç‚¹çš„æ‰€æœ‰BSTå¯èƒ½</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=lo;i&lt;=hi;i++)&#123;</span><br><span class="line">            <span class="comment">// iä½œä¸ºæ ¹èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">let</span> leftTree = count(lo,i-<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">let</span> rightTree = count(i+<span class="number">1</span>,hi);</span><br><span class="line">            <span class="comment">// ç©·ä¸¾rootçš„æ‰€æœ‰å·¦å³å­æ ‘ç»„åˆ</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> left <span class="keyword">of</span> leftTree) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">const</span> right <span class="keyword">of</span> rightTree) &#123;</span><br><span class="line">                    res.push(<span class="keyword">new</span> TreeNode(i,left,right))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜æ”¾res</span></span><br><span class="line">        memo.set(memoKey,res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count(<span class="number">1</span>,n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>BSTçš„æ„é€ æ ¸å¿ƒè¿˜æ˜¯BTçš„æ„é€ ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®BSTçš„rootåˆ’åˆ†å·¦å³å»ç©·ä¸¾å¹¶æ„é€ ã€‚ç©·ä¸¾çš„è¿‡ç¨‹å°±æ˜¯çœ‹å·¦å³å­æ ‘æœ‰å¤šå°‘ç§å¯èƒ½çš„è¿‡ç¨‹ï¼Œæœ€åå¯èƒ½æ€§ç›¸ä¹˜å°±æ˜¯ç»„åˆã€‚è¿˜å­¦ä¹ åˆ°äº†memoçš„è®°å½•æ–¹å¼æ¥æ’é™¤é‡å¤å­é—®é¢˜ï¼Œä»¥åŠç”¨ç®€å•çš„memoKeyã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Binary Search TreeäºŒå‰æœç´¢æ ‘ç¬”è®°â‘¦--åŸºæ“ç¯‡</title>
    <link href="https://zlinni.github.io/posts/3737568820/"/>
    <id>https://zlinni.github.io/posts/3737568820/</id>
    <published>2022-05-07T08:49:21.000Z</published>
    <updated>2022-05-08T07:51:33.430Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨å‰é¢çš„æ–‡ç« æˆ‘ä»¬å­¦ä¹ äº†BSTäºŒå‰æœç´¢æ ‘çš„æ€§è´¨ï¼Œä»¥åŠç»“åˆä¸­åºéå†çš„æ€§è´¨ï¼Œå¯ä»¥å®ç°æ ‘çš„å‡åºå’Œé™åºï¼Œä»¥åŠç´¯åŠ æ ‘çš„æ“ä½œã€‚ä¸‹é¢è¿™ç¯‡æ–‡ç« æ·±å…¥è®²è§£BSTçš„æ€§è´¨ï¼Œåˆ¤æ–­BSTçš„åˆæ³•æ€§ï¼Œå¢åˆ æ”¹æŸ¥ï¼Œè¯»å®Œæœ¬æ–‡ä½ å¯¹ä¸‹é¢çš„ç®—æ³•é¢˜ä¼šæœ‰æ›´æ·±å…¥çš„äº†è§£</p></div><p>Leetcode<br><a href="https://leetcode-cn.com/problems/delete-node-in-a-bst/">450.åˆ é™¤äºŒå‰æœç´¢æ ‘çš„èŠ‚ç‚¹</a><br><a href="https://leetcode-cn.com/problems/insert-into-a-binary-search-tree/">701.äºŒå‰æœç´¢æ ‘ä¸­çš„æ’å…¥æ“ä½œ</a><br><a href="https://leetcode-cn.com/problems/search-in-a-binary-search-tree/">700.äºŒå‰æœç´¢æ ‘ä¸­çš„æœç´¢</a><br><a href="https://leetcode-cn.com/problems/validate-binary-search-tree/">98.éªŒè¯äºŒå‰æœç´¢æ ‘</a></p><h1 id="BSTç®€ä»‹"><a href="#BSTç®€ä»‹" class="headerlink" title="BSTç®€ä»‹"></a>BSTç®€ä»‹</h1><div class="note primary flat"><p>æ‰€è°“çš„äºŒå‰æœç´¢æ ‘ï¼Œå°±æ˜¯å·¦å°å³å¤§çš„äºŒå‰æ ‘ã€‚åˆ©ç”¨ä»–çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°ç±»ä¼¼äºŒåˆ†æœç´¢çš„æ“ä½œï¼Œæœç´¢ä¸€ä¸ªå…ƒç´ çš„æ•ˆç‡å¾ˆé«˜ï¼Œ</p></div><p>å¯¹äºBSTç›¸å…³çš„é—®é¢˜ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°ä»¥ä¸‹ä»£ç é€»è¾‘<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BST = <span class="function">(<span class="params">root,target</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root.val===target)&#123;</span><br><span class="line">        <span class="comment">//do something...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(root.val&lt;target)&#123;</span><br><span class="line">        BST(root.right,target);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(root.val&gt;target)&#123;</span><br><span class="line">        BST(root.left,target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªä»£ç æ¡†æ¶å…¶å®å’ŒäºŒå‰æ ‘éå†å·®ä¸å¤šï¼Œæ— éå°±æ˜¯åˆ©ç”¨äº†BSTå·¦å°å³å¤§çš„ç‰¹æ€§</p><p>ä¸‹é¢æ¥è®²å‡ é“BSTå¿…ä¼šçš„é¢˜ç›®</p><h1 id="åˆ¤æ–­BSTçš„åˆæ³•æ€§"><a href="#åˆ¤æ–­BSTçš„åˆæ³•æ€§" class="headerlink" title="åˆ¤æ–­BSTçš„åˆæ³•æ€§"></a>åˆ¤æ–­BSTçš„åˆæ³•æ€§</h1><p>è¿™é‡Œå­˜åœ¨äº†å‘ç‚¹ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¹‹å‰æ€è€ƒçš„äºŒå‰æ ‘èŠ‚ç‚¹åº”è¯¥åšä»€ä¹ˆçš„åšæ³•ï¼Œè¿™é‡Œä¼šå†™å‡ºä»¥ä¸‹çš„code<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> judgeBST = <span class="function"><span class="params">n</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(n.left!==<span class="literal">null</span>&amp;&amp;n.val&lt;n.left.val)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(n.right!==<span class="literal">null</span>&amp;n.val&gt;n.right.val)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> judgeBST(n.left)&amp;&amp;judgeBST(n.right)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>çœ‹ä¼¼å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªç®—æ³•å‡ºç°äº†é”™è¯¯ï¼ŒåŸå› åœ¨äºBSTçš„æ€§è´¨ã€‚å¯¹äºè¿™ä¸ªç®—æ³•æ¥è¯´ï¼Œä»–åˆ¤æ–­çš„æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„å€¼è¦å¤§äºå·¦è¾¹å°äºå³è¾¹ï¼Œä½†æ˜¯BSTçš„æ€§è´¨æ˜¯å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œä»–çš„å€¼éƒ½è¦å°äºå³å­æ ‘çš„å…¨éƒ¨å€¼ï¼Œå¤§äºå·¦å­æ ‘çš„å…¨éƒ¨å€¼ï¼Œçœ‹å›¾ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507182900.png" alt=""></p><p>è¯¥å›¾ä¸æ˜¯BSTï¼Œä½†æ˜¯ä»–ä¼šè¢«è¿™ä¸ªç®—æ³•åˆ¤å®šä¸ºBST</p><p>é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæ—¢ç„¶è¦æ»¡è¶³å½“å‰èŠ‚ç‚¹å¤§äºå·¦å­æ ‘å…¨éƒ¨å€¼ï¼Œå°äºå³å­æ ‘å…¨éƒ¨å€¼ï¼Œæˆ‘ä»¬ä¸å¦¨è®¾ä¸ªå˜é‡maxå’Œminï¼Œåˆ†åˆ«æ¥ä»£æ›¿å·¦å³å­æ ‘çš„æœ€å¤§å€¼ï¼Œä¸€æ—¦æ²¡æœ‰æ»¡è¶³è¿™ä¸ªæ¡ä»¶å°±è§†ä¸ºéBST</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœæ»¡è¶³max&gt;root.val&gt;minå°±æ­£ç¡®</span></span><br><span class="line"><span class="keyword">const</span> isValidBST = <span class="function">(<span class="params">n,max,min</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">//æ³¨æ„è¿™é‡Œæ˜¯åˆ¤æ–­å­æ ‘ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span>(min!==<span class="literal">null</span>&amp;&amp;n.val&lt;=min.val)<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(max!==<span class="literal">null</span>&amp;&amp;n.val&gt;=max.val)<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//å¯¹äºå·¦å­æ ‘æ¥è¯´ï¼Œæœ€å¤§å€¼æ˜¯nï¼Œå¯¹äºå³å­æ ‘æ¥è¯´ï¼Œæœ€å°å€¼æ˜¯n</span></span><br><span class="line">    <span class="keyword">return</span> isValidBST(n.left,n,min)&amp;&amp;isValidBST(n.right,max,n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isValidBST(root,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h1 id="åœ¨BSTä¸­æœç´¢å…ƒç´ "><a href="#åœ¨BSTä¸­æœç´¢å…ƒç´ " class="headerlink" title="åœ¨BSTä¸­æœç´¢å…ƒç´ "></a>åœ¨BSTä¸­æœç´¢å…ƒç´ </h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507184411.png" alt=""></p><p>å¦‚æœæ˜¯ä¸€é¢—æ™®é€šçš„äºŒå‰æ ‘å¯ä»¥å†™å¦‚ä¸‹çš„ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchBST = <span class="function">(<span class="params">n,target</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(n.val === target) <span class="keyword">return</span> n;</span><br><span class="line">    <span class="keyword">let</span> left = searchBST(n.left,target);</span><br><span class="line">    <span class="keyword">let</span> right = searchBST(n.right,target); </span><br><span class="line">    <span class="keyword">return</span> left!==<span class="literal">null</span>?left:right</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ®µä»£ç ç›¸å½“äºç©·ä¸¾äº†äºŒå‰æ ‘ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœæ‰¾çš„åˆ°å°±è¿”å›å¯¹åº”çš„å­æ ‘.</p><p>ä½†æˆ‘ä»¬æ‹¥æœ‰BSTçš„æ€§è´¨ï¼Œå°±åº”è¯¥åˆ©ç”¨èµ·æ¥ï¼Œæ¯”è¾ƒrootå’Œtargetçš„å€¼ï¼Œå°†å…¶ä¸­çš„ä¸€è¾¹èˆå»ã€‚<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchBST = <span class="function">(<span class="params">n,target</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(n.val&lt;target)<span class="keyword">return</span> searchBST(n.right,target);</span><br><span class="line">    <span class="keyword">if</span>(n.val&gt;target)<span class="keyword">return</span> searchBST(n.left,target);</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="åœ¨BSTä¸­æ’å…¥ä¸€ä¸ªæ•°"><a href="#åœ¨BSTä¸­æ’å…¥ä¸€ä¸ªæ•°" class="headerlink" title="åœ¨BSTä¸­æ’å…¥ä¸€ä¸ªæ•°"></a>åœ¨BSTä¸­æ’å…¥ä¸€ä¸ªæ•°</h1><div class="note primary flat"><p>å¯¹äºæ•°æ®ç»“æ„çš„æ“ä½œæ— éå°±æ˜¯éå†+è®¿é—®ï¼Œå…¶ä¸­éå†å°±æ˜¯æ‰¾ï¼Œè®¿é—®å°±æ˜¯æ”¹ã€‚å…·ä½“è€Œè¨€ï¼Œæ’å…¥ä¸€ä¸ªæ•°æ®å°±é¦–å…ˆè¦æ‰¾åˆ°æ’å…¥çš„ä½ç½®ï¼Œç„¶åè¿›è¡Œæ’å…¥æ“ä½œã€‚</p></div><p>ä¸Šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€»ç»“äº†BSTçš„éå†æ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯æ‰¾çš„é—®é¢˜ï¼Œç›´æ¥å¥—æ¡†æ¶ï¼Œç„¶åæˆ‘ä»¬åªè¦è¿›è¡Œæ”¹çš„æ“ä½œå°±å¯ä»¥äº†ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦æ¶‰åŠåˆ°æ”¹ï¼Œå‡½æ•°å°±è¦è¿”å›treenodeç±»å‹ï¼Œå¹¶ä¸”å¯¹é€’å½’è°ƒç”¨çš„è¿”å›å€¼è¿›è¡Œæ¥æ”¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> insertIntoBST = <span class="function"><span class="keyword">function</span>(<span class="params">root, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!root) <span class="keyword">return</span> <span class="keyword">new</span> TreeNode(val);</span><br><span class="line">    <span class="keyword">if</span>(root.val&lt;val)&#123;</span><br><span class="line">        root.right = insertIntoBST(root.right,val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(root.val&gt;val)&#123;</span><br><span class="line">        root.left = insertIntoBST(root.left,val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="åœ¨BSTä¸­åˆ é™¤ä¸€ä¸ªæ•°"><a href="#åœ¨BSTä¸­åˆ é™¤ä¸€ä¸ªæ•°" class="headerlink" title="åœ¨BSTä¸­åˆ é™¤ä¸€ä¸ªæ•°"></a>åœ¨BSTä¸­åˆ é™¤ä¸€ä¸ªæ•°</h1><p>è¿™ä¸ªé—®é¢˜æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯æ€è·¯ä¹Ÿå·®ä¸å¤šï¼Œå…ˆæ‰¾åˆ°å†æ”¹ï¼Œæ¡†æ¶å¦‚ä¸‹<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deleteNode = <span class="function"><span class="keyword">function</span>(<span class="params">root, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root.val === key)&#123;</span><br><span class="line">        <span class="comment">//delete</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(root.val&lt;key)&#123;</span><br><span class="line">        root.left = deleteNode(root.left,key);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        root.right = deleteNode(root.right,key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…³äºå¦‚ä½•åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹ï¼Œæœ‰ä¸‹é¢çš„å‡ ç§æƒ…å†µï¼š</p><p>æƒ…å†µä¸€ï¼šAè¿™ä¸ªèŠ‚ç‚¹æ°å¥½æ˜¯æœ«ç«¯èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå­èŠ‚ç‚¹ä¸ºç©ºï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥å½“åœºå»ä¸–äº†ã€‚<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507194014.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!root.left&amp;&amp;!root.right)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ…å†µäºŒï¼šAåªæœ‰ä¸€ä¸ªéç©ºå­—èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±è¦è®©è¿™å­èŠ‚ç‚¹æ›¿ä»£è‡ªå·±çš„ä½ç½®<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507194203.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!root.left)<span class="keyword">return</span> root.right;</span><br><span class="line"><span class="keyword">if</span>(!root.right)<span class="keyword">return</span> root.left;</span><br></pre></td></tr></table></figure><p>æƒ…å†µä¸‰ï¼šAæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œéœ€è¦æ‰¾åˆ°å³å­æ ‘æœ€å°çš„èŠ‚ç‚¹æ¥æ›¿ä»£è‡ªå·±<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507194517.png" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(root.left&amp;&amp;root.right)&#123;</span><br><span class="line">    <span class="keyword">let</span> minNode = getMin(root.right);</span><br><span class="line">    root.val = minNode.val;</span><br><span class="line">    root.right = deleteNode(root.right,minNode.val)</span><br><span class="line">    minNode.left = root.left;</span><br><span class="line">    minNode.right = root.right;</span><br><span class="line">    root = minNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´code<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deleteNode = <span class="function"><span class="keyword">function</span> (<span class="params">root, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!root) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(root.val === key)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root.left)<span class="keyword">return</span> root.right;</span><br><span class="line">        <span class="keyword">if</span>(!root.right)<span class="keyword">return</span> root.left;</span><br><span class="line">        <span class="keyword">if</span>(root.left&amp;&amp;root.right)&#123;</span><br><span class="line">            <span class="keyword">let</span> minNode = root.right;</span><br><span class="line">            <span class="keyword">while</span>(minNode.left)&#123;</span><br><span class="line">                minNode = minNode.left;</span><br><span class="line">            &#125;</span><br><span class="line">            root.right = deleteNode(root.right,minNode.val);</span><br><span class="line">            minNode.left = root.left;</span><br><span class="line">            minNode.right = root.right;</span><br><span class="line">            root = minNode</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(root.val &lt; key)&#123;</span><br><span class="line">        root.right = deleteNode(root.right,key);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        root.left = deleteNode(root.left,key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·å°±å®Œæˆäº†åˆ é™¤çš„æ“ä½œï¼Œä½†æ˜¯æœ‰äººå¯èƒ½åœ¨è¿™ä¸€æ­¥ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆä¿®æ”¹rootèŠ‚ç‚¹è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥ä¿®æ”¹valå€¼ä¸æ˜¯æ›´æ–¹ä¾¿å—<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minNode.left = root.left;</span><br><span class="line">minNode.right = root.right;</span><br><span class="line">root = minNode</span><br><span class="line"></span><br><span class="line">=ã€‹</span><br><span class="line"></span><br><span class="line">root.val = minNode.val;</span><br></pre></td></tr></table></figure></p><p>å¯¹äºè¿™é“é¢˜æ¥è¯´æ˜¯å¯ä»¥è¿™ä¹ˆåšçš„ï¼Œä½†æ˜¯ä¸æå€¡ï¼Œå› ä¸ºåœ¨å®é™…åº”ç”¨ä¸­ï¼ŒBST èŠ‚ç‚¹å†…éƒ¨çš„æ•°æ®åŸŸæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œå¯ä»¥éå¸¸å¤æ‚ï¼Œè€Œ BST ä½œä¸ºæ•°æ®ç»“æ„ï¼ˆä¸€ä¸ªå·¥å…·äººï¼‰ï¼Œå…¶æ“ä½œåº”è¯¥å’Œå†…éƒ¨å­˜å‚¨çš„æ•°æ®åŸŸè§£è€¦ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨æŒ‡é’ˆæ“ä½œæ¥äº¤æ¢èŠ‚ç‚¹ï¼Œæ ¹æœ¬æ²¡å¿…è¦å…³å¿ƒå†…éƒ¨æ•°æ®ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><div class="note primary flat"><p>é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬èƒ½å­¦ä¼šå‡ ä¸ªå…³é”®çš„æ“ä½œï¼ŒBSTçš„å¢åˆ æ”¹æŸ¥ï¼Œå’Œåˆæ³•æ€§åˆ¤æ–­ã€‚</p></div><p>æŠ€å·§å¦‚ä¸‹ï¼š<br>æ ¹æ®äºŒå‰æ ‘çš„é€’å½’å¾—åˆ°BSTçš„ä»£ç æ¡†æ¶<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BST = <span class="function">(<span class="params">n,target</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(root.val===target)&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(root.val&lt;val)&#123;</span><br><span class="line">        BST(root.right,target);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(root.val&gt;val)&#123;</span><br><span class="line">        BST(root.left,target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Piniaå¤§è è--æ–°ä¸€ä»£çŠ¶æ€ç®¡ç†</title>
    <link href="https://zlinni.github.io/posts/3383846748/"/>
    <id>https://zlinni.github.io/posts/3383846748/</id>
    <published>2022-05-06T09:57:23.000Z</published>
    <updated>2022-05-08T11:30:35.545Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>å¦‚ä»Šå·²ç»æ˜¯vue3+tsçš„æ—¶ä»£ï¼Œä½†å¯¹äºæˆ‘ä»¬çš„çŠ¶æ€ç®¡ç†å·¥å…·vuexæ¥è¯´ï¼Œä»–ä¹Ÿæ˜¯å­˜åœ¨ä¸€å®šçš„ç¼ºé™·çš„ï¼Œä¸‹æ–‡è®²è§£piniaçš„ç”±æ¥å’ŒåŸºç¡€çš„ç”¨æ³•ï¼Œç”¨äºæ„å»ºä¸ªäººçš„è½»é‡çº§é¡¹ç›®ã€‚</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220506181436.png" alt=""></p><h1 id="Piniaå¤§è è"><a href="#Piniaå¤§è è" class="headerlink" title="Piniaå¤§è è"></a>Piniaå¤§è è</h1><div class="note primary flat"><p>piniaæ˜¯æ–°çš„ä¸€é—¨çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œä»–æ˜¯vueå®˜æ–¹æ¨èçš„æ›¿ä»£vuexçš„äº§å“ã€‚ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p></div><ul><li>æ‹¥æœ‰å®Œæ•´çš„tsæ”¯æŒï¼Œè¿™ç‚¹å’Œvuexæ¯”èµ·æ¥æ›´èˆ’é€‚ã€‚</li><li>æ›´å°çš„ä½“ç§¯(çº¦1kb)</li><li>æ²¡æœ‰muatationï¼Œåªæœ‰action</li><li>storeå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦è¾…åŠ©å‡½æ•°</li></ul><h1 id="piniaä¸ºä»€ä¹ˆä½“ç§¯å°äºvuex"><a href="#piniaä¸ºä»€ä¹ˆä½“ç§¯å°äºvuex" class="headerlink" title="piniaä¸ºä»€ä¹ˆä½“ç§¯å°äºvuex"></a>piniaä¸ºä»€ä¹ˆä½“ç§¯å°äºvuex</h1><p>è¿™å¾—ä»å®ƒä»¬ä¸¤è€…çš„ä»£ç åˆ†å‰²æœºåˆ¶æ¥è®²ï¼š</p><div class="note primary flat"><p>ä¸¾ä¸ªä¾‹å­ï¼šæŸé¡¹ç›®æœ‰3ä¸ªstoreã€Œuserã€jobã€payã€ï¼Œå¦å¤–æœ‰2ä¸ªè·¯ç”±é¡µé¢ã€Œé¦–é¡µã€ä¸ªäººä¸­å¿ƒé¡µã€ï¼Œé¦–é¡µç”¨åˆ°job storeï¼Œä¸ªäººä¸­å¿ƒé¡µç”¨åˆ°äº†user storeï¼Œåˆ†åˆ«ç”¨Piniaå’ŒVuexå¯¹å…¶çŠ¶æ€ç®¡ç†ã€‚</p></div><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220506183109.png" alt=""></p><p>å…ˆçœ‹Vuexçš„ä»£ç åˆ†å‰²ï¼š æ‰“åŒ…æ—¶ï¼Œvuexä¼šæŠŠ3ä¸ªstoreåˆå¹¶æ‰“åŒ…ï¼Œå½“é¦–é¡µç”¨åˆ°Vuexæ—¶ï¼Œè¿™ä¸ªåŒ…ä¼šå¼•å…¥åˆ°é¦–é¡µä¸€èµ·æ‰“åŒ…ï¼Œæœ€åè¾“å‡º1ä¸ªjs chunkã€‚è¿™æ ·çš„é—®é¢˜æ˜¯ï¼Œå…¶å®é¦–é¡µåªéœ€è¦å…¶ä¸­1ä¸ªstoreï¼Œä½†å…¶ä»–2ä¸ªæ— å…³çš„storeä¹Ÿè¢«æ‰“åŒ…è¿›æ¥ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220506183122.png" alt=""></p><p>Piniaçš„ä»£ç åˆ†å‰²ï¼š æ‰“åŒ…æ—¶ï¼ŒPiniaä¼šæ£€æŸ¥å¼•ç”¨ä¾èµ–ï¼Œå½“é¦–é¡µç”¨åˆ°job storeï¼Œæ‰“åŒ…åªä¼šæŠŠç”¨åˆ°çš„storeå’Œé¡µé¢åˆå¹¶è¾“å‡º1ä¸ªjs chunkï¼Œå…¶ä»–2ä¸ªstoreä¸è€¦åˆåœ¨å…¶ä¸­ã€‚Piniaèƒ½åšåˆ°è¿™ç‚¹ï¼Œæ˜¯å› ä¸ºå®ƒçš„è®¾è®¡å°±æ˜¯storeåˆ†ç¦»çš„ï¼Œè§£å†³äº†é¡¹ç›®çš„è€¦åˆé—®é¢˜ã€‚</p><p>æ€»ç»“ï¼špiniaæ ¹æ®å¼•ç”¨æ‰“åŒ…storeæ–‡ä»¶ï¼Œä½†vuexå°±æ˜¯å…¨éƒ¨æ‰“åŒ…ã€‚</p><h1 id="å®‰è£…pinia"><a href="#å®‰è£…pinia" class="headerlink" title="å®‰è£…pinia"></a>å®‰è£…pinia</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinia</span><br></pre></td></tr></table></figure><h1 id="æŒ‚è½½å®ä¾‹"><a href="#æŒ‚è½½å®ä¾‹" class="headerlink" title="æŒ‚è½½å®ä¾‹"></a>æŒ‚è½½å®ä¾‹</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createPinia&#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> pinia = createPinia();</span><br><span class="line">app.use(pinia);</span><br></pre></td></tr></table></figure><h1 id="åˆ›å»ºç¬¬ä¸€ä¸ªstore"><a href="#åˆ›å»ºç¬¬ä¸€ä¸ªstore" class="headerlink" title="åˆ›å»ºç¬¬ä¸€ä¸ªstore"></a>åˆ›å»ºç¬¬ä¸€ä¸ªstore</h1><p>åœ¨<code>src/store/index.ts</code>é‡Œé¢åˆ›å»ºä½ çš„storeï¼Œå…¶ä¸­å®šä¹‰storeçš„æ–¹å¼æœ‰ä¸¤ç§ </p><ul><li><p>ä½¿ç”¨optionAPIæ¨¡å¼å®šä¹‰ï¼Œè¿™ç§æ–¹å¼å’Œvue2çš„ç±»ä¼¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;defineStore&#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mainStore = defineStore(<span class="string">&#x27;main&#x27;</span>,&#123;</span><br><span class="line">  <span class="attr">state</span>:<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span>&#123;</span><br><span class="line">      <span class="attr">count</span>:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>:&#123;</span><br><span class="line">    <span class="function"><span class="title">increment</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">this</span>.count++:</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="attr">getters</span>:&#123;</span><br><span class="line">    <span class="function"><span class="title">doubleCount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> state.count * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨setupæ¨¡å¼å®šä¹‰ï¼Œç¬¦åˆVue3 setupçš„ç¼–ç¨‹æ¨¡å¼ï¼Œè®©ç»“æ„æ›´åŠ æ‰å¹³åŒ–ï¼Œæ›´æ¨èä½¿ç”¨è¿™ç§æ–¹å¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;ref&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;defineStore&#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mainStore = defineStore(<span class="string">&#x27;main&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> count = ref&lt;<span class="built_in">number</span>&gt;(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> increment:<span class="built_in">number</span> = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    count.value++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> doubleCount:<span class="built_in">number</span> = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> count.value*<span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;count,increment,doubleCount&#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><div class="note primary flat"><p>stateå®šä¹‰æ•°æ®ï¼Œactionæ”¾åŒæ­¥æˆ–è€…å¼‚æ­¥çš„æ–¹æ³•ï¼Œgettersè·å–stateçš„è®¡ç®—ç»“æœ</p></div><p>ä¸Šé¢ä¸¤ä¸ªçš„æ–¹å¼æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºä½¿ç”¨äº†setupçš„æ–¹å¼æ›´è´´è¿‘äºvue3ï¼Œç„¶åæˆ‘ä»¬ä¸ç”¨åœ¨æ„actionå’Œgetterså…³é”®å­—ã€‚è€Œç¬¬ä¸€ç§æ–¹å¼çš„è¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å†™getterså’Œactionsç­‰æ¥åŒºåˆ†æˆ‘ä»¬çš„ä»£ç </p><h1 id="è°ƒç”¨storeçš„æ•°æ®"><a href="#è°ƒç”¨storeçš„æ•°æ®" class="headerlink" title="è°ƒç”¨storeçš„æ•°æ®"></a>è°ƒç”¨storeçš„æ•°æ®</h1><div class="note primary flat"><p>è¿™ä¸€éƒ¨åˆ†è®²è§£æ€ä¹ˆè°ƒç”¨storeçš„æ•°æ®,ä¸»è¦æ˜¯è§£æå“åº”å¼æ•°æ®ï¼Œå¯¹äºrefæˆ‘ä»¬éœ€è¦å¼•å…¥<code>storeToRefs</code>å†è§£æ„ï¼Œå¦åˆ™ä¸¢å¤±å“åº”</p></div><p>code ä½¿ç”¨setupçš„æ ¼å¼<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;mainStore&#125; <span class="keyword">from</span> <span class="string">&#x27;@/store/mainStore.ts&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;storeToRefs&#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> store = mainStore();</span><br><span class="line">  <span class="comment">//è§£ææ•°æ® å¯ä»¥è§£æ„reactiveçš„</span></span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = store;</span><br><span class="line">  <span class="comment">//refç±»å‹éœ€è¦è¿™æ ·</span></span><br><span class="line">  <span class="keyword">const</span> &#123; refData &#125; = storeToRefs(store); </span><br><span class="line">  <span class="keyword">const</span> &#123; fun1,fun2 &#125; = store;</span><br><span class="line">  <span class="comment">//ä½¿ç”¨refçš„æ•°æ® </span></span><br><span class="line">  <span class="built_in">console</span>.log(refData.value);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></p><h1 id="åˆ›å»ºå¤šä¸ªstore"><a href="#åˆ›å»ºå¤šä¸ªstore" class="headerlink" title="åˆ›å»ºå¤šä¸ªstore"></a>åˆ›å»ºå¤šä¸ªstore</h1><p>é¡¹ç›®å¤æ‚äº†å°±éœ€è¦å¤šä¸ªstoreç®¡ç†ã€‚å…¶å®piniaåˆ›å»ºæ–°çš„storeæ–¹å¼å¾ˆç®€å•ï¼Œå°±æ˜¯exportçš„æ—¶å€™å‘½åå’Œæ–‡ä»¶åä¸€è‡´å°±è¡Œäº†ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> index = defineStore(<span class="string">&#x27;index&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// map.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> map = defineStore(<span class="string">&#x27;map&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Vueç³»åˆ—" scheme="https://zlinni.github.io/categories/Vue%E7%B3%BB%E5%88%97/"/>
    
    
    <category term="Vue" scheme="https://zlinni.github.io/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Binary Search TreeäºŒå‰æœç´¢æ ‘ç¬”è®°â‘¥--ç‰¹æ€§ç¯‡</title>
    <link href="https://zlinni.github.io/posts/2732070170/"/>
    <id>https://zlinni.github.io/posts/2732070170/</id>
    <published>2022-05-05T08:38:38.000Z</published>
    <updated>2022-05-08T03:37:53.742Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨å‰é¢çš„æ–‡ç« æˆ‘ä»¬å­¦ä¹ äº†å¯»æ‰¾ä¸€é¢—äºŒå‰æ ‘çš„é‡å¤å­æ ‘ï¼Œè¿™ä¸ªé—®é¢˜ç»“åˆäº†ç¬¬å››ç« èŠ‚çš„åºåˆ—åŒ–å†…å®¹åŠ ç¬¬ä¸‰ç« èŠ‚çš„æ„é€ å†…å®¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ äºŒå‰æœç´¢æ ‘çš„çŸ¥è¯†ï¼Œè¯»å®Œæœ¬æ–‡ä½ å¯¹ä»¥ä¸‹çš„é¢˜ç›®æœ‰æ›´æ·±åˆ»çš„äº†è§£ï¼š</p></div><p>Leetcode<br><a href="https://leetcode-cn.com/problems/kth-smallest-element-in-a-bst/">230.äºŒå‰æ ‘ä¸­çš„ç¬¬kå°å…ƒç´ </a><br><a href="https://leetcode-cn.com/problems/convert-bst-to-greater-tree/">538.æŠŠäºŒå‰æœç´¢æ ‘è½¬ä¸ºç´¯åŠ æ ‘</a><br><a href="https://leetcode-cn.com/problems/binary-search-tree-to-greater-sum-tree/">1038.æŠŠäºŒå‰æœç´¢æ ‘è½¬ä¸ºç´¯åŠ æ ‘</a></p><h1 id="Binary-Search-Tree"><a href="#Binary-Search-Tree" class="headerlink" title="Binary Search Tree"></a>Binary Search Tree</h1><div class="note primary flat"><p>å…¨ç§°äºŒå‰æœç´¢æ ‘ï¼Œç®€å†™BSTï¼Œç‰¹æ€§å¦‚ä¸‹ï¼š</p></div><ol><li>BSTçš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå·¦å­æ ‘èŠ‚ç‚¹çš„å€¼éƒ½æ¯”ä»–å°ï¼Œå³å­æ ‘èŠ‚ç‚¹çš„å€¼éƒ½æ¯”ä»–å¤§ã€‚</li><li>å¯¹äºBSTçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»–çš„å·¦ä¾§å­æ ‘å’Œå³ä¾§å­æ ‘éƒ½æ˜¯BST</li></ol><div class="note primary flat"><p>labuladongåŸè¯ï¼šäºŒå‰æœç´¢æ ‘å¹¶ä¸ç®—å¤æ‚ï¼Œä½†æˆ‘è§‰å¾—å®ƒå¯ä»¥ç®—æ˜¯æ•°æ®ç»“æ„é¢†åŸŸçš„åŠå£æ±Ÿå±±ï¼Œç›´æ¥åŸºäº BST çš„æ•°æ®ç»“æ„æœ‰ AVL æ ‘ï¼Œçº¢é»‘æ ‘ç­‰ç­‰ï¼Œæ‹¥æœ‰äº†è‡ªå¹³è¡¡æ€§è´¨ï¼Œå¯ä»¥æä¾› logN çº§åˆ«çš„å¢åˆ æŸ¥æ”¹æ•ˆç‡ï¼›è¿˜æœ‰ B+ æ ‘ï¼Œçº¿æ®µæ ‘ç­‰ç»“æ„éƒ½æ˜¯åŸºäº BST çš„æ€æƒ³æ¥è®¾è®¡çš„ã€‚</p></div><p>ä»ç®—æ³•é¢˜çš„è§’åº¦æ¥è®²ï¼Œä¸­åºéå†ä¸€ä¸ªBSTï¼Œæ˜¯å‡åºçš„ï¼Œå› ä¸ºä»–å…ˆæ„é€ äº†å·¦å­æ ‘å†æ„é€ å³å­æ ‘ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ä»¥ä¸€ä¸ªæ•°ç»„çš„å½¢å¼æ˜¾ç¤ºï¼Œå°±æ˜¯ä»å°åˆ°å¤§çš„ã€‚</p><h1 id="å¯»æ‰¾ç¬¬-K-å°çš„å…ƒç´ "><a href="#å¯»æ‰¾ç¬¬-K-å°çš„å…ƒç´ " class="headerlink" title="å¯»æ‰¾ç¬¬ K å°çš„å…ƒç´ "></a>å¯»æ‰¾ç¬¬ K å°çš„å…ƒç´ </h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505183122.png" alt=""><br>æŒ‰ç…§ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬åªè¦ä¸­åºéå†è¿™ä¸ªäºŒå‰æ ‘ç„¶åæ‰¾ç¬¬kä¸ªå°±è¡Œäº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> kthSmallest = <span class="function"><span class="keyword">function</span>(<span class="params">root, k</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res;</span><br><span class="line">    <span class="keyword">const</span> inorder = <span class="function"><span class="params">root</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)<span class="keyword">return</span>;</span><br><span class="line">        inorder(root.left);</span><br><span class="line">        k--;</span><br><span class="line">        <span class="keyword">if</span>(k===<span class="number">0</span>)res = root.val;</span><br><span class="line">        inorder(root.right);</span><br><span class="line">    &#125;</span><br><span class="line">    inorder(root);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™é“é¢˜åšå®Œäº†ï¼Œä½†æ˜¯è¿™ä¸ªè§£æ³•åœ¨ç›®å‰æ¥è¯´å¹¶ä¸æ˜¯æœ€é«˜æ•ˆçš„ã€‚ä¸‹é¢å¼•è‡ªlabuladong</p><div class="note primary flat"><p>å¦‚æœæŒ‰ç…§æˆ‘ä»¬åˆšæ‰è¯´çš„æ–¹æ³•ï¼Œåˆ©ç”¨ã€ŒBST ä¸­åºéå†å°±æ˜¯å‡åºæ’åºç»“æœã€è¿™ä¸ªæ€§è´¨ï¼Œæ¯æ¬¡å¯»æ‰¾ç¬¬ k å°çš„å…ƒç´ éƒ½è¦ä¸­åºéå†ä¸€æ¬¡ï¼Œæœ€åçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N)ï¼ŒN æ˜¯ BST çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚</p><p>è¦çŸ¥é“ BST æ€§è´¨æ˜¯éå¸¸ç‰›é€¼çš„ï¼Œåƒçº¢é»‘æ ‘è¿™ç§æ”¹è‰¯çš„è‡ªå¹³è¡¡ BSTï¼Œå¢åˆ æŸ¥æ”¹éƒ½æ˜¯ O(logN) çš„å¤æ‚åº¦ï¼Œè®©ä½ ç®—ä¸€ä¸ªç¬¬ k å°å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ç«Ÿç„¶è¦ O(N)ï¼Œæœ‰ç‚¹ä½æ•ˆäº†ã€‚</p><p>æ‰€ä»¥è¯´ï¼Œè®¡ç®—ç¬¬ k å°å…ƒç´ ï¼Œæœ€å¥½çš„ç®—æ³•è‚¯å®šä¹Ÿæ˜¯å¯¹æ•°çº§åˆ«çš„å¤æ‚åº¦ï¼Œä¸è¿‡è¿™ä¸ªä¾èµ–äº BST èŠ‚ç‚¹è®°å½•çš„ä¿¡æ¯æœ‰å¤šå°‘ã€‚</p><p>æˆ‘ä»¬æƒ³ä¸€ä¸‹ BST çš„æ“ä½œä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜æ•ˆï¼Ÿå°±æ‹¿æœç´¢æŸä¸€ä¸ªå…ƒç´ æ¥è¯´ï¼ŒBST èƒ½å¤Ÿåœ¨å¯¹æ•°æ—¶é—´æ‰¾åˆ°è¯¥å…ƒç´ çš„æ ¹æœ¬åŸå› è¿˜æ˜¯åœ¨ BST çš„å®šä¹‰é‡Œï¼Œå·¦å­æ ‘å°å³å­æ ‘å¤§å˜›ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥é€šè¿‡å¯¹æ¯”è‡ªèº«çš„å€¼åˆ¤æ–­å»å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘æœç´¢ç›®æ ‡å€¼ï¼Œä»è€Œé¿å…äº†å…¨æ ‘éå†ï¼Œè¾¾åˆ°å¯¹æ•°çº§å¤æ‚åº¦ã€‚</p><p>é‚£ä¹ˆå›åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæƒ³æ‰¾åˆ°ç¬¬ k å°çš„å…ƒç´ ï¼Œæˆ–è€…è¯´æ‰¾åˆ°æ’åä¸º k çš„å…ƒç´ ï¼Œå¦‚æœæƒ³è¾¾åˆ°å¯¹æ•°çº§å¤æ‚åº¦ï¼Œå…³é”®ä¹Ÿåœ¨äºæ¯ä¸ªèŠ‚ç‚¹å¾—çŸ¥é“ä»–è‡ªå·±æ’ç¬¬å‡ ã€‚</p><p>æ¯”å¦‚è¯´ä½ è®©æˆ‘æŸ¥æ‰¾æ’åä¸º k çš„å…ƒç´ ï¼Œå½“å‰èŠ‚ç‚¹çŸ¥é“è‡ªå·±æ’åç¬¬ mï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥æ¯”è¾ƒ m å’Œ k çš„å¤§å°ï¼š</p><p>1ã€å¦‚æœ m == kï¼Œæ˜¾ç„¶å°±æ˜¯æ‰¾åˆ°äº†ç¬¬ k ä¸ªå…ƒç´ ï¼Œè¿”å›å½“å‰èŠ‚ç‚¹å°±è¡Œäº†ã€‚</p><p>2ã€å¦‚æœ k &lt; mï¼Œé‚£è¯´æ˜æ’åç¬¬ k çš„å…ƒç´ åœ¨å·¦å­æ ‘ï¼Œæ‰€ä»¥å¯ä»¥å»å·¦å­æ ‘æœç´¢ç¬¬ k ä¸ªå…ƒç´ ã€‚</p><p>3ã€å¦‚æœ k &gt; mï¼Œé‚£è¯´æ˜æ’åç¬¬ k çš„å…ƒç´ åœ¨å³å­æ ‘ï¼Œæ‰€ä»¥å¯ä»¥å»å³å­æ ‘æœç´¢ç¬¬ k - m - 1 ä¸ªå…ƒç´ ã€‚</p><p>è¿™æ ·å°±å¯ä»¥å°†æ—¶é—´å¤æ‚åº¦é™åˆ° O(logN) äº†ã€‚</p><p>é‚£ä¹ˆï¼Œå¦‚ä½•è®©æ¯ä¸€ä¸ªèŠ‚ç‚¹çŸ¥é“è‡ªå·±çš„æ’åå‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œéœ€è¦åœ¨äºŒå‰æ ‘èŠ‚ç‚¹ä¸­ç»´æŠ¤é¢å¤–ä¿¡æ¯ã€‚æ¯ä¸ªèŠ‚ç‚¹éœ€è¦è®°å½•ï¼Œä»¥è‡ªå·±ä¸ºæ ¹çš„è¿™æ£µäºŒå‰æ ‘æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ TreeNode ä¸­çš„å­—æ®µåº”è¯¥å¦‚ä¸‹ï¼š</p></div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">    int val;</span><br><span class="line">    <span class="comment">// ä»¥è¯¥èŠ‚ç‚¹ä¸ºæ ¹çš„æ ‘çš„èŠ‚ç‚¹æ€»æ•°</span></span><br><span class="line">    int size;</span><br><span class="line">    TreeNode left;</span><br><span class="line">    TreeNode right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº† size å­—æ®µï¼Œå¤–åŠ  BST èŠ‚ç‚¹å·¦å°å³å¤§çš„æ€§è´¨ï¼Œå¯¹äºæ¯ä¸ªèŠ‚ç‚¹ node å°±å¯ä»¥é€šè¿‡ node.left æ¨å¯¼å‡º node çš„æ’åï¼Œä»è€Œåšåˆ°æˆ‘ä»¬åˆšæ‰è¯´åˆ°çš„å¯¹æ•°çº§ç®—æ³•ã€‚</p><p>å½“ç„¶ï¼Œsize å­—æ®µéœ€è¦åœ¨å¢åˆ å…ƒç´ çš„æ—¶å€™éœ€è¦è¢«æ­£ç¡®ç»´æŠ¤ï¼ŒåŠ›æ‰£æä¾›çš„ TreeNode æ˜¯æ²¡æœ‰ size è¿™ä¸ªå­—æ®µçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é“é¢˜å°±åªèƒ½åˆ©ç”¨ BST ä¸­åºéå†çš„ç‰¹æ€§å®ç°äº†ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´åˆ°çš„ä¼˜åŒ–æ€è·¯æ˜¯ BST çš„å¸¸è§æ“ä½œï¼Œè¿˜æ˜¯æœ‰å¿…è¦ç†è§£çš„ã€‚</p><h1 id="BSTè½¬ç´¯åŠ æ ‘"><a href="#BSTè½¬ç´¯åŠ æ ‘" class="headerlink" title="BSTè½¬ç´¯åŠ æ ‘"></a>BSTè½¬ç´¯åŠ æ ‘</h1><p>åŠ›æ‰£538å’Œ1038é¢˜éƒ½æ˜¯è¿™ä¸€é“ï¼Œå¯ä»¥ä¸€èµ·åšäº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220507162402.png" alt=""></p><p>æŒ‰ç…§äºŒå‰æ ‘çš„é€šç”¨æ€è·¯ï¼Œæˆ‘ä»¬è¦æ€è€ƒæ¯ä¸ªèŠ‚ç‚¹æœ¬èº«åº”è¯¥åšä»€ä¹ˆï¼Œä½†æ˜¯è¿™é“é¢˜å¾ˆéš¾æƒ³åˆ°ä»€ä¹ˆæ€è·¯ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è¿™æ ·æƒ³ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œæ˜¯å°†èŠ‚ç‚¹è¿›è¡Œä¸€ä¸ªç´¯åŠ ç„¶åèµ‹å€¼åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œä¸­åºéå†çš„æ€§è´¨å°±æ˜¯èƒ½å°†BSTå˜æˆå‡åºã€‚</p><p>ä¸è¿‡ä¸€èˆ¬çš„ä¸­åºå¯åšä¸åˆ°è¿™ä¸ªç‰¹ç‚¹ï¼Œå› ä¸ºæ˜¯å·¦æ ¹å³ï¼Œåªèƒ½æ‰“å°å‡ºå‡åºçš„ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ä»å³å­æ ‘å¼€å§‹è®¡ç®—ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å³æ ¹å·¦ï¼Œæ‰“å°å‡ºé™åºçš„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> convertBST = <span class="function"><span class="keyword">function</span> (<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> inorder = <span class="function"><span class="params">n</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    inorder(n.right);</span><br><span class="line">    sum+=n.val;</span><br><span class="line">    n.val = sum;</span><br><span class="line">    inorder(n.left);</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> inorder(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>BSTå¯ä»¥ç»“åˆä¸­åºéå†çš„ç‰¹æ€§å»å¸®åŠ©æˆ‘ä»¬å®Œæˆæ ‘çš„å‡åºæˆ–è€…é™åºï¼Œè¿™ä¸€ç‚¹éœ€è¦ç‰¢è®°ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Binary TreeäºŒå‰æ ‘ç¬”è®°--åˆé›†</title>
    <link href="https://zlinni.github.io/posts/3500150157/"/>
    <id>https://zlinni.github.io/posts/3500150157/</id>
    <published>2022-05-05T07:06:00.000Z</published>
    <updated>2022-06-10T00:47:43.396Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ ¹æ®è¿™äº”ç¯‡çš„äºŒå‰æ ‘å­¦ä¹ ï¼Œä½ å°†ä»ä¸€ä¸ªåªä¼šæ ¹å·¦å³ï¼Œå·¦æ ¹å³å’Œå·¦å³æ ¹çš„ç®—æ³•å°ç™½ä¸­é¢†ç•¥äºŒå‰æ ‘çš„æ ¸å¿ƒç®—æ³•ã€‚</p><h1 id="ä¼ é€é—¨"><a href="#ä¼ é€é—¨" class="headerlink" title="ä¼ é€é—¨"></a>ä¼ é€é—¨</h1><p><a href="https://zlinni.github.io/posts/1410341477">æ‰‹æŠŠæ‰‹äºŒå‰æ ‘ç¬”è®°â‘ â€”çº²é¢†ç¯‡</a><br><a href="https://zlinni.github.io/posts/1410341478">æ‰‹æŠŠæ‰‹äºŒå‰æ ‘ç¬”è®°â‘¡â€”æ€è·¯ç¯‡</a><br><a href="https://zlinni.github.io/posts/686027467">æ‰‹æŠŠæ‰‹äºŒå‰æ ‘ç¬”è®°â‘¢â€”æ„é€ ç¯‡</a><br><a href="https://zlinni.github.io/posts/3440987103">æ‰‹æŠŠæ‰‹äºŒå‰æ ‘ç¬”è®°â‘£â€”åºåˆ—åŒ–ç¯‡</a><br><a href="https://zlinni.github.io/posts/3318597918">æ‰‹æŠŠæ‰‹äºŒå‰æ ‘ç¬”è®°â‘¤â€”ååºç¯‡</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Binary TreeäºŒå‰æ ‘ç¬”è®°â‘¤--ååºç¯‡</title>
    <link href="https://zlinni.github.io/posts/732690854/"/>
    <id>https://zlinni.github.io/posts/732690854/</id>
    <published>2022-05-05T07:05:40.000Z</published>
    <updated>2022-05-08T03:34:51.372Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨ä¸Šä¸€ç¯‡æˆ‘ä»¬å­¦ä¹ äº†ç”¨jsè§£å†³äºŒå‰æ ‘çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„é—®é¢˜ï¼Œå…¶å®åºåˆ—åŒ–çš„è¿‡ç¨‹å°±æ˜¯è€ƒå¯ŸäºŒå‰æ ‘éå†çš„è¿‡ç¨‹ï¼Œååºåˆ—åŒ–çš„è¿‡ç¨‹å°±æ˜¯è€ƒå¯Ÿäº†äºŒå‰æ ‘çš„æ„é€ è¿‡ç¨‹ï¼Œç»“åˆäº†å‰å‡ ç« çš„çŸ¥è¯†ã€‚æœ¬ç¯‡æ–‡ç« æ·±å…¥å­¦ä¹ äºŒå‰æ ‘ååºçš„å¦™ç”¨ï¼Œå¸¦ä½ äº†è§£ä»¥ä¸‹é¢˜ç›®ï¼š</p></div><p>Leetcode<br>652.å¯»æ‰¾é‡å¤çš„å­æ ‘</p><h1 id="å¯»æ‰¾é‡å¤çš„å­æ ‘"><a href="#å¯»æ‰¾é‡å¤çš„å­æ ‘" class="headerlink" title="å¯»æ‰¾é‡å¤çš„å­æ ‘"></a>å¯»æ‰¾é‡å¤çš„å­æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505151327.png" alt=""></p><p>è¿™é“é¢˜å®é™…ä¸Šå°±æ˜¯æ‰¾å­æ ‘çš„é—®é¢˜ï¼Œçœ‹ä¸‹å›¾<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505151425.png" alt=""></p><p>é¦–å…ˆèŠ‚ç‚¹4å¯ä»¥ä½œä¸ºä¸€é¢—å­æ ‘ï¼ŒäºŒå‰æ ‘ä¸­æœ‰å¤šä¸ªèŠ‚ç‚¹4<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505151457.png" alt=""></p><p>ç±»ä¼¼çš„è¿˜å­˜åœ¨ä¸¤é¢—ä»¥2ä¸ºæ ¹çš„é‡å¤å­æ ‘<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505151521.png" alt=""></p><p>é‚£ä¹ˆæˆ‘ä»¬è¿”å›çš„listå°±åº”è¯¥æœ‰ä¸¤ä¸ªtreenodeï¼Œ2å’Œ4 </p><p>å…·ä½“è¿™é“é¢˜è¦æ€ä¹ˆåšå‘¢ï¼Ÿå…ˆæ€è€ƒå¯¹äºä¸€ä¸ªèŠ‚ç‚¹ä»–åº”è¯¥åšä»€ä¹ˆï¼Ÿ</p><p>æˆ‘ä»¬æ‹¿è¿™ä¸ª2èŠ‚ç‚¹ä½œä¸ºä¾‹å­ï¼Œä»–æ˜¯ä¸æ˜¯é‡å¤çš„å­æ ‘ï¼Œæ˜¯ä¸æ˜¯å°±è¦å…ˆçŸ¥é“è‡ªå·±æ˜¯ä¸€é¢—æ€ä¹ˆæ ·çš„å­æ ‘ï¼Œå†å»æ‰¾åˆ«çš„å­æ ‘è¿›è¡Œå¯¹æ¯”ï¼Ÿ<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505152207.png" alt=""></p><p>é‚£ä¹ˆæˆ‘ä»¬è§£é¢˜çš„å…³é”®å°±æ¥äº†ï¼š</p><ol><li>å…ˆçŸ¥é“è‡ªå·±é•¿ä»€ä¹ˆæ ·</li><li>å»çœ‹çœ‹åˆ«äººæœ‰æ²¡æœ‰å’Œè‡ªå·±ä¸€æ ·çš„</li></ol><p>é‚£ä¹ˆå¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ ¹æ®æœ¬æ–‡ä½ å¯ä»¥çŸ¥é“æˆ‘ä»¬è¦ç”¨ååºéå†çš„æ“ä½œå»åšï¼Œå…¶å®å‰åºä¸­åºéƒ½å¯ä»¥ï¼Œåªä¸è¿‡ååºåœ¨è¿™ä¸ªé˜¶æ®µçœ‹çš„ä¸œè¥¿æ›´æ˜æ˜¾ï¼Œæ€ä¹ˆçŸ¥é“è‡ªå·±æ˜¯è°å‘¢ï¼Ÿå…¶å®å°±æ˜¯è‡ªèº«åŠ å·¦å³å­æ ‘<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> postoreder = <span class="function">(<span class="params">n</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!n)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> left = postoreder(n.left);</span><br><span class="line">  <span class="keyword">let</span> right = postoreder(n.right);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;n.val&#125;</span>`</span>;</span><br><span class="line">  <span class="comment">//n å°±æ˜¯ä¸€é¢—æ ‘äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·ä¸å°±èƒ½çŸ¥é“è‡ªå·±æ˜¯è°äº†å—ï¼Ÿä¸€çœ‹è¿™ä¸ªé—®é¢˜ï¼Œä½ å°±ä¼šå‘ç°ï¼Œå’Œä¹‹å‰çš„åºåˆ—åŒ–äºŒå‰æ ‘åŠå…¶ç›¸ä¼¼ï¼Œå…¶å®çŸ¥é“è‡ªå·±æ˜¯è°çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯ç»å†äº†ä¸€æ¬¡åºåˆ—åŒ–ã€‚</p><p>é‚£ä¹ˆç°åœ¨æ€ä¹ˆè§£å†³æ‰¾åŒä¼´çš„é—®é¢˜å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬è¿ç”¨jsçš„setæˆ–è€…mapï¼Œè€ƒé‡è¿™ä¸¤ä¸ªapiç”¨å“ªä¸ªçš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆçœ‹æˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Ÿæˆ‘ä»¬éœ€è¦è®°å½•å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€æ¬¡çš„å­æ ‘ï¼Œä¹Ÿå°±æ˜¯è®°å½•å­æ ‘+å­æ ‘å‡ºç°æ¬¡æ•°ï¼Œæ‰€ä»¥ç”¨mapæ›´å¥½ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> findDuplicateSubtrees = <span class="function"><span class="keyword">function</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//å®šä¹‰mapé›†åˆå’Œå­˜æ”¾çš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>(),res = [];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> tranverse = <span class="function"><span class="params">root</span> =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!root)<span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">        <span class="keyword">const</span> left = tranverse(root.left);</span><br><span class="line">        <span class="keyword">const</span> right = tranverse(root.right);</span><br><span class="line">        <span class="keyword">const</span> str = <span class="string">`<span class="subst">$&#123;left&#125;</span>,<span class="subst">$&#123;right&#125;</span>,<span class="subst">$&#123;root.val&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">const</span> count = map.get(str);</span><br><span class="line">        <span class="keyword">if</span>(count===<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//ç­‰äº1å°±å­˜æ”¾å­æ ‘</span></span><br><span class="line">            res.push(root);</span><br><span class="line">        &#125;</span><br><span class="line">        map.set(str,(count||<span class="number">0</span>)+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tranverse(root);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¯»æ‰¾é‡å¤å­æ ‘çš„è¿‡ç¨‹å°±æ˜¯ååºåºåˆ—åŒ–+æœç´¢çš„è¿‡ç¨‹ï¼Œæ³¨æ„åºåˆ—åŒ–çš„æ—¶å€™è¦æ”¾å…¥çš„æ˜¯valï¼Œæœç´¢çš„æ—¶å€™ç»“åˆmapå’Œæ»¡è¶³ä¸€æ¬¡åŠ å…¥resçš„æ¡ä»¶ä¼˜åŒ–ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Binary TreeäºŒå‰æ ‘ç¬”è®°â‘£--åºåˆ—åŒ–ç¯‡</title>
    <link href="https://zlinni.github.io/posts/3440987103/"/>
    <id>https://zlinni.github.io/posts/3440987103/</id>
    <published>2022-05-04T11:44:11.000Z</published>
    <updated>2022-05-08T03:19:58.608Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨ä¸Šä¸€æœŸæˆ‘ä»¬å¯¹äºŒå‰æ ‘çš„æ„é€ è¿›è¡Œäº†æ·±å…¥çš„äº†è§£ï¼Œé‡ç‚¹æŒæ¡äº†æ„é€ çš„æ ¸å¿ƒåŸç†ä»¥åŠä¸€äº›ç»†èŠ‚ä¸Šé¢çš„é—®é¢˜ã€‚ä¸‹é¢æ¥å­¦ä¹ äºŒå‰æ ‘çš„åºåˆ—åŒ–ï¼Œé€šè¿‡æœ¬ç¯‡æ–‡ç« ä½ å¯ä»¥å­¦ä¼šä»¥ä¸‹çš„é¢˜ç›®</p></div><p>Leetcode<br><a href="https://leetcode-cn.com/problems/serialize-and-deserialize-binary-tree/">297.äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</a></p><h1 id="äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>äºŒå‰æ ‘çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505111425.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505145026.png" alt=""></p><p>è¯¥é¢˜ç›®æœ¬è´¨ä¸Šï¼Œå°±æ˜¯æŠŠäºŒå‰æ ‘è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå†ä»å­—ç¬¦ä¸²è½¬ä¸ºäºŒå‰æ ‘çš„è¿‡ç¨‹ã€‚</p><p>è‡³äºæˆ‘ä»¬åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œä½¿ç”¨ä»€ä¹ˆç¬¦å·å®šä¹‰å¹¶ä¸é‡è¦ï¼Œåªè¦æœ€åèƒ½å¤Ÿååºåˆ—åŒ–å‡ºæ¥å³å¯ã€‚</p><p>eg<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505145259.png" alt=""></p><p>å¯¹äºä¸€é¢—è¿™æ ·çš„æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»–åºåˆ—åŒ–æˆ<code>2,1,#,6,3,#,#</code>å…¶å®ä»–è€ƒå¯Ÿçš„å°±æ˜¯å¦‚ä½•å¯¹äºŒå‰æ ‘è¿›è¡Œéå†ã€‚</p><p>äºŒå‰æ ‘çš„é€’å½’éå†æœ‰ä¸‰ç§ï¼Œå‰åºä¸­åºååºï¼Œè¿­ä»£éå†æœ‰å±‚åºï¼Œé‚£ä¹ˆå°±ä»å±‚åºå¼€å§‹ï¼Œçœ‹å¦‚ä½•è§£é¢˜</p><h1 id="å‰åºéå†è§£æ³•"><a href="#å‰åºéå†è§£æ³•" class="headerlink" title="å‰åºéå†è§£æ³•"></a>å‰åºéå†è§£æ³•</h1><p>æˆ‘ä»¬çŸ¥é“ï¼Œå‰åºéå†çš„ä»£ç å°±æ˜¯åœ¨é€’å½’ä¹‹å‰å†™çš„ï¼Œé‚£ä¹ˆå°±æœ‰ä»¥ä¸‹çš„é€»è¾‘<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!root)<span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">traverse(root.left);</span><br><span class="line">traverse(root.right);</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¾ˆå®¹æ˜“å¾—å‡ºåºåˆ—åŒ–çš„è¿‡ç¨‹äº†ï¼Œå°±æ˜¯å­—ç¬¦ä¸²çš„è¿æ¥<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serialize = <span class="function"><span class="keyword">function</span> (<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!root)<span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;root&#125;</span>,<span class="subst">$&#123;serialize(root.left)&#125;</span>,<span class="subst">$&#123;serialize(root.right)&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><p>é‚£ä¹ˆå…¶å®ååºåˆ—åŒ–ï¼Œå°±æ˜¯æŠŠåºåˆ—åŒ–çš„è¿™ä¸€ä¸²å­—ç¬¦ä¸²è½¬æ¢ä¸ºtreenodeã€‚</p><p>å¯¹äºä¸€ä¸ªå­—ç¬¦ä¸²æ¥è¯´ï¼Œjsæä¾›äº†splitæ–¹æ³•å¸®æˆ‘ä»¬è¿›è¡Œåˆ†å‰²ï¼Œä¹Ÿå°±æ˜¯è¯´ä»¥ä¸‹çš„é€»è¾‘ï¼Œä¼šåˆ†å‰²å‡ºä¸€ä¸ªæ•°ç»„<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nodeArr = data.split(<span class="string">&quot;,&quot;</span>);</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬æ‹¿åˆ°äº†è¿™ä¸ªæ•°ç»„ï¼Œå› ä¸ºä»–æ˜¯å‰åºçš„åºåˆ—åŒ–è€Œæ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ ¹æ®å‰åºçš„ç‰¹æ€§å¯ä»¥å¾—åˆ°ä»¥ä¸‹æ¡ä»¶<br><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220505145931.png" alt=""></p><p>ç¬¬ä¸€ä¸ªå€¼æ˜¯æ ¹ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„é€’å½’å…³é”®ï¼Œå›æƒ³ä¸€ä¸‹å‰åºæ„é€ äºŒå‰æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> build = <span class="function">(<span class="params">preorder</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> val = preorder.shift();</span><br><span class="line">  <span class="keyword">if</span>(val === <span class="string">&#x27;#&#x27;</span>)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(val);</span><br><span class="line">  root.left = build(preorder);</span><br><span class="line">  root.right = build(preorder);</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆæˆ‘ä»¬çš„ååºåˆ—åŒ–å°±èƒ½å†™å‡ºæ¥äº†<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> deserialize = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nodearr = data.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!nodearr.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> build = <span class="function">(<span class="params">nodearr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> val = nodearr.shift();</span><br><span class="line">        <span class="keyword">if</span> (val === <span class="string">&#x27;#&#x27;</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(val);</span><br><span class="line">        root.left = build(nodearr);</span><br><span class="line">        root.right = build(nodearr);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> build(nodearr);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å®Œæ•´ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> serialize = <span class="function"><span class="keyword">function</span> (<span class="params">root</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;root.val&#125;</span>,<span class="subst">$&#123;serialize(root.left)&#125;</span>,<span class="subst">$&#123;serialize(root.right)&#125;</span>`</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> deserialize = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nodearr = data.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!nodearr.length) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> build = <span class="function">(<span class="params">nodearr</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> val = nodearr.shift();</span><br><span class="line">        <span class="keyword">if</span> (val === <span class="string">&#x27;#&#x27;</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(val);</span><br><span class="line">        root.left = build(nodearr);</span><br><span class="line">        root.right = build(nodearr);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> build(nodearr);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åºåˆ—åŒ–å°±æ˜¯è½¬å­—ç¬¦ä¸²çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”¨ä»€ä¹ˆç¬¦å·ä»£æ›¿å¹¶ä¸é‡è¦ï¼Œåªè¦æœ€åèƒ½è§£æå³å¯ã€‚ä¸€èˆ¬æ˜¯åˆ©ç”¨å‰åºç©ºèŠ‚ç‚¹è¿”å›#ç„¶åæ¨¡æ¿å­—ç¬¦ä¸²æ‹¼æ¥æ ¹+é€’å½’çš„å·¦å³</p><p>ååºåˆ—åŒ–çš„å°±æ˜¯è§£æå­—ç¬¦ä¸²é‡æ„æ ‘çš„è¿‡ç¨‹ï¼Œæ³¨æ„éœ€è¦ç”¨splitåˆ†å‰²å­—ç¬¦ä¸²ä¸ºæ•°ç»„ï¼Œé‡åˆ°#å°±è¿”å›nullã€‚</p><p>é‡æ„æ ‘çš„è¿‡ç¨‹ï¼Œç”±äºä»–æ˜¯æ•°ç»„è½¬æ ‘ï¼Œæˆ‘ä»¬é€’å½’çš„æ—¶å€™å°±è¦æ³¨æ„é€’å½’çš„æ˜¯æ•°ç»„ï¼Œæˆ‘ä»¬å–èŠ‚ç‚¹å°±åº”è¯¥ä½¿ç”¨shift</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Binary TreeäºŒå‰æ ‘ç¬”è®°â‘¢--æ„é€ ç¯‡</title>
    <link href="https://zlinni.github.io/posts/686027467/"/>
    <id>https://zlinni.github.io/posts/686027467/</id>
    <published>2022-05-04T11:43:28.000Z</published>
    <updated>2022-05-08T03:01:55.154Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><div class="note primary flat"><p>åœ¨ä¸Šä¸€ç¯‡ç¬”è®°é‡Œé¢ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†å‰åºå’Œååºéå†çš„æœ¬è´¨ï¼Œå­¦ä¼šäº†ç¿»è½¬äºŒå‰æ ‘ï¼Œå°†äºŒå‰æ ‘è½¬ä¸ºé“¾è¡¨å’Œå¡«å……äºŒå‰æ ‘å³ä¾§æŒ‡é’ˆä¸‰é“é—®é¢˜ã€‚æ¥ä¸‹æ¥è¿›ä¸€æ­¥å­¦ä¹ ï¼Œåœ¨æœ¬ç¯‡èƒ½ç†è§£å¹¶è¿ç”¨ä»¥ä¸‹é¢˜ç›®ï¼š</p></div><p>Leetcode<br><a href="https://leetcode-cn.com/problems/maximum-binary-tree/">654.æœ€å¤§äºŒå‰æ ‘</a><br><a href="https://leetcode-cn.com/problems/construct-binary-tree-from-preorder-and-inorder-traversal/">105.ä»å‰åºéå†å’Œä¸­åºéå†æ„é€ äºŒå‰æ ‘</a><br><a href="https://leetcode-cn.com/problems/construct-binary-tree-from-inorder-and-postorder-traversal/">106.ä»ä¸­åºå’Œååºéå†æ„é€ äºŒå‰æ ‘</a><br><a href="https://leetcode-cn.com/problems/construct-binary-tree-from-preorder-and-postorder-traversal/">889.æ ¹æ®å‰åºå’Œååºéå†æ„é€ äºŒå‰æ ‘</a></p><h1 id="æœ€å¤§äºŒå‰æ ‘"><a href="#æœ€å¤§äºŒå‰æ ‘" class="headerlink" title="æœ€å¤§äºŒå‰æ ‘"></a>æœ€å¤§äºŒå‰æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220504201032.png" alt=""></p><p>æˆ‘ä»¬ç»†åˆ†è¿™é“é¢˜ï¼Œå…¶å®ä»–åœ¨åšè¿™æ ·çš„äº‹æƒ…<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> constructMaximumBinaryTree = <span class="function"><span class="keyword">function</span> (<span class="params">[<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">5</span>]</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°æ•°ç»„çš„æœ€å¤§å€¼</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(<span class="number">6</span>)</span><br><span class="line">    <span class="comment">// é€’å½’è°ƒç”¨æ„é€ å·¦å³å­æ ‘</span></span><br><span class="line">    root.left = constructMaximumBinaryTree([<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>]);</span><br><span class="line">    root.right = constructMaximumBinaryTree([<span class="number">0</span>,<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å†è¯¦ç»†ä¸€ç‚¹å°±æ˜¯å¦‚ä¸‹çš„æ€è·¯ï¼š<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> constructMaximumBinaryTree = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> len = nums.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> build = <span class="function">(<span class="params">nums,start,end</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(start&gt;end)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾æœ€å¤§å€¼å’Œä»–çš„ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">let</span> max = -<span class="literal">Infinity</span>,index;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i=start;i&lt;=end;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[i]&gt;max)&#123;</span><br><span class="line">                max = nums[i];</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ„é€ äºŒå‰æ ‘</span></span><br><span class="line">        <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(max);</span><br><span class="line">        root.left = build(nums,start,index-<span class="number">1</span>);</span><br><span class="line">        root.right = build(nums,index+<span class="number">1</span>,end);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> build(nums,<span class="number">0</span>,len);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æˆ–è€…å¯ä»¥è¿™æ ·</span></span><br><span class="line"><span class="keyword">var</span> constructMaximumBinaryTree = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//æŸ¥æ‰¾æœ€å¤§å€¼å’Œä»–çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">if</span>(!nums.length)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> max = -<span class="literal">Infinity</span>, index = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i] &gt; max) &#123;</span><br><span class="line">            max = nums[i];</span><br><span class="line">            index = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ„é€ äºŒå‰æ ‘</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="keyword">new</span> TreeNode(max);</span><br><span class="line">    root.left = constructMaximumBinaryTree(nums.slice(<span class="number">0</span>, index));</span><br><span class="line">    <span class="comment">//+1</span></span><br><span class="line">    root.right = constructMaximumBinaryTree(nums.slice(index + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>è‡³æ­¤ç¬¬ä¸€é“æ„é€ äºŒå‰æ ‘çš„é¢˜ç›®å°±åšå®Œäº†ï¼Œæ¥ä¸‹çœ‹çœ‹å¦å¤–ä¸¤é“é¢˜ç›®</p><h1 id="é€šè¿‡å‰åºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘"><a href="#é€šè¿‡å‰åºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘" class="headerlink" title="é€šè¿‡å‰åºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘"></a>é€šè¿‡å‰åºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220504201525.png" alt=""></p><p>æˆ‘ä»¬çŸ¥é“å‰åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æ•´ä¸ªæ ‘çš„æ ¹ï¼Œé‚£ä¹ˆä¸­åºéå†çš„æ ¹èŠ‚ç‚¹å‰é¢å°±æ˜¯å·¦å­æ ‘ï¼Œåé¢å°±æ˜¯å³å­æ ‘ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œè‡ªç„¶è€Œç„¶çš„ä¼šæƒ³å‡ºä»¥ä¸‹ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> build = <span class="function">(<span class="params">preorder, inorder</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//æ‰¾åˆ°æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">const</span> root = preorder.shift();</span><br><span class="line">    <span class="comment">// ä¸­åºæ‰¾åˆ°è¯¥èŠ‚ç‚¹çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">const</span> rootIndex = inorder.indexOf(root);</span><br><span class="line">    <span class="keyword">const</span> tree = <span class="keyword">new</span> TreeNode(root);</span><br><span class="line">    <span class="comment">//é€’å½’è°ƒç”¨æ„é€ å·¦å³å­æ ‘</span></span><br><span class="line">    tree.left = fun(...);</span><br><span class="line">    tree.right = fun(...);</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªä»€ä¹ˆæ ·çš„å‡½æ•°å»é€’å½’å‘¢ï¼Ÿ<br>å…¶å®æˆ‘ä»¬åªè¦åˆ©ç”¨æˆ‘ä»¬çš„ä¸­åºæ•°ç»„å°±å¯ä»¥äº†ï¼Œå› ä¸ºèƒ½ä¾é ä»–æŸ¥æ‰¾ï¼Œå°±èƒ½ä¾é ä»–æ„é€ </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buildTree = <span class="function"><span class="keyword">function</span>(<span class="params">preorder, inorder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> build = <span class="function">(<span class="params">inorder</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!inorder||!inorder.length)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">const</span> root = preorder.shift();</span><br><span class="line">        <span class="keyword">const</span> rootIndex = inorder.indexOf(root);</span><br><span class="line">        <span class="keyword">const</span> tree = <span class="keyword">new</span> TreeNode(root);</span><br><span class="line">        tree.left = build(inorder.slice(<span class="number">0</span>,rootIndex));</span><br><span class="line">        tree.right = build(inorder.slice(rootIndex+<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> build(inorder);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ–è€…æˆ‘ä»¬å¯ä»¥è¿™æ ·,æˆ‘ä»¬çŸ¥é“äº†å…¶å®å‰åºçš„å·¦å­æ ‘ç»ˆæ­¢è¾¹ç•Œå°±æ˜¯ä¸­åºåˆ°æ ¹èŠ‚ç‚¹çš„é•¿åº¦+1ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥å¸¦å…¥å‰åºé€’å½’<br><img src="https://labuladong.github.io/algo/images/%e4%ba%8c%e5%8f%89%e6%a0%91%e7%b3%bb%e5%88%972/6.jpeg" alt=""><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buildTree = <span class="function"><span class="keyword">function</span>(<span class="params">preorder, inorder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preorder.length) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">const</span> root = preorder.shift();</span><br><span class="line">    <span class="keyword">const</span> tree = <span class="keyword">new</span> TreeNode(root)</span><br><span class="line">    <span class="keyword">const</span> rootIndex = inorder.indexOf(root)</span><br><span class="line">    tree.left = buildTree(preorder.slice(<span class="number">0</span>, rootIndex), inorder.slice(<span class="number">0</span>,rootIndex))</span><br><span class="line">    tree.right = buildTree(preorder.slice(rootIndex), inorder.slice(rootIndex+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h1 id="é€šè¿‡ååºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘"><a href="#é€šè¿‡ååºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘" class="headerlink" title="é€šè¿‡ååºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘"></a>é€šè¿‡ååºå’Œä¸­åºéå†ç»“æœæ„é€ äºŒå‰æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220504204143.png" alt=""></p><p>ååºéå†çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯rootï¼Œé‚£ä¹ˆæˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ªé“ç†ï¼Œå…¶å®å°±æŠŠshiftçš„æ“ä½œå˜æˆpopå³å¯ã€‚<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buildTree = <span class="function"><span class="keyword">function</span>(<span class="params">inorder, postorder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!postorder.length)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> root = postorder.pop();</span><br><span class="line">    <span class="keyword">const</span> rootIndex = inorder.indexOf(root);</span><br><span class="line">    <span class="keyword">const</span> tree = <span class="keyword">new</span> TreeNode(root);</span><br><span class="line">    tree.left = buildTree(inorder.slice(<span class="number">0</span>,rootIndex),postorder.slice(<span class="number">0</span>,rootIndex));</span><br><span class="line">    tree.right = buildTree(inorder.slice(rootIndex+<span class="number">1</span>),postorder.slice(rootIndex));</span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h1 id="é€šè¿‡å‰åºå’Œååºæ„é€ äºŒå‰æ ‘"><a href="#é€šè¿‡å‰åºå’Œååºæ„é€ äºŒå‰æ ‘" class="headerlink" title="é€šè¿‡å‰åºå’Œååºæ„é€ äºŒå‰æ ‘"></a>é€šè¿‡å‰åºå’Œååºæ„é€ äºŒå‰æ ‘</h1><p><img src="https://cdn.jsdelivr.net/gh/Zlinni/Pic/img/20220508105922.png" alt=""><br>æˆ‘ä»¬çŸ¥é“äº†ç»“åˆä¸­åºæ„é€ çš„æ–¹æ³•ï¼Œå°±æ˜¯ä»ä¸­åºä¸­æ‰¾åˆ°å¯¹åº”çš„indexç„¶ååˆ†ç¦»å·¦å³ï¼Œæœ€åé€’å½’ã€‚</p><p>é‚£ä¹ˆå‰åºå’Œååºæ€ä¹ˆæ„é€ å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œæ‹¿å‰åºå½“å‚ç…§ç‰©ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯æ ¹èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªå°±æ˜¯å·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åŒæ ·çš„åœ¨ååºä¸­æ‰¾åˆ°è¿™ä¸ªå·¦å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œå»åˆ†ç¦»æˆ‘ä»¬çš„å·¦å³å­æ ‘ã€‚</p><p><img src="https://labuladong.github.io/algo/images/%e4%ba%8c%e5%8f%89%e6%a0%91%e7%b3%bb%e5%88%972/8.jpeg" alt=""><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> constructFromPrePost = <span class="function"><span class="keyword">function</span>(<span class="params">preorder, postorder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preorder.length||!postorder.length)<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(preorder.length===<span class="number">1</span>)<span class="keyword">return</span> <span class="keyword">new</span> TreeNode(preorder[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">const</span> root = preorder[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> index = postorder.indexOf(root);</span><br><span class="line">    <span class="keyword">const</span> tree = <span class="keyword">new</span> TreeNode(preorder.shift());</span><br><span class="line">    <span class="comment">//ä¹‹å‰æ‰¾çš„æ˜¯æ ¹èŠ‚ç‚¹å‰é¢çš„ä¸€æ®µï¼Œæ‰€ä»¥æ˜¯indexï¼Œç°åœ¨æ‰¾çš„æ˜¯å·¦å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥index+1</span></span><br><span class="line">    tree.left = constructFromPrePost(preorder.slice(<span class="number">0</span>,index+<span class="number">1</span>),postorder.slice(<span class="number">0</span>,index+<span class="number">1</span>),)</span><br><span class="line">    tree.right = constructFromPrePost(preorder.slice(index+<span class="number">1</span>),postorder.slice(index+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œæ„é€ äºŒå‰æ ‘å®é™…ä¸Šå°±æ˜¯æ‰¾åˆ°æ ¹èŠ‚ç‚¹+æ„é€ å·¦å­æ ‘+æ„é€ å³å­æ ‘ã€‚æ ¹èŠ‚ç‚¹ä½¿ç”¨indexofå’Œéå†çš„æ€§è´¨å¯»æ‰¾ï¼Œå·¦å³å­æ ‘çš„æ„é€ ä½¿ç”¨é€’å½’çš„æ–¹æ³•ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;\assets\css\APlayer.min.css&quot;&gt;&lt;script src=&quot;\assets\js\APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="ç®—æ³•æŒ‡å—" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/"/>
    
    <category term="Binary Tree" scheme="https://zlinni.github.io/categories/%E7%AE%97%E6%B3%95%E6%8C%87%E5%8D%97/Binary-Tree/"/>
    
    
    <category term="ç®—æ³•" scheme="https://zlinni.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
</feed>
